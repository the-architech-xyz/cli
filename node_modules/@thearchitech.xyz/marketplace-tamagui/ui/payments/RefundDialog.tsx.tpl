// Refund Dialog Component

"use client";

import React, { useState } from 'react';
import { useTranslation } from '@/lib/i18n';
import {
  AlertTriangle, 
  DollarSign, 
  CreditCard, 
  Calendar,
  User,
  FileText
} from 'lucide-react-native';

import {
  YStack,
  XStack,
  Button,
  Input,
  Label,
  TextArea,
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
  Badge,
  Alert,
  AlertDescription,
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  Text,
  Checkbox,
  Theme,
  Square,
  Separator
} from 'tamagui';

interface RefundDialogProps {
  isOpen: boolean;
  onClose: () => void;
  transaction: {
    id: string;
    amount: number;
    currency: string;
    status: string;
    paymentMethod: string;
    customerName: string;
    customerEmail: string;
    date: string;
    description?: string;
  };
  onRefund: (refundData: RefundData) => Promise<void>;
  isLoading?: boolean;
}

interface RefundData {
  amount: number;
  reason: string;
  description?: string;
  notifyCustomer: boolean;
  refundType: 'full' | 'partial';
}

export function RefundDialog({
  isOpen,
  onClose,
  transaction,
  onRefund,
  isLoading = false,
}: RefundDialogProps) {
  const { t } = useTranslation();
  const [refundData, setRefundData] = useState<RefundData>({
    amount: transaction.amount,
    reason: '',
    description: '',
    notifyCustomer: true,
    refundType: 'full',
  });

  const [errors, setErrors] = useState<Record<string, string>>({});

  const refundReasons = [
    'Customer requested',
    'Duplicate payment',
    'Fraudulent transaction',
    'Product not delivered',
    'Product defective',
    'Service not provided',
    'Customer changed mind',
    'Other',
  ];

  const formatCurrency = (amount: number, currency: string): string => {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: currency,
    }).format(amount);
  };

  const formatDate = (dateString: string): string => {
    return new Date(dateString).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
    });
  };

  const validateForm = (): boolean => {
    const newErrors: Record<string, string> = {};

    if (!refundData.reason) {
      newErrors.reason = t('payments.refund.errors.reasonRequired');
    }

    if (refundData.amount <= 0) {
      newErrors.amount = t('payments.refund.errors.amountPositive');
    }

    if (refundData.amount > transaction.amount) {
      newErrors.amount = t('payments.refund.errors.amountExceeded');
    }

    if (refundData.refundType === 'partial' && refundData.amount === transaction.amount) {
      newErrors.amount = t('payments.refund.errors.partialAmount');
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = async () => {
    if (!validateForm()) {
      return;
    }

    try {
      await onRefund(refundData);
      onClose();
      // Reset form
      setRefundData({
        amount: transaction.amount,
        reason: '',
        description: '',
        notifyCustomer: true,
        refundType: 'full',
      });
      setErrors({});
    } catch (error) {
      console.error('Refund failed:', error);
    }
  };

  const handleRefundTypeChange = (type: string) => {
    setRefundData(prev => ({
      ...prev,
      refundType: type as 'full' | 'partial',
      amount: type === 'full' ? transaction.amount : prev.amount,
    }));
  };

  const getStatusTheme = (status: string): string => {
    switch (status.toLowerCase()) {
      case 'completed':
      case 'succeeded':
        return 'green';
      case 'pending':
        return 'yellow';
      case 'failed':
      case 'declined':
        return 'red';
      default:
        return 'gray';
    }
  };

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>
            <XStack alignItems="center" gap="$2">
              <AlertTriangle size={20} color="$orange10" />
              <Text>{t('payments.refund.title')}</Text>
            </XStack>
          </DialogTitle>
          <DialogDescription>
            {t('payments.refund.description')}
          </DialogDescription>
        </DialogHeader>

        <YStack space="$6">
          {/* Transaction Details */}
          <YStack 
            backgroundColor="$backgroundHover" 
            padding="$4" 
            borderRadius="$3" 
            space="$3"
          >
            <Text fontWeight="$6" fontSize="$3">
              {t('payments.refund.transactionDetails')}
            </Text>
            <YStack space="$4">
              <XStack flexWrap="wrap" gap="$4">
                <XStack flex={1} minWidth={200} alignItems="center" gap="$2">
                  <CreditCard size={16} color="$colorFocus" />
                  <Text color="$colorFocus">{t('payments.refund.id')}:</Text>
                  <Text fontFamily="$mono">{transaction.id}</Text>
                </XStack>
                <XStack flex={1} minWidth={200} alignItems="center" gap="$2">
                  <DollarSign size={16} color="$colorFocus" />
                  <Text color="$colorFocus">{t('payments.refund.amount')}:</Text>
                  <Text fontWeight="$6">
                    {formatCurrency(transaction.amount, transaction.currency)}
                  </Text>
                </XStack>
                <XStack flex={1} minWidth={200} alignItems="center" gap="$2">
                  <User size={16} color="$colorFocus" />
                  <Text color="$colorFocus">{t('payments.refund.customer')}:</Text>
                  <Text>{transaction.customerName}</Text>
                </XStack>
                <XStack flex={1} minWidth={200} alignItems="center" gap="$2">
                  <Calendar size={16} color="$colorFocus" />
                  <Text color="$colorFocus">{t('payments.refund.date')}:</Text>
                  <Text>{formatDate(transaction.date)}</Text>
                </XStack>
              </XStack>
              <XStack alignItems="center" gap="$2">
                <Theme name={getStatusTheme(transaction.status)}>
                  <Badge>
                    <Text fontSize="$1">{transaction.status}</Text>
                  </Badge>
                </Theme>
                <Text fontSize="$2" color="$colorFocus">
                  {t('payments.refund.via')} {transaction.paymentMethod}
                </Text>
              </XStack>
            </YStack>
          </YStack>

          {/* Refund Configuration */}
          <YStack space="$4">
            <YStack>
              <Label htmlFor="refundType">{t('payments.refund.refundType')}</Label>
              <Select
                id="refundType"
                value={refundData.refundType}
                onValueChange={handleRefundTypeChange}
              >
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="full">
                    <Text>{t('payments.refund.fullRefund')}</Text>
                  </SelectItem>
                  <SelectItem value="partial">
                    <Text>{t('payments.refund.partialRefund')}</Text>
                  </SelectItem>
                </SelectContent>
              </Select>
            </YStack>

            <YStack>
              <Label htmlFor="amount">{t('payments.refund.refundAmount')}</Label>
              <XStack position="relative">
                <XStack 
                  position="absolute" 
                  left="$3" 
                  top="50%" 
                  alignItems="center" 
                  transform={[{ translateY: -8 }]}
                >
                  <DollarSign size={16} color="$colorFocus" />
                </XStack>
                <Input
                  id="amount"
                  type="number"
                  step="0.01"
                  min="0.01"
                  max={transaction.amount.toString()}
                  value={refundData.amount.toString()}
                  onChangeText={(text) => setRefundData(prev => ({
                    ...prev,
                    amount: parseFloat(text) || 0
                  }))}
                  paddingLeft="$10"
                  disabled={refundData.refundType === 'full'}
                  flex={1}
                />
              </XStack>
              {errors.amount && (
                <Text fontSize="$1" color="$red10" marginTop="$1">{errors.amount}</Text>
              )}
              <Text fontSize="$1" color="$colorFocus" marginTop="$1">
                {t('payments.refund.maximum')}: {formatCurrency(transaction.amount, transaction.currency)}
              </Text>
            </YStack>

            <YStack>
              <Label htmlFor="reason">{t('payments.refund.reasonRequired')}</Label>
              <Select
                id="reason"
                value={refundData.reason}
                onValueChange={(value) => setRefundData(prev => ({ ...prev, reason: value }))}
              >
                <SelectTrigger>
                  <SelectValue placeholder={t('payments.refund.selectReason')} />
                </SelectTrigger>
                <SelectContent>
                  {refundReasons.map((reason) => (
                    <SelectItem key={reason} value={reason}>
                      <Text>{t(`payments.refund.reasons.${reason.toLowerCase().replace(/\s+/g, '_')}`, reason)}</Text>
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
              {errors.reason && (
                <Text fontSize="$1" color="$red10" marginTop="$1">{errors.reason}</Text>
              )}
            </YStack>

            <YStack>
              <Label htmlFor="description">{t('payments.refund.additionalNotes')}</Label>
              <TextArea
                id="description"
                placeholder={t('payments.refund.optionalNotes')}
                value={refundData.description}
                onChangeText={(text) => setRefundData(prev => ({ ...prev, description: text }))}
                numberOfLines={3}
                minHeight={80}
              />
            </YStack>

            <XStack alignItems="center" gap="$2">
              <Checkbox
                id="notifyCustomer"
                checked={refundData.notifyCustomer}
                onCheckedChange={(checked) => 
                  setRefundData(prev => ({ ...prev, notifyCustomer: !!checked }))
                }
              />
              <Label htmlFor="notifyCustomer" fontSize="$2">
                {t('payments.refund.notifyCustomer')}
              </Label>
            </XStack>
          </YStack>

          {/* Warning */}
          <Alert theme="orange">
            <XStack gap="$2" alignItems="center">
              <AlertTriangle size={16} />
              <AlertDescription>
                {t('payments.refund.warning')}
              </AlertDescription>
            </XStack>
          </Alert>
        </YStack>

        <DialogFooter>
          <XStack gap="$3" justifyContent="flex-end">
            <Button 
              variant="outlined" 
              onPress={onClose} 
              disabled={isLoading}
            >
              {t('common.cancel')}
            </Button>
            <Button 
              theme="red"
              onPress={handleSubmit} 
              disabled={isLoading}
            >
              {isLoading ? t('payments.refund.processing') : t('payments.refund.processRefund')}
            </Button>
          </XStack>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
