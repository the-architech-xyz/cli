// Invoices Page Component

"use client";

import React, { useState, useEffect } from 'react';
import { useTranslation } from '@/lib/i18n';
import { 
  Download, 
  Eye, 
  Search, 
  Filter, 
  Calendar,
  FileText,
  DollarSign,
  Clock,
  CheckCircle,
  XCircle,
  AlertCircle
} from 'lucide-react-native';
import { useInvoicesList as useInvoices } from '@/lib/payments';

import {
  YStack,
  XStack,
  Button,
  Input,
  Badge,
  Card,
  CardContent,
  CardHeader,
  CardTitle,
  CardDescription,
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
  Alert,
  AlertDescription,
  Text,
  Theme,
  Square,
  Spinner,
  ScrollView
} from 'tamagui';

// Import InvoiceCard component
import { InvoiceCard } from './InvoiceCard';

// Custom Table components
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow
} from '@/components/ui/table-tamagui';

interface InvoicesPageProps {
  onInvoiceClick?: (invoice: any) => void;
  onDownload?: (invoice: any) => void;
}

export function InvoicesPage({
  onInvoiceClick,
  onDownload,
}: InvoicesPageProps) {
  const { t } = useTranslation();
  const { invoices, isLoading, error, fetchInvoices, downloadInvoice } = useInvoices();
  
  const [searchTerm, setSearchTerm] = useState('');
  const [statusFilter, setStatusFilter] = useState<string>('all');
  const [dateFilter, setDateFilter] = useState<string>('all');
  const [selectedInvoice, setSelectedInvoice] = useState<any>(null);
  const [isDetailOpen, setIsDetailOpen] = useState(false);

  useEffect(() => {
    fetchInvoices();
  }, []);

  const filteredInvoices = invoices.filter(invoice => {
    const matchesSearch = invoice.invoiceNumber.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         invoice.customerName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         invoice.customerEmail.toLowerCase().includes(searchTerm.toLowerCase());
    
    const matchesStatus = statusFilter === 'all' || invoice.status === statusFilter;
    
    const matchesDate = dateFilter === 'all' || {
      'last-30-days': () => {
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        return new Date(invoice.createdAt) >= thirtyDaysAgo;
      },
      'last-90-days': () => {
        const ninetyDaysAgo = new Date();
        ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);
        return new Date(invoice.createdAt) >= ninetyDaysAgo;
      },
      'this-year': () => {
        const thisYear = new Date().getFullYear();
        return new Date(invoice.createdAt).getFullYear() === thisYear;
      },
    }[dateFilter]?.() ?? true;

    return matchesSearch && matchesStatus && matchesDate;
  });

  const getStatusBadge = (status: string) => {
    const statusConfig: Record<string, { theme: string, icon: React.ComponentType<{ size?: number; color?: string }> }> = {
      paid: { theme: 'green', icon: CheckCircle },
      pending: { theme: 'yellow', icon: Clock },
      overdue: { theme: 'red', icon: AlertCircle },
      cancelled: { theme: 'gray', icon: XCircle },
    };

    const config = statusConfig[status] || statusConfig.pending;
    const Icon = config.icon;

    return (
      <Theme name={config.theme}>
        <Badge size="$1">
          <XStack alignItems="center" gap="$1">
            <Icon size={12} />
            <Text fontSize="$1" textTransform="capitalize">{status}</Text>
          </XStack>
        </Badge>
      </Theme>
    );
  };

  const handleInvoiceClick = (invoice: any) => {
    setSelectedInvoice(invoice);
    setIsDetailOpen(true);
    onInvoiceClick?.(invoice);
  };

  const handleDownload = async (invoice: any) => {
    try {
      await downloadInvoice(invoice.id);
      onDownload?.(invoice);
    } catch (error) {
      console.error('Download failed:', error);
    }
  };

  const totalAmount = filteredInvoices.reduce((sum, invoice) => sum + invoice.amount, 0);
  const paidAmount = filteredInvoices
    .filter(invoice => invoice.status === 'paid')
    .reduce((sum, invoice) => sum + invoice.amount, 0);

  if (isLoading) {
    return (
      <YStack padding="$4" alignItems="center" justifyContent="center" height={400}>
        <Spinner size="large" />
        <Text marginTop="$4" color="$colorFocus">
          {t('payments.invoices.loading')}
        </Text>
      </YStack>
    );
  }

  return (
    <YStack padding="$4" space="$6">
      {/* Header */}
      <XStack flexDirection={{ xs: 'column', sm: 'row' }} justifyContent="space-between" alignItems={{ sm: 'center' }}>
        <YStack>
          <Text fontSize="$8" fontWeight="$8" color="$color">
            {t('payments.invoices.title')}
          </Text>
          <Text fontSize="$3" color="$colorFocus" marginTop="$1">
            {t('payments.invoices.subtitle')}
          </Text>
        </YStack>
        <Button 
          marginTop={{ xs: '$4', sm: 0 }}
          icon={<FileText size={16} />}
        >
          {t('payments.invoices.createInvoice')}
        </Button>
      </XStack>

      {/* Stats Cards */}
      <XStack 
        flexDirection={{ xs: 'column', md: 'row' }}
        gap="$6"
      >
        <Card flex={1} elevate>
          <CardContent padding="$6">
            <XStack alignItems="center">
              <Theme name="blue">
                <Square backgroundColor="$background" padding="$2" borderRadius="$3">
                  <FileText size={24} color="$blue10" />
                </Square>
              </Theme>
              <YStack marginLeft="$4">
                <Text fontSize="$2" fontWeight="$6" color="$colorFocus">
                  {t('payments.invoices.totalInvoices')}
                </Text>
                <Text fontSize="$6" fontWeight="$8" color="$color">
                  {filteredInvoices.length}
                </Text>
              </YStack>
            </XStack>
          </CardContent>
        </Card>

        <Card flex={1} elevate>
          <CardContent padding="$6">
            <XStack alignItems="center">
              <Theme name="green">
                <Square backgroundColor="$background" padding="$2" borderRadius="$3">
                  <DollarSign size={24} color="$green10" />
                </Square>
              </Theme>
              <YStack marginLeft="$4">
                <Text fontSize="$2" fontWeight="$6" color="$colorFocus">
                  {t('payments.invoices.totalAmount')}
                </Text>
                <Text fontSize="$6" fontWeight="$8" color="$color">
                  ${totalAmount.toFixed(2)}
                </Text>
              </YStack>
            </XStack>
          </CardContent>
        </Card>

        <Card flex={1} elevate>
          <CardContent padding="$6">
            <XStack alignItems="center">
              <Theme name="green">
                <Square backgroundColor="$background" padding="$2" borderRadius="$3">
                  <CheckCircle size={24} color="$green10" />
                </Square>
              </Theme>
              <YStack marginLeft="$4">
                <Text fontSize="$2" fontWeight="$6" color="$colorFocus">
                  {t('payments.invoices.paidAmount')}
                </Text>
                <Text fontSize="$6" fontWeight="$8" color="$color">
                  ${paidAmount.toFixed(2)}
                </Text>
              </YStack>
            </XStack>
          </CardContent>
        </Card>
      </XStack>

      {/* Filters */}
      <Card elevate>
        <CardContent padding="$6">
          <XStack 
            flexDirection={{ xs: 'column', sm: 'row' }}
            gap="$4"
          >
            <YStack flex={1} position="relative">
              <XStack 
                position="absolute" 
                left="$3" 
                top="50%" 
                alignItems="center" 
                transform={[{ translateY: -8 }]}
              >
                <Search size={16} color="$colorFocus" />
              </XStack>
              <Input
                placeholder={t('payments.invoices.searchPlaceholder')}
                value={searchTerm}
                onChangeText={setSearchTerm}
                paddingLeft="$10"
                flex={1}
              />
            </YStack>
            
            <Select value={statusFilter} onValueChange={setStatusFilter}>
              <SelectTrigger width={{ xs: '100%', sm: 200 }}>
                <SelectValue placeholder={t('payments.invoices.filterByStatus')} />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">
                  <Text>{t('payments.invoices.allStatus')}</Text>
                </SelectItem>
                <SelectItem value="paid">
                  <Text>{t('payments.invoices.paid')}</Text>
                </SelectItem>
                <SelectItem value="pending">
                  <Text>{t('payments.invoices.pending')}</Text>
                </SelectItem>
                <SelectItem value="overdue">
                  <Text>{t('payments.invoices.overdue')}</Text>
                </SelectItem>
                <SelectItem value="cancelled">
                  <Text>{t('payments.invoices.cancelled')}</Text>
                </SelectItem>
              </SelectContent>
            </Select>

            <Select value={dateFilter} onValueChange={setDateFilter}>
              <SelectTrigger width={{ xs: '100%', sm: 200 }}>
                <SelectValue placeholder={t('payments.invoices.filterByDate')} />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">
                  <Text>{t('payments.invoices.allTime')}</Text>
                </SelectItem>
                <SelectItem value="last-30-days">
                  <Text>{t('payments.invoices.last30Days')}</Text>
                </SelectItem>
                <SelectItem value="last-90-days">
                  <Text>{t('payments.invoices.last90Days')}</Text>
                </SelectItem>
                <SelectItem value="this-year">
                  <Text>{t('payments.invoices.thisYear')}</Text>
                </SelectItem>
              </SelectContent>
            </Select>
          </XStack>
        </CardContent>
      </Card>

      {/* Error Alert */}
      {error && (
        <Alert theme="red">
          <XStack gap="$2" alignItems="center">
            <AlertCircle size={16} />
            <AlertDescription>{error}</AlertDescription>
          </XStack>
        </Alert>
      )}

      {/* Invoices Table */}
      <Card elevate>
        <CardHeader>
          <CardTitle>{t('payments.invoices.invoicesTitle')}</CardTitle>
          <CardDescription>
            {t('payments.invoices.invoicesFound', { 
              count: filteredInvoices.length 
            })}
          </CardDescription>
        </CardHeader>
        <CardContent>
          {filteredInvoices.length === 0 ? (
            <YStack alignItems="center" justifyContent="center" paddingVertical="$12">
              <FileText size={48} color="$colorFocus" />
              <Text fontSize="$5" fontWeight="$6" marginTop="$4" marginBottom="$2">
                {t('payments.invoices.noInvoicesFound')}
              </Text>
              <Text color="$colorFocus">
                {t('payments.invoices.adjustFilters')}
              </Text>
            </YStack>
          ) : (
            <ScrollView horizontal showsHorizontalScrollIndicator={false}>
              <Table>
                <TableHeader>
                  <TableRow>
                    <TableHead>{t('payments.invoices.invoiceNumber')}</TableHead>
                    <TableHead>{t('payments.invoices.customer')}</TableHead>
                    <TableHead>{t('payments.invoices.date')}</TableHead>
                    <TableHead>{t('payments.invoices.amount')}</TableHead>
                    <TableHead>{t('payments.invoices.status')}</TableHead>
                    <TableHead>{t('payments.invoices.dueDate')}</TableHead>
                    <TableHead align="right">{t('payments.invoices.actions')}</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {filteredInvoices.map((invoice) => (
                    <TableRow key={invoice.id}>
                      <TableCell>
                        <Text fontWeight="$6">{invoice.invoiceNumber}</Text>
                      </TableCell>
                      <TableCell>
                        <YStack>
                          <Text fontWeight="$6">{invoice.customerName}</Text>
                          <Text fontSize="$2" color="$colorFocus">{invoice.customerEmail}</Text>
                        </YStack>
                      </TableCell>
                      <TableCell>
                        <Text>{new Date(invoice.createdAt).toLocaleDateString()}</Text>
                      </TableCell>
                      <TableCell>
                        <Text fontWeight="$6">${invoice.amount.toFixed(2)}</Text>
                      </TableCell>
                      <TableCell>
                        {getStatusBadge(invoice.status)}
                      </TableCell>
                      <TableCell>
                        <Text>{new Date(invoice.dueDate).toLocaleDateString()}</Text>
                      </TableCell>
                      <TableCell align="right">
                        <XStack gap="$2" justifyContent="flex-end">
                          <Button
                            variant="outlined"
                            size="$2"
                            onPress={() => handleInvoiceClick(invoice)}
                            icon={<Eye size={16} />}
                          />
                          <Button
                            variant="outlined"
                            size="$2"
                            onPress={() => handleDownload(invoice)}
                            icon={<Download size={16} />}
                          />
                        </XStack>
                      </TableCell>
                    </TableRow>
                  ))}
                </TableBody>
              </Table>
            </ScrollView>
          )}
        </CardContent>
      </Card>

      {/* Invoice Detail Dialog */}
      <Dialog open={isDetailOpen} onOpenChange={setIsDetailOpen}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>{t('payments.invoices.invoiceDetails')}</DialogTitle>
            <DialogDescription>
              {t('payments.invoices.viewAndManage')}
            </DialogDescription>
          </DialogHeader>
          {selectedInvoice && (
            <InvoiceCard invoice={selectedInvoice} />
          )}
        </DialogContent>
      </Dialog>
    </YStack>
  );
}
