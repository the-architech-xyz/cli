// Subscriptions Page Component

"use client";

import React, { useState, useEffect } from 'react';
import { useTranslation } from '@/lib/i18n';
import { 
  CreditCard, 
  Calendar,
  DollarSign,
  Settings,
  Play,
  Pause,
  X,
  CheckCircle,
  XCircle,
  AlertCircle,
  Clock,
  TrendingUp,
  Users
} from 'lucide-react-native';
import { useSubscriptionsList as useSubscriptions } from '@/lib/payments';
import { SubscriptionCard } from './SubscriptionCard';

import {
  YStack,
  XStack,
  Button,
  Badge,
  Card,
  CardContent,
  CardHeader,
  CardTitle,
  CardDescription,
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
  Alert,
  AlertDescription,
  Text,
  Theme,
  Square,
  Spinner,
  ScrollView
} from 'tamagui';

// Custom Table components
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow
} from '@/components/ui/table-tamagui';

interface SubscriptionsPageProps {
  onSubscriptionClick?: (subscription: any) => void;
  onManage?: (subscription: any) => void;
}

export function SubscriptionsPage({
  onSubscriptionClick,
  onManage,
}: SubscriptionsPageProps) {
  const { t } = useTranslation();
  const { 
    subscriptions, 
    isLoading, 
    error, 
    fetchSubscriptions, 
    cancelSubscription, 
    pauseSubscription, 
    resumeSubscription,
    updateSubscription 
  } = useSubscriptions();
  
  const [statusFilter, setStatusFilter] = useState<string>('all');
  const [selectedSubscription, setSelectedSubscription] = useState<any>(null);
  const [isDetailOpen, setIsDetailOpen] = useState(false);
  const [isManaging, setIsManaging] = useState(false);

  useEffect(() => {
    fetchSubscriptions();
  }, []);

  const filteredSubscriptions = subscriptions.filter(subscription => {
    return statusFilter === 'all' || subscription.status === statusFilter;
  });

  const getStatusBadge = (status: string) => {
    const statusConfig: Record<string, { theme: string, icon: React.ComponentType<{ size?: number; color?: string }> }> = {
      active: { theme: 'green', icon: CheckCircle },
      paused: { theme: 'yellow', icon: Pause },
      cancelled: { theme: 'red', icon: XCircle },
      past_due: { theme: 'orange', icon: AlertCircle },
      trialing: { theme: 'blue', icon: Clock },
    };

    const config = statusConfig[status] || statusConfig.active;
    const Icon = config.icon;

    return (
      <Theme name={config.theme}>
        <Badge size="$1">
          <XStack alignItems="center" gap="$1">
            <Icon size={12} />
            <Text fontSize="$1" textTransform="capitalize">{status.replace('_', ' ')}</Text>
          </XStack>
        </Badge>
      </Theme>
    );
  };

  const handleSubscriptionClick = (subscription: any) => {
    setSelectedSubscription(subscription);
    setIsDetailOpen(true);
    onSubscriptionClick?.(subscription);
  };

  const handleManage = (subscription: any) => {
    setSelectedSubscription(subscription);
    setIsManaging(true);
    onManage?.(subscription);
  };

  const handleCancel = async (subscription: any) => {
    // In a real implementation, we'd use a proper confirmation dialog
    if (confirm(t('payments.subscriptions.confirmCancel'))) {
      try {
        await cancelSubscription(subscription.id);
        await fetchSubscriptions();
      } catch (error) {
        console.error('Failed to cancel subscription:', error);
      }
    }
  };

  const handlePause = async (subscription: any) => {
    try {
      await pauseSubscription(subscription.id);
      await fetchSubscriptions();
    } catch (error) {
      console.error('Failed to pause subscription:', error);
    }
  };

  const handleResume = async (subscription: any) => {
    try {
      await resumeSubscription(subscription.id);
      await fetchSubscriptions();
    } catch (error) {
      console.error('Failed to resume subscription:', error);
    }
  };

  const totalRevenue = subscriptions
    .filter(sub => sub.status === 'active')
    .reduce((sum, sub) => sum + sub.amount, 0);

  const activeSubscriptions = subscriptions.filter(sub => sub.status === 'active').length;
  const cancelledSubscriptions = subscriptions.filter(sub => sub.status === 'cancelled').length;

  if (isLoading) {
    return (
      <YStack padding="$4" alignItems="center" justifyContent="center" height={400}>
        <Spinner size="large" />
        <Text marginTop="$4" color="$colorFocus">
          {t('payments.subscriptions.loading')}
        </Text>
      </YStack>
    );
  }

  return (
    <YStack padding="$4" space="$6">
      {/* Header */}
      <XStack flexDirection={{ xs: 'column', sm: 'row' }} justifyContent="space-between" alignItems={{ sm: 'center' }}>
        <YStack>
          <Text fontSize="$8" fontWeight="$8" color="$color">
            {t('payments.subscriptions.title')}
          </Text>
          <Text fontSize="$3" color="$colorFocus" marginTop="$1">
            {t('payments.subscriptions.subtitle')}
          </Text>
        </YStack>
        <Button 
          marginTop={{ xs: '$4', sm: 0 }}
          icon={<CreditCard size={16} />}
        >
          {t('payments.subscriptions.createSubscription')}
        </Button>
      </XStack>

      {/* Stats Cards */}
      <XStack 
        flexDirection={{ xs: 'column', md: 'row' }}
        gap="$6"
      >
        <Card flex={1} elevate>
          <CardContent padding="$6">
            <XStack alignItems="center">
              <Theme name="blue">
                <Square backgroundColor="$background" padding="$2" borderRadius="$3">
                  <CreditCard size={24} color="$blue10" />
                </Square>
              </Theme>
              <YStack marginLeft="$4">
                <Text fontSize="$2" fontWeight="$6" color="$colorFocus">
                  {t('payments.subscriptions.totalSubscriptions')}
                </Text>
                <Text fontSize="$6" fontWeight="$8" color="$color">
                  {subscriptions.length}
                </Text>
              </YStack>
            </XStack>
          </CardContent>
        </Card>

        <Card flex={1} elevate>
          <CardContent padding="$6">
            <XStack alignItems="center">
              <Theme name="green">
                <Square backgroundColor="$background" padding="$2" borderRadius="$3">
                  <CheckCircle size={24} color="$green10" />
                </Square>
              </Theme>
              <YStack marginLeft="$4">
                <Text fontSize="$2" fontWeight="$6" color="$colorFocus">
                  {t('payments.subscriptions.active')}
                </Text>
                <Text fontSize="$6" fontWeight="$8" color="$color">
                  {activeSubscriptions}
                </Text>
              </YStack>
            </XStack>
          </CardContent>
        </Card>

        <Card flex={1} elevate>
          <CardContent padding="$6">
            <XStack alignItems="center">
              <Theme name="red">
                <Square backgroundColor="$background" padding="$2" borderRadius="$3">
                  <XCircle size={24} color="$red10" />
                </Square>
              </Theme>
              <YStack marginLeft="$4">
                <Text fontSize="$2" fontWeight="$6" color="$colorFocus">
                  {t('payments.subscriptions.cancelled')}
                </Text>
                <Text fontSize="$6" fontWeight="$8" color="$color">
                  {cancelledSubscriptions}
                </Text>
              </YStack>
            </XStack>
          </CardContent>
        </Card>

        <Card flex={1} elevate>
          <CardContent padding="$6">
            <XStack alignItems="center">
              <Theme name="green">
                <Square backgroundColor="$background" padding="$2" borderRadius="$3">
                  <DollarSign size={24} color="$green10" />
                </Square>
              </Theme>
              <YStack marginLeft="$4">
                <Text fontSize="$2" fontWeight="$6" color="$colorFocus">
                  {t('payments.subscriptions.monthlyRevenue')}
                </Text>
                <Text fontSize="$6" fontWeight="$8" color="$color">
                  ${totalRevenue.toFixed(2)}
                </Text>
              </YStack>
            </XStack>
          </CardContent>
        </Card>
      </XStack>

      {/* Filters */}
      <Card elevate>
        <CardContent padding="$6">
          <XStack 
            flexDirection={{ xs: 'column', sm: 'row' }}
            gap="$4"
          >
            <Select value={statusFilter} onValueChange={setStatusFilter}>
              <SelectTrigger width={{ xs: '100%', sm: 200 }}>
                <SelectValue placeholder={t('payments.subscriptions.filterByStatus')} />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">
                  <Text>{t('payments.subscriptions.allStatus')}</Text>
                </SelectItem>
                <SelectItem value="active">
                  <Text>{t('payments.subscriptions.statusActive')}</Text>
                </SelectItem>
                <SelectItem value="paused">
                  <Text>{t('payments.subscriptions.statusPaused')}</Text>
                </SelectItem>
                <SelectItem value="cancelled">
                  <Text>{t('payments.subscriptions.statusCancelled')}</Text>
                </SelectItem>
                <SelectItem value="past_due">
                  <Text>{t('payments.subscriptions.statusPastDue')}</Text>
                </SelectItem>
                <SelectItem value="trialing">
                  <Text>{t('payments.subscriptions.statusTrialing')}</Text>
                </SelectItem>
              </SelectContent>
            </Select>
          </XStack>
        </CardContent>
      </Card>

      {/* Error Alert */}
      {error && (
        <Alert theme="red">
          <XStack gap="$2" alignItems="center">
            <AlertCircle size={16} />
            <AlertDescription>{error}</AlertDescription>
          </XStack>
        </Alert>
      )}

      {/* Subscriptions Table */}
      <Card elevate>
        <CardHeader>
          <CardTitle>{t('payments.subscriptions.subscriptionsTitle')}</CardTitle>
          <CardDescription>
            {t('payments.subscriptions.subscriptionsFound', { 
              count: filteredSubscriptions.length 
            })}
          </CardDescription>
        </CardHeader>
        <CardContent>
          {filteredSubscriptions.length === 0 ? (
            <YStack alignItems="center" justifyContent="center" paddingVertical="$12">
              <CreditCard size={48} color="$colorFocus" />
              <Text fontSize="$5" fontWeight="$6" marginTop="$4" marginBottom="$2">
                {t('payments.subscriptions.noSubscriptionsFound')}
              </Text>
              <Text color="$colorFocus">
                {t('payments.subscriptions.adjustFilters')}
              </Text>
            </YStack>
          ) : (
            <ScrollView horizontal showsHorizontalScrollIndicator={false}>
              <Table>
                <TableHeader>
                  <TableRow>
                    <TableHead>{t('payments.subscriptions.customer')}</TableHead>
                    <TableHead>{t('payments.subscriptions.plan')}</TableHead>
                    <TableHead>{t('payments.subscriptions.amount')}</TableHead>
                    <TableHead>{t('payments.subscriptions.status')}</TableHead>
                    <TableHead>{t('payments.subscriptions.nextBilling')}</TableHead>
                    <TableHead>{t('payments.subscriptions.created')}</TableHead>
                    <TableHead align="right">{t('payments.subscriptions.actions')}</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {filteredSubscriptions.map((subscription) => (
                    <TableRow key={subscription.id}>
                      <TableCell>
                        <YStack>
                          <Text fontWeight="$6">{subscription.customerName}</Text>
                          <Text fontSize="$2" color="$colorFocus">{subscription.customerEmail}</Text>
                        </YStack>
                      </TableCell>
                      <TableCell>
                        <YStack>
                          <Text fontWeight="$6">{subscription.planName}</Text>
                          <Text fontSize="$2" color="$colorFocus">{subscription.interval}</Text>
                        </YStack>
                      </TableCell>
                      <TableCell>
                        <Text fontWeight="$6">${subscription.amount.toFixed(2)}</Text>
                      </TableCell>
                      <TableCell>
                        {getStatusBadge(subscription.status)}
                      </TableCell>
                      <TableCell>
                        <Text>
                          {subscription.nextBillingDate 
                            ? new Date(subscription.nextBillingDate).toLocaleDateString()
                            : t('payments.subscriptions.notApplicable')
                          }
                        </Text>
                      </TableCell>
                      <TableCell>
                        <Text>{new Date(subscription.createdAt).toLocaleDateString()}</Text>
                      </TableCell>
                      <TableCell align="right">
                        <XStack gap="$2" justifyContent="flex-end">
                          <Button
                            variant="outlined"
                            size="$2"
                            onPress={() => handleSubscriptionClick(subscription)}
                            icon={<Settings size={16} />}
                          />
                          
                          {subscription.status === 'active' && (
                            <Button
                              variant="outlined"
                              size="$2"
                              onPress={() => handlePause(subscription)}
                              icon={<Pause size={16} />}
                            />
                          )}
                          
                          {subscription.status === 'paused' && (
                            <Button
                              variant="outlined"
                              size="$2"
                              onPress={() => handleResume(subscription)}
                              icon={<Play size={16} />}
                            />
                          )}
                          
                          {subscription.status === 'active' && (
                            <Button
                              variant="outlined"
                              size="$2"
                              onPress={() => handleCancel(subscription)}
                              theme="red"
                              icon={<X size={16} />}
                            />
                          )}
                        </XStack>
                      </TableCell>
                    </TableRow>
                  ))}
                </TableBody>
              </Table>
            </ScrollView>
          )}
        </CardContent>
      </Card>

      {/* Subscription Detail Dialog */}
      <Dialog open={isDetailOpen} onOpenChange={setIsDetailOpen}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>{t('payments.subscriptions.subscriptionDetails')}</DialogTitle>
            <DialogDescription>
              {t('payments.subscriptions.viewAndManage')}
            </DialogDescription>
          </DialogHeader>
          {selectedSubscription && (
            <SubscriptionCard subscription={selectedSubscription} />
          )}
        </DialogContent>
      </Dialog>

      {/* Manage Subscription Dialog */}
      <Dialog open={isManaging} onOpenChange={setIsManaging}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>{t('payments.subscriptions.manageSubscription')}</DialogTitle>
            <DialogDescription>
              {t('payments.subscriptions.updateSettings')}
            </DialogDescription>
          </DialogHeader>
          {selectedSubscription && (
            <YStack space="$4">
              <Text>
                {t('payments.subscriptions.manageFor', { name: selectedSubscription.customerName })}
              </Text>
              {/* Add subscription management form here */}
            </YStack>
          )}
        </DialogContent>
      </Dialog>
    </YStack>
  );
}
