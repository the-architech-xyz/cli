/**
 * Checkout Form Component (Tamagui)
 * 
 * Payment checkout form with i18n support
 */

import React, { useState } from 'react';
import { YStack, XStack, Card, Text, Button, Input, Label, Separator, Spinner } from 'tamagui';
import { useTranslation } from '@/lib/i18n';
import { 
  CreditCard, 
  Lock, 
  Eye, 
  EyeOff,
  CheckCircle,
  AlertCircle
} from '@tamagui/lucide-icons';

interface CheckoutFormProps {
  onSubmit?: (data: PaymentFormData) => void;
  isLoading?: boolean;
  error?: string;
}

interface PaymentFormData {
  cardNumber: string;
  expiryDate: string;
  cvv: string;
  cardholderName: string;
  billingAddress: {
    line1: string;
    line2?: string;
    city: string;
    state: string;
    postalCode: string;
    country: string;
  };
  saveCard?: boolean;
}

export const CheckoutForm: React.FC<CheckoutFormProps> = ({
  onSubmit,
  isLoading = false,
  error,
}) => {
  const { t } = useTranslation();
  
  const [formData, setFormData] = useState<PaymentFormData>({
    cardNumber: '',
    expiryDate: '',
    cvv: '',
    cardholderName: '',
    billingAddress: {
      line1: '',
      line2: '',
      city: '',
      state: '',
      postalCode: '',
      country: 'US',
    },
    saveCard: false,
  });

  const [showCvv, setShowCvv] = useState(false);
  const [errors, setErrors] = useState<Record<string, string>>({});

  const formatCardNumber = (value: string) => {
    const v = value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
    const matches = v.match(/\d{4,16}/g);
    const match = matches && matches[0] || '';
    const parts = [];
    for (let i = 0, len = match.length; i < len; i += 4) {
      parts.push(match.substring(i, i + 4));
    }
    if (parts.length) {
      return parts.join(' ');
    } else {
      return v;
    }
  };

  const formatExpiryDate = (value: string) => {
    const v = value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
    if (v.length >= 2) {
      return v.substring(0, 2) + '/' + v.substring(2, 4);
    }
    return v;
  };

  const validateForm = (): boolean => {
    const newErrors: Record<string, string> = {};

    // Card number validation
    if (!formData.cardNumber || formData.cardNumber.replace(/\s/g, '').length < 13) {
      newErrors.cardNumber = t('checkout.errors.cardNumber');
    }

    // Expiry date validation
    if (!formData.expiryDate || formData.expiryDate.length !== 5) {
      newErrors.expiryDate = t('checkout.errors.expiryDateFormat');
    } else {
      const [month, year] = formData.expiryDate.split('/');
      const currentDate = new Date();
      const currentYear = currentDate.getFullYear() % 100;
      const currentMonth = currentDate.getMonth() + 1;
      
      if (parseInt(month) < 1 || parseInt(month) > 12) {
        newErrors.expiryDate = t('checkout.errors.invalidMonth');
      } else if (parseInt(year) < currentYear || (parseInt(year) === currentYear && parseInt(month) < currentMonth)) {
        newErrors.expiryDate = t('checkout.errors.cardExpired');
      }
    }

    // CVV validation
    if (!formData.cvv || formData.cvv.length < 3) {
      newErrors.cvv = t('checkout.errors.cvv');
    }

    // Cardholder name validation
    if (!formData.cardholderName.trim()) {
      newErrors.cardholderName = t('checkout.errors.cardholderName');
    }

    // Billing address validation
    if (!formData.billingAddress.line1.trim()) {
      newErrors.billingAddress = t('checkout.errors.address');
    }
    if (!formData.billingAddress.city.trim()) {
      newErrors.city = t('checkout.errors.city');
    }
    if (!formData.billingAddress.state.trim()) {
      newErrors.state = t('checkout.errors.state');
    }
    if (!formData.billingAddress.postalCode.trim()) {
      newErrors.postalCode = t('checkout.errors.postalCode');
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    
    if (validateForm()) {
      onSubmit?.(formData);
    }
  };

  const handleInputChange = (field: string, value: string) => {
    setFormData(prev => ({
      ...prev,
      [field]: value,
    }));

    // Clear error when user starts typing
    if (errors[field]) {
      setErrors(prev => ({
        ...prev,
        [field]: '',
      }));
    }
  };

  const handleAddressChange = (field: string, value: string) => {
    setFormData(prev => ({
      ...prev,
      billingAddress: {
        ...prev.billingAddress,
        [field]: value,
      },
    }));

    // Clear error when user starts typing
    if (errors[field]) {
      setErrors(prev => ({
        ...prev,
        [field]: '',
      }));
    }
  };

  return (
    <YStack asChild space="$6">
      <form onSubmit={handleSubmit}>
        {/* Card Information */}
        <Card
          theme="base"
          size="$4"
          padding="$0"
          backgroundColor="$background"
          borderWidth={1}
          borderColor="$borderColor"
          borderRadius="$6"
          elevation="$2"
        >
          <YStack padding="$6" gap="$1">
            <XStack gap="$2" alignItems="center">
              <CreditCard size="$1" color="$color" />
              <Text fontSize="$6" fontWeight="bold" color="$color">
                {t('checkout.cardInfo.title')}
              </Text>
            </XStack>
          </YStack>
          
          <YStack padding="$6" paddingTop="$0" gap="$4">
            {/* Card Number */}
            <YStack gap="$2">
              <Label htmlFor="cardNumber" fontSize="$4" color="$color">
                {t('checkout.cardInfo.cardNumber')} *
              </Label>
              <Input
                id="cardNumber"
                value={formData.cardNumber}
                onChangeText={(text) => handleInputChange('cardNumber', formatCardNumber(text))}
                placeholder={t('checkout.cardInfo.cardNumberPlaceholder')}
                backgroundColor="$background"
                color="$color"
                borderWidth={1}
                borderColor={errors.cardNumber ? '$red10' : '$borderColor'}
                borderRadius="$4"
                padding="$3"
                maxLength={19}
              />
              {errors.cardNumber && (
                <Text fontSize="$2" color="$red10">
                  {errors.cardNumber}
                </Text>
              )}
            </YStack>

            {/* Expiry Date and CVV */}
            <XStack gap="$4">
              {/* Expiry Date */}
              <YStack flex={1} gap="$2">
                <Label htmlFor="expiryDate" fontSize="$4" color="$color">
                  {t('checkout.cardInfo.expiryDate')} *
                </Label>
                <Input
                  id="expiryDate"
                  value={formData.expiryDate}
                  onChangeText={(text) => handleInputChange('expiryDate', formatExpiryDate(text))}
                  placeholder={t('checkout.cardInfo.expiryDatePlaceholder')}
                  backgroundColor="$background"
                  color="$color"
                  borderWidth={1}
                  borderColor={errors.expiryDate ? '$red10' : '$borderColor'}
                  borderRadius="$4"
                  padding="$3"
                  maxLength={5}
                />
                {errors.expiryDate && (
                  <Text fontSize="$2" color="$red10">
                    {errors.expiryDate}
                  </Text>
                )}
              </YStack>

              {/* CVV */}
              <YStack flex={1} gap="$2">
                <Label htmlFor="cvv" fontSize="$4" color="$color">
                  {t('checkout.cardInfo.cvv')} *
                </Label>
                <XStack position="relative">
                  <Input
                    id="cvv"
                    secureTextEntry={!showCvv}
                    value={formData.cvv}
                    onChangeText={(text) => handleInputChange('cvv', text.replace(/\D/g, ''))}
                    placeholder={t('checkout.cardInfo.cvvPlaceholder')}
                    backgroundColor="$background"
                    color="$color"
                    borderWidth={1}
                    borderColor={errors.cvv ? '$red10' : '$borderColor'}
                    borderRadius="$4"
                    padding="$3"
                    maxLength={4}
                    flex={1}
                  />
                  <Button
                    type="button"
                    position="absolute"
                    right="$3"
                    top="50%"
                    transform="translateY(-50%)"
                    backgroundColor="transparent"
                    onPress={() => setShowCvv(!showCvv)}
                    padding="$0"
                  >
                    {showCvv ? (
                      <EyeOff size="$1" color="$colorFocus" />
                    ) : (
                      <Eye size="$1" color="$colorFocus" />
                    )}
                  </Button>
                </XStack>
                {errors.cvv && (
                  <Text fontSize="$2" color="$red10">
                    {errors.cvv}
                  </Text>
                )}
              </YStack>
            </XStack>

            {/* Cardholder Name */}
            <YStack gap="$2">
              <Label htmlFor="cardholderName" fontSize="$4" color="$color">
                {t('checkout.cardInfo.cardholderName')} *
              </Label>
              <Input
                id="cardholderName"
                value={formData.cardholderName}
                onChangeText={(text) => handleInputChange('cardholderName', text)}
                placeholder={t('checkout.cardInfo.cardholderNamePlaceholder')}
                backgroundColor="$background"
                color="$color"
                borderWidth={1}
                borderColor={errors.cardholderName ? '$red10' : '$borderColor'}
                borderRadius="$4"
                padding="$3"
              />
              {errors.cardholderName && (
                <Text fontSize="$2" color="$red10">
                  {errors.cardholderName}
                </Text>
              )}
            </YStack>
          </YStack>
        </Card>

        {/* Billing Address */}
        <Card
          theme="base"
          size="$4"
          padding="$0"
          backgroundColor="$background"
          borderWidth={1}
          borderColor="$borderColor"
          borderRadius="$6"
          elevation="$2"
        >
          <YStack padding="$6" gap="$1">
            <Text fontSize="$6" fontWeight="bold" color="$color">
              {t('checkout.billing.title')}
            </Text>
          </YStack>
          
          <YStack padding="$6" paddingTop="$0" gap="$4">
            {/* Address Line 1 */}
            <YStack gap="$2">
              <Label htmlFor="address" fontSize="$4" color="$color">
                {t('checkout.billing.addressLine1')} *
              </Label>
              <Input
                id="address"
                value={formData.billingAddress.line1}
                onChangeText={(text) => handleAddressChange('line1', text)}
                placeholder={t('checkout.billing.addressLine1Placeholder')}
                backgroundColor="$background"
                color="$color"
                borderWidth={1}
                borderColor={errors.billingAddress ? '$red10' : '$borderColor'}
                borderRadius="$4"
                padding="$3"
              />
              {errors.billingAddress && (
                <Text fontSize="$2" color="$red10">
                  {errors.billingAddress}
                </Text>
              )}
            </YStack>

            {/* Address Line 2 */}
            <YStack gap="$2">
              <Label htmlFor="address2" fontSize="$4" color="$color">
                {t('checkout.billing.addressLine2')}
              </Label>
              <Input
                id="address2"
                value={formData.billingAddress.line2}
                onChangeText={(text) => handleAddressChange('line2', text)}
                placeholder={t('checkout.billing.addressLine2Placeholder')}
                backgroundColor="$background"
                color="$color"
                borderWidth={1}
                borderColor="$borderColor"
                borderRadius="$4"
                padding="$3"
              />
            </YStack>

            {/* City and State */}
            <XStack gap="$4">
              {/* City */}
              <YStack flex={1} gap="$2">
                <Label htmlFor="city" fontSize="$4" color="$color">
                  {t('checkout.billing.city')} *
                </Label>
                <Input
                  id="city"
                  value={formData.billingAddress.city}
                  onChangeText={(text) => handleAddressChange('city', text)}
                  placeholder={t('checkout.billing.cityPlaceholder')}
                  backgroundColor="$background"
                  color="$color"
                  borderWidth={1}
                  borderColor={errors.city ? '$red10' : '$borderColor'}
                  borderRadius="$4"
                  padding="$3"
                />
                {errors.city && (
                  <Text fontSize="$2" color="$red10">
                    {errors.city}
                  </Text>
                )}
              </YStack>

              {/* State */}
              <YStack flex={1} gap="$2">
                <Label htmlFor="state" fontSize="$4" color="$color">
                  {t('checkout.billing.state')} *
                </Label>
                <Input
                  id="state"
                  value={formData.billingAddress.state}
                  onChangeText={(text) => handleAddressChange('state', text)}
                  placeholder={t('checkout.billing.statePlaceholder')}
                  backgroundColor="$background"
                  color="$color"
                  borderWidth={1}
                  borderColor={errors.state ? '$red10' : '$borderColor'}
                  borderRadius="$4"
                  padding="$3"
                />
                {errors.state && (
                  <Text fontSize="$2" color="$red10">
                    {errors.state}
                  </Text>
                )}
              </YStack>
            </XStack>

            {/* Postal Code and Country */}
            <XStack gap="$4">
              {/* Postal Code */}
              <YStack flex={1} gap="$2">
                <Label htmlFor="postalCode" fontSize="$4" color="$color">
                  {t('checkout.billing.postalCode')} *
                </Label>
                <Input
                  id="postalCode"
                  value={formData.billingAddress.postalCode}
                  onChangeText={(text) => handleAddressChange('postalCode', text)}
                  placeholder={t('checkout.billing.postalCodePlaceholder')}
                  backgroundColor="$background"
                  color="$color"
                  borderWidth={1}
                  borderColor={errors.postalCode ? '$red10' : '$borderColor'}
                  borderRadius="$4"
                  padding="$3"
                />
                {errors.postalCode && (
                  <Text fontSize="$2" color="$red10">
                    {errors.postalCode}
                  </Text>
                )}
              </YStack>

              {/* Country */}
              <YStack flex={1} gap="$2">
                <Label htmlFor="country" fontSize="$4" color="$color">
                  {t('checkout.billing.country')} *
                </Label>
                <Input
                  id="country"
                  value={formData.billingAddress.country}
                  onChangeText={(text) => handleAddressChange('country', text)}
                  backgroundColor="$background"
                  color="$color"
                  borderWidth={1}
                  borderColor="$borderColor"
                  borderRadius="$4"
                  padding="$3"
                  disabled
                />
              </YStack>
            </XStack>
          </YStack>
        </Card>

        {/* Security Notice */}
        <XStack
          backgroundColor="$green2"
          borderWidth={1}
          borderColor="$green6"
          borderRadius="$4"
          padding="$4"
          gap="$3"
          alignItems="flex-start"
        >
          <CheckCircle size="$1" color="$green10" marginTop="$1" />
          <YStack>
            <Text fontSize="$4" fontWeight="bold" color="$green10">
              {t('checkout.security.title')}
            </Text>
            <Text fontSize="$3" color="$green10">
              {t('checkout.security.message')}
            </Text>
          </YStack>
        </XStack>

        {/* Error Alert */}
        {error && (
          <XStack
            backgroundColor="$red2"
            borderWidth={1}
            borderColor="$red6"
            borderRadius="$4"
            padding="$4"
            gap="$3"
            alignItems="center"
          >
            <AlertCircle size="$1" color="$red10" />
            <Text fontSize="$3" color="$red10">
              {error}
            </Text>
          </XStack>
        )}

        {/* Submit Button */}
        <Button
          theme="accent"
          size="$5"
          backgroundColor={isLoading ? "$backgroundHover" : "$blue10"}
          color="white"
          onPress={handleSubmit}
          disabled={isLoading}
          borderRadius="$4"
          width="100%"
        >
          <XStack gap="$2" alignItems="center" justifyContent="center">
            {isLoading ? (
              <>
                <Spinner size="small" color="white" />
                <Text fontSize="$4" fontWeight="bold" color="white">
                  {t('checkout.processing')}
                </Text>
              </>
            ) : (
              <>
                <Lock size="$1" />
                <Text fontSize="$4" fontWeight="bold">
                  {t('checkout.completePayment')}
                </Text>
              </>
            )}
          </XStack>
        </Button>
      </form>
    </YStack>
  );
};

export default CheckoutForm;

