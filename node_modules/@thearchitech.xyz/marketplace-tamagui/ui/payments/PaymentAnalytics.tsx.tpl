/**
 * Payment Analytics Component (Tamagui)
 * 
 * Payment analytics dashboard with i18n support
 */

import React from 'react';
import { YStack, XStack, Card, Text, Badge } from 'tamagui';
import { useTranslation } from '@/lib/i18n';
import { 
  DollarSign, 
  TrendingUp, 
  TrendingDown,
  CreditCard,
  Users,
  ShoppingCart,
  BarChart3,
  PieChart
} from '@tamagui/lucide-icons';

interface PaymentAnalyticsProps {
  analytics: {
    totalRevenue: number;
    revenueChange: number;
    totalTransactions: number;
    transactionsChange: number;
    averageOrderValue: number;
    aovChange: number;
    conversionRate: number;
    conversionChange: number;
    topPaymentMethods: Array<{
      method: string;
      count: number;
      percentage: number;
    }>;
    revenueByPeriod: Array<{
      period: string;
      revenue: number;
      transactions: number;
    }>;
    refunds: {
      total: number;
      percentage: number;
      change: number;
    };
    chargebacks: {
      total: number;
      percentage: number;
      change: number;
    };
  };
  period: 'day' | 'week' | 'month' | 'year';
  onPeriodChange?: (period: string) => void;
}

export function PaymentAnalytics({
  analytics,
  period,
  onPeriodChange,
}: PaymentAnalyticsProps) {
  const { t, formatCurrency } = useTranslation();

  const formatPercentage = (value: number): string => {
    return `${value >= 0 ? '+' : ''}${value.toFixed(1)}%`;
  };

  const getChangeIcon = (change: number) => {
    return change >= 0 ? (
      <TrendingUp size="$1" color="$green10" />
    ) : (
      <TrendingDown size="$1" color="$red10" />
    );
  };

  const getChangeColor = (change: number): string => {
    return change >= 0 ? '$green10' : '$red10';
  };

  return (
    <YStack gap="$6">
      {/* Key Metrics */}
      <XStack flexWrap="wrap" gap="$6">
        {/* Total Revenue */}
        <Card
          theme="base"
          size="$4"
          padding="$6"
          backgroundColor="$background"
          borderWidth={1}
          borderColor="$borderColor"
          borderRadius="$6"
          elevation="$2"
          flex={1}
          minWidth={200}
        >
          <XStack alignItems="center">
            <XStack
              padding="$2"
              backgroundColor="$green2"
              borderRadius="$4"
            >
              <DollarSign size="$1" color="$green10" />
            </XStack>
            <YStack marginLeft="$4">
              <Text fontSize="$3" color="$colorFocus">
                {t('analytics.payments.totalRevenue')}
              </Text>
              <Text fontSize="$6" fontWeight="bold" color="$color">
                {formatCurrency(analytics.totalRevenue)}
              </Text>
              <XStack alignItems="center" marginTop="$1">
                {getChangeIcon(analytics.revenueChange)}
                <Text fontSize="$2" marginLeft="$1" color={getChangeColor(analytics.revenueChange)}>
                  {formatPercentage(analytics.revenueChange)}
                </Text>
              </XStack>
            </YStack>
          </XStack>
        </Card>

        {/* Transactions */}
        <Card
          theme="base"
          size="$4"
          padding="$6"
          backgroundColor="$background"
          borderWidth={1}
          borderColor="$borderColor"
          borderRadius="$6"
          elevation="$2"
          flex={1}
          minWidth={200}
        >
          <XStack alignItems="center">
            <XStack
              padding="$2"
              backgroundColor="$blue2"
              borderRadius="$4"
            >
              <CreditCard size="$1" color="$blue10" />
            </XStack>
            <YStack marginLeft="$4">
              <Text fontSize="$3" color="$colorFocus">
                {t('analytics.payments.transactions')}
              </Text>
              <Text fontSize="$6" fontWeight="bold" color="$color">
                {analytics.totalTransactions.toLocaleString()}
              </Text>
              <XStack alignItems="center" marginTop="$1">
                {getChangeIcon(analytics.transactionsChange)}
                <Text fontSize="$2" marginLeft="$1" color={getChangeColor(analytics.transactionsChange)}>
                  {formatPercentage(analytics.transactionsChange)}
                </Text>
              </XStack>
            </YStack>
          </XStack>
        </Card>

        {/* Average Order Value */}
        <Card
          theme="base"
          size="$4"
          padding="$6"
          backgroundColor="$background"
          borderWidth={1}
          borderColor="$borderColor"
          borderRadius="$6"
          elevation="$2"
          flex={1}
          minWidth={200}
        >
          <XStack alignItems="center">
            <XStack
              padding="$2"
              backgroundColor="$purple2"
              borderRadius="$4"
            >
              <ShoppingCart size="$1" color="$purple10" />
            </XStack>
            <YStack marginLeft="$4">
              <Text fontSize="$3" color="$colorFocus">
                {t('analytics.payments.avgOrderValue')}
              </Text>
              <Text fontSize="$6" fontWeight="bold" color="$color">
                {formatCurrency(analytics.averageOrderValue)}
              </Text>
              <XStack alignItems="center" marginTop="$1">
                {getChangeIcon(analytics.aovChange)}
                <Text fontSize="$2" marginLeft="$1" color={getChangeColor(analytics.aovChange)}>
                  {formatPercentage(analytics.aovChange)}
                </Text>
              </XStack>
            </YStack>
          </XStack>
        </Card>

        {/* Conversion Rate */}
        <Card
          theme="base"
          size="$4"
          padding="$6"
          backgroundColor="$background"
          borderWidth={1}
          borderColor="$borderColor"
          borderRadius="$6"
          elevation="$2"
          flex={1}
          minWidth={200}
        >
          <XStack alignItems="center">
            <XStack
              padding="$2"
              backgroundColor="$orange2"
              borderRadius="$4"
            >
              <Users size="$1" color="$orange10" />
            </XStack>
            <YStack marginLeft="$4">
              <Text fontSize="$3" color="$colorFocus">
                {t('analytics.payments.conversionRate')}
              </Text>
              <Text fontSize="$6" fontWeight="bold" color="$color">
                {analytics.conversionRate.toFixed(1)}%
              </Text>
              <XStack alignItems="center" marginTop="$1">
                {getChangeIcon(analytics.conversionChange)}
                <Text fontSize="$2" marginLeft="$1" color={getChangeColor(analytics.conversionChange)}>
                  {formatPercentage(analytics.conversionChange)}
                </Text>
              </XStack>
            </YStack>
          </XStack>
        </Card>
      </XStack>

      {/* Payment Methods & Issues */}
      <XStack flexWrap="wrap" gap="$6">
        {/* Top Payment Methods */}
        <Card
          theme="base"
          size="$4"
          padding="$0"
          backgroundColor="$background"
          borderWidth={1}
          borderColor="$borderColor"
          borderRadius="$6"
          elevation="$2"
          flex={1}
          minWidth={300}
        >
          <YStack padding="$6" paddingBottom="$2">
            <XStack gap="$2" alignItems="center">
              <PieChart size="$1" color="$color" />
              <Text fontSize="$5" fontWeight="bold" color="$color">
                {t('analytics.payments.methods.title')}
              </Text>
            </XStack>
            <Text fontSize="$3" color="$colorFocus">
              {t('analytics.payments.methods.description')}
            </Text>
          </YStack>
          
          <YStack padding="$6" paddingTop="$0" gap="$4">
            {analytics.topPaymentMethods.map((method, index) => (
              <XStack key={index} justifyContent="space-between" alignItems="center">
                <XStack gap="$3" alignItems="center">
                  <YStack width="$1" height="$1" borderRadius="$full" backgroundColor="$blue10" />
                  <Text fontSize="$3" fontWeight="medium" color="$color">
                    {method.method}
                  </Text>
                </XStack>
                <YStack alignItems="flex-end">
                  <Text fontSize="$3" fontWeight="bold" color="$color">
                    {method.count.toLocaleString()}
                  </Text>
                  <Text fontSize="$2" color="$colorFocus">
                    {method.percentage.toFixed(1)}%
                  </Text>
                </YStack>
              </XStack>
            ))}
          </YStack>
        </Card>

        {/* Refunds & Chargebacks */}
        <Card
          theme="base"
          size="$4"
          padding="$0"
          backgroundColor="$background"
          borderWidth={1}
          borderColor="$borderColor"
          borderRadius="$6"
          elevation="$2"
          flex={1}
          minWidth={300}
        >
          <YStack padding="$6" paddingBottom="$2">
            <XStack gap="$2" alignItems="center">
              <BarChart3 size="$1" color="$color" />
              <Text fontSize="$5" fontWeight="bold" color="$color">
                {t('analytics.payments.issues.title')}
              </Text>
            </XStack>
            <Text fontSize="$3" color="$colorFocus">
              {t('analytics.payments.issues.description')}
            </Text>
          </YStack>
          
          <YStack padding="$6" paddingTop="$0" gap="$4">
            {/* Refunds */}
            <XStack 
              justifyContent="space-between" 
              alignItems="center"
              padding="$3"
              backgroundColor="$red2"
              borderRadius="$4"
            >
              <YStack>
                <Text fontSize="$3" fontWeight="medium" color="$red10">
                  {t('analytics.payments.issues.refunds')}
                </Text>
                <Text fontSize="$2" color="$red9">
                  {t('analytics.payments.issues.transactions', { count: analytics.refunds.total.toLocaleString() })}
                </Text>
              </YStack>
              <YStack alignItems="flex-end">
                <Text fontSize="$5" fontWeight="bold" color="$red10">
                  {analytics.refunds.percentage.toFixed(1)}%
                </Text>
                <XStack alignItems="center">
                  {getChangeIcon(analytics.refunds.change)}
                  <Text fontSize="$2" marginLeft="$1" color={getChangeColor(analytics.refunds.change)}>
                    {formatPercentage(analytics.refunds.change)}
                  </Text>
                </XStack>
              </YStack>
            </XStack>

            {/* Chargebacks */}
            <XStack 
              justifyContent="space-between" 
              alignItems="center"
              padding="$3"
              backgroundColor="$orange2"
              borderRadius="$4"
            >
              <YStack>
                <Text fontSize="$3" fontWeight="medium" color="$orange10">
                  {t('analytics.payments.issues.chargebacks')}
                </Text>
                <Text fontSize="$2" color="$orange9">
                  {t('analytics.payments.issues.transactions', { count: analytics.chargebacks.total.toLocaleString() })}
                </Text>
              </YStack>
              <YStack alignItems="flex-end">
                <Text fontSize="$5" fontWeight="bold" color="$orange10">
                  {analytics.chargebacks.percentage.toFixed(1)}%
                </Text>
                <XStack alignItems="center">
                  {getChangeIcon(analytics.chargebacks.change)}
                  <Text fontSize="$2" marginLeft="$1" color={getChangeColor(analytics.chargebacks.change)}>
                    {formatPercentage(analytics.chargebacks.change)}
                  </Text>
                </XStack>
              </YStack>
            </XStack>
          </YStack>
        </Card>
      </XStack>

      {/* Revenue by Period */}
      <Card
        theme="base"
        size="$4"
        padding="$0"
        backgroundColor="$background"
        borderWidth={1}
        borderColor="$borderColor"
        borderRadius="$6"
        elevation="$2"
      >
        <YStack padding="$6" paddingBottom="$2">
          <Text fontSize="$5" fontWeight="bold" color="$color">
            {t('analytics.payments.revenue.title', { period })}
          </Text>
          <Text fontSize="$3" color="$colorFocus">
            {t('analytics.payments.revenue.description')}
          </Text>
        </YStack>
        
        <YStack padding="$6" paddingTop="$0" gap="$4">
          {analytics.revenueByPeriod.map((item, index) => (
            <XStack 
              key={index}
              justifyContent="space-between" 
              alignItems="center"
              padding="$3"
              borderWidth={1}
              borderColor="$borderColor"
              borderRadius="$4"
            >
              <YStack>
                <Text fontSize="$3" fontWeight="medium" color="$color">
                  {item.period}
                </Text>
                <Text fontSize="$2" color="$colorFocus">
                  {t('analytics.payments.revenue.transactions', { count: item.transactions.toLocaleString() })}
                </Text>
              </YStack>
              <YStack alignItems="flex-end">
                <Text fontSize="$5" fontWeight="bold" color="$color">
                  {formatCurrency(item.revenue)}
                </Text>
              </YStack>
            </XStack>
          ))}
        </YStack>
      </Card>
    </YStack>
  );
}

export default PaymentAnalytics;

