/**
 * PaymentForm Component (Tamagui)
 * 
 * Payment form using Tamagui UI with i18n integration
 */

import React, { useState } from 'react';
import { YStack, XStack, Button, Input, Text, Label, Card, Select, Adapt, Sheet } from 'tamagui';
import { useTranslation } from '@/lib/i18n';
import { useToast } from '@/hooks/use-toast';
import { paymentService } from '@/services/PaymentService';
import { CreatePaymentData, Currency, PaymentMethod } from '@/features/payments/contract';

interface PaymentFormProps {
  onSuccess?: (payment: any) => void;
  onError?: (error: Error) => void;
}

export function PaymentForm({ onSuccess, onError }: PaymentFormProps) {
  const { t } = useTranslation();
  const { toast } = useToast();
  
  const [formData, setFormData] = useState<CreatePaymentData>({
    amount: 0,
    currency: 'USD',
    method: 'card',
    description: '',
    customerId: '',
    saveCard: false
  });

  // Use the cohesive PaymentService
  const { create, list } = paymentService.usePayments();
  const { list: paymentMethods } = paymentService.usePaymentMethods();

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    try {
      const result = await create.mutateAsync(formData);
      
      toast({
        title: t('payment.success.title'),
        description: t('payment.success.description'),
      });
      
      onSuccess?.(result);
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : t('payment.error.unknown');
      
      toast({
        title: t('payment.error.title'),
        description: errorMessage,
        variant: "destructive",
      });
      
      onError?.(error as Error);
    }
  };

  const handleInputChange = (field: keyof CreatePaymentData, value: any) => {
    setFormData(prev => ({
      ...prev,
      [field]: value
    }));
  };

  return (
    <Card
      theme="base"
      size="$4"
      padding="$6"
      backgroundColor="$background"
      borderWidth={1}
      borderColor="$borderColor"
      borderRadius="$6"
      elevation="$2"
    >
      <YStack gap="$4">
        {/* Header */}
        <YStack gap="$2">
          <Text fontSize="$7" fontWeight="bold" color="$color">
            {t('payment.form.title')}
          </Text>
          <Text fontSize="$4" color="$colorFocus">
            {t('payment.form.description')}
          </Text>
        </YStack>

        {/* Form */}
        <YStack asChild gap="$4">
          <form onSubmit={handleSubmit}>
            {/* Amount */}
            <YStack gap="$2">
              <Label htmlFor="amount" fontSize="$4" color="$color">
                {t('payment.form.amount')}
              </Label>
              <Input
                id="amount"
                type="number"
                step="0.01"
                min="0"
                value={formData.amount.toString()}
                onChangeText={(text) => handleInputChange('amount', parseFloat(text))}
                placeholder={t('payment.form.amountPlaceholder')}
                backgroundColor="$background"
                color="$color"
                borderWidth={1}
                borderColor="$borderColor"
                borderRadius="$4"
                padding="$3"
              />
            </YStack>

            {/* Currency */}
            <YStack gap="$2">
              <Label htmlFor="currency" fontSize="$4" color="$color">
                {t('payment.form.currency')}
              </Label>
              <Select
                value={formData.currency}
                onValueChange={(value: Currency) => handleInputChange('currency', value)}
              >
                <Select.Trigger
                  backgroundColor="$background"
                  borderColor="$borderColor"
                  borderRadius="$4"
                >
                  <Select.Value placeholder={t('payment.form.currencyPlaceholder')} />
                </Select.Trigger>

                <Adapt when="sm" platform="touch">
                  <Sheet
                    native
                    modal
                    dismissOnSnapToBottom
                    snapPointsMode="fit"
                  >
                    <Sheet.Frame>
                      <Sheet.ScrollView>
                        <Adapt.Contents />
                      </Sheet.ScrollView>
                    </Sheet.Frame>
                    <Sheet.Overlay />
                  </Sheet>
                </Adapt>

                <Select.Content zIndex={200000}>
                  <Select.ScrollUpButton />
                  <Select.Viewport minHeight={200}>
                    <Select.Group>
                      <Select.Label>{t('payment.form.currencyLabel')}</Select.Label>
                      {['USD', 'EUR', 'GBP', 'CAD', 'AUD', 'JPY', 'CHF'].map((currency) => (
                        <Select.Item index={0} key={currency} value={currency}>
                          <Select.ItemText>{currency}</Select.ItemText>
                        </Select.Item>
                      ))}
                    </Select.Group>
                  </Select.Viewport>
                  <Select.ScrollDownButton />
                </Select.Content>
              </Select>
            </YStack>

            {/* Description */}
            <YStack gap="$2">
              <Label htmlFor="description" fontSize="$4" color="$color">
                {t('payment.form.description')}
              </Label>
              <Input
                id="description"
                value={formData.description}
                onChangeText={(text) => handleInputChange('description', text)}
                placeholder={t('payment.form.descriptionPlaceholder')}
                backgroundColor="$background"
                color="$color"
                borderWidth={1}
                borderColor="$borderColor"
                borderRadius="$4"
                padding="$3"
              />
            </YStack>

            {/* Submit Button */}
            <Button
              theme="accent"
              size="$4"
              backgroundColor={create.isPending ? "$backgroundHover" : "$background"}
              color="$color"
              onPress={handleSubmit}
              disabled={create.isPending}
              borderWidth={1}
              borderColor="$borderColor"
              borderRadius="$4"
            >
              <Text fontSize="$4" fontWeight="bold">
                {create.isPending ? t('payment.form.processing') : t('payment.form.submit')}
              </Text>
            </Button>
          </form>
        </YStack>

        {/* Display recent payments */}
        {list.data && list.data.length > 0 && (
          <YStack gap="$2">
            <Text fontSize="$5" fontWeight="bold" color="$color">
              {t('payment.recent')}
            </Text>
            <YStack gap="$1">
              {list.data.slice(0, 3).map((payment) => (
                <XStack key={payment.id} gap="$2">
                  <Text fontSize="$3" color="$colorFocus">
                    {payment.amount} {payment.currency} - {payment.status}
                  </Text>
                </XStack>
              ))}
            </YStack>
          </YStack>
        )}
      </YStack>
    </Card>
  );
}

export default PaymentForm;

