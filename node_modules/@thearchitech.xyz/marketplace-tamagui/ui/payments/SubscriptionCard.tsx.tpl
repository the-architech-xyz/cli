/**
 * Subscription Card Component (Tamagui)
 * 
 * Displays subscription details with i18n support
 */

import React from 'react';
import { YStack, XStack, Card, Text, Button, Separator, Badge } from 'tamagui';
import { useTranslation } from '@/lib/i18n';
import { 
  CreditCard, 
  Calendar,
  User,
  Settings,
  Play,
  Pause,
  X,
  CheckCircle,
  Clock,
  AlertCircle,
  XCircle,
  DollarSign
} from '@tamagui/lucide-icons';

interface SubscriptionCardProps {
  subscription: {
    id: string;
    status: 'active' | 'paused' | 'cancelled' | 'past_due' | 'trialing';
    planName: string;
    planDescription?: string;
    amount: number;
    currency: string;
    interval: 'month' | 'year' | 'week' | 'day';
    customerName: string;
    customerEmail: string;
    createdAt: string;
    currentPeriodStart: string;
    currentPeriodEnd: string;
    nextBillingDate?: string;
    trialEnd?: string;
    cancelAtPeriodEnd: boolean;
    cancelledAt?: string;
    metadata?: Record<string, any>;
  };
  onManage?: (subscription: any) => void;
  onCancel?: (subscription: any) => void;
  onPause?: (subscription: any) => void;
  onResume?: (subscription: any) => void;
}

export const SubscriptionCard: React.FC<SubscriptionCardProps> = ({
  subscription,
  onManage,
  onCancel,
  onPause,
  onResume,
}) => {
  const { t, formatDate, formatCurrency } = useTranslation();

  const getStatusBadge = (status: string) => {
    const statusConfig = {
      active: { 
        color: '$green10',
        textColor: 'white',
        icon: CheckCircle,
        label: t('subscription.status.active')
      },
      paused: { 
        color: '$yellow10',
        textColor: 'black',
        icon: Pause,
        label: t('subscription.status.paused')
      },
      cancelled: { 
        color: '$red10',
        textColor: 'white',
        icon: XCircle,
        label: t('subscription.status.cancelled')
      },
      past_due: { 
        color: '$orange10',
        textColor: 'white',
        icon: AlertCircle,
        label: t('subscription.status.pastDue')
      },
      trialing: { 
        color: '$blue10',
        textColor: 'white',
        icon: Clock,
        label: t('subscription.status.trial')
      },
    };

    const config = statusConfig[status as keyof typeof statusConfig] || statusConfig.active;
    const Icon = config.icon;

    return (
      <Badge
        backgroundColor={config.color}
        color={config.textColor}
        borderRadius="$4"
        size="$3"
      >
        <XStack gap="$1" alignItems="center">
          <Icon size="$1" />
          <Text fontSize="$2" fontWeight="bold">
            {config.label}
          </Text>
        </XStack>
      </Badge>
    );
  };

  const getIntervalText = (interval: string) => {
    return t(`subscription.interval.${interval}`);
  };

  const isTrialActive = subscription.status === 'trialing' && subscription.trialEnd && new Date(subscription.trialEnd) > new Date();
  const isCancelling = subscription.cancelAtPeriodEnd;

  return (
    <Card
      theme="base"
      size="$4"
      padding="$0"
      backgroundColor="$background"
      borderWidth={1}
      borderColor="$borderColor"
      borderRadius="$6"
      elevation="$2"
      width="100%"
    >
      {/* Header */}
      <YStack padding="$6" paddingBottom="$4">
        <XStack justifyContent="space-between" alignItems="center">
          <YStack gap="$1">
            <XStack gap="$2" alignItems="center">
              <CreditCard size="$1" color="$color" />
              <Text fontSize="$6" fontWeight="bold" color="$color">
                {subscription.planName}
              </Text>
            </XStack>
            <Text fontSize="$3" color="$colorFocus">
              {subscription.planDescription || t('subscription.interval.description', { interval: getIntervalText(subscription.interval) })}
            </Text>
          </YStack>
          {getStatusBadge(subscription.status)}
        </XStack>
      </YStack>

      {/* Content */}
      <YStack padding="$6" paddingTop="$0" gap="$6">
        {/* Customer Information */}
        <YStack gap="$3">
          <XStack gap="$2" alignItems="center">
            <User size="$1" color="$color" />
            <Text fontSize="$5" fontWeight="bold" color="$color">
              {t('subscription.customer.title')}
            </Text>
          </XStack>
          <YStack gap="$1">
            <Text fontSize="$4" fontWeight="medium" color="$color">
              {subscription.customerName}
            </Text>
            <Text fontSize="$3" color="$colorFocus">
              {subscription.customerEmail}
            </Text>
          </YStack>
        </YStack>

        <Separator borderColor="$borderColor" />

        {/* Subscription Details */}
        <XStack flexWrap="wrap" gap="$6">
          {/* Billing Column */}
          <YStack flex={1} minWidth={180} gap="$3">
            <XStack gap="$2" alignItems="center">
              <DollarSign size="$1" color="$color" />
              <Text fontSize="$5" fontWeight="bold" color="$color">
                {t('subscription.billing.title')}
              </Text>
            </XStack>
            <YStack gap="$2">
              <XStack justifyContent="space-between">
                <Text fontSize="$3" color="$colorFocus">
                  {t('subscription.billing.amount')}:
                </Text>
                <Text fontSize="$3" fontWeight="medium" color="$color">
                  {formatCurrency(subscription.amount, subscription.currency)}
                </Text>
              </XStack>
              <XStack justifyContent="space-between">
                <Text fontSize="$3" color="$colorFocus">
                  {t('subscription.billing.interval')}:
                </Text>
                <Text fontSize="$3" color="$color">
                  {getIntervalText(subscription.interval)}
                </Text>
              </XStack>
              {subscription.nextBillingDate && (
                <XStack justifyContent="space-between">
                  <Text fontSize="$3" color="$colorFocus">
                    {t('subscription.billing.nextBilling')}:
                  </Text>
                  <Text fontSize="$3" color="$color">
                    {formatDate(subscription.nextBillingDate)}
                  </Text>
                </XStack>
              )}
            </YStack>
          </YStack>

          {/* Period Column */}
          <YStack flex={1} minWidth={180} gap="$3">
            <XStack gap="$2" alignItems="center">
              <Calendar size="$1" color="$color" />
              <Text fontSize="$5" fontWeight="bold" color="$color">
                {t('subscription.period.title')}
              </Text>
            </XStack>
            <YStack gap="$2">
              <XStack justifyContent="space-between">
                <Text fontSize="$3" color="$colorFocus">
                  {t('subscription.period.current')}:
                </Text>
                <Text fontSize="$3" color="$color">
                  {formatDate(subscription.currentPeriodStart)} - {formatDate(subscription.currentPeriodEnd)}
                </Text>
              </XStack>
              <XStack justifyContent="space-between">
                <Text fontSize="$3" color="$colorFocus">
                  {t('subscription.period.created')}:
                </Text>
                <Text fontSize="$3" color="$color">
                  {formatDate(subscription.createdAt)}
                </Text>
              </XStack>
              {subscription.cancelledAt && (
                <XStack justifyContent="space-between">
                  <Text fontSize="$3" color="$colorFocus">
                    {t('subscription.period.cancelled')}:
                  </Text>
                  <Text fontSize="$3" color="$color">
                    {formatDate(subscription.cancelledAt)}
                  </Text>
                </XStack>
              )}
            </YStack>
          </YStack>
        </XStack>

        {/* Trial Information */}
        {isTrialActive && subscription.trialEnd && (
          <>
            <Separator borderColor="$borderColor" />
            <YStack
              backgroundColor="$blue2"
              borderWidth={1}
              borderColor="$blue6"
              borderRadius="$4"
              padding="$4"
              gap="$2"
            >
              <XStack gap="$2" alignItems="center">
                <Clock size="$1" color="$blue10" />
                <Text fontSize="$4" fontWeight="bold" color="$blue10">
                  {t('subscription.trial.title')}
                </Text>
              </XStack>
              <Text fontSize="$3" color="$blue10">
                {t('subscription.trial.endsOn', { date: formatDate(subscription.trialEnd) })}
              </Text>
            </YStack>
          </>
        )}

        {/* Cancellation Notice */}
        {isCancelling && (
          <>
            <Separator borderColor="$borderColor" />
            <YStack
              backgroundColor="$orange2"
              borderWidth={1}
              borderColor="$orange6"
              borderRadius="$4"
              padding="$4"
              gap="$2"
            >
              <XStack gap="$2" alignItems="center">
                <AlertCircle size="$1" color="$orange10" />
                <Text fontSize="$4" fontWeight="bold" color="$orange10">
                  {t('subscription.cancellation.title')}
                </Text>
              </XStack>
              <Text fontSize="$3" color="$orange10">
                {t('subscription.cancellation.message')}
              </Text>
            </YStack>
          </>
        )}

        {/* Metadata */}
        {subscription.metadata && Object.keys(subscription.metadata).length > 0 && (
          <>
            <Separator borderColor="$borderColor" />
            <YStack gap="$3">
              <Text fontSize="$5" fontWeight="bold" color="$color">
                {t('subscription.metadata.title')}
              </Text>
              <YStack gap="$2">
                {Object.entries(subscription.metadata).map(([key, value]) => (
                  <XStack key={key} justifyContent="space-between">
                    <Text fontSize="$3" color="$colorFocus" textTransform="capitalize">
                      {key.replace(/_/g, ' ')}:
                    </Text>
                    <Text fontSize="$3" color="$color">
                      {String(value)}
                    </Text>
                  </XStack>
                ))}
              </YStack>
            </YStack>
          </>
        )}

        {/* Actions */}
        <XStack flexWrap="wrap" gap="$2" paddingTop="$2">
          <Button
            size="$3"
            backgroundColor="$backgroundHover"
            color="$color"
            borderWidth={1}
            borderColor="$borderColor"
            borderRadius="$4"
            onPress={() => onManage?.(subscription)}
          >
            <XStack gap="$1" alignItems="center">
              <Settings size="$1" />
              <Text>{t('subscription.actions.manage')}</Text>
            </XStack>
          </Button>
          
          {subscription.status === 'active' && !isCancelling && (
            <>
              <Button
                size="$3"
                backgroundColor="$backgroundHover"
                color="$color"
                borderWidth={1}
                borderColor="$borderColor"
                borderRadius="$4"
                onPress={() => onPause?.(subscription)}
              >
                <XStack gap="$1" alignItems="center">
                  <Pause size="$1" />
                  <Text>{t('subscription.actions.pause')}</Text>
                </XStack>
              </Button>
              
              <Button
                size="$3"
                backgroundColor="$backgroundHover"
                color="$red10"
                borderWidth={1}
                borderColor="$red6"
                borderRadius="$4"
                onPress={() => onCancel?.(subscription)}
              >
                <XStack gap="$1" alignItems="center">
                  <X size="$1" />
                  <Text>{t('subscription.actions.cancel')}</Text>
                </XStack>
              </Button>
            </>
          )}
          
          {subscription.status === 'paused' && (
            <Button
              size="$3"
              backgroundColor="$blue10"
              color="white"
              borderRadius="$4"
              onPress={() => onResume?.(subscription)}
            >
              <XStack gap="$1" alignItems="center">
                <Play size="$1" />
                <Text>{t('subscription.actions.resume')}</Text>
              </XStack>
            </Button>
          )}
        </XStack>
      </YStack>
    </Card>
  );
};

export default SubscriptionCard;

