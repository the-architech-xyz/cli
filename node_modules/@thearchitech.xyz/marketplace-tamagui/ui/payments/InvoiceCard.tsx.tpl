// Invoice Card Component for Tamagui

import React from 'react';
import { YStack, XStack, Button, Text, Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent, Badge, Separator, Theme, Square } from '@tamagui/core';
import { useTranslation } from '@/lib/i18n/client';
import { 
  Download, 
  Mail, 
  Calendar,
  User,
  MapPin,
  FileText,
  CheckCircle,
  Clock,
  AlertCircle,
  XCircle
} from '@tamagui/lucide-icons';

interface InvoiceCardProps {
  invoice: {
    id: string;
    invoiceNumber: string;
    status: 'paid' | 'pending' | 'overdue' | 'cancelled';
    amount: number;
    currency: string;
    customerName: string;
    customerEmail: string;
    customerAddress?: {
      line1: string;
      line2?: string;
      city: string;
      state: string;
      postalCode: string;
      country: string;
    };
    items: Array<{
      id: string;
      name: string;
      description?: string;
      quantity: number;
      unitPrice: number;
      total: number;
    }>;
    subtotal: number;
    tax: number;
    total: number;
    createdAt: string;
    dueDate: string;
    paidAt?: string;
    notes?: string;
  };
  onDownload?: (invoice: any) => void;
  onSendEmail?: (invoice: any) => void;
  onMarkPaid?: (invoice: any) => void;
  className?: string;
}

export const InvoiceCard: React.FC<InvoiceCardProps> = ({
  invoice,
  onDownload,
  onSendEmail,
  onMarkPaid,
}) => {
  const { t } = useTranslation();

  const getStatusBadge = (status: string) => {
    const statusConfig = {
      paid: { 
        color: '$green10', 
        bgColor: '$green3',
        icon: CheckCircle,
        label: t('payments.status.paid')
      },
      pending: { 
        color: '$yellow10', 
        bgColor: '$yellow3',
        icon: Clock,
        label: t('payments.status.pending')
      },
      overdue: { 
        color: '$red10', 
        bgColor: '$red3',
        icon: AlertCircle,
        label: t('payments.status.overdue')
      },
      cancelled: { 
        color: '$gray10', 
        bgColor: '$gray3',
        icon: XCircle,
        label: t('payments.status.cancelled')
      },
    };

    const config = statusConfig[status as keyof typeof statusConfig] || statusConfig.pending;
    const Icon = config.icon;

    return (
      <Badge size="$2" backgroundColor={config.bgColor}>
        <XStack gap="$1" alignItems="center">
          <Icon size={12} color={config.color} />
          <Text color={config.color} fontSize="$1">{config.label}</Text>
        </XStack>
      </Badge>
    );
  };

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    });
  };

  const formatCurrency = (amount: number, currency: string = 'USD') => {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: currency,
    }).format(amount);
  };

  return (
    <Card width="100%" overflow="hidden">
      <CardHeader>
        <XStack justifyContent="space-between" alignItems="center">
          <YStack>
            <XStack space="$2" alignItems="center">
              <FileText size={18} />
              <CardTitle>{t('payments.invoice.title', { number: invoice.invoiceNumber })}</CardTitle>
            </XStack>
            <CardDescription>
              {t('payments.invoice.created', { date: formatDate(invoice.createdAt) })}
            </CardDescription>
          </YStack>
          {getStatusBadge(invoice.status)}
        </XStack>
      </CardHeader>

      <CardContent>
        <YStack space="$6">
          {/* Customer Information */}
          <XStack $gtSm={{ flexDirection: 'row' }} flexDirection="column" gap="$6">
            <YStack flex={1}>
              <XStack space="$2" alignItems="center" marginBottom="$3">
                <User size={16} />
                <Text fontWeight="bold">{t('payments.invoice.billTo')}</Text>
              </XStack>
              <YStack space="$1">
                <Text fontWeight="500">{invoice.customerName}</Text>
                <Text fontSize="$2" color="$gray10">{invoice.customerEmail}</Text>
                {invoice.customerAddress && (
                  <YStack fontSize="$2" color="$gray10">
                    <Text>{invoice.customerAddress.line1}</Text>
                    {invoice.customerAddress.line2 && <Text>{invoice.customerAddress.line2}</Text>}
                    <Text>
                      {invoice.customerAddress.city}, {invoice.customerAddress.state} {invoice.customerAddress.postalCode}
                    </Text>
                    <Text>{invoice.customerAddress.country}</Text>
                  </YStack>
                )}
              </YStack>
            </YStack>

            <YStack flex={1}>
              <XStack space="$2" alignItems="center" marginBottom="$3">
                <Calendar size={16} />
                <Text fontWeight="bold">{t('payments.invoice.details')}</Text>
              </XStack>
              <YStack space="$2">
                <XStack justifyContent="space-between">
                  <Text fontSize="$2" color="$gray10">{t('payments.invoice.invoiceDate')}:</Text>
                  <Text fontSize="$2">{formatDate(invoice.createdAt)}</Text>
                </XStack>
                <XStack justifyContent="space-between">
                  <Text fontSize="$2" color="$gray10">{t('payments.invoice.dueDate')}:</Text>
                  <Text fontSize="$2">{formatDate(invoice.dueDate)}</Text>
                </XStack>
                {invoice.paidAt && (
                  <XStack justifyContent="space-between">
                    <Text fontSize="$2" color="$gray10">{t('payments.invoice.paidDate')}:</Text>
                    <Text fontSize="$2">{formatDate(invoice.paidAt)}</Text>
                  </XStack>
                )}
              </YStack>
            </YStack>
          </XStack>

          <Separator />

          {/* Invoice Items */}
          <YStack>
            <Text fontWeight="bold" marginBottom="$3">{t('payments.invoice.items')}</Text>
            <YStack space="$3">
              {invoice.items.map((item) => (
                <XStack key={item.id} justifyContent="space-between" alignItems="flex-start">
                  <YStack flex={1}>
                    <Text fontWeight="500">{item.name}</Text>
                    {item.description && (
                      <Text fontSize="$2" color="$gray10">{item.description}</Text>
                    )}
                    <Text fontSize="$2" color="$gray10">
                      {item.quantity} Ã— {formatCurrency(item.unitPrice, invoice.currency)}
                    </Text>
                  </YStack>
                  <Text fontWeight="500">
                    {formatCurrency(item.total, invoice.currency)}
                  </Text>
                </XStack>
              ))}
            </YStack>
          </YStack>

          <Separator />

          {/* Invoice Totals */}
          <YStack space="$2">
            <XStack justifyContent="space-between">
              <Text fontSize="$2" color="$gray10">{t('payments.invoice.subtotal')}:</Text>
              <Text fontSize="$2">{formatCurrency(invoice.subtotal, invoice.currency)}</Text>
            </XStack>
            <XStack justifyContent="space-between">
              <Text fontSize="$2" color="$gray10">{t('payments.invoice.tax')}:</Text>
              <Text fontSize="$2">{formatCurrency(invoice.tax, invoice.currency)}</Text>
            </XStack>
            <Separator />
            <XStack justifyContent="space-between">
              <Text fontSize="$5" fontWeight="bold">{t('payments.invoice.total')}:</Text>
              <Text fontSize="$5" fontWeight="bold">{formatCurrency(invoice.total, invoice.currency)}</Text>
            </XStack>
          </YStack>

          {/* Notes */}
          {invoice.notes && (
            <>
              <Separator />
              <YStack>
                <Text fontWeight="bold" marginBottom="$2">{t('payments.invoice.notes')}</Text>
                <Text fontSize="$2" color="$gray10">{invoice.notes}</Text>
              </YStack>
            </>
          )}

          {/* Actions */}
          <XStack flexWrap="wrap" gap="$2" marginTop="$4">
            <Button 
              size="$2" 
              variant="outlined"
              onPress={() => onDownload?.(invoice)}
              icon={<Download size={16} />}
            >
              {t('payments.invoice.downloadPdf')}
            </Button>
            
            <Button 
              size="$2" 
              variant="outlined"
              onPress={() => onSendEmail?.(invoice)}
              icon={<Mail size={16} />}
            >
              {t('payments.invoice.sendEmail')}
            </Button>
            
            {invoice.status === 'pending' && (
              <Button 
                size="$2"
                theme="active"
                onPress={() => onMarkPaid?.(invoice)}
                icon={<CheckCircle size={16} />}
              >
                {t('payments.invoice.markAsPaid')}
              </Button>
            )}
          </XStack>
        </YStack>
      </CardContent>
    </Card>
  );
};
