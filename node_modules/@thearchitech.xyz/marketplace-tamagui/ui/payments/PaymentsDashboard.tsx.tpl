'use client';

import { useState } from 'react';
import { 
  YStack, 
  XStack, 
  Button, 
  Text,
  Card,
  CardHeader,
  CardContent,
  Badge,
  Input,
  Tabs,
  TabsContent,
  TabsList,
  TabsTrigger,
  Select,
  DropdownMenu,
  Theme,
  Square,
  AnimatePresence
} from 'tamagui';
import { 
  CreditCard, 
  TrendingUp, 
  DollarSign, 
  Users, 
  Calendar,
  Filter,
  Download,
  Plus,
  Search,
  MoreHorizontal,
  ArrowUpRight,
  ArrowDownRight,
  Eye,
  Edit,
  Trash2
} from 'lucide-react-native';
import { PaymentAnalytics } from '@/components/payments/PaymentAnalytics';
import { TransactionTable } from '@/components/payments/TransactionTable';
import { PaymentStatus } from '@/components/payments/PaymentStatus';
import { usePaymentsList as usePayments } from '@/lib/payments';
import { useSubscriptionsList as useSubscriptions } from '@/lib/payments';
import { useInvoicesList as useInvoices } from '@/lib/payments';
import { useTranslation } from '@/lib/i18n';

export default function PaymentsDashboard() {
  const { t } = useTranslation();
  const [searchTerm, setSearchTerm] = useState('');
  const [statusFilter, setStatusFilter] = useState('all');
  const [dateRange, setDateRange] = useState('30d');
  
  const { data: payments, isLoading: paymentsLoading } = usePayments();
  const { data: subscriptions, isLoading: subscriptionsLoading } = useSubscriptions();
  const { data: invoices, isLoading: invoicesLoading } = useInvoices();

  // Mock data for demonstration
  const stats = {
    totalRevenue: 125430.50,
    monthlyRevenue: 28450.75,
    totalTransactions: 1247,
    activeSubscriptions: 89,
    revenueGrowth: 12.5,
    transactionGrowth: 8.3,
    subscriptionGrowth: 15.2,
    invoiceGrowth: -2.1
  };

  const recentTransactions = [
    {
      id: 'tx_001',
      amount: 299.99,
      currency: 'USD',
      status: 'completed',
      customer: 'John Doe',
      description: 'Premium Plan Subscription',
      date: '2024-01-15T10:30:00Z',
      method: 'card'
    },
    {
      id: 'tx_002',
      amount: 149.99,
      currency: 'USD',
      status: 'pending',
      customer: 'Jane Smith',
      description: 'Pro Plan Subscription',
      date: '2024-01-15T09:15:00Z',
      method: 'bank_transfer'
    },
    {
      id: 'tx_003',
      amount: 99.99,
      currency: 'USD',
      status: 'failed',
      customer: 'Bob Johnson',
      description: 'Basic Plan Subscription',
      date: '2024-01-14T16:45:00Z',
      method: 'card'
    }
  ];

  const recentInvoices = [
    {
      id: 'inv_001',
      amount: 299.99,
      currency: 'USD',
      status: 'paid',
      customer: 'John Doe',
      dueDate: '2024-01-15',
      paidDate: '2024-01-15'
    },
    {
      id: 'inv_002',
      amount: 149.99,
      currency: 'USD',
      status: 'pending',
      customer: 'Jane Smith',
      dueDate: '2024-01-20',
      paidDate: null
    }
  ];

  return (
    <YStack space="$8" padding="$6">
      {/* Header */}
      <XStack alignItems="center" justifyContent="space-between">
        <YStack>
          <Text fontSize="$7" fontWeight="$8" color="$gray12">
            {t('payments.dashboard.title')}
          </Text>
          <Text fontSize="$3" color="$gray10" marginTop="$1">
            {t('payments.dashboard.subtitle')}
          </Text>
        </YStack>
        <XStack alignItems="center" gap="$3">
          <Button chromeless bordered size="$3">
            <Download size={16} />
            <Text marginLeft="$2">{t('common.actions.export')}</Text>
          </Button>
          <Button theme="accent" size="$3">
            <Plus size={16} />
            <Text marginLeft="$2">{t('payments.dashboard.newPayment')}</Text>
          </Button>
        </XStack>
      </XStack>

      {/* Stats Cards */}
      <XStack flexWrap="wrap" gap="$6">
        <AnimatePresence>
          <Card
            elevate
            bordered={false}
            flex={1}
            minWidth={220}
            animation="bouncy"
            enterStyle={{ opacity: 0, y: 20 }}
            exitStyle={{ opacity: 0, y: -20 }}
            backgroundColor="$blue10"
            padding="$0"
          >
            <CardHeader paddingHorizontal="$4" paddingTop="$4" paddingBottom="$2">
              <XStack alignItems="center" justifyContent="space-between">
                <Text fontSize="$2" fontWeight="$5" color="white">
                  {t('payments.dashboard.stats.totalRevenue')}
                </Text>
                <DollarSign size={16} color="white" opacity={0.8} />
              </XStack>
            </CardHeader>
            <CardContent paddingHorizontal="$4" paddingBottom="$4">
              <Text fontSize="$6" fontWeight="$8" color="white">
                ${stats.totalRevenue.toLocaleString()}
              </Text>
              <XStack alignItems="center" color="white" opacity={0.8}>
                <ArrowUpRight size={12} color="white" />
                <Text fontSize="$1" color="white" marginLeft="$1">
                  +{stats.revenueGrowth}% {t('payments.dashboard.stats.fromLastMonth')}
                </Text>
              </XStack>
            </CardContent>
          </Card>

          <Card
            elevate
            bordered={false}
            flex={1}
            minWidth={220}
            animation="bouncy"
            enterStyle={{ opacity: 0, y: 20 }}
            exitStyle={{ opacity: 0, y: -20 }}
            backgroundColor="$green10"
            padding="$0"
          >
            <CardHeader paddingHorizontal="$4" paddingTop="$4" paddingBottom="$2">
              <XStack alignItems="center" justifyContent="space-between">
                <Text fontSize="$2" fontWeight="$5" color="white">
                  {t('payments.dashboard.stats.monthlyRevenue')}
                </Text>
                <TrendingUp size={16} color="white" opacity={0.8} />
              </XStack>
            </CardHeader>
            <CardContent paddingHorizontal="$4" paddingBottom="$4">
              <Text fontSize="$6" fontWeight="$8" color="white">
                ${stats.monthlyRevenue.toLocaleString()}
              </Text>
              <XStack alignItems="center" color="white" opacity={0.8}>
                <ArrowUpRight size={12} color="white" />
                <Text fontSize="$1" color="white" marginLeft="$1">
                  +{stats.revenueGrowth}% {t('payments.dashboard.stats.fromLastMonth')}
                </Text>
              </XStack>
            </CardContent>
          </Card>

          <Card
            elevate
            bordered={false}
            flex={1}
            minWidth={220}
            animation="bouncy"
            enterStyle={{ opacity: 0, y: 20 }}
            exitStyle={{ opacity: 0, y: -20 }}
            backgroundColor="$purple10"
            padding="$0"
          >
            <CardHeader paddingHorizontal="$4" paddingTop="$4" paddingBottom="$2">
              <XStack alignItems="center" justifyContent="space-between">
                <Text fontSize="$2" fontWeight="$5" color="white">
                  {t('payments.dashboard.stats.totalTransactions')}
                </Text>
                <CreditCard size={16} color="white" opacity={0.8} />
              </XStack>
            </CardHeader>
            <CardContent paddingHorizontal="$4" paddingBottom="$4">
              <Text fontSize="$6" fontWeight="$8" color="white">
                {stats.totalTransactions.toLocaleString()}
              </Text>
              <XStack alignItems="center" color="white" opacity={0.8}>
                <ArrowUpRight size={12} color="white" />
                <Text fontSize="$1" color="white" marginLeft="$1">
                  +{stats.transactionGrowth}% {t('payments.dashboard.stats.fromLastMonth')}
                </Text>
              </XStack>
            </CardContent>
          </Card>

          <Card
            elevate
            bordered={false}
            flex={1}
            minWidth={220}
            animation="bouncy"
            enterStyle={{ opacity: 0, y: 20 }}
            exitStyle={{ opacity: 0, y: -20 }}
            backgroundColor="$orange10"
            padding="$0"
          >
            <CardHeader paddingHorizontal="$4" paddingTop="$4" paddingBottom="$2">
              <XStack alignItems="center" justifyContent="space-between">
                <Text fontSize="$2" fontWeight="$5" color="white">
                  {t('payments.dashboard.stats.activeSubscriptions')}
                </Text>
                <Users size={16} color="white" opacity={0.8} />
              </XStack>
            </CardHeader>
            <CardContent paddingHorizontal="$4" paddingBottom="$4">
              <Text fontSize="$6" fontWeight="$8" color="white">
                {stats.activeSubscriptions}
              </Text>
              <XStack alignItems="center" color="white" opacity={0.8}>
                <ArrowUpRight size={12} color="white" />
                <Text fontSize="$1" color="white" marginLeft="$1">
                  +{stats.subscriptionGrowth}% {t('payments.dashboard.stats.fromLastMonth')}
                </Text>
              </XStack>
            </CardContent>
          </Card>
        </AnimatePresence>
      </XStack>

      {/* Main Content */}
      <Tabs defaultValue="overview" orientation="horizontal">
        <TabsList>
          <TabsTrigger value="overview">
            {t('payments.dashboard.tabs.overview')}
          </TabsTrigger>
          <TabsTrigger value="transactions">
            {t('payments.dashboard.tabs.transactions')}
          </TabsTrigger>
          <TabsTrigger value="subscriptions">
            {t('payments.dashboard.tabs.subscriptions')}
          </TabsTrigger>
          <TabsTrigger value="invoices">
            {t('payments.dashboard.tabs.invoices')}
          </TabsTrigger>
        </TabsList>

        <TabsContent value="overview">
          <YStack space="$6" marginTop="$4">
            {/* Analytics Chart */}
            <Card
              elevate
              animation="bouncy"
              enterStyle={{ opacity: 0, y: 20 }}
              exitStyle={{ opacity: 0, y: -20 }}
            >
              <CardHeader>
                <Text fontSize="$5" fontWeight="$6">
                  {t('payments.dashboard.analytics.title')}
                </Text>
                <Text fontSize="$2" color="$gray11">
                  {t('payments.dashboard.analytics.description')}
                </Text>
              </CardHeader>
              <CardContent>
                <PaymentAnalytics />
              </CardContent>
            </Card>

            {/* Recent Transactions */}
            <Card
              elevate
              animation="bouncy"
              enterStyle={{ opacity: 0, y: 20 }}
              exitStyle={{ opacity: 0, y: -20 }}
            >
              <CardHeader>
                <XStack alignItems="center" justifyContent="space-between">
                  <YStack>
                    <Text fontSize="$5" fontWeight="$6">
                      {t('payments.dashboard.recentTransactions.title')}
                    </Text>
                    <Text fontSize="$2" color="$gray11">
                      {t('payments.dashboard.recentTransactions.description')}
                    </Text>
                  </YStack>
                  <Button chromeless bordered size="$3">
                    {t('common.actions.viewAll')}
                  </Button>
                </XStack>
              </CardHeader>
              <CardContent>
                <YStack space="$4">
                  {recentTransactions.map((transaction, index) => (
                    <XStack
                      key={transaction.id}
                      alignItems="center"
                      justifyContent="space-between"
                      padding="$4"
                      borderWidth={1}
                      borderColor="$borderColor"
                      borderRadius="$4"
                      hoverStyle={{ backgroundColor: "$backgroundHover" }}
                      animation="bouncy"
                      enterStyle={{ opacity: 0, x: -20 }}
                      exitStyle={{ opacity: 0, x: 20 }}
                    >
                      <XStack alignItems="center" gap="$4">
                        <Square
                          size="$4"
                          borderRadius="$round"
                          backgroundColor="$blue10"
                          alignItems="center"
                          justifyContent="center"
                        >
                          <CreditCard size={20} color="white" />
                        </Square>
                        <YStack>
                          <Text fontWeight="$5" color="$gray12">
                            {transaction.customer}
                          </Text>
                          <Text fontSize="$2" color="$gray10">
                            {transaction.description}
                          </Text>
                        </YStack>
                      </XStack>
                      <XStack alignItems="center" gap="$4">
                        <YStack alignItems="flex-end">
                          <Text fontWeight="$6" color="$gray12">
                            ${transaction.amount}
                          </Text>
                          <Text fontSize="$2" color="$gray10">
                            {new Date(transaction.date).toLocaleDateString()}
                          </Text>
                        </YStack>
                        <PaymentStatus status={transaction.status} />
                        <DropdownMenu>
                          <DropdownMenu.Trigger asChild>
                            <Button chromeless circular size="$2">
                              <MoreHorizontal size={16} />
                            </Button>
                          </DropdownMenu.Trigger>
                          <DropdownMenu.Content>
                            <DropdownMenu.Item>
                              <XStack alignItems="center" gap="$2">
                                <Eye size={16} />
                                <Text>{t('payments.dashboard.actions.viewDetails')}</Text>
                              </XStack>
                            </DropdownMenu.Item>
                            <DropdownMenu.Item>
                              <XStack alignItems="center" gap="$2">
                                <Edit size={16} />
                                <Text>{t('common.actions.edit')}</Text>
                              </XStack>
                            </DropdownMenu.Item>
                            <DropdownMenu.Item color="$red10">
                              <XStack alignItems="center" gap="$2">
                                <Trash2 size={16} color="$red10" />
                                <Text>{t('common.actions.delete')}</Text>
                              </XStack>
                            </DropdownMenu.Item>
                          </DropdownMenu.Content>
                        </DropdownMenu>
                      </XStack>
                    </XStack>
                  ))}
                </YStack>
              </CardContent>
            </Card>
          </YStack>
        </TabsContent>

        <TabsContent value="transactions">
          <YStack space="$6" marginTop="$4">
            <Card
              elevate
              animation="bouncy"
              enterStyle={{ opacity: 0, y: 20 }}
              exitStyle={{ opacity: 0, y: -20 }}
            >
              <CardHeader>
                <XStack alignItems="center" justifyContent="space-between">
                  <YStack>
                    <Text fontSize="$5" fontWeight="$6">
                      {t('payments.dashboard.allTransactions.title')}
                    </Text>
                    <Text fontSize="$2" color="$gray11">
                      {t('payments.dashboard.allTransactions.description')}
                    </Text>
                  </YStack>
                  <XStack alignItems="center" gap="$2">
                    <XStack position="relative">
                      <XStack position="absolute" left="$3" top="50%" transform={[{ translateY: -8 }]} zIndex={1}>
                        <Search size={16} color="$gray10" />
                      </XStack>
                      <Input
                        placeholder={t('payments.dashboard.searchTransactions')}
                        value={searchTerm}
                        onChangeText={setSearchTerm}
                        paddingLeft="$10"
                        width={250}
                      />
                    </XStack>
                    <Select
                      value={statusFilter}
                      onValueChange={setStatusFilter}
                    >
                      <Select.Trigger width={120}>
                        <Select.Value placeholder={t('payments.dashboard.allStatus')} />
                      </Select.Trigger>
                      <Select.Content>
                        <Select.Item value="all">
                          <Select.ItemText>{t('payments.dashboard.allStatus')}</Select.ItemText>
                        </Select.Item>
                        <Select.Item value="completed">
                          <Select.ItemText>{t('payments.dashboard.completed')}</Select.ItemText>
                        </Select.Item>
                        <Select.Item value="pending">
                          <Select.ItemText>{t('payments.dashboard.pending')}</Select.ItemText>
                        </Select.Item>
                        <Select.Item value="failed">
                          <Select.ItemText>{t('payments.dashboard.failed')}</Select.ItemText>
                        </Select.Item>
                      </Select.Content>
                    </Select>
                    <Button chromeless bordered size="$3">
                      <Filter size={16} />
                      <Text marginLeft="$2">{t('common.actions.filter')}</Text>
                    </Button>
                  </XStack>
                </XStack>
              </CardHeader>
              <CardContent>
                <TransactionTable 
                  transactions={recentTransactions}
                  isLoading={paymentsLoading}
                />
              </CardContent>
            </Card>
          </YStack>
        </TabsContent>

        <TabsContent value="subscriptions">
          <YStack space="$6" marginTop="$4">
            <Card
              elevate
              animation="bouncy"
              enterStyle={{ opacity: 0, y: 20 }}
              exitStyle={{ opacity: 0, y: -20 }}
            >
              <CardHeader>
                <XStack alignItems="center" justifyContent="space-between">
                  <YStack>
                    <Text fontSize="$5" fontWeight="$6">
                      {t('payments.dashboard.subscriptions.title')}
                    </Text>
                    <Text fontSize="$2" color="$gray11">
                      {t('payments.dashboard.subscriptions.description')}
                    </Text>
                  </YStack>
                  <Button theme="accent">
                    <Plus size={16} />
                    <Text marginLeft="$2">{t('payments.dashboard.newSubscription')}</Text>
                  </Button>
                </XStack>
              </CardHeader>
              <CardContent>
                <YStack height={200} alignItems="center" justifyContent="center">
                  <Text color="$gray10" textAlign="center">
                    {t('payments.dashboard.subscriptions.comingSoon')}
                  </Text>
                </YStack>
              </CardContent>
            </Card>
          </YStack>
        </TabsContent>

        <TabsContent value="invoices">
          <YStack space="$6" marginTop="$4">
            <Card
              elevate
              animation="bouncy"
              enterStyle={{ opacity: 0, y: 20 }}
              exitStyle={{ opacity: 0, y: -20 }}
            >
              <CardHeader>
                <XStack alignItems="center" justifyContent="space-between">
                  <YStack>
                    <Text fontSize="$5" fontWeight="$6">
                      {t('payments.dashboard.invoices.title')}
                    </Text>
                    <Text fontSize="$2" color="$gray11">
                      {t('payments.dashboard.invoices.description')}
                    </Text>
                  </YStack>
                  <Button theme="accent">
                    <Plus size={16} />
                    <Text marginLeft="$2">{t('payments.dashboard.createInvoice')}</Text>
                  </Button>
                </XStack>
              </CardHeader>
              <CardContent>
                <YStack space="$4">
                  {recentInvoices.map((invoice, index) => (
                    <XStack
                      key={invoice.id}
                      alignItems="center"
                      justifyContent="space-between"
                      padding="$4"
                      borderWidth={1}
                      borderColor="$borderColor"
                      borderRadius="$4"
                      hoverStyle={{ backgroundColor: "$backgroundHover" }}
                      animation="bouncy"
                      enterStyle={{ opacity: 0, x: -20 }}
                      exitStyle={{ opacity: 0, x: 20 }}
                    >
                      <XStack alignItems="center" gap="$4">
                        <Square
                          size="$4"
                          borderRadius="$round"
                          backgroundColor="$green10"
                          alignItems="center"
                          justifyContent="center"
                        >
                          <CreditCard size={20} color="white" />
                        </Square>
                        <YStack>
                          <Text fontWeight="$5" color="$gray12">
                            {t('payments.dashboard.invoiceNumber', { id: invoice.id })}
                          </Text>
                          <Text fontSize="$2" color="$gray10">
                            {invoice.customer} â€¢ {t('payments.dashboard.due')} {new Date(invoice.dueDate).toLocaleDateString()}
                          </Text>
                        </YStack>
                      </XStack>
                      <XStack alignItems="center" gap="$4">
                        <YStack alignItems="flex-end">
                          <Text fontWeight="$6" color="$gray12">
                            ${invoice.amount}
                          </Text>
                          <Badge
                            theme={invoice.status === 'paid' ? "green" : "yellow"}
                            size="$1"
                          >
                            {invoice.status}
                          </Badge>
                        </YStack>
                        <DropdownMenu>
                          <DropdownMenu.Trigger asChild>
                            <Button chromeless circular size="$2">
                              <MoreHorizontal size={16} />
                            </Button>
                          </DropdownMenu.Trigger>
                          <DropdownMenu.Content>
                            <DropdownMenu.Item>
                              <XStack alignItems="center" gap="$2">
                                <Eye size={16} />
                                <Text>{t('payments.dashboard.viewInvoice')}</Text>
                              </XStack>
                            </DropdownMenu.Item>
                            <DropdownMenu.Item>
                              <XStack alignItems="center" gap="$2">
                                <Download size={16} />
                                <Text>{t('payments.dashboard.downloadPDF')}</Text>
                              </XStack>
                            </DropdownMenu.Item>
                            <DropdownMenu.Item>
                              <XStack alignItems="center" gap="$2">
                                <Edit size={16} />
                                <Text>{t('common.actions.edit')}</Text>
                              </XStack>
                            </DropdownMenu.Item>
                          </DropdownMenu.Content>
                        </DropdownMenu>
                      </XStack>
                    </XStack>
                  ))}
                </YStack>
              </CardContent>
            </Card>
          </YStack>
        </TabsContent>
      </Tabs>
    </YStack>
  );
}

