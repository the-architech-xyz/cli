// Checkout Page Component

"use client";

import React, { useState } from 'react';
import { useRouter } from 'next/navigation';
import { 
  YStack, 
  XStack, 
  Button, 
  Text,
  Card,
  CardHeader,
  CardContent,
  Badge,
  Separator,
  Input,
  Label,
  Checkbox,
  Theme,
  Square,
  Alert,
  Image
} from 'tamagui';
import { Loader2, CreditCard, Lock, Shield, Check } from 'lucide-react-native';
import { useCart, usePaymentsCreate } from '@/lib/payments';  // âœ… Import from tech-stack
import { PaymentMethodSelector } from '@/components/payments/PaymentMethodSelector';
import { CheckoutForm } from '@/components/payments/CheckoutForm';
import { useTranslation } from '@/lib/i18n';

interface CheckoutPageProps {
  onSuccess?: (paymentIntent: any) => void;
  onError?: (error: string) => void;
}

export const CheckoutPage: React.FC<CheckoutPageProps> = ({
  onSuccess,
  onError,
}) => {
  const { t } = useTranslation();
  const router = useRouter();
  const createPayment = usePaymentsCreate();
  const { items, total, clearCart } = useCart();
  
  const [paymentMethod, setPaymentMethod] = useState<string>('card');
  const [billingInfo, setBillingInfo] = useState({
    email: '',
    firstName: '',
    lastName: '',
    address: '',
    city: '',
    state: '',
    zipCode: '',
    country: 'US',
  });
  const [agreedToTerms, setAgreedToTerms] = useState(false);
  const [isProcessing, setIsProcessing] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handlePayment = async () => {
    if (!agreedToTerms) {
      const errorMsg = t('payments.checkout.errors.agreeToTerms');
      setError(errorMsg);
      onError?.(errorMsg);
      return;
    }

    if (!billingInfo.email || !billingInfo.firstName || !billingInfo.lastName) {
      const errorMsg = t('payments.checkout.errors.requiredFields');
      setError(errorMsg);
      onError?.(errorMsg);
      return;
    }

    try {
      setIsProcessing(true);
      setError(null);

      // Create payment
      const result = await createPayment.mutateAsync({
        amount: total * 100, // Convert to cents
        currency: 'usd',
        payment_method: paymentMethod,
        items: items.map(item => ({
          id: item.id,
          name: item.name,
          price: item.price,
          quantity: item.quantity,
        })),
        customer: {
          email: billingInfo.email,
          name: `${billingInfo.firstName} ${billingInfo.lastName}`,
          address: {
            line1: billingInfo.address,
            city: billingInfo.city,
            state: billingInfo.state,
            postal_code: billingInfo.zipCode,
            country: billingInfo.country,
          },
        },
      });

      // Clear cart and redirect
      clearCart();
      onSuccess?.(result);
      
      // Redirect to success page
      router.push(`/payments/success?payment_intent=${result.id}`);
    } catch (err: any) {
      const errorMsg = err.message || t('payments.checkout.errors.paymentFailed');
      setError(errorMsg);
      onError?.(errorMsg);
    } finally {
      setIsProcessing(false);
    }
  };

  if (items.length === 0) {
    return (
      <YStack padding="$4" maxWidth={800} marginHorizontal="auto">
        <Card elevate>
          <CardContent padding="$6" alignItems="center" justifyContent="center">
            <YStack alignItems="center" space="$4">
              <Text fontSize="$6" fontWeight="$7" textAlign="center">
                {t('payments.checkout.emptyCart')}
              </Text>
              <Text fontSize="$3" color="$gray11" textAlign="center" marginBottom="$2">
                {t('payments.checkout.addItemsBeforeCheckout')}
              </Text>
              <Button 
                theme="accent"
                size="$4"
                onPress={() => router.push('/')}
              >
                {t('payments.checkout.continueShopping')}
              </Button>
            </YStack>
          </CardContent>
        </Card>
      </YStack>
    );
  }

  return (
    <YStack padding="$4" maxWidth={1200} marginHorizontal="auto">
      <XStack flexDirection={{ xs: 'column', md: 'row' }} gap="$6">
        {/* Order Summary */}
        <YStack flex={1} space="$6">
          <Card elevate>
            <CardHeader>
              <Text fontSize="$5" fontWeight="$6">
                {t('payments.checkout.orderSummary')}
              </Text>
              <Text fontSize="$2" color="$gray11">
                {t('payments.checkout.reviewItems')}
              </Text>
            </CardHeader>
            <CardContent space="$4">
              {items.map((item) => (
                <XStack key={item.id} alignItems="center" justifyContent="space-between">
                  <XStack alignItems="center" gap="$3">
                    <Square size="$4" backgroundColor="$gray3" borderRadius="$3" alignItems="center" justifyContent="center">
                      {item.image ? (
                        <Image
                          source={{ uri: item.image }}
                          alt={item.name}
                          width="100%"
                          height="100%"
                          borderRadius="$3"
                          resizeMode="cover"
                        />
                      ) : (
                        <Square size="$2" backgroundColor="$gray6" borderRadius="$1" />
                      )}
                    </Square>
                    <YStack>
                      <Text fontWeight="$5">{item.name}</Text>
                      <Text fontSize="$2" color="$gray10">
                        {t('payments.checkout.quantity', { quantity: item.quantity })}
                      </Text>
                    </YStack>
                  </XStack>
                  <Text fontWeight="$5">
                    ${(item.price * item.quantity).toFixed(2)}
                  </Text>
                </XStack>
              ))}
              
              <Separator />
              
              <YStack space="$2">
                <XStack justifyContent="space-between">
                  <Text>{t('payments.checkout.subtotal')}</Text>
                  <Text>${total.toFixed(2)}</Text>
                </XStack>
                <XStack justifyContent="space-between">
                  <Text>{t('payments.checkout.tax')}</Text>
                  <Text>$0.00</Text>
                </XStack>
                <XStack justifyContent="space-between">
                  <Text>{t('payments.checkout.shipping')}</Text>
                  <Text>{t('payments.checkout.free')}</Text>
                </XStack>
                <Separator />
                <XStack justifyContent="space-between">
                  <Text fontWeight="$7" fontSize="$4">
                    {t('payments.checkout.total')}
                  </Text>
                  <Text fontWeight="$7" fontSize="$4">
                    ${total.toFixed(2)}
                  </Text>
                </XStack>
              </YStack>
            </CardContent>
          </Card>

          {/* Security Features */}
          <Card elevate>
            <CardHeader>
              <XStack alignItems="center" gap="$2">
                <Shield size={20} color="$green10" />
                <Text fontSize="$5" fontWeight="$6">
                  {t('payments.checkout.secureCheckout')}
                </Text>
              </XStack>
            </CardHeader>
            <CardContent space="$3">
              <XStack alignItems="center" gap="$2">
                <Lock size={16} color="$green10" />
                <Text fontSize="$2" color="$gray11">
                  {t('payments.checkout.security.encryption')}
                </Text>
              </XStack>
              <XStack alignItems="center" gap="$2">
                <Check size={16} color="$green10" />
                <Text fontSize="$2" color="$gray11">
                  {t('payments.checkout.security.pciCompliant')}
                </Text>
              </XStack>
              <XStack alignItems="center" gap="$2">
                <Shield size={16} color="$green10" />
                <Text fontSize="$2" color="$gray11">
                  {t('payments.checkout.security.fraudProtection')}
                </Text>
              </XStack>
            </CardContent>
          </Card>
        </YStack>

        {/* Checkout Form */}
        <YStack flex={1} space="$6">
          <Card elevate>
            <CardHeader>
              <Text fontSize="$5" fontWeight="$6">
                {t('payments.checkout.billingInformation')}
              </Text>
              <Text fontSize="$2" color="$gray11">
                {t('payments.checkout.enterBillingDetails')}
              </Text>
            </CardHeader>
            <CardContent space="$4">
              <XStack gap="$4">
                <YStack flex={1}>
                  <Label htmlFor="firstName">
                    {t('payments.checkout.firstName')} *
                  </Label>
                  <Input
                    id="firstName"
                    value={billingInfo.firstName}
                    onChangeText={(text) => setBillingInfo(prev => ({ ...prev, firstName: text }))}
                    required
                  />
                </YStack>
                <YStack flex={1}>
                  <Label htmlFor="lastName">
                    {t('payments.checkout.lastName')} *
                  </Label>
                  <Input
                    id="lastName"
                    value={billingInfo.lastName}
                    onChangeText={(text) => setBillingInfo(prev => ({ ...prev, lastName: text }))}
                    required
                  />
                </YStack>
              </XStack>

              <YStack>
                <Label htmlFor="email">
                  {t('payments.checkout.email')} *
                </Label>
                <Input
                  id="email"
                  keyboardType="email-address"
                  value={billingInfo.email}
                  onChangeText={(text) => setBillingInfo(prev => ({ ...prev, email: text }))}
                  required
                />
              </YStack>

              <YStack>
                <Label htmlFor="address">
                  {t('payments.checkout.address')}
                </Label>
                <Input
                  id="address"
                  value={billingInfo.address}
                  onChangeText={(text) => setBillingInfo(prev => ({ ...prev, address: text }))}
                />
              </YStack>

              <XStack gap="$2">
                <YStack flex={1}>
                  <Label htmlFor="city">
                    {t('payments.checkout.city')}
                  </Label>
                  <Input
                    id="city"
                    value={billingInfo.city}
                    onChangeText={(text) => setBillingInfo(prev => ({ ...prev, city: text }))}
                  />
                </YStack>
                <YStack flex={1}>
                  <Label htmlFor="state">
                    {t('payments.checkout.state')}
                  </Label>
                  <Input
                    id="state"
                    value={billingInfo.state}
                    onChangeText={(text) => setBillingInfo(prev => ({ ...prev, state: text }))}
                  />
                </YStack>
                <YStack flex={1}>
                  <Label htmlFor="zipCode">
                    {t('payments.checkout.zipCode')}
                  </Label>
                  <Input
                    id="zipCode"
                    value={billingInfo.zipCode}
                    onChangeText={(text) => setBillingInfo(prev => ({ ...prev, zipCode: text }))}
                  />
                </YStack>
              </XStack>
            </CardContent>
          </Card>

          <Card elevate>
            <CardHeader>
              <Text fontSize="$5" fontWeight="$6">
                {t('payments.checkout.paymentMethod')}
              </Text>
              <Text fontSize="$2" color="$gray11">
                {t('payments.checkout.choosePaymentMethod')}
              </Text>
            </CardHeader>
            <CardContent>
              <PaymentMethodSelector
                value={paymentMethod}
                onChange={setPaymentMethod}
              />
            </CardContent>
          </Card>

          {paymentMethod === 'card' && (
            <Card elevate>
              <CardHeader>
                <XStack alignItems="center" gap="$2">
                  <CreditCard size={20} />
                  <Text fontSize="$5" fontWeight="$6">
                    {t('payments.checkout.cardDetails')}
                  </Text>
                </XStack>
              </CardHeader>
              <CardContent>
                <CheckoutForm />
              </CardContent>
            </Card>
          )}

          <Card elevate>
            <CardContent paddingTop="$6">
              <XStack alignItems="center" gap="$2" marginBottom="$4">
                <Checkbox
                  id="terms"
                  checked={agreedToTerms}
                  onCheckedChange={(checked) => setAgreedToTerms(!!checked)}
                  size="$3"
                >
                  <Checkbox.Indicator>
                    <Check size={16} />
                  </Checkbox.Indicator>
                </Checkbox>
                <Label htmlFor="terms" fontSize="$2">
                  {t('payments.checkout.agreeToTerms')}{' '}
                  <Text color="$blue10" textDecorationLine="underline" onPress={() => router.push('/terms')}>
                    {t('payments.checkout.termsOfService')}
                  </Text>{' '}
                  {t('payments.checkout.and')}{' '}
                  <Text color="$blue10" textDecorationLine="underline" onPress={() => router.push('/privacy')}>
                    {t('payments.checkout.privacyPolicy')}
                  </Text>
                </Label>
              </XStack>

              {error && (
                <Alert theme="red" marginBottom="$4">
                  <Text color="$red10">{error}</Text>
                </Alert>
              )}

              <Button
                onPress={handlePayment}
                disabled={isProcessing || createPayment.isLoading || !agreedToTerms}
                size="$4"
                theme="accent"
              >
                {isProcessing || createPayment.isLoading ? (
                  <XStack alignItems="center" gap="$2">
                    <Loader2 size={16} style={{ animation: 'spin 1s linear infinite' }} />
                    <Text>{t('payments.checkout.processing')}</Text>
                  </XStack>
                ) : (
                  <XStack alignItems="center" gap="$2">
                    <Lock size={16} />
                    <Text>
                      {t('payments.checkout.completeOrder', { total: total.toFixed(2) })}
                    </Text>
                  </XStack>
                )}
              </Button>
            </CardContent>
          </Card>
        </YStack>
      </XStack>
    </YStack>
  );
};

