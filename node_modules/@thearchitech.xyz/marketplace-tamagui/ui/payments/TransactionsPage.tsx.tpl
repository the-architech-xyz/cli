// Transactions Page Component

"use client";

import React, { useState, useEffect } from 'react';
import { useTranslation } from '@/lib/i18n';
import { 
  CreditCard, 
  Search, 
  Filter, 
  Calendar,
  DollarSign,
  Eye,
  Download,
  CheckCircle,
  XCircle,
  Clock,
  AlertCircle,
  TrendingUp,
  TrendingDown,
  Minus
} from 'lucide-react-native';
import { useTransactions } from '@/hooks/payments/use-transactions';
import { TransactionTable } from './TransactionTable';

import {
  YStack,
  XStack,
  Button,
  Input,
  Badge,
  Card,
  CardContent,
  CardHeader,
  CardTitle,
  CardDescription,
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
  Alert,
  AlertDescription,
  Text,
  Theme,
  Square,
  Spinner,
  ScrollView
} from 'tamagui';

interface TransactionsPageProps {
  onTransactionClick?: (transaction: any) => void;
  onExport?: () => void;
}

export function TransactionsPage({
  onTransactionClick,
  onExport,
}: TransactionsPageProps) {
  const { t } = useTranslation();
  const { transactions, isLoading, error, fetchTransactions, exportTransactions } = useTransactions();
  
  const [searchTerm, setSearchTerm] = useState('');
  const [statusFilter, setStatusFilter] = useState<string>('all');
  const [typeFilter, setTypeFilter] = useState<string>('all');
  const [dateFilter, setDateFilter] = useState<string>('all');
  const [selectedTransaction, setSelectedTransaction] = useState<any>(null);
  const [isDetailOpen, setIsDetailOpen] = useState(false);

  useEffect(() => {
    fetchTransactions();
  }, []);

  const filteredTransactions = transactions.filter(transaction => {
    const matchesSearch = transaction.id.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         transaction.customerName?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         transaction.customerEmail?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         transaction.description?.toLowerCase().includes(searchTerm.toLowerCase());
    
    const matchesStatus = statusFilter === 'all' || transaction.status === statusFilter;
    const matchesType = typeFilter === 'all' || transaction.type === typeFilter;
    
    const matchesDate = dateFilter === 'all' || {
      'last-7-days': () => {
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        return new Date(transaction.createdAt) >= sevenDaysAgo;
      },
      'last-30-days': () => {
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        return new Date(transaction.createdAt) >= thirtyDaysAgo;
      },
      'last-90-days': () => {
        const ninetyDaysAgo = new Date();
        ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);
        return new Date(transaction.createdAt) >= ninetyDaysAgo;
      },
      'this-year': () => {
        const thisYear = new Date().getFullYear();
        return new Date(transaction.createdAt).getFullYear() === thisYear;
      },
    }[dateFilter]?.() ?? true;

    return matchesSearch && matchesStatus && matchesType && matchesDate;
  });

  const getStatusBadge = (status: string) => {
    const statusConfig: Record<string, { theme: string, icon: React.ComponentType<{ size?: number; color?: string }> }> = {
      succeeded: { theme: 'green', icon: CheckCircle },
      pending: { theme: 'yellow', icon: Clock },
      failed: { theme: 'red', icon: XCircle },
      cancelled: { theme: 'gray', icon: XCircle },
      requires_action: { theme: 'orange', icon: AlertCircle },
    };

    const config = statusConfig[status] || statusConfig.pending;
    const Icon = config.icon;

    return (
      <Theme name={config.theme}>
        <Badge size="$1">
          <XStack alignItems="center" gap="$1">
            <Icon size={12} />
            <Text fontSize="$1" textTransform="capitalize">{status.replace('_', ' ')}</Text>
          </XStack>
        </Badge>
      </Theme>
    );
  };

  const getTypeIcon = (type: string) => {
    const typeConfig: Record<string, { icon: React.ComponentType<{ size?: number; color?: string }>, color: string }> = {
      payment: { icon: TrendingUp, color: '$green10' },
      refund: { icon: TrendingDown, color: '$red10' },
      chargeback: { icon: AlertCircle, color: '$orange10' },
      adjustment: { icon: Minus, color: '$blue10' },
    };

    const config = typeConfig[type] || typeConfig.payment;
    const Icon = config.icon;

    return <Icon size={16} color={config.color} />;
  };

  const handleTransactionClick = (transaction: any) => {
    setSelectedTransaction(transaction);
    setIsDetailOpen(true);
    onTransactionClick?.(transaction);
  };

  const handleExport = async () => {
    try {
      await exportTransactions(filteredTransactions);
      onExport?.();
    } catch (error) {
      console.error('Export failed:', error);
    }
  };

  const totalAmount = filteredTransactions.reduce((sum, transaction) => {
    return sum + (transaction.amount || 0);
  }, 0);

  const successfulTransactions = filteredTransactions.filter(t => t.status === 'succeeded').length;
  const failedTransactions = filteredTransactions.filter(t => t.status === 'failed').length;

  if (isLoading) {
    return (
      <YStack padding="$4" alignItems="center" justifyContent="center" height={400}>
        <Spinner size="large" />
        <Text marginTop="$4" color="$colorFocus">
          {t('payments.transactions.loading')}
        </Text>
      </YStack>
    );
  }

  return (
    <YStack padding="$4" space="$6">
      {/* Header */}
      <XStack flexDirection={{ xs: 'column', sm: 'row' }} justifyContent="space-between" alignItems={{ sm: 'center' }}>
        <YStack>
          <Text fontSize="$8" fontWeight="$8" color="$color">
            {t('payments.transactions.title')}
          </Text>
          <Text fontSize="$3" color="$colorFocus" marginTop="$1">
            {t('payments.transactions.subtitle')}
          </Text>
        </YStack>
        <XStack gap="$2" marginTop={{ xs: '$4', sm: 0 }}>
          <Button 
            variant="outlined"
            onPress={handleExport}
            icon={<Download size={16} />}
          >
            {t('payments.transactions.export')}
          </Button>
        </XStack>
      </XStack>

      {/* Stats Cards */}
      <XStack 
        flexDirection={{ xs: 'column', md: 'row' }}
        gap="$6"
      >
        <Card flex={1} elevate>
          <CardContent padding="$6">
            <XStack alignItems="center">
              <Theme name="blue">
                <Square backgroundColor="$background" padding="$2" borderRadius="$3">
                  <CreditCard size={24} color="$blue10" />
                </Square>
              </Theme>
              <YStack marginLeft="$4">
                <Text fontSize="$2" fontWeight="$6" color="$colorFocus">
                  {t('payments.transactions.totalTransactions')}
                </Text>
                <Text fontSize="$6" fontWeight="$8" color="$color">
                  {filteredTransactions.length}
                </Text>
              </YStack>
            </XStack>
          </CardContent>
        </Card>

        <Card flex={1} elevate>
          <CardContent padding="$6">
            <XStack alignItems="center">
              <Theme name="green">
                <Square backgroundColor="$background" padding="$2" borderRadius="$3">
                  <DollarSign size={24} color="$green10" />
                </Square>
              </Theme>
              <YStack marginLeft="$4">
                <Text fontSize="$2" fontWeight="$6" color="$colorFocus">
                  {t('payments.transactions.totalAmount')}
                </Text>
                <Text fontSize="$6" fontWeight="$8" color="$color">
                  ${totalAmount.toFixed(2)}
                </Text>
              </YStack>
            </XStack>
          </CardContent>
        </Card>

        <Card flex={1} elevate>
          <CardContent padding="$6">
            <XStack alignItems="center">
              <Theme name="green">
                <Square backgroundColor="$background" padding="$2" borderRadius="$3">
                  <CheckCircle size={24} color="$green10" />
                </Square>
              </Theme>
              <YStack marginLeft="$4">
                <Text fontSize="$2" fontWeight="$6" color="$colorFocus">
                  {t('payments.transactions.successful')}
                </Text>
                <Text fontSize="$6" fontWeight="$8" color="$color">
                  {successfulTransactions}
                </Text>
              </YStack>
            </XStack>
          </CardContent>
        </Card>

        <Card flex={1} elevate>
          <CardContent padding="$6">
            <XStack alignItems="center">
              <Theme name="red">
                <Square backgroundColor="$background" padding="$2" borderRadius="$3">
                  <XCircle size={24} color="$red10" />
                </Square>
              </Theme>
              <YStack marginLeft="$4">
                <Text fontSize="$2" fontWeight="$6" color="$colorFocus">
                  {t('payments.transactions.failed')}
                </Text>
                <Text fontSize="$6" fontWeight="$8" color="$color">
                  {failedTransactions}
                </Text>
              </YStack>
            </XStack>
          </CardContent>
        </Card>
      </XStack>

      {/* Filters */}
      <Card elevate>
        <CardContent padding="$6">
          <XStack 
            flexDirection={{ xs: 'column', sm: 'row' }}
            gap="$4"
          >
            <YStack flex={1} position="relative">
              <XStack 
                position="absolute" 
                left="$3" 
                top="50%" 
                alignItems="center" 
                transform={[{ translateY: -8 }]}
              >
                <Search size={16} color="$colorFocus" />
              </XStack>
              <Input
                placeholder={t('payments.transactions.searchPlaceholder')}
                value={searchTerm}
                onChangeText={setSearchTerm}
                paddingLeft="$10"
                flex={1}
              />
            </YStack>
            
            <Select value={statusFilter} onValueChange={setStatusFilter}>
              <SelectTrigger width={{ xs: '100%', sm: 200 }}>
                <SelectValue placeholder={t('payments.transactions.filterByStatus')} />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">
                  <Text>{t('payments.transactions.allStatus')}</Text>
                </SelectItem>
                <SelectItem value="succeeded">
                  <Text>{t('payments.transactions.succeeded')}</Text>
                </SelectItem>
                <SelectItem value="pending">
                  <Text>{t('payments.transactions.pending')}</Text>
                </SelectItem>
                <SelectItem value="failed">
                  <Text>{t('payments.transactions.failed')}</Text>
                </SelectItem>
                <SelectItem value="cancelled">
                  <Text>{t('payments.transactions.cancelled')}</Text>
                </SelectItem>
                <SelectItem value="requires_action">
                  <Text>{t('payments.transactions.requiresAction')}</Text>
                </SelectItem>
              </SelectContent>
            </Select>

            <Select value={typeFilter} onValueChange={setTypeFilter}>
              <SelectTrigger width={{ xs: '100%', sm: 200 }}>
                <SelectValue placeholder={t('payments.transactions.filterByType')} />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">
                  <Text>{t('payments.transactions.allTypes')}</Text>
                </SelectItem>
                <SelectItem value="payment">
                  <Text>{t('payments.transactions.payment')}</Text>
                </SelectItem>
                <SelectItem value="refund">
                  <Text>{t('payments.transactions.refund')}</Text>
                </SelectItem>
                <SelectItem value="chargeback">
                  <Text>{t('payments.transactions.chargeback')}</Text>
                </SelectItem>
                <SelectItem value="adjustment">
                  <Text>{t('payments.transactions.adjustment')}</Text>
                </SelectItem>
              </SelectContent>
            </Select>

            <Select value={dateFilter} onValueChange={setDateFilter}>
              <SelectTrigger width={{ xs: '100%', sm: 200 }}>
                <SelectValue placeholder={t('payments.transactions.filterByDate')} />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">
                  <Text>{t('payments.transactions.allTime')}</Text>
                </SelectItem>
                <SelectItem value="last-7-days">
                  <Text>{t('payments.transactions.last7Days')}</Text>
                </SelectItem>
                <SelectItem value="last-30-days">
                  <Text>{t('payments.transactions.last30Days')}</Text>
                </SelectItem>
                <SelectItem value="last-90-days">
                  <Text>{t('payments.transactions.last90Days')}</Text>
                </SelectItem>
                <SelectItem value="this-year">
                  <Text>{t('payments.transactions.thisYear')}</Text>
                </SelectItem>
              </SelectContent>
            </Select>
          </XStack>
        </CardContent>
      </Card>

      {/* Error Alert */}
      {error && (
        <Alert theme="red">
          <XStack gap="$2" alignItems="center">
            <AlertCircle size={16} />
            <AlertDescription>{error}</AlertDescription>
          </XStack>
        </Alert>
      )}

      {/* Transactions Table */}
      <Card elevate>
        <CardHeader>
          <CardTitle>{t('payments.transactions.transactionsTitle')}</CardTitle>
          <CardDescription>
            {t('payments.transactions.transactionsFound', { 
              count: filteredTransactions.length 
            })}
          </CardDescription>
        </CardHeader>
        <CardContent>
          {filteredTransactions.length === 0 ? (
            <YStack alignItems="center" justifyContent="center" paddingVertical="$12">
              <CreditCard size={48} color="$colorFocus" />
              <Text fontSize="$5" fontWeight="$6" marginTop="$4" marginBottom="$2">
                {t('payments.transactions.noTransactionsFound')}
              </Text>
              <Text color="$colorFocus">
                {t('payments.transactions.adjustFilters')}
              </Text>
            </YStack>
          ) : (
            <TransactionTable 
              transactions={filteredTransactions}
              onTransactionClick={handleTransactionClick}
              getStatusBadge={getStatusBadge}
              getTypeIcon={getTypeIcon}
            />
          )}
        </CardContent>
      </Card>

      {/* Transaction Detail Dialog */}
      <Dialog open={isDetailOpen} onOpenChange={setIsDetailOpen}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>{t('payments.transactions.transactionDetails')}</DialogTitle>
            <DialogDescription>
              {t('payments.transactions.viewDetails')}
            </DialogDescription>
          </DialogHeader>
          {selectedTransaction && (
            <YStack space="$4">
              <XStack flexWrap="wrap" gap="$4">
                <YStack flex={1} minWidth={150}>
                  <Text fontSize="$2" fontWeight="$6" color="$colorFocus">
                    {t('payments.transactions.transactionId')}
                  </Text>
                  <Text fontSize="$2">{selectedTransaction.id}</Text>
                </YStack>
                <YStack flex={1} minWidth={150}>
                  <Text fontSize="$2" fontWeight="$6" color="$colorFocus">
                    {t('payments.transactions.status')}
                  </Text>
                  {getStatusBadge(selectedTransaction.status)}
                </YStack>
                <YStack flex={1} minWidth={150}>
                  <Text fontSize="$2" fontWeight="$6" color="$colorFocus">
                    {t('payments.transactions.amount')}
                  </Text>
                  <Text fontSize="$2" fontWeight="$6">
                    ${selectedTransaction.amount?.toFixed(2) || '0.00'}
                  </Text>
                </YStack>
                <YStack flex={1} minWidth={150}>
                  <Text fontSize="$2" fontWeight="$6" color="$colorFocus">
                    {t('payments.transactions.type')}
                  </Text>
                  <XStack alignItems="center" gap="$1">
                    {getTypeIcon(selectedTransaction.type)}
                    <Text fontSize="$2" textTransform="capitalize">
                      {selectedTransaction.type}
                    </Text>
                  </XStack>
                </YStack>
                <YStack flex={1} minWidth={150}>
                  <Text fontSize="$2" fontWeight="$6" color="$colorFocus">
                    {t('payments.transactions.date')}
                  </Text>
                  <Text fontSize="$2">
                    {new Date(selectedTransaction.createdAt).toLocaleString()}
                  </Text>
                </YStack>
                <YStack flex={1} minWidth={150}>
                  <Text fontSize="$2" fontWeight="$6" color="$colorFocus">
                    {t('payments.transactions.customer')}
                  </Text>
                  <Text fontSize="$2">
                    {selectedTransaction.customerName || t('payments.transactions.notApplicable')}
                  </Text>
                </YStack>
              </XStack>
              
              {selectedTransaction.description && (
                <YStack>
                  <Text fontSize="$2" fontWeight="$6" color="$colorFocus">
                    {t('payments.transactions.description')}
                  </Text>
                  <Text fontSize="$2">{selectedTransaction.description}</Text>
                </YStack>
              )}
            </YStack>
          )}
        </DialogContent>
      </Dialog>
    </YStack>
  );
}
