'use client';

import React, { useState } from 'react';
import { useTranslation } from '@/lib/i18n';
import { 
  YStack, 
  XStack, 
  Button, 
  Input, 
  Label, 
  TextArea,
  Avatar,
  AvatarFallback,
  AvatarImage,
  Tabs,
  TabsContent,
  TabsList,
  TabsTrigger,
  Card, 
  CardContent, 
  CardDescription, 
  CardHeader, 
  CardTitle,
  Alert, 
  AlertDescription,
  Text,
  Theme,
  Square,
  Checkbox,
  Switch
} from 'tamagui';
import { 
  User, 
  Mail, 
  Upload, 
  Loader2,
  CheckCircle,
  AlertTriangle,
  Save
} from 'lucide-react-native';

export const ProfilePage = () => {
  const { t } = useTranslation();
  const [formData, setFormData] = useState({
    name: 'John Doe',
    email: 'john@example.com',
    bio: 'Software developer passionate about creating great user experiences.',
    location: 'San Francisco, CA',
    website: 'https://johndoe.com',
    company: 'Acme Inc.'
  });
  const [avatarUrl, setAvatarUrl] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [success, setSuccess] = useState(false);
  const [error, setError] = useState('');
  
  // Preferences state
  const [emailNotifications, setEmailNotifications] = useState(true);
  const [marketingEmails, setMarketingEmails] = useState(false);
  const [pushNotifications, setPushNotifications] = useState(true);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    setSuccess(false);
    setIsLoading(true);

    try {
      // Simulate API call
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      setSuccess(true);
      setTimeout(() => setSuccess(false), 3000);
    } catch (err) {
      setError(t('profile.updateError'));
    } finally {
      setIsLoading(false);
    }
  };

  const handleAvatarUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setAvatarUrl(reader.result as string);
      };
      reader.readAsDataURL(file);
    }
  };

  return (
    <YStack paddingHorizontal="$6" paddingVertical="$6" maxWidth={800} marginHorizontal="auto" space="$6">
      <YStack>
        <Text fontSize="$6" fontWeight="bold" color="$gray12">
          {t('profile.title')}
        </Text>
        <Text color="$gray10">
          {t('profile.subtitle')}
        </Text>
      </YStack>

      <Tabs defaultValue="general" orientation="horizontal">
        <TabsList>
          <TabsTrigger value="general">{t('profile.tabs.general')}</TabsTrigger>
          <TabsTrigger value="account">{t('profile.tabs.account')}</TabsTrigger>
          <TabsTrigger value="preferences">{t('profile.tabs.preferences')}</TabsTrigger>
        </TabsList>
        
        <TabsContent value="general">
          <YStack tag="form" onSubmit={handleSubmit} space="$6" marginTop="$6">
            {success && (
              <Alert backgroundColor="$green2" borderColor="$green6">
                <XStack alignItems="center" space="$2">
                  <CheckCircle size={16} color="$green10" />
                  <AlertDescription>
                    <Text color="$green10">{t('profile.updateSuccess')}</Text>
                  </AlertDescription>
                </XStack>
              </Alert>
            )}

            {error && (
              <Alert backgroundColor="$red2" borderColor="$red6">
                <XStack alignItems="center" space="$2">
                  <AlertTriangle size={16} color="$red10" />
                  <AlertDescription>
                    <Text color="$red10">{error}</Text>
                  </AlertDescription>
                </XStack>
              </Alert>
            )}

            {/* Avatar */}
            <Card elevate>
              <CardHeader>
                <CardTitle>{t('profile.profilePicture.title')}</CardTitle>
                <CardDescription>{t('profile.profilePicture.description')}</CardDescription>
              </CardHeader>
              <CardContent>
                <XStack alignItems="center" space="$6">
                  <Avatar size="$10">
                    <AvatarImage src={avatarUrl} alt={formData.name} />
                    <AvatarFallback>
                      <Text fontSize="$6" fontWeight="bold">
                        {formData.name.split(' ').map(n => n[0]).join('')}
                      </Text>
                    </AvatarFallback>
                  </Avatar>
                  <YStack>
                    <Label htmlFor="avatar" cursor="pointer">
                      <XStack alignItems="center" space="$2" marginBottom="$1">
                        <Upload size={16} color="$blue10" />
                        <Text color="$blue10" fontWeight="500" hoverStyle={{ color: '$blue9' }}>
                          {t('profile.profilePicture.uploadButton')}
                        </Text>
                      </XStack>
                      <Input
                        id="avatar"
                        type="file"
                        accept="image/*"
                        display="none"
                        onChange={handleAvatarUpload}
                      />
                    </Label>
                    <Text fontSize="$2" color="$gray10">
                      {t('profile.profilePicture.fileRequirements')}
                    </Text>
                  </YStack>
                </XStack>
              </CardContent>
            </Card>

            {/* Personal Information */}
            <Card elevate>
              <CardHeader>
                <CardTitle>{t('profile.personalInfo.title')}</CardTitle>
                <CardDescription>{t('profile.personalInfo.description')}</CardDescription>
              </CardHeader>
              <CardContent space="$4">
                <XStack flexWrap="wrap" gap="$4">
                  <YStack space="$2" flex={1} minWidth={200}>
                    <Label htmlFor="name">{t('profile.personalInfo.fullName')}</Label>
                    <XStack position="relative">
                      <XStack 
                        position="absolute" 
                        left="$3" 
                        top="50%" 
                        transform="translateY(-50%)" 
                        zIndex={1}
                      >
                        <User size={16} color="$gray10" />
                      </XStack>
                      <Input
                        id="name"
                        value={formData.name}
                        onChange={(e) => setFormData(prev => ({ ...prev, name: e.target.value }))}
                        paddingLeft="$10"
                        width="100%"
                      />
                    </XStack>
                  </YStack>

                  <YStack space="$2" flex={1} minWidth={200}>
                    <Label htmlFor="email">{t('profile.personalInfo.email')}</Label>
                    <XStack position="relative">
                      <XStack 
                        position="absolute" 
                        left="$3" 
                        top="50%" 
                        transform="translateY(-50%)" 
                        zIndex={1}
                      >
                        <Mail size={16} color="$gray10" />
                      </XStack>
                      <Input
                        id="email"
                        type="email"
                        value={formData.email}
                        onChange={(e) => setFormData(prev => ({ ...prev, email: e.target.value }))}
                        paddingLeft="$10"
                        width="100%"
                        disabled
                      />
                    </XStack>
                    <Text fontSize="$1" color="$gray10">
                      {t('profile.personalInfo.emailCannotChange')}
                    </Text>
                  </YStack>
                </XStack>

                <YStack space="$2">
                  <Label htmlFor="bio">{t('profile.personalInfo.bio')}</Label>
                  <TextArea
                    id="bio"
                    value={formData.bio}
                    onChange={(e) => setFormData(prev => ({ ...prev, bio: e.target.value }))}
                    placeholder={t('profile.personalInfo.bioPlaceholder')}
                    numberOfLines={4}
                    width="100%"
                  />
                  <Text fontSize="$1" color="$gray10">
                    {t('profile.personalInfo.bioLimit')}
                  </Text>
                </YStack>

                <XStack flexWrap="wrap" gap="$4">
                  <YStack space="$2" flex={1} minWidth={200}>
                    <Label htmlFor="location">{t('profile.personalInfo.location')}</Label>
                    <Input
                      id="location"
                      value={formData.location}
                      onChange={(e) => setFormData(prev => ({ ...prev, location: e.target.value }))}
                      placeholder={t('profile.personalInfo.locationPlaceholder')}
                      width="100%"
                    />
                  </YStack>

                  <YStack space="$2" flex={1} minWidth={200}>
                    <Label htmlFor="company">{t('profile.personalInfo.company')}</Label>
                    <Input
                      id="company"
                      value={formData.company}
                      onChange={(e) => setFormData(prev => ({ ...prev, company: e.target.value }))}
                      placeholder={t('profile.personalInfo.companyPlaceholder')}
                      width="100%"
                    />
                  </YStack>
                </XStack>

                <YStack space="$2">
                  <Label htmlFor="website">{t('profile.personalInfo.website')}</Label>
                  <Input
                    id="website"
                    type="url"
                    value={formData.website}
                    onChange={(e) => setFormData(prev => ({ ...prev, website: e.target.value }))}
                    placeholder={t('profile.personalInfo.websitePlaceholder')}
                    width="100%"
                  />
                </YStack>
              </CardContent>
            </Card>

            <XStack justifyContent="flex-end" space="$2">
              <Button variant="outlined">
                {t('common.cancel')}
              </Button>
              <Button theme="accent" disabled={isLoading} type="submit">
                <XStack space="$2" alignItems="center">
                  {isLoading ? (
                    <>
                      <Loader2 size={16} color="$color" className="animate-spin" />
                      <Text>{t('profile.saving')}</Text>
                    </>
                  ) : (
                    <>
                      <Save size={16} />
                      <Text>{t('profile.saveChanges')}</Text>
                    </>
                  )}
                </XStack>
              </Button>
            </XStack>
          </YStack>
        </TabsContent>
        
        <TabsContent value="account">
          <YStack space="$6" marginTop="$6">
            <Card elevate>
              <CardHeader>
                <CardTitle>{t('profile.account.title')}</CardTitle>
                <CardDescription>{t('profile.account.description')}</CardDescription>
              </CardHeader>
              <CardContent space="$4">
                <YStack space="$4">
                  <XStack justifyContent="space-between" alignItems="center">
                    <YStack>
                      <Text fontWeight="500">{t('profile.account.email')}</Text>
                      <Text fontSize="$2" color="$gray10">{formData.email}</Text>
                    </YStack>
                    <Button variant="outlined" size="$3">
                      {t('profile.account.changeEmail')}
                    </Button>
                  </XStack>

                  <XStack justifyContent="space-between" alignItems="center">
                    <YStack>
                      <Text fontWeight="500">{t('profile.account.password')}</Text>
                      <Text fontSize="$2" color="$gray10">••••••••</Text>
                    </YStack>
                    <Button variant="outlined" size="$3">
                      {t('profile.account.changePassword')}
                    </Button>
                  </XStack>

                  <XStack justifyContent="space-between" alignItems="center">
                    <YStack>
                      <Text fontWeight="500">{t('profile.account.twoFactor')}</Text>
                      <Text fontSize="$2" color="$gray10">{t('profile.account.twoFactorDescription')}</Text>
                    </YStack>
                    <Button variant="outlined" size="$3">
                      {t('profile.account.enable2FA')}
                    </Button>
                  </XStack>
                </YStack>
              </CardContent>
            </Card>
          </YStack>
        </TabsContent>
        
        <TabsContent value="preferences">
          <YStack space="$6" marginTop="$6">
            <Card elevate>
              <CardHeader>
                <CardTitle>{t('profile.preferences.title')}</CardTitle>
                <CardDescription>{t('profile.preferences.description')}</CardDescription>
              </CardHeader>
              <CardContent space="$4">
                <YStack space="$4">
                  <XStack justifyContent="space-between" alignItems="center">
                    <YStack>
                      <Text fontWeight="500">{t('profile.preferences.emailNotifications')}</Text>
                      <Text fontSize="$2" color="$gray10">{t('profile.preferences.emailNotificationsDescription')}</Text>
                    </YStack>
                    <Switch 
                      checked={emailNotifications} 
                      onCheckedChange={setEmailNotifications}
                      size="$3"
                    />
                  </XStack>

                  <XStack justifyContent="space-between" alignItems="center">
                    <YStack>
                      <Text fontWeight="500">{t('profile.preferences.marketingEmails')}</Text>
                      <Text fontSize="$2" color="$gray10">{t('profile.preferences.marketingEmailsDescription')}</Text>
                    </YStack>
                    <Switch 
                      checked={marketingEmails} 
                      onCheckedChange={setMarketingEmails}
                      size="$3"
                    />
                  </XStack>

                  <XStack justifyContent="space-between" alignItems="center">
                    <YStack>
                      <Text fontWeight="500">{t('profile.preferences.pushNotifications')}</Text>
                      <Text fontSize="$2" color="$gray10">{t('profile.preferences.pushNotificationsDescription')}</Text>
                    </YStack>
                    <Switch 
                      checked={pushNotifications} 
                      onCheckedChange={setPushNotifications}
                      size="$3"
                    />
                  </XStack>
                </YStack>
              </CardContent>
            </Card>
          </YStack>
        </TabsContent>
      </Tabs>
    </YStack>
  );
};