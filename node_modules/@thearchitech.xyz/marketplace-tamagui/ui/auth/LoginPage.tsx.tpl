'use client';

import React, { useState } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { useTranslation } from '@/lib/i18n';
import { 
  YStack, 
  XStack, 
  Button, 
  Input, 
  Label, 
  Card, 
  CardContent, 
  CardDescription, 
  CardHeader, 
  CardTitle,
  Alert, 
  AlertDescription,
  Checkbox,
  Separator,
  Text,
  Theme
} from 'tamagui';
import { 
  Mail, 
  Lock, 
  Eye, 
  EyeOff, 
  Loader2,
  Github,
  Chrome,
  AlertCircle,
  Check
} from 'lucide-react-native';
import { useAuthService } from '@/lib/auth/hooks';

interface LoginPageProps {
  onSuccess?: () => void;
  redirectTo?: string;
  className?: string;
}

export default function LoginPage({
  onSuccess,
  redirectTo = '/dashboard',
  className = '',
}: LoginPageProps) {
  const { t } = useTranslation();
  const router = useRouter();
  const { useSession, signIn } = useAuthService();
  const { data: session } = useSession();
  
  const [formData, setFormData] = useState({
    email: '',
    password: '',
    rememberMe: false,
  });
  const [showPassword, setShowPassword] = useState(false);
  const [formErrors, setFormErrors] = useState<Record<string, string>>({});
  const [isLoading, setIsLoading] = useState(false);

  const handleInputChange = (field: string, value: string | boolean) => {
    setFormData(prev => ({
      ...prev,
      [field]: value,
    }));

    // Clear error when user starts typing
    if (formErrors[field]) {
      setFormErrors(prev => ({
        ...prev,
        [field]: '',
      }));
    }
  };

  const validateForm = (): boolean => {
    const errors: Record<string, string> = {};

    if (!formData.email) {
      errors.email = t('auth.errors.emailRequired');
    } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email)) {
      errors.email = t('auth.errors.emailInvalid');
    }

    if (!formData.password) {
      errors.password = t('auth.errors.passwordRequired');
    } else if (formData.password.length < 6) {
      errors.password = t('auth.errors.passwordLength');
    }

    setFormErrors(errors);
    return Object.keys(errors).length === 0;
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!validateForm()) {
      return;
    }

    setIsLoading(true);
    try {
      await signIn.email.mutateAsync({
        email: formData.email,
        password: formData.password,
        rememberMe: formData.rememberMe,
      });
      onSuccess?.();
      router.push(redirectTo);
    } catch (err: any) {
      setFormErrors({ general: err.message || t('auth.errors.signInFailed') });
    } finally {
      setIsLoading(false);
    }
  };

  const handleSocialLogin = async (provider: 'google' | 'github') => {
    try {
      setIsLoading(true);
      await signIn.social.mutateAsync({ 
        provider, 
        callbackURL: redirectTo 
      });
    } catch (err: any) {
      setFormErrors({ 
        general: err.message || t('auth.errors.socialSignInFailed', { provider }) 
      });
    } finally {
      setIsLoading(false);
    }
  };

  // Get available social providers
  const providers = [
    { id: 'google', name: 'Google' },
    { id: 'github', name: 'GitHub' }
  ];

  return (
    <YStack 
      minHeight="100vh" 
      alignItems="center" 
      justifyContent="center" 
      backgroundColor="$gray2" 
      paddingVertical="$12" 
      paddingHorizontal="$4"
    >
      <YStack maxWidth={400} width="100%" space="$8">
        <YStack alignItems="center">
          <Text fontSize="$6" fontWeight="bold" color="$gray12">
            {t('auth.signInTitle')}
          </Text>
          <Text marginTop="$2" fontSize="$2" color="$gray10">
            {t('auth.orCreateAccount')}{' '}
            <Text 
              tag="a" 
              href="/auth/signup" 
              color="$blue10" 
              fontWeight="500" 
              hoverStyle={{ color: '$blue9' }}
            >
              {t('auth.createNewAccount')}
            </Text>
          </Text>
        </YStack>

        <Card elevate>
          <CardHeader>
            <CardTitle>{t('auth.welcomeBack')}</CardTitle>
            <CardDescription>
              {t('auth.enterCredentials')}
            </CardDescription>
          </CardHeader>
          <CardContent space="$6">
            {/* Error Alert */}
            {formErrors.general && (
              <Alert backgroundColor="$red2" borderColor="$red6">
                <XStack alignItems="center" space="$2">
                  <AlertCircle size={16} color="$red10" />
                  <AlertDescription>
                    <Text color="$red10">{formErrors.general}</Text>
                  </AlertDescription>
                </XStack>
              </Alert>
            )}

            {/* Social Login */}
            {providers.length > 0 && (
              <YStack space="$3">
                {providers.map((provider) => (
                  <Button
                    key={provider.id}
                    variant="outlined"
                    width="100%"
                    onPress={() => handleSocialLogin(provider.id as 'google' | 'github')}
                    disabled={isLoading}
                  >
                    <XStack alignItems="center" space="$2">
                      {provider.id === 'google' && <Chrome size={16} />}
                      {provider.id === 'github' && <Github size={16} />}
                      <Text>{t('auth.continueWith', { provider: provider.name })}</Text>
                    </XStack>
                  </Button>
                ))}
                
                <XStack alignItems="center" justifyContent="center" position="relative">
                  <Separator width="100%" position="absolute" />
                  <YStack backgroundColor="$background" paddingHorizontal="$2">
                    <Text fontSize="$1" color="$gray10" textTransform="uppercase">
                      {t('auth.orContinueWith')}
                    </Text>
                  </YStack>
                </XStack>
              </YStack>
            )}

            {/* Login Form */}
            <YStack tag="form" onSubmit={handleSubmit} space="$4">
              <YStack>
                <Label htmlFor="email">{t('auth.email')}</Label>
                <XStack position="relative">
                  <XStack 
                    position="absolute" 
                    left="$3" 
                    top="50%" 
                    transform="translateY(-50%)" 
                    zIndex={1}
                  >
                    <Mail size={16} color="$gray10" />
                  </XStack>
                  <Input
                    id="email"
                    type="email"
                    placeholder={t('auth.emailPlaceholder')}
                    value={formData.email}
                    onChange={(e) => handleInputChange('email', e.target.value)}
                    paddingLeft="$10"
                    width="100%"
                    borderColor={formErrors.email ? '$red10' : undefined}
                    required
                  />
                </XStack>
                {formErrors.email && (
                  <Text fontSize="$2" color="$red10" marginTop="$1">{formErrors.email}</Text>
                )}
              </YStack>

              <YStack>
                <Label htmlFor="password">{t('auth.password')}</Label>
                <XStack position="relative">
                  <XStack 
                    position="absolute" 
                    left="$3" 
                    top="50%" 
                    transform="translateY(-50%)" 
                    zIndex={1}
                  >
                    <Lock size={16} color="$gray10" />
                  </XStack>
                  <Input
                    id="password"
                    type={showPassword ? 'text' : 'password'}
                    placeholder={t('auth.passwordPlaceholder')}
                    value={formData.password}
                    onChange={(e) => handleInputChange('password', e.target.value)}
                    paddingLeft="$10"
                    paddingRight="$10"
                    width="100%"
                    borderColor={formErrors.password ? '$red10' : undefined}
                    required
                  />
                  <XStack 
                    position="absolute" 
                    right="$3" 
                    top="50%" 
                    transform="translateY(-50%)" 
                    zIndex={1}
                  >
                    <Button
                      chromeless
                      onPress={() => setShowPassword(!showPassword)}
                      padding="$0"
                    >
                      {showPassword ? <EyeOff size={16} color="$gray10" /> : <Eye size={16} color="$gray10" />}
                    </Button>
                  </XStack>
                </XStack>
                {formErrors.password && (
                  <Text fontSize="$2" color="$red10" marginTop="$1">{formErrors.password}</Text>
                )}
              </YStack>

              <XStack alignItems="center" justifyContent="space-between">
                <XStack alignItems="center" space="$2">
                  <Checkbox
                    id="rememberMe"
                    checked={formData.rememberMe}
                    onCheckedChange={(checked) => handleInputChange('rememberMe', !!checked)}
                    size="$2"
                  >
                    <Checkbox.Indicator>
                      <Theme name="accent">
                        <XStack alignItems="center" justifyContent="center">
                          <Check size={12} color="$color" />
                        </XStack>
                      </Theme>
                    </Checkbox.Indicator>
                  </Checkbox>
                  <Label htmlFor="rememberMe" fontSize="$2">
                    {t('auth.rememberMe')}
                  </Label>
                </XStack>
                <Text 
                  tag="a" 
                  href="/auth/forgot-password" 
                  fontSize="$2" 
                  color="$blue10" 
                  hoverStyle={{ color: '$blue9' }}
                >
                  {t('auth.forgotPassword')}
                </Text>
              </XStack>

              <Button
                type="submit"
                width="100%"
                theme="accent"
                disabled={isLoading}
              >
                <XStack alignItems="center" space="$2">
                  {isLoading ? (
                    <>
                      <Loader2 size={16} color="$color" className="animate-spin" />
                      <Text>{t('auth.signingIn')}</Text>
                    </>
                  ) : (
                    <Text>{t('auth.signIn')}</Text>
                  )}
                </XStack>
              </Button>
            </YStack>

            <YStack alignItems="center">
              <Text fontSize="$2" color="$gray10">
                {t('auth.dontHaveAccount')}{' '}
                <Text 
                  tag="a" 
                  href="/auth/signup" 
                  color="$blue10" 
                  fontWeight="500" 
                  hoverStyle={{ color: '$blue9' }}
                >
                  {t('auth.signUp')}
                </Text>
              </Text>
            </YStack>
          </CardContent>
        </Card>
      </YStack>
    </YStack>
  );
}
