'use client';

import React, { useState } from 'react';
import { 
  YStack, 
  XStack, 
  Button, 
  Text,
  Card,
  CardHeader,
  CardContent,
  CardDescription,
  Input,
  Label,
  Switch,
  Select,
  Tabs,
  TabsContent,
  TabsList,
  TabsTrigger,
  Alert,
  Theme,
  Square
} from 'tamagui';
import { 
  Settings, 
  Lock, 
  Bell, 
  Shield, 
  Trash2,
  Save,
  Loader2,
  CheckCircle,
  AlertTriangle
} from 'lucide-react-native';
import { useTranslation } from '@/lib/i18n';

export default function SettingsPage() {
  const { t } = useTranslation();
  const [settings, setSettings] = useState({
    // Security settings
    twoFactorEnabled: false,
    sessionTimeout: '30',
    passwordExpiration: 'never',
    
    // Notification settings
    emailNotifications: true,
    pushNotifications: true,
    marketingEmails: false,
    securityAlerts: true,
    
    // Privacy settings
    profileVisibility: 'public',
    showEmail: false,
    showLocation: true,
    
    // Preferences
    language: 'en',
    timezone: 'UTC',
    theme: 'system'
  });

  const [isLoading, setIsLoading] = useState(false);
  const [success, setSuccess] = useState(false);
  const [error, setError] = useState('');

  const handleSave = async () => {
    setError('');
    setSuccess(false);
    setIsLoading(true);

    try {
      // Simulate API call
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      setSuccess(true);
      setTimeout(() => setSuccess(false), 3000);
    } catch (err) {
      setError(t('auth.settings.errors.saveFailed'));
    } finally {
      setIsLoading(false);
    }
  };

  const handleDeleteAccount = () => {
    if (confirm(t('auth.settings.dangerZone.confirmDelete'))) {
      console.log('Delete account');
    }
  };

  return (
    <YStack maxWidth={1000} marginHorizontal="auto" padding="$6" space="$6">
      <YStack>
        <Text fontSize="$7" fontWeight="$8">
          {t('auth.settings.title')}
        </Text>
        <Text color="$gray10">
          {t('auth.settings.subtitle')}
        </Text>
      </YStack>

      {success && (
        <Alert theme="green">
          <XStack alignItems="center" gap="$2">
            <CheckCircle size={16} color="$green10" />
            <Text color="$green10">
              {t('auth.settings.success')}
            </Text>
          </XStack>
        </Alert>
      )}

      {error && (
        <Alert theme="red">
          <XStack alignItems="center" gap="$2">
            <AlertTriangle size={16} color="$red10" />
            <Text color="$red10">{error}</Text>
          </XStack>
        </Alert>
      )}

      <Tabs defaultValue="security">
        <TabsList>
          <TabsTrigger value="security">
            {t('auth.settings.sections.security')}
          </TabsTrigger>
          <TabsTrigger value="notifications">
            {t('auth.settings.sections.notifications')}
          </TabsTrigger>
          <TabsTrigger value="privacy">
            {t('auth.settings.sections.privacy')}
          </TabsTrigger>
          <TabsTrigger value="preferences">
            {t('auth.settings.sections.preferences')}
          </TabsTrigger>
        </TabsList>
        
        <TabsContent value="security">
          <YStack space="$6" marginTop="$4">
            <Card elevate>
              <CardHeader>
                <XStack alignItems="center" gap="$2">
                  <Shield size={20} />
                  <Text fontSize="$5" fontWeight="$6">
                    {t('auth.settings.security.title')}
                  </Text>
                </XStack>
                <Text fontSize="$2" color="$gray11">
                  {t('auth.settings.security.description')}
                </Text>
              </CardHeader>
              <CardContent space="$6">
                <XStack alignItems="center" justifyContent="space-between">
                  <YStack>
                    <Text fontWeight="$5">
                      {t('auth.settings.security.twoFactor')}
                    </Text>
                    <Text fontSize="$2" color="$gray10">
                      {t('auth.settings.security.twoFactorDescription')}
                    </Text>
                  </YStack>
                  <Switch
                    checked={settings.twoFactorEnabled}
                    onCheckedChange={(checked) => setSettings(prev => ({ ...prev, twoFactorEnabled: !!checked }))}
                    size="$3"
                  >
                    <Switch.Thumb animation="quick" />
                  </Switch>
                </XStack>

                <YStack space="$2">
                  <Label htmlFor="sessionTimeout">
                    {t('auth.settings.security.sessionTimeout')}
                  </Label>
                  <Select
                    id="sessionTimeout"
                    value={settings.sessionTimeout}
                    onValueChange={(value) => setSettings(prev => ({ ...prev, sessionTimeout: value }))}
                  >
                    <Select.Trigger width="100%" id="sessionTimeout">
                      <Select.Value placeholder={t('auth.settings.security.selectTimeout')} />
                    </Select.Trigger>
                    <Select.Content>
                      <Select.Item value="15">
                        <Select.ItemText>{t('auth.settings.security.minutes', { minutes: 15 })}</Select.ItemText>
                      </Select.Item>
                      <Select.Item value="30">
                        <Select.ItemText>{t('auth.settings.security.minutes', { minutes: 30 })}</Select.ItemText>
                      </Select.Item>
                      <Select.Item value="60">
                        <Select.ItemText>{t('auth.settings.security.hour', { hours: 1 })}</Select.ItemText>
                      </Select.Item>
                      <Select.Item value="never">
                        <Select.ItemText>{t('auth.settings.security.never')}</Select.ItemText>
                      </Select.Item>
                    </Select.Content>
                  </Select>
                  <Text fontSize="$1" color="$gray10">
                    {t('auth.settings.security.sessionTimeoutDescription')}
                  </Text>
                </YStack>

                <YStack space="$2">
                  <Label htmlFor="passwordExpiration">
                    {t('auth.settings.security.passwordExpiration')}
                  </Label>
                  <Select
                    id="passwordExpiration"
                    value={settings.passwordExpiration}
                    onValueChange={(value) => setSettings(prev => ({ ...prev, passwordExpiration: value }))}
                  >
                    <Select.Trigger width="100%" id="passwordExpiration">
                      <Select.Value placeholder={t('auth.settings.security.selectExpiration')} />
                    </Select.Trigger>
                    <Select.Content>
                      <Select.Item value="30">
                        <Select.ItemText>{t('auth.settings.security.days', { days: 30 })}</Select.ItemText>
                      </Select.Item>
                      <Select.Item value="60">
                        <Select.ItemText>{t('auth.settings.security.days', { days: 60 })}</Select.ItemText>
                      </Select.Item>
                      <Select.Item value="90">
                        <Select.ItemText>{t('auth.settings.security.days', { days: 90 })}</Select.ItemText>
                      </Select.Item>
                      <Select.Item value="never">
                        <Select.ItemText>{t('auth.settings.security.never')}</Select.ItemText>
                      </Select.Item>
                    </Select.Content>
                  </Select>
                  <Text fontSize="$1" color="$gray10">
                    {t('auth.settings.security.passwordExpirationDescription')}
                  </Text>
                </YStack>

                <XStack alignItems="center" justifyContent="space-between" paddingTop="$4" borderTopWidth={1} borderTopColor="$borderColor">
                  <YStack>
                    <Text fontWeight="$5">
                      {t('auth.settings.security.changePassword')}
                    </Text>
                    <Text fontSize="$2" color="$gray10">
                      {t('auth.settings.security.changePasswordDescription')}
                    </Text>
                  </YStack>
                  <Button chromeless bordered icon={<Lock size={16} />}>
                    <Text marginLeft="$2">
                      {t('auth.settings.security.changePasswordButton')}
                    </Text>
                  </Button>
                </XStack>
              </CardContent>
            </Card>
          </YStack>
        </TabsContent>
        
        <TabsContent value="notifications">
          <YStack space="$6" marginTop="$4">
            <Card elevate>
              <CardHeader>
                <XStack alignItems="center" gap="$2">
                  <Bell size={20} />
                  <Text fontSize="$5" fontWeight="$6">
                    {t('auth.settings.notifications.title')}
                  </Text>
                </XStack>
                <Text fontSize="$2" color="$gray11">
                  {t('auth.settings.notifications.description')}
                </Text>
              </CardHeader>
              <CardContent space="$6">
                <XStack alignItems="center" justifyContent="space-between">
                  <YStack>
                    <Text fontWeight="$5">
                      {t('auth.settings.notifications.emailNotifications')}
                    </Text>
                    <Text fontSize="$2" color="$gray10">
                      {t('auth.settings.notifications.emailDescription')}
                    </Text>
                  </YStack>
                  <Switch
                    checked={settings.emailNotifications}
                    onCheckedChange={(checked) => setSettings(prev => ({ ...prev, emailNotifications: !!checked }))}
                    size="$3"
                  >
                    <Switch.Thumb animation="quick" />
                  </Switch>
                </XStack>

                <XStack alignItems="center" justifyContent="space-between">
                  <YStack>
                    <Text fontWeight="$5">
                      {t('auth.settings.notifications.pushNotifications')}
                    </Text>
                    <Text fontSize="$2" color="$gray10">
                      {t('auth.settings.notifications.pushDescription')}
                    </Text>
                  </YStack>
                  <Switch
                    checked={settings.pushNotifications}
                    onCheckedChange={(checked) => setSettings(prev => ({ ...prev, pushNotifications: !!checked }))}
                    size="$3"
                  >
                    <Switch.Thumb animation="quick" />
                  </Switch>
                </XStack>

                <XStack alignItems="center" justifyContent="space-between">
                  <YStack>
                    <Text fontWeight="$5">
                      {t('auth.settings.notifications.marketingEmails')}
                    </Text>
                    <Text fontSize="$2" color="$gray10">
                      {t('auth.settings.notifications.marketingDescription')}
                    </Text>
                  </YStack>
                  <Switch
                    checked={settings.marketingEmails}
                    onCheckedChange={(checked) => setSettings(prev => ({ ...prev, marketingEmails: !!checked }))}
                    size="$3"
                  >
                    <Switch.Thumb animation="quick" />
                  </Switch>
                </XStack>

                <XStack alignItems="center" justifyContent="space-between">
                  <YStack>
                    <Text fontWeight="$5">
                      {t('auth.settings.notifications.securityAlerts')}
                    </Text>
                    <Text fontSize="$2" color="$gray10">
                      {t('auth.settings.notifications.securityAlertsDescription')}
                    </Text>
                  </YStack>
                  <Switch
                    checked={settings.securityAlerts}
                    onCheckedChange={(checked) => setSettings(prev => ({ ...prev, securityAlerts: !!checked }))}
                    size="$3"
                  >
                    <Switch.Thumb animation="quick" />
                  </Switch>
                </XStack>
              </CardContent>
            </Card>
          </YStack>
        </TabsContent>
        
        <TabsContent value="privacy">
          <YStack space="$6" marginTop="$4">
            <Card elevate>
              <CardHeader>
                <XStack alignItems="center" gap="$2">
                  <Lock size={20} />
                  <Text fontSize="$5" fontWeight="$6">
                    {t('auth.settings.privacy.title')}
                  </Text>
                </XStack>
                <Text fontSize="$2" color="$gray11">
                  {t('auth.settings.privacy.description')}
                </Text>
              </CardHeader>
              <CardContent space="$6">
                <YStack space="$2">
                  <Label htmlFor="profileVisibility">
                    {t('auth.settings.privacy.profileVisibility')}
                  </Label>
                  <Select
                    id="profileVisibility"
                    value={settings.profileVisibility}
                    onValueChange={(value) => setSettings(prev => ({ ...prev, profileVisibility: value }))}
                  >
                    <Select.Trigger width="100%" id="profileVisibility">
                      <Select.Value placeholder={t('auth.settings.privacy.selectVisibility')} />
                    </Select.Trigger>
                    <Select.Content>
                      <Select.Item value="public">
                        <Select.ItemText>{t('auth.settings.privacy.public')}</Select.ItemText>
                      </Select.Item>
                      <Select.Item value="private">
                        <Select.ItemText>{t('auth.settings.privacy.private')}</Select.ItemText>
                      </Select.Item>
                      <Select.Item value="friends">
                        <Select.ItemText>{t('auth.settings.privacy.friends')}</Select.ItemText>
                      </Select.Item>
                    </Select.Content>
                  </Select>
                  <Text fontSize="$1" color="$gray10">
                    {t('auth.settings.privacy.profileVisibilityDescription')}
                  </Text>
                </YStack>

                <XStack alignItems="center" justifyContent="space-between">
                  <YStack>
                    <Text fontWeight="$5">
                      {t('auth.settings.privacy.showEmail')}
                    </Text>
                    <Text fontSize="$2" color="$gray10">
                      {t('auth.settings.privacy.showEmailDescription')}
                    </Text>
                  </YStack>
                  <Switch
                    checked={settings.showEmail}
                    onCheckedChange={(checked) => setSettings(prev => ({ ...prev, showEmail: !!checked }))}
                    size="$3"
                  >
                    <Switch.Thumb animation="quick" />
                  </Switch>
                </XStack>

                <XStack alignItems="center" justifyContent="space-between">
                  <YStack>
                    <Text fontWeight="$5">
                      {t('auth.settings.privacy.showLocation')}
                    </Text>
                    <Text fontSize="$2" color="$gray10">
                      {t('auth.settings.privacy.showLocationDescription')}
                    </Text>
                  </YStack>
                  <Switch
                    checked={settings.showLocation}
                    onCheckedChange={(checked) => setSettings(prev => ({ ...prev, showLocation: !!checked }))}
                    size="$3"
                  >
                    <Switch.Thumb animation="quick" />
                  </Switch>
                </XStack>
              </CardContent>
            </Card>
          </YStack>
        </TabsContent>
        
        <TabsContent value="preferences">
          <YStack space="$6" marginTop="$4">
            <Card elevate>
              <CardHeader>
                <XStack alignItems="center" gap="$2">
                  <Settings size={20} />
                  <Text fontSize="$5" fontWeight="$6">
                    {t('auth.settings.preferences.title')}
                  </Text>
                </XStack>
                <Text fontSize="$2" color="$gray11">
                  {t('auth.settings.preferences.description')}
                </Text>
              </CardHeader>
              <CardContent space="$6">
                <YStack space="$2">
                  <Label htmlFor="language">
                    {t('auth.settings.preferences.language')}
                  </Label>
                  <Select
                    id="language"
                    value={settings.language}
                    onValueChange={(value) => setSettings(prev => ({ ...prev, language: value }))}
                  >
                    <Select.Trigger width="100%" id="language">
                      <Select.Value placeholder={t('auth.settings.preferences.selectLanguage')} />
                    </Select.Trigger>
                    <Select.Content>
                      <Select.Item value="en">
                        <Select.ItemText>English</Select.ItemText>
                      </Select.Item>
                      <Select.Item value="es">
                        <Select.ItemText>Español</Select.ItemText>
                      </Select.Item>
                      <Select.Item value="fr">
                        <Select.ItemText>Français</Select.ItemText>
                      </Select.Item>
                      <Select.Item value="de">
                        <Select.ItemText>Deutsch</Select.ItemText>
                      </Select.Item>
                    </Select.Content>
                  </Select>
                </YStack>

                <YStack space="$2">
                  <Label htmlFor="timezone">
                    {t('auth.settings.preferences.timezone')}
                  </Label>
                  <Select
                    id="timezone"
                    value={settings.timezone}
                    onValueChange={(value) => setSettings(prev => ({ ...prev, timezone: value }))}
                  >
                    <Select.Trigger width="100%" id="timezone">
                      <Select.Value placeholder={t('auth.settings.preferences.selectTimezone')} />
                    </Select.Trigger>
                    <Select.Content>
                      <Select.Item value="UTC">
                        <Select.ItemText>UTC</Select.ItemText>
                      </Select.Item>
                      <Select.Item value="EST">
                        <Select.ItemText>{t('auth.settings.preferences.easternTime')}</Select.ItemText>
                      </Select.Item>
                      <Select.Item value="PST">
                        <Select.ItemText>{t('auth.settings.preferences.pacificTime')}</Select.ItemText>
                      </Select.Item>
                      <Select.Item value="GMT">
                        <Select.ItemText>{t('auth.settings.preferences.greenwichTime')}</Select.ItemText>
                      </Select.Item>
                    </Select.Content>
                  </Select>
                </YStack>

                <YStack space="$2">
                  <Label htmlFor="theme">
                    {t('auth.settings.preferences.theme')}
                  </Label>
                  <Select
                    id="theme"
                    value={settings.theme}
                    onValueChange={(value) => setSettings(prev => ({ ...prev, theme: value }))}
                  >
                    <Select.Trigger width="100%" id="theme">
                      <Select.Value placeholder={t('auth.settings.preferences.selectTheme')} />
                    </Select.Trigger>
                    <Select.Content>
                      <Select.Item value="light">
                        <Select.ItemText>{t('auth.settings.preferences.light')}</Select.ItemText>
                      </Select.Item>
                      <Select.Item value="dark">
                        <Select.ItemText>{t('auth.settings.preferences.dark')}</Select.ItemText>
                      </Select.Item>
                      <Select.Item value="system">
                        <Select.ItemText>{t('auth.settings.preferences.system')}</Select.ItemText>
                      </Select.Item>
                    </Select.Content>
                  </Select>
                </YStack>
              </CardContent>
            </Card>

            <Card elevate borderColor="$red8">
              <CardHeader>
                <XStack alignItems="center" gap="$2">
                  <Trash2 size={20} color="$red10" />
                  <Text fontSize="$5" fontWeight="$6" color="$red10">
                    {t('auth.settings.dangerZone.title')}
                  </Text>
                </XStack>
                <Text fontSize="$2" color="$gray11">
                  {t('auth.settings.dangerZone.description')}
                </Text>
              </CardHeader>
              <CardContent>
                <XStack alignItems="center" justifyContent="space-between">
                  <YStack>
                    <Text fontWeight="$5">
                      {t('auth.settings.dangerZone.deleteAccount')}
                    </Text>
                    <Text fontSize="$2" color="$gray10">
                      {t('auth.settings.dangerZone.deleteAccountDescription')}
                    </Text>
                  </YStack>
                  <Button 
                    theme="red" 
                    onPress={handleDeleteAccount}
                    icon={<Trash2 size={16} />}
                  >
                    <Text marginLeft="$2">
                      {t('auth.settings.dangerZone.deleteAccountButton')}
                    </Text>
                  </Button>
                </XStack>
              </CardContent>
            </Card>
          </YStack>
        </TabsContent>
      </Tabs>

      <XStack justifyContent="flex-end" gap="$2">
        <Button chromeless bordered>
          {t('common.actions.cancel')}
        </Button>
        <Button 
          theme="accent" 
          onPress={handleSave} 
          disabled={isLoading}
          icon={isLoading ? 
            <Loader2 size={16} style={{ animation: 'spin 1s linear infinite' }} /> : 
            <Save size={16} />
          }
        >
          <Text marginLeft="$2">
            {isLoading ? 
              t('common.actions.saving') : 
              t('common.actions.saveChanges')
            }
          </Text>
        </Button>
      </XStack>
    </YStack>
  );
}

