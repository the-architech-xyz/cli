'use client';

import React, { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';
import { useTranslation } from '@/lib/i18n';
import { 
  YStack, 
  XStack, 
  Button, 
  Input, 
  Label, 
  Text,
  Card, 
  CardContent, 
  CardHeader, 
  CardTitle, 
  CardDescription,
  Alert, 
  AlertDescription,
  Theme,
  Square,
  Separator
} from 'tamagui';
import { 
  Mail, 
  ArrowLeft,
  CheckCircle,
  AlertCircle,
  Loader2,
  Send
} from 'lucide-react-native';

const forgotPasswordSchema = z.object({
  email: z.string().email('Please enter a valid email address'),
});

type ForgotPasswordFormData = z.infer<typeof forgotPasswordSchema>;

interface ForgotPasswordFormProps {
  onSubmit: (data: ForgotPasswordFormData) => Promise<void>;
  isLoading?: boolean;
  error?: string;
  success?: string;
  onBackToLogin?: () => void;
  className?: string;
}

export const ForgotPasswordForm: React.FC<ForgotPasswordFormProps> = ({
  onSubmit,
  isLoading = false,
  error,
  success,
  onBackToLogin,
  className = '',
}) => {
  const { t } = useTranslation();
  const [isSubmitted, setIsSubmitted] = useState(false);

  const {
    register,
    handleSubmit,
    formState: { errors },
    watch,
  } = useForm<ForgotPasswordFormData>({
    resolver: zodResolver(forgotPasswordSchema),
  });

  const email = watch('email', '');

  const handleFormSubmit = async (data: ForgotPasswordFormData) => {
    try {
      await onSubmit(data);
      setIsSubmitted(true);
    } catch (error) {
      console.error('Password reset request failed:', error);
    }
  };

  if (isSubmitted && success) {
    return (
      <Card width="100%" maxWidth={400} marginHorizontal="auto" elevate>
        <CardHeader alignItems="center">
          <YStack alignItems="center" marginBottom="$4">
            <Theme name="green">
              <Square size="$6" backgroundColor="$backgroundHover" borderRadius="$full" alignItems="center" justifyContent="center">
                <CheckCircle size={24} color="$green10" />
              </Square>
            </Theme>
          </YStack>
          <CardTitle>{t('auth.forgotPassword.checkEmail')}</CardTitle>
          <CardDescription>
            {t('auth.forgotPassword.resetInstructions')}
          </CardDescription>
        </CardHeader>

        <CardContent space="$6">
          <Alert backgroundColor="$green2" borderColor="$green6">
            <XStack alignItems="center" space="$2">
              <CheckCircle size={16} color="$green10" />
              <AlertDescription>
                <Text>
                  {t('auth.forgotPassword.emailSentTo', { email: <Text fontWeight="bold">{email}</Text> })}
                </Text>
              </AlertDescription>
            </XStack>
          </Alert>

          <YStack alignItems="center" space="$4">
            <Text size="$2" color="$gray10">
              {t('auth.forgotPassword.didntReceive')}
            </Text>
            
            <YStack space="$2" width="100%">
              <Button
                variant="outlined"
                width="100%"
                onPress={() => setIsSubmitted(false)}
              >
                <Text>{t('auth.forgotPassword.tryDifferentEmail')}</Text>
              </Button>
              
              {onBackToLogin && (
                <Button
                  variant="ghost"
                  width="100%"
                  onPress={onBackToLogin}
                >
                  <XStack alignItems="center" space="$2">
                    <ArrowLeft size={16} />
                    <Text>{t('auth.backToLogin')}</Text>
                  </XStack>
                </Button>
              )}
            </YStack>
          </YStack>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card width="100%" maxWidth={400} marginHorizontal="auto" elevate>
      <CardHeader alignItems="center">
        <CardTitle>{t('auth.forgotPassword.title')}</CardTitle>
        <CardDescription>
          {t('auth.forgotPassword.description')}
        </CardDescription>
      </CardHeader>

      <CardContent space="$6">
        {/* Error Message */}
        {error && (
          <Alert backgroundColor="$red2" borderColor="$red6">
            <XStack alignItems="center" space="$2">
              <AlertCircle size={16} color="$red10" />
              <AlertDescription>
                <Text color="$red10">{error}</Text>
              </AlertDescription>
            </XStack>
          </Alert>
        )}

        {/* Success Message */}
        {success && !isSubmitted && (
          <Alert backgroundColor="$green2" borderColor="$green6">
            <XStack alignItems="center" space="$2">
              <CheckCircle size={16} color="$green10" />
              <AlertDescription>
                <Text color="$green10">{success}</Text>
              </AlertDescription>
            </XStack>
          </Alert>
        )}

        {/* Forgot Password Form */}
        <YStack tag="form" onSubmit={handleSubmit(handleFormSubmit)} space="$4">
          <YStack>
            <Label htmlFor="email">{t('auth.email')}</Label>
            <XStack position="relative">
              <XStack 
                position="absolute" 
                left="$3" 
                top="$3" 
                alignItems="center" 
                justifyContent="center" 
                zIndex={1}
              >
                <Mail size={16} color="$gray10" />
              </XStack>
              <Input
                id="email"
                type="email"
                placeholder={t('auth.emailPlaceholder')}
                paddingLeft="$10"
                width="100%"
                {...register('email')}
                disabled={isLoading}
                autoFocus
              />
            </XStack>
            {errors.email && (
              <Text size="$2" color="$red10" marginTop="$1">{errors.email.message}</Text>
            )}
          </YStack>

          <Button
            type="submit"
            width="100%"
            theme="accent"
            disabled={isLoading}
          >
            <XStack alignItems="center" space="$2">
              {isLoading ? (
                <>
                  <Loader2 size={16} color="$color" />
                  <Text>{t('auth.forgotPassword.sendingResetLink')}</Text>
                </>
              ) : (
                <>
                  <Send size={16} color="$color" />
                  <Text>{t('auth.forgotPassword.sendResetLink')}</Text>
                </>
              )}
            </XStack>
          </Button>
        </YStack>

        {/* Additional Help */}
        <YStack alignItems="center" space="$4">
          <YStack alignItems="center">
            <Text size="$2" color="$gray10">
              {t('auth.forgotPassword.rememberPassword')}
            </Text>
            {onBackToLogin && (
              <Button
                variant="link"
                padding="$0"
                height="auto"
                onPress={onBackToLogin}
              >
                <XStack alignItems="center" space="$1">
                  <ArrowLeft size={16} color="$blue10" />
                  <Text color="$blue10">{t('auth.backToLogin')}</Text>
                </XStack>
              </Button>
            )}
          </YStack>

          <YStack width="100%">
            <Separator marginVertical="$2" />
            <Text size="$1" color="$gray10" textAlign="center">
              {t('auth.forgotPassword.havingTrouble')}{' '}
              <Text color="$blue10" textDecorationLine="underline" tag="a" href="/support">
                {t('auth.forgotPassword.supportTeam')}
              </Text>
            </Text>
          </YStack>
        </YStack>
      </CardContent>
    </Card>
  );
};


