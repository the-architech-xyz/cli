/**
 * Reset Password Form Component (Tamagui)
 * 
 * Password reset form with i18n support
 */

import React, { useState } from 'react';
import { YStack, XStack, Card, Text, Button, Input, Label, Progress } from 'tamagui';
import { useForm, Controller } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';
import { useTranslation } from '@/lib/i18n';
import { 
  Lock, 
  Eye, 
  EyeOff,
  CheckCircle,
  AlertCircle,
  Shield,
  ArrowRight
} from '@tamagui/lucide-icons';
import { Spinner } from 'tamagui';

const resetPasswordSchema = z.object({
  password: z.string()
    .min(8, 'Password must be at least 8 characters')
    .regex(/[A-Z]/, 'Password must contain at least one uppercase letter')
    .regex(/[a-z]/, 'Password must contain at least one lowercase letter')
    .regex(/[0-9]/, 'Password must contain at least one number')
    .regex(/[^A-Za-z0-9]/, 'Password must contain at least one special character'),
  confirmPassword: z.string(),
}).refine((data) => data.password === data.confirmPassword, {
  message: "Passwords don't match",
  path: ["confirmPassword"],
});

type ResetPasswordFormData = z.infer<typeof resetPasswordSchema>;

interface ResetPasswordFormProps {
  token: string;
  onSubmit: (data: ResetPasswordFormData & { token: string }) => Promise<void>;
  isLoading?: boolean;
  error?: string;
  success?: string;
  onSuccess?: () => void;
}

export function ResetPasswordForm({
  token,
  onSubmit,
  isLoading = false,
  error,
  success,
  onSuccess,
}: ResetPasswordFormProps) {
  const { t } = useTranslation();
  const [showPassword, setShowPassword] = useState(false);
  const [showConfirmPassword, setShowConfirmPassword] = useState(false);
  const [isSubmitted, setIsSubmitted] = useState(false);

  const {
    control,
    handleSubmit,
    formState: { errors, isValid },
    watch,
  } = useForm<ResetPasswordFormData>({
    resolver: zodResolver(resetPasswordSchema),
    mode: 'onChange',
  });

  const password = watch('password', '');

  const getPasswordStrength = (password: string): { score: number; label: string; color: string } => {
    let score = 0;
    if (password.length >= 8) score++;
    if (/[A-Z]/.test(password)) score++;
    if (/[a-z]/.test(password)) score++;
    if (/[0-9]/.test(password)) score++;
    if (/[^A-Za-z0-9]/.test(password)) score++;

    const strengthMap = {
      0: { label: t('password.strength.veryWeak'), color: '$red10' },
      1: { label: t('password.strength.weak'), color: '$red9' },
      2: { label: t('password.strength.fair'), color: '$yellow10' },
      3: { label: t('password.strength.good'), color: '$blue10' },
      4: { label: t('password.strength.strong'), color: '$green9' },
      5: { label: t('password.strength.veryStrong'), color: '$green10' },
    };

    return { score, ...strengthMap[score as keyof typeof strengthMap] };
  };

  const passwordStrength = getPasswordStrength(password);

  const handleFormSubmit = async (data: ResetPasswordFormData) => {
    try {
      await onSubmit({ ...data, token });
      setIsSubmitted(true);
      onSuccess?.();
    } catch (error) {
      console.error('Password reset failed:', error);
    }
  };

  if (isSubmitted && success) {
    return (
      <Card
        theme="base"
        size="$4"
        padding="$0"
        backgroundColor="$background"
        borderWidth={1}
        borderColor="$borderColor"
        borderRadius="$6"
        elevation="$2"
        width="100%"
        maxWidth={400}
        alignSelf="center"
      >
        <YStack padding="$6" alignItems="center" gap="$4">
          <XStack
            width="$4"
            height="$4"
            borderRadius="$full"
            backgroundColor="$green2"
            alignItems="center"
            justifyContent="center"
            marginBottom="$2"
          >
            <CheckCircle size="$1" color="$green10" />
          </XStack>
          <Text fontSize="$6" fontWeight="bold" color="$color" textAlign="center">
            {t('password.reset.successTitle')}
          </Text>
          <Text fontSize="$3" color="$colorFocus" textAlign="center">
            {t('password.reset.successDescription')}
          </Text>
        </YStack>

        <YStack padding="$6" paddingTop="$0" gap="$6">
          <XStack
            backgroundColor="$green2"
            borderWidth={1}
            borderColor="$green6"
            borderRadius="$4"
            padding="$4"
            gap="$3"
            alignItems="center"
          >
            <CheckCircle size="$1" color="$green10" />
            <Text fontSize="$3" color="$green10">
              {t('password.reset.loginPrompt')}
            </Text>
          </XStack>

          <Button
            theme="accent"
            size="$4"
            backgroundColor="$blue10"
            color="white"
            borderRadius="$4"
            onPress={() => window.location.href = '/login'}
          >
            <XStack gap="$2" alignItems="center">
              <Text fontSize="$4" fontWeight="bold" color="white">
                {t('password.reset.continueToLogin')}
              </Text>
              <ArrowRight size="$1" color="white" />
            </XStack>
          </Button>
        </YStack>
      </Card>
    );
  }

  return (
    <Card
      theme="base"
      size="$4"
      padding="$0"
      backgroundColor="$background"
      borderWidth={1}
      borderColor="$borderColor"
      borderRadius="$6"
      elevation="$2"
      width="100%"
      maxWidth={400}
      alignSelf="center"
    >
      <YStack padding="$6" alignItems="center" gap="$2">
        <XStack
          width="$4"
          height="$4"
          borderRadius="$full"
          backgroundColor="$blue2"
          alignItems="center"
          justifyContent="center"
          marginBottom="$2"
        >
          <Shield size="$1" color="$blue10" />
        </XStack>
        <Text fontSize="$6" fontWeight="bold" color="$color" textAlign="center">
          {t('password.reset.title')}
        </Text>
        <Text fontSize="$3" color="$colorFocus" textAlign="center">
          {t('password.reset.description')}
        </Text>
      </YStack>

      <YStack padding="$6" paddingTop="$0" gap="$6">
        {/* Error Message */}
        {error && (
          <XStack
            backgroundColor="$red2"
            borderWidth={1}
            borderColor="$red6"
            borderRadius="$4"
            padding="$4"
            gap="$3"
            alignItems="center"
          >
            <AlertCircle size="$1" color="$red10" />
            <Text fontSize="$3" color="$red10">
              {error}
            </Text>
          </XStack>
        )}

        {/* Success Message */}
        {success && !isSubmitted && (
          <XStack
            backgroundColor="$green2"
            borderWidth={1}
            borderColor="$green6"
            borderRadius="$4"
            padding="$4"
            gap="$3"
            alignItems="center"
          >
            <CheckCircle size="$1" color="$green10" />
            <Text fontSize="$3" color="$green10">
              {success}
            </Text>
          </XStack>
        )}

        {/* Reset Password Form */}
        <YStack asChild gap="$4">
          <form onSubmit={handleSubmit(handleFormSubmit)}>
            {/* New Password */}
            <YStack gap="$2">
              <Label htmlFor="password" fontSize="$4" color="$color">
                {t('password.reset.newPassword')}
              </Label>
              <XStack position="relative">
                <Lock 
                  size="$1" 
                  color="$colorFocus" 
                  position="absolute" 
                  left="$3" 
                  top="50%" 
                  transform="translateY(-50%)" 
                />
                <Controller
                  control={control}
                  name="password"
                  render={({ field }) => (
                    <Input
                      id="password"
                      value={field.value || ''}
                      onChangeText={field.onChange}
                      placeholder={t('password.reset.newPasswordPlaceholder')}
                      backgroundColor="$background"
                      color="$color"
                      borderWidth={1}
                      borderColor={errors.password ? '$red10' : '$borderColor'}
                      borderRadius="$4"
                      padding="$3"
                      paddingLeft="$8"
                      paddingRight="$8"
                      secureTextEntry={!showPassword}
                      disabled={isLoading}
                      flex={1}
                      autoFocus
                    />
                  )}
                />
                <Button
                  position="absolute"
                  right="$3"
                  top="50%"
                  transform="translateY(-50%)"
                  size="$2"
                  backgroundColor="transparent"
                  padding="$0"
                  onPress={() => setShowPassword(!showPassword)}
                  disabled={isLoading}
                >
                  {showPassword ? (
                    <EyeOff size="$1" color="$colorFocus" />
                  ) : (
                    <Eye size="$1" color="$colorFocus" />
                  )}
                </Button>
              </XStack>
              {errors.password && (
                <Text fontSize="$2" color="$red10">
                  {errors.password.message}
                </Text>
              )}
              
              {/* Password Strength Indicator */}
              {password && (
                <YStack gap="$1" marginTop="$2">
                  <XStack gap="$2" alignItems="center">
                    <YStack flex={1}>
                      <Progress value={(passwordStrength.score / 5) * 100}>
                        <Progress.Indicator backgroundColor={passwordStrength.color} />
                      </Progress>
                    </YStack>
                    <Text fontSize="$2" color="$colorFocus">
                      {passwordStrength.label}
                    </Text>
                  </XStack>
                </YStack>
              )}
            </YStack>

            {/* Confirm Password */}
            <YStack gap="$2">
              <Label htmlFor="confirmPassword" fontSize="$4" color="$color">
                {t('password.reset.confirmPassword')}
              </Label>
              <XStack position="relative">
                <Lock 
                  size="$1" 
                  color="$colorFocus" 
                  position="absolute" 
                  left="$3" 
                  top="50%" 
                  transform="translateY(-50%)" 
                />
                <Controller
                  control={control}
                  name="confirmPassword"
                  render={({ field }) => (
                    <Input
                      id="confirmPassword"
                      value={field.value || ''}
                      onChangeText={field.onChange}
                      placeholder={t('password.reset.confirmPasswordPlaceholder')}
                      backgroundColor="$background"
                      color="$color"
                      borderWidth={1}
                      borderColor={errors.confirmPassword ? '$red10' : '$borderColor'}
                      borderRadius="$4"
                      padding="$3"
                      paddingLeft="$8"
                      paddingRight="$8"
                      secureTextEntry={!showConfirmPassword}
                      disabled={isLoading}
                      flex={1}
                    />
                  )}
                />
                <Button
                  position="absolute"
                  right="$3"
                  top="50%"
                  transform="translateY(-50%)"
                  size="$2"
                  backgroundColor="transparent"
                  padding="$0"
                  onPress={() => setShowConfirmPassword(!showConfirmPassword)}
                  disabled={isLoading}
                >
                  {showConfirmPassword ? (
                    <EyeOff size="$1" color="$colorFocus" />
                  ) : (
                    <Eye size="$1" color="$colorFocus" />
                  )}
                </Button>
              </XStack>
              {errors.confirmPassword && (
                <Text fontSize="$2" color="$red10">
                  {errors.confirmPassword.message}
                </Text>
              )}
            </YStack>

            {/* Password Requirements */}
            <YStack
              backgroundColor="$gray2"
              padding="$4"
              borderRadius="$4"
              gap="$2"
            >
              <Text fontSize="$3" fontWeight="bold" color="$color" marginBottom="$1">
                {t('password.requirements.title')}
              </Text>
              <YStack gap="$1">
                <XStack gap="$2" alignItems="center">
                  <YStack
                    width="$1"
                    height="$1"
                    borderRadius="$full"
                    backgroundColor={password.length >= 8 ? '$green10' : '$gray5'}
                  />
                  <Text fontSize="$2" color="$colorFocus">
                    {t('password.requirements.length')}
                  </Text>
                </XStack>
                <XStack gap="$2" alignItems="center">
                  <YStack
                    width="$1"
                    height="$1"
                    borderRadius="$full"
                    backgroundColor={/[A-Z]/.test(password) ? '$green10' : '$gray5'}
                  />
                  <Text fontSize="$2" color="$colorFocus">
                    {t('password.requirements.uppercase')}
                  </Text>
                </XStack>
                <XStack gap="$2" alignItems="center">
                  <YStack
                    width="$1"
                    height="$1"
                    borderRadius="$full"
                    backgroundColor={/[a-z]/.test(password) ? '$green10' : '$gray5'}
                  />
                  <Text fontSize="$2" color="$colorFocus">
                    {t('password.requirements.lowercase')}
                  </Text>
                </XStack>
                <XStack gap="$2" alignItems="center">
                  <YStack
                    width="$1"
                    height="$1"
                    borderRadius="$full"
                    backgroundColor={/[0-9]/.test(password) ? '$green10' : '$gray5'}
                  />
                  <Text fontSize="$2" color="$colorFocus">
                    {t('password.requirements.number')}
                  </Text>
                </XStack>
                <XStack gap="$2" alignItems="center">
                  <YStack
                    width="$1"
                    height="$1"
                    borderRadius="$full"
                    backgroundColor={/[^A-Za-z0-9]/.test(password) ? '$green10' : '$gray5'}
                  />
                  <Text fontSize="$2" color="$colorFocus">
                    {t('password.requirements.special')}
                  </Text>
                </XStack>
              </YStack>
            </YStack>

            {/* Submit Button */}
            <Button
              theme="accent"
              size="$4"
              backgroundColor={isLoading || !isValid ? "$backgroundHover" : "$blue10"}
              color="white"
              borderRadius="$4"
              onPress={handleSubmit(handleFormSubmit)}
              disabled={isLoading || !isValid}
            >
              <XStack gap="$2" alignItems="center">
                {isLoading && <Spinner size="small" color="white" />}
                <Text fontSize="$4" fontWeight="bold" color="white">
                  {isLoading ? t('password.reset.updating') : t('password.reset.update')}
                </Text>
              </XStack>
            </Button>
          </form>
        </YStack>

        {/* Additional Help */}
        <YStack alignItems="center">
          <Text fontSize="$2" color="$colorFocus" textAlign="center">
            {t('password.reset.troublePrefix')}{' '}
            <Text
              fontSize="$2"
              color="$blue10"
              textDecorationLine="underline"
              onPress={() => window.location.href = '/support'}
            >
              {t('password.reset.troubleLink')}
            </Text>{' '}
            {t('password.reset.troubleSuffix')}
          </Text>
        </YStack>
      </YStack>
    </Card>
  );
}

export default ResetPasswordForm;

