'use client';

import React, { useState } from 'react';
import { useRouter } from 'next/navigation';
import { useTranslation } from '@/lib/i18n';
import { 
  YStack, 
  XStack, 
  Button, 
  Input, 
  Label, 
  Card, 
  CardContent, 
  CardDescription, 
  CardHeader, 
  CardTitle,
  Alert, 
  AlertDescription,
  Text,
  Theme,
  Square
} from 'tamagui';
import { 
  Mail, 
  Loader2,
  AlertCircle,
  CheckCircle,
  ArrowLeft
} from 'lucide-react-native';
import { useAuthService } from '@/lib/auth/hooks';

interface ForgotPasswordPageProps {
  onSuccess?: () => void;
  className?: string;
}

export const ForgotPasswordPage: React.FC<ForgotPasswordPageProps> = ({
  onSuccess,
  className = '',
}) => {
  const { t } = useTranslation();
  const router = useRouter();
  const { forgetPassword } = useAuthService();
  
  const [email, setEmail] = useState('');
  const [emailError, setEmailError] = useState('');
  const [isEmailSent, setIsEmailSent] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const validateEmail = (email: string): boolean => {
    if (!email) {
      setEmailError(t('auth.errors.emailRequired'));
      return false;
    }
    
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      setEmailError(t('auth.errors.emailInvalid'));
      return false;
    }
    
    setEmailError('');
    return true;
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!validateEmail(email)) {
      return;
    }

    try {
      setIsLoading(true);
      setError(null);
      
      await forgetPassword.mutateAsync({ 
        email, 
        redirectTo: '/reset-password' 
      });
      
      setIsEmailSent(true);
      onSuccess?.();
    } catch (err: any) {
      setError(err.message || t('auth.errors.resetEmailFailed'));
    } finally {
      setIsLoading(false);
    }
  };

  const handleEmailChange = (value: string) => {
    setEmail(value);
    if (emailError) {
      setEmailError('');
    }
  };

  if (isEmailSent) {
    return (
      <YStack 
        minHeight="100vh" 
        alignItems="center" 
        justifyContent="center" 
        backgroundColor="$gray2" 
        paddingVertical="$12" 
        paddingHorizontal="$4"
      >
        <YStack maxWidth={400} width="100%" space="$8">
          <YStack alignItems="center">
            <Text fontSize="$6" fontWeight="bold" color="$gray12">
              {t('auth.checkYourEmail')}
            </Text>
            <Text marginTop="$2" fontSize="$2" color="$gray10">
              {t('auth.passwordResetLinkSent')}
            </Text>
          </YStack>

          <Card elevate>
            <CardContent paddingTop="$6" space="$4">
              <YStack alignItems="center" space="$4">
                <XStack 
                  width={64} 
                  height={64} 
                  backgroundColor="$green2" 
                  borderRadius="$full" 
                  alignItems="center" 
                  justifyContent="center"
                >
                  <CheckCircle size={32} color="$green10" />
                </XStack>
                
                <YStack alignItems="center">
                  <Text fontSize="$4" fontWeight="500" color="$gray12" marginBottom="$2">
                    {t('auth.emailSentSuccessfully')}
                  </Text>
                  <Text fontSize="$2" color="$gray10" textAlign="center">
                    {t('auth.passwordResetLinkSentTo')}{' '}
                    <Text fontWeight="500" color="$gray12">{email}</Text>
                  </Text>
                </YStack>

                <YStack space="$3" width="100%">
                  <Text fontSize="$2" color="$gray10" textAlign="center">
                    {t('auth.checkEmailAndClickLink')}
                  </Text>
                  
                  <YStack space="$2">
                    <Button
                      variant="outlined"
                      width="100%"
                      onPress={() => {
                        setEmail('');
                        // Reset the hook state
                        window.location.reload();
                      }}
                    >
                      <Text>{t('auth.sendAnotherEmail')}</Text>
                    </Button>
                    
                    <Button
                      variant="ghost"
                      width="100%"
                      onPress={() => router.push('/auth/login')}
                    >
                      <XStack space="$2" alignItems="center">
                        <ArrowLeft size={16} />
                        <Text>{t('auth.backToLogin')}</Text>
                      </XStack>
                    </Button>
                  </YStack>
                </YStack>
              </YStack>
            </CardContent>
          </Card>
        </YStack>
      </YStack>
    );
  }

  return (
    <YStack 
      minHeight="100vh" 
      alignItems="center" 
      justifyContent="center" 
      backgroundColor="$gray2" 
      paddingVertical="$12" 
      paddingHorizontal="$4"
    >
      <YStack maxWidth={400} width="100%" space="$8">
        <YStack alignItems="center">
          <Text fontSize="$6" fontWeight="bold" color="$gray12">
            {t('auth.forgotPassword')}
          </Text>
          <Text marginTop="$2" fontSize="$2" color="$gray10">
            {t('auth.resetInstructions')}
          </Text>
        </YStack>

        <Card elevate>
          <CardHeader>
            <CardTitle>{t('auth.resetYourPassword')}</CardTitle>
            <CardDescription>
              {t('auth.enterEmailForResetLink')}
            </CardDescription>
          </CardHeader>
          <CardContent space="$6">
            {/* Error Alert */}
            {error && (
              <Alert backgroundColor="$red2" borderColor="$red6">
                <XStack alignItems="center" space="$2">
                  <AlertCircle size={16} color="$red10" />
                  <AlertDescription>
                    <Text color="$red10">{error}</Text>
                  </AlertDescription>
                </XStack>
              </Alert>
            )}

            {/* Reset Form */}
            <YStack tag="form" onSubmit={handleSubmit} space="$4">
              <YStack>
                <Label htmlFor="email">{t('auth.email')}</Label>
                <XStack position="relative">
                  <XStack 
                    position="absolute" 
                    left="$3" 
                    top="50%" 
                    transform="translateY(-50%)" 
                    zIndex={1}
                  >
                    <Mail size={16} color="$gray10" />
                  </XStack>
                  <Input
                    id="email"
                    type="email"
                    placeholder={t('auth.emailPlaceholder')}
                    value={email}
                    onChange={(e) => handleEmailChange(e.target.value)}
                    paddingLeft="$10"
                    width="100%"
                    borderColor={emailError ? '$red10' : undefined}
                    required
                  />
                </XStack>
                {emailError && (
                  <Text fontSize="$2" color="$red10" marginTop="$1">{emailError}</Text>
                )}
              </YStack>

              <Button
                type="submit"
                width="100%"
                theme="accent"
                disabled={isLoading}
              >
                <XStack alignItems="center" space="$2">
                  {isLoading ? (
                    <>
                      <Loader2 size={16} color="$color" className="animate-spin" />
                      <Text>{t('auth.sendingResetLink')}</Text>
                    </>
                  ) : (
                    <Text>{t('auth.sendResetLink')}</Text>
                  )}
                </XStack>
              </Button>
            </YStack>

            <YStack alignItems="center">
              <Text fontSize="$2" color="$gray10">
                {t('auth.rememberPassword')}{' '}
                <Text 
                  tag="a" 
                  href="/auth/login" 
                  color="$blue10" 
                  fontWeight="500" 
                  hoverStyle={{ color: '$blue9' }}
                >
                  {t('auth.signIn')}
                </Text>
              </Text>
            </YStack>
          </CardContent>
        </Card>

        {/* Help Text */}
        <YStack alignItems="center">
          <Text fontSize="$1" color="$gray9" textAlign="center">
            {t('auth.resetEmailHelp')}
          </Text>
        </YStack>
      </YStack>
    </YStack>
  );
};


