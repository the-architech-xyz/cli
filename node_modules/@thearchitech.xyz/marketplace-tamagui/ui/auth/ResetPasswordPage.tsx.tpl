'use client';

import React, { useState, useEffect } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { useTranslation } from '@/lib/i18n';
import { 
  YStack, 
  XStack, 
  Button, 
  Input, 
  Label, 
  Card, 
  CardContent, 
  CardDescription, 
  CardHeader, 
  CardTitle,
  Alert, 
  AlertDescription,
  Text,
  Theme,
  Progress,
  Spinner
} from 'tamagui';
import { 
  Lock, 
  Eye, 
  EyeOff, 
  Loader2,
  AlertCircle,
  CheckCircle,
  ArrowLeft
} from 'lucide-react-native';
import { useAuthService } from '@/lib/auth/hooks';

interface ResetPasswordPageProps {
  onSuccess?: () => void;
  className?: string;
}

// Custom hook for password reset functionality
const usePasswordReset = () => {
  const { resetPassword } = useAuthService();
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<{ message: string } | null>(null);
  const [isTokenValid, setIsTokenValid] = useState(false);

  const verifyToken = async (token: string) => {
    try {
      setIsLoading(true);
      // In a real implementation, this would verify the token with the backend
      // For now, we'll simulate a successful verification after a delay
      await new Promise(resolve => setTimeout(resolve, 1000));
      setIsTokenValid(true);
    } catch (err: any) {
      setError({ message: err.message || 'Invalid token' });
      setIsTokenValid(false);
    } finally {
      setIsLoading(false);
    }
  };

  const resetPasswordFn = async (token: string, password: string, confirmPassword: string) => {
    try {
      setIsLoading(true);
      setError(null);
      await resetPassword.mutateAsync({ token, password, confirmPassword });
    } catch (err: any) {
      setError({ message: err.message || 'Failed to reset password' });
      throw err;
    } finally {
      setIsLoading(false);
    }
  };

  return {
    resetPassword: resetPasswordFn,
    verifyToken,
    isLoading,
    error,
    isTokenValid
  };
};

export const ResetPasswordPage: React.FC<ResetPasswordPageProps> = ({
  onSuccess,
  className = '',
}) => {
  const { t } = useTranslation();
  const router = useRouter();
  const searchParams = useSearchParams();
  const { resetPassword, verifyToken, isLoading, error, isTokenValid } = usePasswordReset();
  
  const [formData, setFormData] = useState({
    password: '',
    confirmPassword: '',
  });
  const [showPassword, setShowPassword] = useState(false);
  const [showConfirmPassword, setShowConfirmPassword] = useState(false);
  const [formErrors, setFormErrors] = useState<Record<string, string>>({});
  const [token, setToken] = useState<string | null>(null);
  const [isVerifying, setIsVerifying] = useState(true);

  useEffect(() => {
    const tokenParam = searchParams?.get('token');
    if (tokenParam) {
      setToken(tokenParam);
      verifyToken(tokenParam);
    } else {
      setIsVerifying(false);
    }
  }, [searchParams, verifyToken]);

  const handleInputChange = (field: string, value: string) => {
    setFormData(prev => ({
      ...prev,
      [field]: value,
    }));

    // Clear error when user starts typing
    if (formErrors[field]) {
      setFormErrors(prev => ({
        ...prev,
        [field]: '',
      }));
    }
  };

  const validateForm = (): boolean => {
    const errors: Record<string, string> = {};

    if (!formData.password) {
      errors.password = t('auth.errors.passwordRequired');
    } else if (formData.password.length < 8) {
      errors.password = t('auth.errors.passwordLength');
    } else if (!/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/.test(formData.password)) {
      errors.password = t('auth.errors.passwordComplexity');
    }

    if (!formData.confirmPassword) {
      errors.confirmPassword = t('auth.errors.confirmPasswordRequired');
    } else if (formData.password !== formData.confirmPassword) {
      errors.confirmPassword = t('auth.errors.passwordsDoNotMatch');
    }

    setFormErrors(errors);
    return Object.keys(errors).length === 0;
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!token) {
      setFormErrors({ password: t('auth.errors.invalidResetToken') });
      return;
    }
    
    if (!validateForm()) {
      return;
    }

    try {
      await resetPassword(token, formData.password, formData.confirmPassword);
      onSuccess?.();
      router.push('/auth/login?message=password-reset-success');
    } catch (err) {
      // Error is handled by the usePasswordReset hook
    }
  };

  const getPasswordStrength = (password: string): { strength: number; label: string; color: string } => {
    let strength = 0;
    
    if (password.length >= 8) strength++;
    if (/[a-z]/.test(password)) strength++;
    if (/[A-Z]/.test(password)) strength++;
    if (/\d/.test(password)) strength++;
    if (/[^A-Za-z0-9]/.test(password)) strength++;
    
    const strengthMap = {
      0: { label: t('auth.passwordStrength.veryWeak'), color: '$red10' },
      1: { label: t('auth.passwordStrength.weak'), color: '$red9' },
      2: { label: t('auth.passwordStrength.fair'), color: '$yellow9' },
      3: { label: t('auth.passwordStrength.good'), color: '$yellow10' },
      4: { label: t('auth.passwordStrength.strong'), color: '$green9' },
      5: { label: t('auth.passwordStrength.veryStrong'), color: '$green10' },
    };
    
    return {
      strength,
      ...strengthMap[strength as keyof typeof strengthMap],
    };
  };

  const passwordStrength = getPasswordStrength(formData.password);

  if (isVerifying) {
    return (
      <YStack 
        minHeight="100vh" 
        alignItems="center" 
        justifyContent="center" 
        backgroundColor="$gray2" 
        paddingVertical="$12" 
        paddingHorizontal="$4"
      >
        <YStack maxWidth={400} width="100%" space="$8" alignItems="center">
          <Spinner size="large" color="$blue10" />
          <Text color="$gray11">{t('auth.verifyingResetToken')}</Text>
        </YStack>
      </YStack>
    );
  }

  if (!isTokenValid) {
    return (
      <YStack 
        minHeight="100vh" 
        alignItems="center" 
        justifyContent="center" 
        backgroundColor="$gray2" 
        paddingVertical="$12" 
        paddingHorizontal="$4"
      >
        <YStack maxWidth={400} width="100%" space="$8">
          <YStack alignItems="center">
            <Text fontSize="$6" fontWeight="bold" color="$gray12">
              {t('auth.invalidResetLink')}
            </Text>
            <Text marginTop="$2" fontSize="$2" color="$gray10">
              {t('auth.invalidResetLinkDescription')}
            </Text>
          </YStack>

          <Card elevate>
            <CardContent paddingTop="$6" space="$4">
              <YStack alignItems="center" space="$4">
                <XStack 
                  width={64} 
                  height={64} 
                  backgroundColor="$red2" 
                  borderRadius="$full" 
                  alignItems="center" 
                  justifyContent="center"
                >
                  <AlertCircle size={32} color="$red10" />
                </XStack>
                
                <YStack alignItems="center">
                  <Text fontSize="$4" fontWeight="500" color="$gray12" marginBottom="$2">
                    {t('auth.linkExpiredOrInvalid')}
                  </Text>
                  <Text fontSize="$2" color="$gray10" textAlign="center">
                    {t('auth.requestNewResetLinkDescription')}
                  </Text>
                </YStack>

                <YStack width="100%" space="$2">
                  <Button 
                    theme="accent" 
                    width="100%" 
                    onPress={() => router.push('/auth/forgot-password')}
                  >
                    {t('auth.requestNewResetLink')}
                  </Button>
                  
                  <Button 
                    variant="outlined" 
                    width="100%" 
                    onPress={() => router.push('/auth/login')}
                  >
                    <XStack space="$2" alignItems="center">
                      <ArrowLeft size={16} />
                      <Text>{t('auth.backToLogin')}</Text>
                    </XStack>
                  </Button>
                </YStack>
              </YStack>
            </CardContent>
          </Card>
        </YStack>
      </YStack>
    );
  }

  return (
    <YStack 
      minHeight="100vh" 
      alignItems="center" 
      justifyContent="center" 
      backgroundColor="$gray2" 
      paddingVertical="$12" 
      paddingHorizontal="$4"
    >
      <YStack maxWidth={400} width="100%" space="$8">
        <YStack alignItems="center">
          <Text fontSize="$6" fontWeight="bold" color="$gray12">
            {t('auth.resetYourPassword')}
          </Text>
          <Text marginTop="$2" fontSize="$2" color="$gray10">
            {t('auth.enterNewPasswordBelow')}
          </Text>
        </YStack>

        <Card elevate>
          <CardHeader>
            <CardTitle>{t('auth.createNewPassword')}</CardTitle>
            <CardDescription>
              {t('auth.chooseStrongPassword')}
            </CardDescription>
          </CardHeader>
          <CardContent space="$6">
            {/* Error Alert */}
            {error && (
              <Alert backgroundColor="$red2" borderColor="$red6">
                <XStack alignItems="center" space="$2">
                  <AlertCircle size={16} color="$red10" />
                  <AlertDescription>
                    <Text color="$red10">{error.message}</Text>
                  </AlertDescription>
                </XStack>
              </Alert>
            )}

            {/* Reset Form */}
            <YStack tag="form" onSubmit={handleSubmit} space="$4">
              <YStack>
                <Label htmlFor="password">{t('auth.newPassword')}</Label>
                <XStack position="relative">
                  <XStack 
                    position="absolute" 
                    left="$3" 
                    top="50%" 
                    transform="translateY(-50%)" 
                    zIndex={1}
                  >
                    <Lock size={16} color="$gray10" />
                  </XStack>
                  <Input
                    id="password"
                    type={showPassword ? 'text' : 'password'}
                    placeholder={t('auth.newPasswordPlaceholder')}
                    value={formData.password}
                    onChange={(e) => handleInputChange('password', e.target.value)}
                    paddingLeft="$10"
                    paddingRight="$10"
                    width="100%"
                    borderColor={formErrors.password ? '$red10' : undefined}
                    required
                  />
                  <XStack 
                    position="absolute" 
                    right="$3" 
                    top="50%" 
                    transform="translateY(-50%)" 
                    zIndex={1}
                  >
                    <Button
                      chromeless
                      onPress={() => setShowPassword(!showPassword)}
                      padding="$0"
                    >
                      {showPassword ? <EyeOff size={16} color="$gray10" /> : <Eye size={16} color="$gray10" />}
                    </Button>
                  </XStack>
                </XStack>
                {formData.password && (
                  <YStack marginTop="$2">
                    <XStack alignItems="center" space="$2">
                      <Progress 
                        value={(passwordStrength.strength / 5) * 100} 
                        backgroundColor="$gray5"
                        flex={1}
                      >
                        <Progress.Indicator backgroundColor={passwordStrength.color} />
                      </Progress>
                      <Text fontSize="$1" color="$gray10">{passwordStrength.label}</Text>
                    </XStack>
                  </YStack>
                )}
                {formErrors.password && (
                  <Text fontSize="$2" color="$red10" marginTop="$1">{formErrors.password}</Text>
                )}
              </YStack>

              <YStack>
                <Label htmlFor="confirmPassword">{t('auth.confirmNewPassword')}</Label>
                <XStack position="relative">
                  <XStack 
                    position="absolute" 
                    left="$3" 
                    top="50%" 
                    transform="translateY(-50%)" 
                    zIndex={1}
                  >
                    <Lock size={16} color="$gray10" />
                  </XStack>
                  <Input
                    id="confirmPassword"
                    type={showConfirmPassword ? 'text' : 'password'}
                    placeholder={t('auth.confirmNewPasswordPlaceholder')}
                    value={formData.confirmPassword}
                    onChange={(e) => handleInputChange('confirmPassword', e.target.value)}
                    paddingLeft="$10"
                    paddingRight="$10"
                    width="100%"
                    borderColor={formErrors.confirmPassword ? '$red10' : undefined}
                    required
                  />
                  <XStack 
                    position="absolute" 
                    right="$3" 
                    top="50%" 
                    transform="translateY(-50%)" 
                    zIndex={1}
                  >
                    <Button
                      chromeless
                      onPress={() => setShowConfirmPassword(!showConfirmPassword)}
                      padding="$0"
                    >
                      {showConfirmPassword ? <EyeOff size={16} color="$gray10" /> : <Eye size={16} color="$gray10" />}
                    </Button>
                  </XStack>
                </XStack>
                {formErrors.confirmPassword && (
                  <Text fontSize="$2" color="$red10" marginTop="$1">{formErrors.confirmPassword}</Text>
                )}
              </YStack>

              <Button
                type="submit"
                width="100%"
                theme="accent"
                disabled={isLoading}
              >
                <XStack alignItems="center" space="$2">
                  {isLoading ? (
                    <>
                      <Loader2 size={16} color="$color" className="animate-spin" />
                      <Text>{t('auth.resettingPassword')}</Text>
                    </>
                  ) : (
                    <Text>{t('auth.resetPassword')}</Text>
                  )}
                </XStack>
              </Button>
            </YStack>

            <YStack alignItems="center">
              <Text fontSize="$2" color="$gray10">
                {t('auth.rememberPassword')}{' '}
                <Text 
                  tag="a" 
                  href="/auth/login" 
                  color="$blue10" 
                  fontWeight="500" 
                  hoverStyle={{ color: '$blue9' }}
                >
                  {t('auth.signIn')}
                </Text>
              </Text>
            </YStack>
          </CardContent>
        </Card>

        {/* Help Text */}
        <YStack alignItems="center">
          <Text fontSize="$1" color="$gray9" textAlign="center">
            {t('auth.passwordRequirements')}
          </Text>
        </YStack>
      </YStack>
    </YStack>
  );
};


