'use client';

// Account Settings Component

import React, { useState } from 'react';
import { 
  YStack, 
  XStack, 
  Button, 
  Text,
  Card,
  CardHeader,
  CardContent,
  CardDescription,
  Badge,
  Input,
  Label,
  Switch,
  Select,
  Alert,
  Theme,
  Square
} from 'tamagui';
import { 
  Settings, 
  Bell, 
  Shield, 
  Globe, 
  Trash2,
  Save,
  AlertTriangle,
  CheckCircle,
  Loader2
} from 'lucide-react-native';
import { useTranslation } from '@/lib/i18n';

interface AccountSettingsProps {
  settings: {
    notifications: {
      email: boolean;
      push: boolean;
      sms: boolean;
      marketing: boolean;
    };
    privacy: {
      profileVisibility: 'public' | 'private' | 'friends';
      showEmail: boolean;
      showPhone: boolean;
      showLocation: boolean;
    };
    security: {
      twoFactorEnabled: boolean;
      loginAlerts: boolean;
      sessionTimeout: number;
    };
    preferences: {
      language: string;
      timezone: string;
      theme: 'light' | 'dark' | 'system';
    };
  };
  onUpdate: (section: string, data: any) => Promise<void>;
  onDeleteAccount?: () => Promise<void>;
  isLoading?: boolean;
  error?: string;
  success?: string;
  className?: string;
}

export const AccountSettings: React.FC<AccountSettingsProps> = ({
  settings,
  onUpdate,
  onDeleteAccount,
  isLoading = false,
  error,
  success,
  className = '',
}) => {
  const { t } = useTranslation();
  const [activeSection, setActiveSection] = useState<string>('notifications');
  const [localSettings, setLocalSettings] = useState(settings);

  const handleNotificationChange = async (key: string, value: boolean) => {
    const newSettings = {
      ...localSettings.notifications,
      [key]: value,
    };
    setLocalSettings(prev => ({ ...prev, notifications: newSettings }));
    await onUpdate('notifications', newSettings);
  };

  const handlePrivacyChange = async (key: string, value: any) => {
    const newSettings = {
      ...localSettings.privacy,
      [key]: value,
    };
    setLocalSettings(prev => ({ ...prev, privacy: newSettings }));
    await onUpdate('privacy', newSettings);
  };

  const handleSecurityChange = async (key: string, value: any) => {
    const newSettings = {
      ...localSettings.security,
      [key]: value,
    };
    setLocalSettings(prev => ({ ...prev, security: newSettings }));
    await onUpdate('security', newSettings);
  };

  const handlePreferenceChange = async (key: string, value: any) => {
    const newSettings = {
      ...localSettings.preferences,
      [key]: value,
    };
    setLocalSettings(prev => ({ ...prev, preferences: newSettings }));
    await onUpdate('preferences', newSettings);
  };

  const sections = [
    { id: 'notifications', label: t('auth.settings.sections.notifications'), icon: Bell },
    { id: 'privacy', label: t('auth.settings.sections.privacy'), icon: Shield },
    { id: 'security', label: t('auth.settings.sections.security'), icon: Shield },
    { id: 'preferences', label: t('auth.settings.sections.preferences'), icon: Globe },
  ];

  return (
    <YStack space="$6" {...(className ? { className } : {})}>
      {/* Header */}
      <XStack alignItems="center" gap="$3">
        <Settings size={24} />
        <Text fontSize="$6" fontWeight="$8">
          {t('auth.settings.title')}
        </Text>
      </XStack>

      {/* Messages */}
      {error && (
        <Alert theme="red">
          <XStack alignItems="center" gap="$2">
            <AlertTriangle size={16} color="$red10" />
            <Text color="$red10">{error}</Text>
          </XStack>
        </Alert>
      )}

      {success && (
        <Alert theme="green">
          <XStack alignItems="center" gap="$2">
            <CheckCircle size={16} color="$green10" />
            <Text color="$green10">{success}</Text>
          </XStack>
        </Alert>
      )}

      <XStack flexDirection={{ xs: 'column', md: 'row' }} gap="$6">
        {/* Sidebar */}
        <YStack width={{ xs: '100%', md: 250 }}>
          <Card elevate>
            <CardContent padding="$4">
              <YStack space="$2">
                {sections.map((section) => {
                  const Icon = section.icon;
                  return (
                    <Button
                      key={section.id}
                      onPress={() => setActiveSection(section.id)}
                      chromeless
                      justifyContent="flex-start"
                      paddingHorizontal="$3"
                      paddingVertical="$2"
                      borderRadius="$4"
                      backgroundColor={activeSection === section.id ? '$blue2' : 'transparent'}
                      hoverStyle={{ backgroundColor: activeSection === section.id ? '$blue2' : '$gray2' }}
                      pressStyle={{ backgroundColor: activeSection === section.id ? '$blue3' : '$gray3' }}
                    >
                      <XStack alignItems="center" gap="$3">
                        <Icon 
                          size={16} 
                          color={activeSection === section.id ? '$blue10' : '$gray10'} 
                        />
                        <Text 
                          fontSize="$2" 
                          fontWeight="$5" 
                          color={activeSection === section.id ? '$blue10' : '$gray11'}
                        >
                          {section.label}
                        </Text>
                      </XStack>
                    </Button>
                  );
                })}
              </YStack>
            </CardContent>
          </Card>
        </YStack>

        {/* Content */}
        <YStack flex={1}>
          {/* Notifications */}
          {activeSection === 'notifications' && (
            <Card elevate>
              <CardHeader>
                <XStack alignItems="center" gap="$2">
                  <Bell size={20} />
                  <Text fontSize="$5" fontWeight="$6">
                    {t('auth.settings.notifications.title')}
                  </Text>
                </XStack>
                <Text fontSize="$2" color="$gray11">
                  {t('auth.settings.notifications.description')}
                </Text>
              </CardHeader>
              <CardContent space="$6">
                <YStack space="$4">
                  <XStack alignItems="center" justifyContent="space-between">
                    <YStack>
                      <Label htmlFor="email-notifications">
                        {t('auth.settings.notifications.emailNotifications')}
                      </Label>
                      <Text fontSize="$2" color="$gray10">
                        {t('auth.settings.notifications.emailDescription')}
                      </Text>
                    </YStack>
                    <Switch
                      id="email-notifications"
                      checked={localSettings.notifications.email}
                      onCheckedChange={(checked) => handleNotificationChange('email', !!checked)}
                      disabled={isLoading}
                      size="$3"
                    >
                      <Switch.Thumb animation="quick" />
                    </Switch>
                  </XStack>

                  <XStack alignItems="center" justifyContent="space-between">
                    <YStack>
                      <Label htmlFor="push-notifications">
                        {t('auth.settings.notifications.pushNotifications')}
                      </Label>
                      <Text fontSize="$2" color="$gray10">
                        {t('auth.settings.notifications.pushDescription')}
                      </Text>
                    </YStack>
                    <Switch
                      id="push-notifications"
                      checked={localSettings.notifications.push}
                      onCheckedChange={(checked) => handleNotificationChange('push', !!checked)}
                      disabled={isLoading}
                      size="$3"
                    >
                      <Switch.Thumb animation="quick" />
                    </Switch>
                  </XStack>

                  <XStack alignItems="center" justifyContent="space-between">
                    <YStack>
                      <Label htmlFor="sms-notifications">
                        {t('auth.settings.notifications.smsNotifications')}
                      </Label>
                      <Text fontSize="$2" color="$gray10">
                        {t('auth.settings.notifications.smsDescription')}
                      </Text>
                    </YStack>
                    <Switch
                      id="sms-notifications"
                      checked={localSettings.notifications.sms}
                      onCheckedChange={(checked) => handleNotificationChange('sms', !!checked)}
                      disabled={isLoading}
                      size="$3"
                    >
                      <Switch.Thumb animation="quick" />
                    </Switch>
                  </XStack>

                  <XStack alignItems="center" justifyContent="space-between">
                    <YStack>
                      <Label htmlFor="marketing-notifications">
                        {t('auth.settings.notifications.marketingEmails')}
                      </Label>
                      <Text fontSize="$2" color="$gray10">
                        {t('auth.settings.notifications.marketingDescription')}
                      </Text>
                    </YStack>
                    <Switch
                      id="marketing-notifications"
                      checked={localSettings.notifications.marketing}
                      onCheckedChange={(checked) => handleNotificationChange('marketing', !!checked)}
                      disabled={isLoading}
                      size="$3"
                    >
                      <Switch.Thumb animation="quick" />
                    </Switch>
                  </XStack>
                </YStack>
              </CardContent>
            </Card>
          )}

          {/* Privacy */}
          {activeSection === 'privacy' && (
            <Card elevate>
              <CardHeader>
                <XStack alignItems="center" gap="$2">
                  <Shield size={20} />
                  <Text fontSize="$5" fontWeight="$6">
                    {t('auth.settings.privacy.title')}
                  </Text>
                </XStack>
                <Text fontSize="$2" color="$gray11">
                  {t('auth.settings.privacy.description')}
                </Text>
              </CardHeader>
              <CardContent space="$6">
                <YStack space="$4">
                  <YStack>
                    <Label htmlFor="profile-visibility">
                      {t('auth.settings.privacy.profileVisibility')}
                    </Label>
                    <Select
                      id="profile-visibility"
                      value={localSettings.privacy.profileVisibility}
                      onValueChange={(value) => handlePrivacyChange('profileVisibility', value)}
                      disabled={isLoading}
                    >
                      <Select.Trigger width="100%" marginTop="$1" id="profile-visibility">
                        <Select.Value placeholder={t('auth.settings.privacy.selectVisibility')} />
                      </Select.Trigger>
                      <Select.Content>
                        <Select.Item value="public">
                          <Select.ItemText>{t('auth.settings.privacy.public')}</Select.ItemText>
                        </Select.Item>
                        <Select.Item value="friends">
                          <Select.ItemText>{t('auth.settings.privacy.friends')}</Select.ItemText>
                        </Select.Item>
                        <Select.Item value="private">
                          <Select.ItemText>{t('auth.settings.privacy.private')}</Select.ItemText>
                        </Select.Item>
                      </Select.Content>
                    </Select>
                  </YStack>

                  <YStack space="$4">
                    <XStack alignItems="center" justifyContent="space-between">
                      <YStack>
                        <Label htmlFor="show-email">
                          {t('auth.settings.privacy.showEmail')}
                        </Label>
                        <Text fontSize="$2" color="$gray10">
                          {t('auth.settings.privacy.showEmailDescription')}
                        </Text>
                      </YStack>
                      <Switch
                        id="show-email"
                        checked={localSettings.privacy.showEmail}
                        onCheckedChange={(checked) => handlePrivacyChange('showEmail', !!checked)}
                        disabled={isLoading}
                        size="$3"
                      >
                        <Switch.Thumb animation="quick" />
                      </Switch>
                    </XStack>

                    <XStack alignItems="center" justifyContent="space-between">
                      <YStack>
                        <Label htmlFor="show-phone">
                          {t('auth.settings.privacy.showPhone')}
                        </Label>
                        <Text fontSize="$2" color="$gray10">
                          {t('auth.settings.privacy.showPhoneDescription')}
                        </Text>
                      </YStack>
                      <Switch
                        id="show-phone"
                        checked={localSettings.privacy.showPhone}
                        onCheckedChange={(checked) => handlePrivacyChange('showPhone', !!checked)}
                        disabled={isLoading}
                        size="$3"
                      >
                        <Switch.Thumb animation="quick" />
                      </Switch>
                    </XStack>

                    <XStack alignItems="center" justifyContent="space-between">
                      <YStack>
                        <Label htmlFor="show-location">
                          {t('auth.settings.privacy.showLocation')}
                        </Label>
                        <Text fontSize="$2" color="$gray10">
                          {t('auth.settings.privacy.showLocationDescription')}
                        </Text>
                      </YStack>
                      <Switch
                        id="show-location"
                        checked={localSettings.privacy.showLocation}
                        onCheckedChange={(checked) => handlePrivacyChange('showLocation', !!checked)}
                        disabled={isLoading}
                        size="$3"
                      >
                        <Switch.Thumb animation="quick" />
                      </Switch>
                    </XStack>
                  </YStack>
                </YStack>
              </CardContent>
            </Card>
          )}

          {/* Security */}
          {activeSection === 'security' && (
            <Card elevate>
              <CardHeader>
                <XStack alignItems="center" gap="$2">
                  <Shield size={20} />
                  <Text fontSize="$5" fontWeight="$6">
                    {t('auth.settings.security.title')}
                  </Text>
                </XStack>
                <Text fontSize="$2" color="$gray11">
                  {t('auth.settings.security.description')}
                </Text>
              </CardHeader>
              <CardContent space="$6">
                <YStack space="$4">
                  <XStack alignItems="center" justifyContent="space-between">
                    <YStack>
                      <Label htmlFor="two-factor">
                        {t('auth.settings.security.twoFactor')}
                      </Label>
                      <Text fontSize="$2" color="$gray10">
                        {t('auth.settings.security.twoFactorDescription')}
                      </Text>
                    </YStack>
                    <XStack alignItems="center" gap="$2">
                      {localSettings.security.twoFactorEnabled && (
                        <Badge theme="green" size="$1">
                          {t('auth.settings.security.enabled')}
                        </Badge>
                      )}
                      <Switch
                        id="two-factor"
                        checked={localSettings.security.twoFactorEnabled}
                        onCheckedChange={(checked) => handleSecurityChange('twoFactorEnabled', !!checked)}
                        disabled={isLoading}
                        size="$3"
                      >
                        <Switch.Thumb animation="quick" />
                      </Switch>
                    </XStack>
                  </XStack>

                  <XStack alignItems="center" justifyContent="space-between">
                    <YStack>
                      <Label htmlFor="login-alerts">
                        {t('auth.settings.security.loginAlerts')}
                      </Label>
                      <Text fontSize="$2" color="$gray10">
                        {t('auth.settings.security.loginAlertsDescription')}
                      </Text>
                    </YStack>
                    <Switch
                      id="login-alerts"
                      checked={localSettings.security.loginAlerts}
                      onCheckedChange={(checked) => handleSecurityChange('loginAlerts', !!checked)}
                      disabled={isLoading}
                      size="$3"
                    >
                      <Switch.Thumb animation="quick" />
                    </Switch>
                  </XStack>

                  <YStack>
                    <Label htmlFor="session-timeout">
                      {t('auth.settings.security.sessionTimeout')}
                    </Label>
                    <Select
                      id="session-timeout"
                      value={localSettings.security.sessionTimeout.toString()}
                      onValueChange={(value) => handleSecurityChange('sessionTimeout', parseInt(value))}
                      disabled={isLoading}
                    >
                      <Select.Trigger width="100%" marginTop="$1" id="session-timeout">
                        <Select.Value placeholder={t('auth.settings.security.selectTimeout')} />
                      </Select.Trigger>
                      <Select.Content>
                        <Select.Item value="15">
                          <Select.ItemText>{t('auth.settings.security.minutes', { minutes: 15 })}</Select.ItemText>
                        </Select.Item>
                        <Select.Item value="30">
                          <Select.ItemText>{t('auth.settings.security.minutes', { minutes: 30 })}</Select.ItemText>
                        </Select.Item>
                        <Select.Item value="60">
                          <Select.ItemText>{t('auth.settings.security.hour', { hours: 1 })}</Select.ItemText>
                        </Select.Item>
                        <Select.Item value="120">
                          <Select.ItemText>{t('auth.settings.security.hours', { hours: 2 })}</Select.ItemText>
                        </Select.Item>
                        <Select.Item value="480">
                          <Select.ItemText>{t('auth.settings.security.hours', { hours: 8 })}</Select.ItemText>
                        </Select.Item>
                      </Select.Content>
                    </Select>
                  </YStack>
                </YStack>
              </CardContent>
            </Card>
          )}

          {/* Preferences */}
          {activeSection === 'preferences' && (
            <Card elevate>
              <CardHeader>
                <XStack alignItems="center" gap="$2">
                  <Globe size={20} />
                  <Text fontSize="$5" fontWeight="$6">
                    {t('auth.settings.preferences.title')}
                  </Text>
                </XStack>
                <Text fontSize="$2" color="$gray11">
                  {t('auth.settings.preferences.description')}
                </Text>
              </CardHeader>
              <CardContent space="$6">
                <YStack space="$4">
                  <YStack>
                    <Label htmlFor="language">
                      {t('auth.settings.preferences.language')}
                    </Label>
                    <Select
                      id="language"
                      value={localSettings.preferences.language}
                      onValueChange={(value) => handlePreferenceChange('language', value)}
                      disabled={isLoading}
                    >
                      <Select.Trigger width="100%" marginTop="$1" id="language">
                        <Select.Value placeholder={t('auth.settings.preferences.selectLanguage')} />
                      </Select.Trigger>
                      <Select.Content>
                        <Select.Item value="en">
                          <Select.ItemText>English</Select.ItemText>
                        </Select.Item>
                        <Select.Item value="es">
                          <Select.ItemText>Español</Select.ItemText>
                        </Select.Item>
                        <Select.Item value="fr">
                          <Select.ItemText>Français</Select.ItemText>
                        </Select.Item>
                        <Select.Item value="de">
                          <Select.ItemText>Deutsch</Select.ItemText>
                        </Select.Item>
                        <Select.Item value="it">
                          <Select.ItemText>Italiano</Select.ItemText>
                        </Select.Item>
                        <Select.Item value="pt">
                          <Select.ItemText>Português</Select.ItemText>
                        </Select.Item>
                      </Select.Content>
                    </Select>
                  </YStack>

                  <YStack>
                    <Label htmlFor="timezone">
                      {t('auth.settings.preferences.timezone')}
                    </Label>
                    <Select
                      id="timezone"
                      value={localSettings.preferences.timezone}
                      onValueChange={(value) => handlePreferenceChange('timezone', value)}
                      disabled={isLoading}
                    >
                      <Select.Trigger width="100%" marginTop="$1" id="timezone">
                        <Select.Value placeholder={t('auth.settings.preferences.selectTimezone')} />
                      </Select.Trigger>
                      <Select.Content>
                        <Select.Item value="UTC">
                          <Select.ItemText>UTC</Select.ItemText>
                        </Select.Item>
                        <Select.Item value="America/New_York">
                          <Select.ItemText>{t('auth.settings.preferences.easternTime')}</Select.ItemText>
                        </Select.Item>
                        <Select.Item value="America/Chicago">
                          <Select.ItemText>{t('auth.settings.preferences.centralTime')}</Select.ItemText>
                        </Select.Item>
                        <Select.Item value="America/Denver">
                          <Select.ItemText>{t('auth.settings.preferences.mountainTime')}</Select.ItemText>
                        </Select.Item>
                        <Select.Item value="America/Los_Angeles">
                          <Select.ItemText>{t('auth.settings.preferences.pacificTime')}</Select.ItemText>
                        </Select.Item>
                        <Select.Item value="Europe/London">
                          <Select.ItemText>{t('auth.settings.preferences.london')}</Select.ItemText>
                        </Select.Item>
                        <Select.Item value="Europe/Paris">
                          <Select.ItemText>{t('auth.settings.preferences.paris')}</Select.ItemText>
                        </Select.Item>
                        <Select.Item value="Asia/Tokyo">
                          <Select.ItemText>{t('auth.settings.preferences.tokyo')}</Select.ItemText>
                        </Select.Item>
                      </Select.Content>
                    </Select>
                  </YStack>

                  <YStack>
                    <Label htmlFor="theme">
                      {t('auth.settings.preferences.theme')}
                    </Label>
                    <Select
                      id="theme"
                      value={localSettings.preferences.theme}
                      onValueChange={(value) => handlePreferenceChange('theme', value)}
                      disabled={isLoading}
                    >
                      <Select.Trigger width="100%" marginTop="$1" id="theme">
                        <Select.Value placeholder={t('auth.settings.preferences.selectTheme')} />
                      </Select.Trigger>
                      <Select.Content>
                        <Select.Item value="light">
                          <Select.ItemText>{t('auth.settings.preferences.light')}</Select.ItemText>
                        </Select.Item>
                        <Select.Item value="dark">
                          <Select.ItemText>{t('auth.settings.preferences.dark')}</Select.ItemText>
                        </Select.Item>
                        <Select.Item value="system">
                          <Select.ItemText>{t('auth.settings.preferences.system')}</Select.ItemText>
                        </Select.Item>
                      </Select.Content>
                    </Select>
                  </YStack>
                </YStack>
              </CardContent>
            </Card>
          )}
        </YStack>
      </XStack>

      {/* Danger Zone */}
      {onDeleteAccount && (
        <Card elevate borderColor="$red8">
          <CardHeader>
            <Text fontSize="$5" fontWeight="$6" color="$red10">
              {t('auth.settings.dangerZone.title')}
            </Text>
            <Text fontSize="$2" color="$gray11">
              {t('auth.settings.dangerZone.description')}
            </Text>
          </CardHeader>
          <CardContent>
            <XStack alignItems="center" justifyContent="space-between">
              <YStack>
                <Text fontWeight="$5" color="$red10">
                  {t('auth.settings.dangerZone.deleteAccount')}
                </Text>
                <Text fontSize="$2" color="$gray10">
                  {t('auth.settings.dangerZone.deleteAccountDescription')}
                </Text>
              </YStack>
              <Button
                theme="red"
                onPress={onDeleteAccount}
                disabled={isLoading}
                icon={<Trash2 size={16} />}
              >
                <Text marginLeft="$2">
                  {t('auth.settings.dangerZone.deleteAccountButton')}
                </Text>
              </Button>
            </XStack>
          </CardContent>
        </Card>
      )}
    </YStack>
  );
};

