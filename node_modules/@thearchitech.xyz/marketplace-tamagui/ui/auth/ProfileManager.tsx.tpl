'use client';

import React, { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';
import { useTranslation } from '@/lib/i18n';
import { 
  YStack, 
  XStack, 
  Button, 
  Input, 
  Label, 
  TextArea,
  Card, 
  CardContent, 
  CardDescription, 
  CardHeader, 
  CardTitle,
  Avatar,
  AvatarFallback,
  AvatarImage,
  Badge,
  Alert,
  AlertDescription,
  Text,
  Theme,
  Square
} from 'tamagui';
import { 
  User, 
  Mail, 
  Phone, 
  MapPin, 
  Calendar,
  Camera,
  Save,
  Edit,
  Check,
  X,
  AlertCircle,
  Loader2
} from 'lucide-react-native';

const profileSchema = z.object({
  firstName: z.string().min(2, 'First name must be at least 2 characters'),
  lastName: z.string().min(2, 'Last name must be at least 2 characters'),
  email: z.string().email('Please enter a valid email address'),
  phone: z.string().optional(),
  bio: z.string().max(500, 'Bio must be less than 500 characters').optional(),
  location: z.string().optional(),
  website: z.string().url('Please enter a valid URL').optional().or(z.literal('')),
  company: z.string().optional(),
  jobTitle: z.string().optional(),
});

type ProfileFormData = z.infer<typeof profileSchema>;

interface ProfileManagerProps {
  profile: {
    id: string;
    firstName: string;
    lastName: string;
    email: string;
    phone?: string;
    bio?: string;
    location?: string;
    website?: string;
    company?: string;
    jobTitle?: string;
    avatar?: string;
    isEmailVerified: boolean;
    createdAt: string;
    lastLoginAt: string;
  };
  onUpdate: (data: ProfileFormData) => Promise<void>;
  onAvatarUpdate?: (file: File) => Promise<void>;
  isLoading?: boolean;
  error?: string;
  success?: string;
  className?: string;
}

export const ProfileManager: React.FC<ProfileManagerProps> = ({
  profile,
  onUpdate,
  onAvatarUpdate,
  isLoading = false,
  error,
  success,
  className = '',
}) => {
  const { t } = useTranslation();
  const [isEditing, setIsEditing] = useState(false);
  const [avatarLoading, setAvatarLoading] = useState(false);

  const {
    register,
    handleSubmit,
    formState: { errors, isDirty },
    reset,
    watch,
  } = useForm<ProfileFormData>({
    resolver: zodResolver(profileSchema),
    defaultValues: {
      firstName: profile.firstName,
      lastName: profile.lastName,
      email: profile.email,
      phone: profile.phone || '',
      bio: profile.bio || '',
      location: profile.location || '',
      website: profile.website || '',
      company: profile.company || '',
      jobTitle: profile.jobTitle || '',
    },
  });

  const watchedValues = watch();

  const handleFormSubmit = async (data: ProfileFormData) => {
    try {
      await onUpdate(data);
      setIsEditing(false);
    } catch (error) {
      console.error('Profile update failed:', error);
    }
  };

  const handleCancel = () => {
    reset();
    setIsEditing(false);
  };

  const handleAvatarChange = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file || !onAvatarUpdate) return;

    setAvatarLoading(true);
    try {
      await onAvatarUpdate(file);
    } catch (error) {
      console.error('Avatar update failed:', error);
    } finally {
      setAvatarLoading(false);
    }
  };

  const formatDate = (dateString: string): string => {
    return new Date(dateString).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    });
  };

  const getInitials = (firstName: string, lastName: string): string => {
    return `${firstName.charAt(0)}${lastName.charAt(0)}`.toUpperCase();
  };

  return (
    <YStack space="$6">
      {/* Profile Header */}
      <Card elevate>
        <CardHeader>
          <XStack alignItems="center" space="$6">
            <YStack position="relative">
              <Avatar size="$8">
                <AvatarImage src={profile.avatar} alt={`${profile.firstName} ${profile.lastName}`} />
                <AvatarFallback>
                  <Text fontSize="$5">{getInitials(profile.firstName, profile.lastName)}</Text>
                </AvatarFallback>
              </Avatar>
              {onAvatarUpdate && (
                <XStack
                  tag="label"
                  position="absolute"
                  bottom={0}
                  right={0}
                  backgroundColor="$blue10"
                  borderRadius="$full"
                  padding="$2"
                  cursor="pointer"
                  hoverStyle={{ backgroundColor: '$blue9' }}
                >
                  <Camera size={16} color="white" />
                  <input
                    type="file"
                    accept="image/*"
                    onChange={handleAvatarChange}
                    style={{ display: 'none' }}
                    disabled={avatarLoading}
                  />
                </XStack>
              )}
            </YStack>
            
            <YStack flex={1}>
              <XStack alignItems="center" space="$3">
                <Text fontSize="$6" fontWeight="bold">
                  {profile.firstName} {profile.lastName}
                </Text>
                {profile.isEmailVerified && (
                  <Theme name="green">
                    <Badge backgroundColor="$green3" borderColor="$green6">
                      <Text fontSize="$2" color="$green10">{t('auth.profile.verified')}</Text>
                    </Badge>
                  </Theme>
                )}
              </XStack>
              
              <XStack alignItems="center" space="$4" marginTop="$2">
                <XStack alignItems="center" space="$1">
                  <Mail size={16} color="$gray10" />
                  <Text fontSize="$2" color="$gray10">{profile.email}</Text>
                </XStack>
                {profile.location && (
                  <XStack alignItems="center" space="$1">
                    <MapPin size={16} color="$gray10" />
                    <Text fontSize="$2" color="$gray10">{profile.location}</Text>
                  </XStack>
                )}
              </XStack>

              <XStack alignItems="center" space="$4" marginTop="$2">
                <XStack alignItems="center" space="$1">
                  <Calendar size={12} color="$gray9" />
                  <Text fontSize="$1" color="$gray9">
                    {t('auth.profile.joined', { date: formatDate(profile.createdAt) })}
                  </Text>
                </XStack>
                <XStack alignItems="center" space="$1">
                  <User size={12} color="$gray9" />
                  <Text fontSize="$1" color="$gray9">
                    {t('auth.profile.lastActive', { date: formatDate(profile.lastLoginAt) })}
                  </Text>
                </XStack>
              </XStack>
            </YStack>

            <XStack space="$2">
              {isEditing ? (
                <>
                  <Button
                    variant="outlined"
                    size="$2"
                    onPress={handleCancel}
                    disabled={isLoading}
                  >
                    <XStack alignItems="center" space="$2">
                      <X size={16} />
                      <Text>{t('common.cancel')}</Text>
                    </XStack>
                  </Button>
                  <Button
                    size="$2"
                    theme="accent"
                    onPress={handleSubmit(handleFormSubmit)}
                    disabled={isLoading || !isDirty}
                  >
                    <XStack alignItems="center" space="$2">
                      {isLoading ? (
                        <Loader2 size={16} className="animate-spin" />
                      ) : (
                        <Check size={16} />
                      )}
                      <Text>{t('common.save')}</Text>
                    </XStack>
                  </Button>
                </>
              ) : (
                <Button
                  variant="outlined"
                  size="$2"
                  onPress={() => setIsEditing(true)}
                >
                  <XStack alignItems="center" space="$2">
                    <Edit size={16} />
                    <Text>{t('auth.profile.editProfile')}</Text>
                  </XStack>
                </Button>
              )}
            </XStack>
          </XStack>
        </CardHeader>
      </Card>

      {/* Profile Form */}
      <Card elevate>
        <CardHeader>
          <CardTitle>{t('auth.profile.information')}</CardTitle>
          <CardDescription>
            {t('auth.profile.updateInfo')}
          </CardDescription>
        </CardHeader>

        <CardContent space="$6">
          {/* Messages */}
          {error && (
            <Alert backgroundColor="$red2" borderColor="$red6">
              <XStack alignItems="center" space="$2">
                <AlertCircle size={16} color="$red10" />
                <AlertDescription>
                  <Text color="$red10">{error}</Text>
                </AlertDescription>
              </XStack>
            </Alert>
          )}

          {success && (
            <Alert backgroundColor="$green2" borderColor="$green6">
              <XStack alignItems="center" space="$2">
                <Check size={16} color="$green10" />
                <AlertDescription>
                  <Text color="$green10">{success}</Text>
                </AlertDescription>
              </XStack>
            </Alert>
          )}

          {/* Form Fields */}
          <YStack tag="form" onSubmit={handleSubmit(handleFormSubmit)} space="$6">
            <XStack flexDirection={{ initial: 'column', md: 'row' }} space="$6">
              <YStack flex={1}>
                <Label htmlFor="firstName">{t('auth.profile.firstName')}</Label>
                <Input
                  id="firstName"
                  {...register('firstName')}
                  disabled={!isEditing || isLoading}
                />
                {errors.firstName && (
                  <Text fontSize="$2" color="$red10" marginTop="$1">{errors.firstName.message}</Text>
                )}
              </YStack>

              <YStack flex={1}>
                <Label htmlFor="lastName">{t('auth.profile.lastName')}</Label>
                <Input
                  id="lastName"
                  {...register('lastName')}
                  disabled={!isEditing || isLoading}
                />
                {errors.lastName && (
                  <Text fontSize="$2" color="$red10" marginTop="$1">{errors.lastName.message}</Text>
                )}
              </YStack>
            </XStack>

            <YStack>
              <Label htmlFor="email">{t('auth.email')}</Label>
              <XStack position="relative">
                <XStack 
                  position="absolute" 
                  left="$3" 
                  top="$3" 
                  alignItems="center" 
                  justifyContent="center" 
                  zIndex={1}
                >
                  <Mail size={16} color="$gray10" />
                </XStack>
                <Input
                  id="email"
                  type="email"
                  paddingLeft="$10"
                  width="100%"
                  {...register('email')}
                  disabled={!isEditing || isLoading}
                />
              </XStack>
              {errors.email && (
                <Text fontSize="$2" color="$red10" marginTop="$1">{errors.email.message}</Text>
              )}
            </YStack>

            <YStack>
              <Label htmlFor="phone">{t('auth.profile.phone')}</Label>
              <XStack position="relative">
                <XStack 
                  position="absolute" 
                  left="$3" 
                  top="$3" 
                  alignItems="center" 
                  justifyContent="center" 
                  zIndex={1}
                >
                  <Phone size={16} color="$gray10" />
                </XStack>
                <Input
                  id="phone"
                  type="tel"
                  paddingLeft="$10"
                  width="100%"
                  placeholder="+1 (555) 123-4567"
                  {...register('phone')}
                  disabled={!isEditing || isLoading}
                />
              </XStack>
              {errors.phone && (
                <Text fontSize="$2" color="$red10" marginTop="$1">{errors.phone.message}</Text>
              )}
            </YStack>

            <YStack>
              <Label htmlFor="bio">{t('auth.profile.bio')}</Label>
              <TextArea
                id="bio"
                placeholder={t('auth.profile.bioPlaceholder')}
                numberOfLines={4}
                {...register('bio')}
                disabled={!isEditing || isLoading}
              />
              <Text fontSize="$1" color="$gray9" marginTop="$1">
                {watchedValues.bio?.length || 0}/500 {t('common.characters')}
              </Text>
              {errors.bio && (
                <Text fontSize="$2" color="$red10" marginTop="$1">{errors.bio.message}</Text>
              )}
            </YStack>

            <XStack flexDirection={{ initial: 'column', md: 'row' }} space="$6">
              <YStack flex={1}>
                <Label htmlFor="location">{t('auth.profile.location')}</Label>
                <XStack position="relative">
                  <XStack 
                    position="absolute" 
                    left="$3" 
                    top="$3" 
                    alignItems="center" 
                    justifyContent="center" 
                    zIndex={1}
                  >
                    <MapPin size={16} color="$gray10" />
                  </XStack>
                  <Input
                    id="location"
                    paddingLeft="$10"
                    width="100%"
                    placeholder={t('auth.profile.locationPlaceholder')}
                    {...register('location')}
                    disabled={!isEditing || isLoading}
                  />
                </XStack>
                {errors.location && (
                  <Text fontSize="$2" color="$red10" marginTop="$1">{errors.location.message}</Text>
                )}
              </YStack>

              <YStack flex={1}>
                <Label htmlFor="website">{t('auth.profile.website')}</Label>
                <Input
                  id="website"
                  type="url"
                  placeholder="https://example.com"
                  {...register('website')}
                  disabled={!isEditing || isLoading}
                />
                {errors.website && (
                  <Text fontSize="$2" color="$red10" marginTop="$1">{errors.website.message}</Text>
                )}
              </YStack>
            </XStack>

            <XStack flexDirection={{ initial: 'column', md: 'row' }} space="$6">
              <YStack flex={1}>
                <Label htmlFor="company">{t('auth.profile.company')}</Label>
                <Input
                  id="company"
                  placeholder={t('auth.profile.companyPlaceholder')}
                  {...register('company')}
                  disabled={!isEditing || isLoading}
                />
                {errors.company && (
                  <Text fontSize="$2" color="$red10" marginTop="$1">{errors.company.message}</Text>
                )}
              </YStack>

              <YStack flex={1}>
                <Label htmlFor="jobTitle">{t('auth.profile.jobTitle')}</Label>
                <Input
                  id="jobTitle"
                  placeholder={t('auth.profile.jobTitlePlaceholder')}
                  {...register('jobTitle')}
                  disabled={!isEditing || isLoading}
                />
                {errors.jobTitle && (
                  <Text fontSize="$2" color="$red10" marginTop="$1">{errors.jobTitle.message}</Text>
                )}
              </YStack>
            </XStack>
          </YStack>
        </CardContent>
      </Card>
    </YStack>
  );
};


