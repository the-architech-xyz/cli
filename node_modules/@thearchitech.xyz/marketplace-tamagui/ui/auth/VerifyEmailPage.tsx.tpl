'use client';

import React, { useState, useEffect } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { useTranslation } from '@/lib/i18n';
import { 
  YStack, 
  XStack, 
  Button, 
  Card, 
  CardContent, 
  CardDescription, 
  CardHeader, 
  CardTitle,
  Alert, 
  AlertDescription,
  Text,
  Theme,
  Square,
  Spinner
} from 'tamagui';
import { 
  Mail, 
  Loader2,
  AlertCircle,
  CheckCircle,
  ArrowLeft,
  RefreshCw
} from 'lucide-react-native';
import { useAuthService } from '@/lib/auth/hooks';

interface VerifyEmailPageProps {
  onSuccess?: () => void;
  className?: string;
}

// Custom hook for email verification functionality
const useEmailVerification = () => {
  const { verifyEmail } = useAuthService();
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<{ message: string } | null>(null);
  const [isVerified, setIsVerified] = useState(false);

  const verifyEmailFn = async (token: string) => {
    try {
      setIsLoading(true);
      setError(null);
      await verifyEmail.mutateAsync({ token });
      setIsVerified(true);
    } catch (err: any) {
      setError({ message: err.message || 'Failed to verify email' });
      setIsVerified(false);
    } finally {
      setIsLoading(false);
    }
  };

  const resendVerification = async (email: string) => {
    try {
      setIsLoading(true);
      setError(null);
      await verifyEmail.resend.mutateAsync({ email });
    } catch (err: any) {
      setError({ message: err.message || 'Failed to resend verification email' });
      throw err;
    } finally {
      setIsLoading(false);
    }
  };

  return {
    verifyEmail: verifyEmailFn,
    resendVerification,
    isLoading,
    error,
    isVerified
  };
};

export const VerifyEmailPage: React.FC<VerifyEmailPageProps> = ({
  onSuccess,
  className = '',
}) => {
  const { t } = useTranslation();
  const router = useRouter();
  const searchParams = useSearchParams();
  const { verifyEmail, resendVerification, isLoading, error, isVerified } = useEmailVerification();
  
  const [token, setToken] = useState<string | null>(null);
  const [isVerifying, setIsVerifying] = useState(true);
  const [email, setEmail] = useState<string>('');

  useEffect(() => {
    const tokenParam = searchParams?.get('token');
    const emailParam = searchParams?.get('email');
    
    if (tokenParam) {
      setToken(tokenParam);
      verifyEmail(tokenParam);
    } else {
      setIsVerifying(false);
    }
    
    if (emailParam) {
      setEmail(emailParam);
    }
  }, [searchParams, verifyEmail]);

  const handleResendVerification = async () => {
    if (email) {
      try {
        await resendVerification(email);
      } catch (err) {
        // Error is handled by the useEmailVerification hook
      }
    }
  };

  if (isVerifying) {
    return (
      <YStack 
        minHeight="100vh" 
        alignItems="center" 
        justifyContent="center" 
        backgroundColor="$gray2" 
        paddingVertical="$12" 
        paddingHorizontal="$4"
      >
        <YStack maxWidth={400} width="100%" space="$8" alignItems="center">
          <Spinner size="large" color="$blue10" />
          <Text color="$gray11">{t('auth.verifyingEmail')}</Text>
        </YStack>
      </YStack>
    );
  }

  if (isVerified) {
    return (
      <YStack 
        minHeight="100vh" 
        alignItems="center" 
        justifyContent="center" 
        backgroundColor="$gray2" 
        paddingVertical="$12" 
        paddingHorizontal="$4"
      >
        <YStack maxWidth={400} width="100%" space="$8">
          <YStack alignItems="center">
            <Text fontSize="$6" fontWeight="bold" color="$gray12">
              {t('auth.emailVerified')}
            </Text>
            <Text marginTop="$2" fontSize="$2" color="$gray10">
              {t('auth.emailSuccessfullyVerified')}
            </Text>
          </YStack>

          <Card elevate>
            <CardContent paddingTop="$6" space="$4">
              <YStack alignItems="center" space="$4">
                <XStack 
                  width={64} 
                  height={64} 
                  backgroundColor="$green2" 
                  borderRadius="$full" 
                  alignItems="center" 
                  justifyContent="center"
                >
                  <CheckCircle size={32} color="$green10" />
                </XStack>
                
                <YStack alignItems="center">
                  <Text fontSize="$4" fontWeight="500" color="$gray12" marginBottom="$2">
                    {t('auth.verificationSuccessful')}
                  </Text>
                  <Text fontSize="$2" color="$gray10" textAlign="center">
                    {t('auth.emailVerifiedDescription')}
                  </Text>
                </YStack>

                <YStack width="100%" space="$2">
                  <Button 
                    theme="accent" 
                    width="100%" 
                    onPress={() => router.push('/dashboard')}
                  >
                    {t('auth.goToDashboard')}
                  </Button>
                  
                  <Button 
                    variant="outlined" 
                    width="100%" 
                    onPress={() => router.push('/auth/login')}
                  >
                    <XStack space="$2" alignItems="center">
                      <ArrowLeft size={16} />
                      <Text>{t('auth.backToLogin')}</Text>
                    </XStack>
                  </Button>
                </YStack>
              </YStack>
            </CardContent>
          </Card>
        </YStack>
      </YStack>
    );
  }

  if (error) {
    return (
      <YStack 
        minHeight="100vh" 
        alignItems="center" 
        justifyContent="center" 
        backgroundColor="$gray2" 
        paddingVertical="$12" 
        paddingHorizontal="$4"
      >
        <YStack maxWidth={400} width="100%" space="$8">
          <YStack alignItems="center">
            <Text fontSize="$6" fontWeight="bold" color="$gray12">
              {t('auth.verificationFailed')}
            </Text>
            <Text marginTop="$2" fontSize="$2" color="$gray10">
              {t('auth.emailVerificationProblem')}
            </Text>
          </YStack>

          <Card elevate>
            <CardContent paddingTop="$6" space="$4">
              <YStack alignItems="center" space="$4">
                <XStack 
                  width={64} 
                  height={64} 
                  backgroundColor="$red2" 
                  borderRadius="$full" 
                  alignItems="center" 
                  justifyContent="center"
                >
                  <AlertCircle size={32} color="$red10" />
                </XStack>
                
                <YStack alignItems="center">
                  <Text fontSize="$4" fontWeight="500" color="$gray12" marginBottom="$2">
                    {t('auth.verificationFailed')}
                  </Text>
                  <Text fontSize="$2" color="$gray10" textAlign="center">
                    {t('auth.verificationLinkInvalid')}
                  </Text>
                </YStack>

                <YStack width="100%" space="$2">
                  <Button
                    theme="accent"
                    width="100%"
                    onPress={handleResendVerification}
                    disabled={isLoading || !email}
                  >
                    <XStack space="$2" alignItems="center">
                      {isLoading ? (
                        <>
                          <Loader2 size={16} color="$color" className="animate-spin" />
                          <Text>{t('auth.sending')}</Text>
                        </>
                      ) : (
                        <>
                          <RefreshCw size={16} />
                          <Text>{t('auth.resendVerificationEmail')}</Text>
                        </>
                      )}
                    </XStack>
                  </Button>
                  
                  <Button 
                    variant="outlined" 
                    width="100%" 
                    onPress={() => router.push('/auth/login')}
                  >
                    <XStack space="$2" alignItems="center">
                      <ArrowLeft size={16} />
                      <Text>{t('auth.backToLogin')}</Text>
                    </XStack>
                  </Button>
                </YStack>
              </YStack>
            </CardContent>
          </Card>
        </YStack>
      </YStack>
    );
  }

  return (
    <YStack 
      minHeight="100vh" 
      alignItems="center" 
      justifyContent="center" 
      backgroundColor="$gray2" 
      paddingVertical="$12" 
      paddingHorizontal="$4"
    >
      <YStack maxWidth={400} width="100%" space="$8">
        <YStack alignItems="center">
          <Text fontSize="$6" fontWeight="bold" color="$gray12">
            {t('auth.verifyYourEmail')}
          </Text>
          <Text marginTop="$2" fontSize="$2" color="$gray10">
            {t('auth.verificationLinkSent')}
          </Text>
        </YStack>

        <Card elevate>
          <CardHeader>
            <CardTitle>{t('auth.checkYourEmail')}</CardTitle>
            <CardDescription>
              {t('auth.verificationLinkSentToEmail')}
            </CardDescription>
          </CardHeader>
          <CardContent space="$6">
            {/* Error Alert */}
            {error && (
              <Alert backgroundColor="$red2" borderColor="$red6">
                <XStack alignItems="center" space="$2">
                  <AlertCircle size={16} color="$red10" />
                  <AlertDescription>
                    <Text color="$red10">{error.message}</Text>
                  </AlertDescription>
                </XStack>
              </Alert>
            )}

            <YStack alignItems="center" space="$4">
              <XStack 
                width={64} 
                height={64} 
                backgroundColor="$blue2" 
                borderRadius="$full" 
                alignItems="center" 
                justifyContent="center"
              >
                <Mail size={32} color="$blue10" />
              </XStack>
              
              <YStack alignItems="center">
                <Text fontSize="$4" fontWeight="500" color="$gray12" marginBottom="$2">
                  {t('auth.verificationEmailSent')}
                </Text>
                <Text fontSize="$2" color="$gray10" textAlign="center">
                  {t('auth.checkEmailAndClickVerificationLink')}
                </Text>
              </YStack>

              <YStack space="$3" width="100%">
                <Text fontSize="$2" color="$gray10" textAlign="center">
                  {t('auth.didntReceiveEmail')}
                </Text>
                
                <YStack space="$2">
                  <Button
                    variant="outlined"
                    width="100%"
                    onPress={handleResendVerification}
                    disabled={isLoading || !email}
                  >
                    <XStack space="$2" alignItems="center">
                      {isLoading ? (
                        <>
                          <Loader2 size={16} className="animate-spin" />
                          <Text>{t('auth.sending')}</Text>
                        </>
                      ) : (
                        <>
                          <RefreshCw size={16} />
                          <Text>{t('auth.resendVerificationEmail')}</Text>
                        </>
                      )}
                    </XStack>
                  </Button>
                  
                  <Button 
                    variant="ghost" 
                    width="100%" 
                    onPress={() => router.push('/auth/login')}
                  >
                    <XStack space="$2" alignItems="center">
                      <ArrowLeft size={16} />
                      <Text>{t('auth.backToLogin')}</Text>
                    </XStack>
                  </Button>
                </YStack>
              </YStack>
            </YStack>
          </CardContent>
        </Card>

        {/* Help Text */}
        <YStack alignItems="center">
          <Text fontSize="$1" color="$gray9" textAlign="center">
            {t('auth.verificationLinkExpiration')}
          </Text>
        </YStack>
      </YStack>
    </YStack>
  );
};