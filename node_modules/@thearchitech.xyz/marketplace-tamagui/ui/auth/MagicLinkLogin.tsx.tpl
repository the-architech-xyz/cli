'use client';

import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { motion, AnimatePresence } from 'framer-motion';
import { useTranslation } from '@/lib/i18n';
import { 
  Mail, 
  Send, 
  CheckCircle, 
  AlertCircle, 
  Loader2,
  ArrowLeft,
  RefreshCw
} from 'lucide-react-native';
import { 
  YStack, 
  XStack, 
  Button, 
  Input, 
  Label, 
  Card, 
  CardContent, 
  CardDescription, 
  CardHeader, 
  CardTitle,
  Alert, 
  AlertDescription,
  Text,
  Theme,
  Square
} from 'tamagui';
import { useAuthService } from '@/lib/auth/hooks';

const magicLinkSchema = z.object({
  email: z.string().email('Please enter a valid email address'),
});

type MagicLinkFormData = z.infer<typeof magicLinkSchema>;

interface MagicLinkLoginProps {
  onSuccess?: () => void;
  onBack?: () => void;
  className?: string;
}

export function MagicLinkLogin({ onSuccess, onBack, className }: MagicLinkLoginProps) {
  const { t } = useTranslation();
  const [isLoading, setIsLoading] = useState(false);
  const [isSent, setIsSent] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [email, setEmail] = useState<string>('');
  const [resendCooldown, setResendCooldown] = useState(0);

  const { useAuthentication } = useAuthService();
  const { magicLinkSignIn } = useAuthentication();

  const form = useForm<MagicLinkFormData>({
    resolver: zodResolver(magicLinkSchema),
    defaultValues: {
      email: '',
    },
  });

  const handleSubmit = async (data: MagicLinkFormData) => {
    setIsLoading(true);
    setError(null);
    setEmail(data.email);

    try {
      const result = await magicLinkSignIn.mutateAsync({
        email: data.email,
        redirectTo: window.location.origin + '/dashboard',
      });

      if (result.success) {
        setIsSent(true);
        setResendCooldown(60); // 60 seconds cooldown
        startCooldown();
      } else {
        setError(result.message || t('auth.magicLink.sendError'));
      }
    } catch (err) {
      setError(err instanceof Error ? err.message : t('auth.magicLink.sendError'));
    } finally {
      setIsLoading(false);
    }
  };

  const handleResend = async () => {
    if (resendCooldown > 0) return;

    setIsLoading(true);
    setError(null);

    try {
      const result = await magicLinkSignIn.mutateAsync({
        email: email,
        redirectTo: window.location.origin + '/dashboard',
      });

      if (result.success) {
        setResendCooldown(60);
        startCooldown();
      } else {
        setError(result.message || t('auth.magicLink.resendError'));
      }
    } catch (err) {
      setError(err instanceof Error ? err.message : t('auth.magicLink.resendError'));
    } finally {
      setIsLoading(false);
    }
  };

  const startCooldown = () => {
    const interval = setInterval(() => {
      setResendCooldown((prev) => {
        if (prev <= 1) {
          clearInterval(interval);
          return 0;
        }
        return prev - 1;
      });
    }, 1000);
  };

  const handleBack = () => {
    setIsSent(false);
    setError(null);
    setEmail('');
    setResendCooldown(0);
    form.reset();
    onBack?.();
  };

  return (
    <YStack width="100%" maxWidth={400} marginHorizontal="auto">
      <Card elevate>
        <CardHeader alignItems="center">
          <motion.div
            initial={{ scale: 0.8 }}
            animate={{ scale: 1 }}
            transition={{ delay: 0.2, type: "spring", stiffness: 200 }}
            style={{ marginBottom: 16 }}
          >
            <Theme name="accent">
              <Square 
                size="$6" 
                backgroundColor="$background" 
                borderRadius="$full" 
                alignItems="center" 
                justifyContent="center"
              >
                <Mail size={24} color="$color" />
              </Square>
            </Theme>
          </motion.div>
          <CardTitle>
            {isSent ? t('auth.magicLink.checkEmail') : t('auth.magicLink.title')}
          </CardTitle>
          <CardDescription>
            {isSent 
              ? t('auth.magicLink.sentDescription')
              : t('auth.magicLink.description')
            }
          </CardDescription>
        </CardHeader>

        <CardContent space="$6">
          <AnimatePresence mode="wait">
            {!isSent ? (
              <motion.div
                key="form"
                initial={{ opacity: 0, x: 20 }}
                animate={{ opacity: 1, x: 0 }}
                exit={{ opacity: 0, x: -20 }}
                style={{ display: 'flex', flexDirection: 'column', gap: 24 }}
              >
                <YStack tag="form" onSubmit={form.handleSubmit(handleSubmit)} space="$4">
                  <YStack space="$2">
                    <Label htmlFor="email">{t('auth.email')}</Label>
                    <XStack position="relative">
                      <XStack 
                        position="absolute" 
                        left="$3" 
                        top="50%" 
                        transform="translateY(-50%)" 
                        zIndex={1}
                      >
                        <Mail size={16} color="$gray10" />
                      </XStack>
                      <Input
                        id="email"
                        type="email"
                        {...form.register('email')}
                        placeholder={t('auth.emailPlaceholder')}
                        disabled={isLoading}
                        paddingLeft="$10"
                        height="$5"
                        width="100%"
                      />
                    </XStack>
                    {form.formState.errors.email && (
                      <XStack alignItems="center" space="$1">
                        <AlertCircle size={12} color="$red10" />
                        <Text fontSize="$2" color="$red10">
                          {form.formState.errors.email.message}
                        </Text>
                      </XStack>
                    )}
                  </YStack>

                  {error && (
                    <Alert backgroundColor="$red2" borderColor="$red6">
                      <XStack alignItems="center" space="$2">
                        <AlertCircle size={16} color="$red10" />
                        <AlertDescription>
                          <Text color="$red10">{error}</Text>
                        </AlertDescription>
                      </XStack>
                    </Alert>
                  )}

                  <YStack space="$3">
                    <Button
                      type="submit"
                      width="100%"
                      height="$5"
                      theme="accent"
                      disabled={isLoading}
                    >
                      <XStack alignItems="center" space="$2">
                        {isLoading ? (
                          <>
                            <Loader2 size={16} color="$color" className="animate-spin" />
                            <Text>{t('auth.magicLink.sending')}</Text>
                          </>
                        ) : (
                          <>
                            <Send size={16} color="$color" />
                            <Text>{t('auth.magicLink.send')}</Text>
                          </>
                        )}
                      </XStack>
                    </Button>

                    {onBack && (
                      <Button
                        type="button"
                        variant="outlined"
                        width="100%"
                        onPress={handleBack}
                        disabled={isLoading}
                      >
                        <XStack alignItems="center" space="$2">
                          <ArrowLeft size={16} />
                          <Text>{t('auth.backToSignIn')}</Text>
                        </XStack>
                      </Button>
                    )}
                  </YStack>
                </YStack>

                <YStack alignItems="center">
                  <Text fontSize="$1" color="$gray10" textAlign="center">
                    {t('auth.magicLink.secureInfo')}
                  </Text>
                </YStack>
              </motion.div>
            ) : (
              <motion.div
                key="success"
                initial={{ opacity: 0, scale: 0.8 }}
                animate={{ opacity: 1, scale: 1 }}
                exit={{ opacity: 0, scale: 0.8 }}
                style={{ display: 'flex', flexDirection: 'column', gap: 24 }}
              >
                <YStack alignItems="center" space="$4">
                  <Theme name="green">
                    <Square 
                      size="$8" 
                      backgroundColor="$backgroundHover" 
                      borderRadius="$full" 
                      alignItems="center" 
                      justifyContent="center"
                    >
                      <CheckCircle size={32} color="$green10" />
                    </Square>
                  </Theme>
                  
                  <YStack alignItems="center" space="$2">
                    <Text fontSize="$4" fontWeight="bold">
                      {t('auth.magicLink.sent')}
                    </Text>
                    <Text fontSize="$2" color="$gray10" textAlign="center">
                      {t('auth.magicLink.sentTo', { email })}
                    </Text>
                  </YStack>
                </YStack>

                <YStack space="$4">
                  <Alert backgroundColor="$blue2" borderColor="$blue6">
                    <XStack alignItems="flex-start" space="$2">
                      <AlertCircle size={16} color="$blue10" marginTop="$1" />
                      <YStack>
                        <Text fontWeight="bold" color="$blue10">
                          {t('auth.magicLink.nextSteps')}
                        </Text>
                        <YStack marginTop="$2" space="$1" paddingLeft="$2">
                          <XStack space="$2">
                            <Text color="$blue10">1.</Text>
                            <Text color="$blue10">{t('auth.magicLink.step1')}</Text>
                          </XStack>
                          <XStack space="$2">
                            <Text color="$blue10">2.</Text>
                            <Text color="$blue10">{t('auth.magicLink.step2')}</Text>
                          </XStack>
                          <XStack space="$2">
                            <Text color="$blue10">3.</Text>
                            <Text color="$blue10">{t('auth.magicLink.step3')}</Text>
                          </XStack>
                        </YStack>
                      </YStack>
                    </XStack>
                  </Alert>

                  <YStack alignItems="center" space="$2">
                    <Text fontSize="$2" color="$gray10">
                      {t('auth.magicLink.didntReceive')}
                    </Text>
                    <Button
                      type="button"
                      variant="outlined"
                      onPress={handleResend}
                      disabled={isLoading || resendCooldown > 0}
                      width="100%"
                    >
                      <XStack alignItems="center" space="$2">
                        {isLoading ? (
                          <>
                            <Loader2 size={16} className="animate-spin" />
                            <Text>{t('auth.magicLink.sending')}</Text>
                          </>
                        ) : resendCooldown > 0 ? (
                          <>
                            <RefreshCw size={16} />
                            <Text>{t('auth.magicLink.resendIn', { seconds: resendCooldown })}</Text>
                          </>
                        ) : (
                          <>
                            <RefreshCw size={16} />
                            <Text>{t('auth.magicLink.resend')}</Text>
                          </>
                        )}
                      </XStack>
                    </Button>
                  </YStack>

                  {error && (
                    <Alert backgroundColor="$red2" borderColor="$red6">
                      <XStack alignItems="center" space="$2">
                        <AlertCircle size={16} color="$red10" />
                        <AlertDescription>
                          <Text color="$red10">{error}</Text>
                        </AlertDescription>
                      </XStack>
                    </Alert>
                  )}

                  <XStack space="$2">
                    <Button
                      type="button"
                      variant="outlined"
                      onPress={handleBack}
                      flex={1}
                    >
                      <XStack alignItems="center" space="$2">
                        <ArrowLeft size={16} />
                        <Text>{t('auth.magicLink.tryDifferent')}</Text>
                      </XStack>
                    </Button>
                    <Button
                      type="button"
                      onPress={() => window.location.reload()}
                      theme="accent"
                      flex={1}
                    >
                      <XStack alignItems="center" space="$2">
                        <RefreshCw size={16} />
                        <Text>{t('auth.magicLink.refresh')}</Text>
                      </XStack>
                    </Button>
                  </XStack>
                </YStack>
              </motion.div>
            )}
          </AnimatePresence>
        </CardContent>
      </Card>
    </YStack>
  );
}


