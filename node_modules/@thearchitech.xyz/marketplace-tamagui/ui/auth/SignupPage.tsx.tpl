'use client';

import React, { useState } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { useTranslation } from '@/lib/i18n';
import { 
  YStack, 
  XStack, 
  Button, 
  Input, 
  Label, 
  Card, 
  CardContent, 
  CardDescription, 
  CardHeader, 
  CardTitle,
  Alert, 
  AlertDescription,
  Checkbox,
  Separator,
  Text,
  Theme,
  Progress
} from 'tamagui';
import { 
  Mail, 
  Lock, 
  User,
  Eye, 
  EyeOff, 
  Loader2,
  Github,
  Chrome,
  AlertCircle,
  Check
} from 'lucide-react-native';
import { useAuthService } from '@/lib/auth/hooks';

interface SignupPageProps {
  onSuccess?: () => void;
  redirectTo?: string;
  className?: string;
}

export const SignupPage: React.FC<SignupPageProps> = ({
  onSuccess,
  redirectTo = '/dashboard',
  className = '',
}) => {
  const { t } = useTranslation();
  const router = useRouter();
  const { useSession, signUp } = useAuthService();
  const { data: session } = useSession();
  
  const [formData, setFormData] = useState({
    name: '',
    email: '',
    password: '',
    confirmPassword: '',
    agreedToTerms: false,
    agreedToMarketing: false,
  });
  const [showPassword, setShowPassword] = useState(false);
  const [showConfirmPassword, setShowConfirmPassword] = useState(false);
  const [formErrors, setFormErrors] = useState<Record<string, string>>({});
  const [isLoading, setIsLoading] = useState(false);

  const handleInputChange = (field: string, value: string | boolean) => {
    setFormData(prev => ({
      ...prev,
      [field]: value,
    }));

    // Clear error when user starts typing
    if (formErrors[field]) {
      setFormErrors(prev => ({
        ...prev,
        [field]: '',
      }));
    }
  };

  const validateForm = (): boolean => {
    const errors: Record<string, string> = {};

    if (!formData.name.trim()) {
      errors.name = t('auth.errors.nameRequired');
    } else if (formData.name.trim().length < 2) {
      errors.name = t('auth.errors.nameLength');
    }

    if (!formData.email) {
      errors.email = t('auth.errors.emailRequired');
    } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email)) {
      errors.email = t('auth.errors.emailInvalid');
    }

    if (!formData.password) {
      errors.password = t('auth.errors.passwordRequired');
    } else if (formData.password.length < 8) {
      errors.password = t('auth.errors.passwordLength');
    } else if (!/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/.test(formData.password)) {
      errors.password = t('auth.errors.passwordComplexity');
    }

    if (!formData.confirmPassword) {
      errors.confirmPassword = t('auth.errors.confirmPasswordRequired');
    } else if (formData.password !== formData.confirmPassword) {
      errors.confirmPassword = t('auth.errors.passwordsDoNotMatch');
    }

    if (!formData.agreedToTerms) {
      errors.agreedToTerms = t('auth.errors.termsRequired');
    }

    setFormErrors(errors);
    return Object.keys(errors).length === 0;
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!validateForm()) {
      return;
    }

    setIsLoading(true);
    try {
      await signUp.email.mutateAsync({
        name: formData.name,
        email: formData.email,
        password: formData.password,
      });
      onSuccess?.();
      router.push(redirectTo);
    } catch (err: any) {
      setFormErrors({ general: err.message || t('auth.errors.signUpFailed') });
    } finally {
      setIsLoading(false);
    }
  };

  const handleSocialLogin = async (provider: 'google' | 'github') => {
    try {
      setIsLoading(true);
      await signUp.social.mutateAsync({ 
        provider, 
        callbackURL: redirectTo 
      });
    } catch (err: any) {
      setFormErrors({ 
        general: err.message || t('auth.errors.socialSignUpFailed', { provider }) 
      });
    } finally {
      setIsLoading(false);
    }
  };

  const getPasswordStrength = (password: string): { strength: number; label: string; color: string } => {
    let strength = 0;
    
    if (password.length >= 8) strength++;
    if (/[a-z]/.test(password)) strength++;
    if (/[A-Z]/.test(password)) strength++;
    if (/\d/.test(password)) strength++;
    if (/[^A-Za-z0-9]/.test(password)) strength++;
    
    const strengthMap = {
      0: { label: t('auth.passwordStrength.veryWeak'), color: '$red10' },
      1: { label: t('auth.passwordStrength.weak'), color: '$red9' },
      2: { label: t('auth.passwordStrength.fair'), color: '$yellow9' },
      3: { label: t('auth.passwordStrength.good'), color: '$yellow10' },
      4: { label: t('auth.passwordStrength.strong'), color: '$green9' },
      5: { label: t('auth.passwordStrength.veryStrong'), color: '$green10' },
    };
    
    return {
      strength,
      ...strengthMap[strength as keyof typeof strengthMap],
    };
  };

  const passwordStrength = getPasswordStrength(formData.password);

  // Get available social providers
  const providers = [
    { id: 'google', name: 'Google' },
    { id: 'github', name: 'GitHub' }
  ];

  return (
    <YStack 
      minHeight="100vh" 
      alignItems="center" 
      justifyContent="center" 
      backgroundColor="$gray2" 
      paddingVertical="$12" 
      paddingHorizontal="$4"
    >
      <YStack maxWidth={400} width="100%" space="$8">
        <YStack alignItems="center">
          <Text fontSize="$6" fontWeight="bold" color="$gray12">
            {t('auth.createAccount')}
          </Text>
          <Text marginTop="$2" fontSize="$2" color="$gray10">
            {t('auth.orSignIn')}{' '}
            <Text 
              tag="a" 
              href="/auth/login" 
              color="$blue10" 
              fontWeight="500" 
              hoverStyle={{ color: '$blue9' }}
            >
              {t('auth.signInExisting')}
            </Text>
          </Text>
        </YStack>

        <Card elevate>
          <CardHeader>
            <CardTitle>{t('auth.getStarted')}</CardTitle>
            <CardDescription>
              {t('auth.createAccountToStart')}
            </CardDescription>
          </CardHeader>
          <CardContent space="$6">
            {/* Error Alert */}
            {formErrors.general && (
              <Alert backgroundColor="$red2" borderColor="$red6">
                <XStack alignItems="center" space="$2">
                  <AlertCircle size={16} color="$red10" />
                  <AlertDescription>
                    <Text color="$red10">{formErrors.general}</Text>
                  </AlertDescription>
                </XStack>
              </Alert>
            )}

            {/* Social Login */}
            {providers.length > 0 && (
              <YStack space="$3">
                {providers.map((provider) => (
                  <Button
                    key={provider.id}
                    variant="outlined"
                    width="100%"
                    onPress={() => handleSocialLogin(provider.id as 'google' | 'github')}
                    disabled={isLoading}
                  >
                    <XStack alignItems="center" space="$2">
                      {provider.id === 'google' && <Chrome size={16} />}
                      {provider.id === 'github' && <Github size={16} />}
                      <Text>{t('auth.continueWith', { provider: provider.name })}</Text>
                    </XStack>
                  </Button>
                ))}
                
                <XStack alignItems="center" justifyContent="center" position="relative">
                  <Separator width="100%" position="absolute" />
                  <YStack backgroundColor="$background" paddingHorizontal="$2">
                    <Text fontSize="$1" color="$gray10" textTransform="uppercase">
                      {t('auth.orContinueWith')}
                    </Text>
                  </YStack>
                </XStack>
              </YStack>
            )}

            {/* Signup Form */}
            <YStack tag="form" onSubmit={handleSubmit} space="$4">
              <YStack>
                <Label htmlFor="name">{t('auth.fullName')}</Label>
                <XStack position="relative">
                  <XStack 
                    position="absolute" 
                    left="$3" 
                    top="50%" 
                    transform="translateY(-50%)" 
                    zIndex={1}
                  >
                    <User size={16} color="$gray10" />
                  </XStack>
                  <Input
                    id="name"
                    type="text"
                    placeholder={t('auth.fullNamePlaceholder')}
                    value={formData.name}
                    onChange={(e) => handleInputChange('name', e.target.value)}
                    paddingLeft="$10"
                    width="100%"
                    borderColor={formErrors.name ? '$red10' : undefined}
                    required
                  />
                </XStack>
                {formErrors.name && (
                  <Text fontSize="$2" color="$red10" marginTop="$1">{formErrors.name}</Text>
                )}
              </YStack>

              <YStack>
                <Label htmlFor="email">{t('auth.email')}</Label>
                <XStack position="relative">
                  <XStack 
                    position="absolute" 
                    left="$3" 
                    top="50%" 
                    transform="translateY(-50%)" 
                    zIndex={1}
                  >
                    <Mail size={16} color="$gray10" />
                  </XStack>
                  <Input
                    id="email"
                    type="email"
                    placeholder={t('auth.emailPlaceholder')}
                    value={formData.email}
                    onChange={(e) => handleInputChange('email', e.target.value)}
                    paddingLeft="$10"
                    width="100%"
                    borderColor={formErrors.email ? '$red10' : undefined}
                    required
                  />
                </XStack>
                {formErrors.email && (
                  <Text fontSize="$2" color="$red10" marginTop="$1">{formErrors.email}</Text>
                )}
              </YStack>

              <YStack>
                <Label htmlFor="password">{t('auth.password')}</Label>
                <XStack position="relative">
                  <XStack 
                    position="absolute" 
                    left="$3" 
                    top="50%" 
                    transform="translateY(-50%)" 
                    zIndex={1}
                  >
                    <Lock size={16} color="$gray10" />
                  </XStack>
                  <Input
                    id="password"
                    type={showPassword ? 'text' : 'password'}
                    placeholder={t('auth.createPasswordPlaceholder')}
                    value={formData.password}
                    onChange={(e) => handleInputChange('password', e.target.value)}
                    paddingLeft="$10"
                    paddingRight="$10"
                    width="100%"
                    borderColor={formErrors.password ? '$red10' : undefined}
                    required
                  />
                  <XStack 
                    position="absolute" 
                    right="$3" 
                    top="50%" 
                    transform="translateY(-50%)" 
                    zIndex={1}
                  >
                    <Button
                      chromeless
                      onPress={() => setShowPassword(!showPassword)}
                      padding="$0"
                    >
                      {showPassword ? <EyeOff size={16} color="$gray10" /> : <Eye size={16} color="$gray10" />}
                    </Button>
                  </XStack>
                </XStack>
                {formData.password && (
                  <YStack marginTop="$2">
                    <XStack alignItems="center" space="$2">
                      <Progress 
                        value={(passwordStrength.strength / 5) * 100} 
                        backgroundColor="$gray5"
                        flex={1}
                      >
                        <Progress.Indicator backgroundColor={passwordStrength.color} />
                      </Progress>
                      <Text fontSize="$1" color="$gray10">{passwordStrength.label}</Text>
                    </XStack>
                  </YStack>
                )}
                {formErrors.password && (
                  <Text fontSize="$2" color="$red10" marginTop="$1">{formErrors.password}</Text>
                )}
              </YStack>

              <YStack>
                <Label htmlFor="confirmPassword">{t('auth.confirmPassword')}</Label>
                <XStack position="relative">
                  <XStack 
                    position="absolute" 
                    left="$3" 
                    top="50%" 
                    transform="translateY(-50%)" 
                    zIndex={1}
                  >
                    <Lock size={16} color="$gray10" />
                  </XStack>
                  <Input
                    id="confirmPassword"
                    type={showConfirmPassword ? 'text' : 'password'}
                    placeholder={t('auth.confirmPasswordPlaceholder')}
                    value={formData.confirmPassword}
                    onChange={(e) => handleInputChange('confirmPassword', e.target.value)}
                    paddingLeft="$10"
                    paddingRight="$10"
                    width="100%"
                    borderColor={formErrors.confirmPassword ? '$red10' : undefined}
                    required
                  />
                  <XStack 
                    position="absolute" 
                    right="$3" 
                    top="50%" 
                    transform="translateY(-50%)" 
                    zIndex={1}
                  >
                    <Button
                      chromeless
                      onPress={() => setShowConfirmPassword(!showConfirmPassword)}
                      padding="$0"
                    >
                      {showConfirmPassword ? <EyeOff size={16} color="$gray10" /> : <Eye size={16} color="$gray10" />}
                    </Button>
                  </XStack>
                </XStack>
                {formErrors.confirmPassword && (
                  <Text fontSize="$2" color="$red10" marginTop="$1">{formErrors.confirmPassword}</Text>
                )}
              </YStack>

              <YStack space="$3">
                <XStack alignItems="center" space="$2">
                  <Checkbox
                    id="agreedToTerms"
                    checked={formData.agreedToTerms}
                    onCheckedChange={(checked) => handleInputChange('agreedToTerms', !!checked)}
                    size="$2"
                  >
                    <Checkbox.Indicator>
                      <Theme name="accent">
                        <XStack alignItems="center" justifyContent="center">
                          <Check size={12} color="$color" />
                        </XStack>
                      </Theme>
                    </Checkbox.Indicator>
                  </Checkbox>
                  <Label htmlFor="agreedToTerms" fontSize="$2">
                    {t('auth.agreeToTerms')}{' '}
                    <Text 
                      tag="a" 
                      href="/terms" 
                      color="$blue10" 
                      hoverStyle={{ color: '$blue9' }}
                    >
                      {t('auth.termsOfService')}
                    </Text>{' '}
                    {t('auth.and')}{' '}
                    <Text 
                      tag="a" 
                      href="/privacy" 
                      color="$blue10" 
                      hoverStyle={{ color: '$blue9' }}
                    >
                      {t('auth.privacyPolicy')}
                    </Text>
                  </Label>
                </XStack>
                {formErrors.agreedToTerms && (
                  <Text fontSize="$2" color="$red10">{formErrors.agreedToTerms}</Text>
                )}

                <XStack alignItems="center" space="$2">
                  <Checkbox
                    id="agreedToMarketing"
                    checked={formData.agreedToMarketing}
                    onCheckedChange={(checked) => handleInputChange('agreedToMarketing', !!checked)}
                    size="$2"
                  >
                    <Checkbox.Indicator>
                      <Theme name="accent">
                        <XStack alignItems="center" justifyContent="center">
                          <Check size={12} color="$color" />
                        </XStack>
                      </Theme>
                    </Checkbox.Indicator>
                  </Checkbox>
                  <Label htmlFor="agreedToMarketing" fontSize="$2">
                    {t('auth.agreeToMarketing')}
                  </Label>
                </XStack>
              </YStack>

              <Button
                type="submit"
                width="100%"
                theme="accent"
                disabled={isLoading}
              >
                <XStack alignItems="center" space="$2">
                  {isLoading ? (
                    <>
                      <Loader2 size={16} color="$color" className="animate-spin" />
                      <Text>{t('auth.creatingAccount')}</Text>
                    </>
                  ) : (
                    <Text>{t('auth.createAccount')}</Text>
                  )}
                </XStack>
              </Button>
            </YStack>

            <YStack alignItems="center">
              <Text fontSize="$2" color="$gray10">
                {t('auth.alreadyHaveAccount')}{' '}
                <Text 
                  tag="a" 
                  href="/auth/login" 
                  color="$blue10" 
                  fontWeight="500" 
                  hoverStyle={{ color: '$blue9' }}
                >
                  {t('auth.signIn')}
                </Text>
              </Text>
            </YStack>
          </CardContent>
        </Card>
      </YStack>
    </YStack>
  );
};


