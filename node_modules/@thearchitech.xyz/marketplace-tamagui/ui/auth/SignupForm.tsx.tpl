/**
 * Signup Form Component (Tamagui)
 * 
 * User registration form with i18n support
 */

import React, { useState } from 'react';
import { YStack, XStack, Card, Text, Button, Input, Label, Checkbox, Progress, Separator } from 'tamagui';
import { useForm, Controller } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';
import { useTranslation } from '@/lib/i18n';
import { 
  Eye, 
  EyeOff, 
  Mail, 
  Lock, 
  User, 
  CheckCircle,
  AlertCircle
} from '@tamagui/lucide-icons';
import { Spinner } from 'tamagui';
import Link from 'next/link';

const signupSchema = z.object({
  firstName: z.string().min(2, 'First name must be at least 2 characters'),
  lastName: z.string().min(2, 'Last name must be at least 2 characters'),
  email: z.string().email('Please enter a valid email address'),
  password: z.string()
    .min(8, 'Password must be at least 8 characters')
    .regex(/[A-Z]/, 'Password must contain at least one uppercase letter')
    .regex(/[a-z]/, 'Password must contain at least one lowercase letter')
    .regex(/[0-9]/, 'Password must contain at least one number')
    .regex(/[^A-Za-z0-9]/, 'Password must contain at least one special character'),
  confirmPassword: z.string(),
  acceptTerms: z.boolean().refine(val => val === true, 'You must accept the terms and conditions'),
  acceptMarketing: z.boolean().optional(),
}).refine((data) => data.password === data.confirmPassword, {
  message: "Passwords don't match",
  path: ["confirmPassword"],
});

type SignupFormData = z.infer<typeof signupSchema>;

interface SignupFormProps {
  onSubmit: (data: SignupFormData) => Promise<void>;
  isLoading?: boolean;
  error?: string;
  success?: string;
  onSocialSignup?: (provider: 'google' | 'github' | 'discord') => void;
}

export function SignupForm({
  onSubmit,
  isLoading = false,
  error,
  success,
  onSocialSignup,
}: SignupFormProps) {
  const { t } = useTranslation();
  const [showPassword, setShowPassword] = useState(false);
  const [showConfirmPassword, setShowConfirmPassword] = useState(false);

  const {
    control,
    handleSubmit,
    formState: { errors, isValid },
    watch,
  } = useForm<SignupFormData>({
    resolver: zodResolver(signupSchema),
    mode: 'onChange',
  });

  const password = watch('password', '');

  const getPasswordStrength = (password: string): { score: number; label: string; color: string } => {
    let score = 0;
    if (password.length >= 8) score++;
    if (/[A-Z]/.test(password)) score++;
    if (/[a-z]/.test(password)) score++;
    if (/[0-9]/.test(password)) score++;
    if (/[^A-Za-z0-9]/.test(password)) score++;

    const strengthMap = {
      0: { label: t('password.strength.veryWeak'), color: '$red10' },
      1: { label: t('password.strength.weak'), color: '$red9' },
      2: { label: t('password.strength.fair'), color: '$yellow10' },
      3: { label: t('password.strength.good'), color: '$blue10' },
      4: { label: t('password.strength.strong'), color: '$green9' },
      5: { label: t('password.strength.veryStrong'), color: '$green10' },
    };

    return { score, ...strengthMap[score as keyof typeof strengthMap] };
  };

  const passwordStrength = getPasswordStrength(password);

  const handleFormSubmit = async (data: SignupFormData) => {
    try {
      await onSubmit(data);
    } catch (error) {
      console.error('Signup failed:', error);
    }
  };

  return (
    <Card
      theme="base"
      size="$4"
      padding="$0"
      backgroundColor="$background"
      borderWidth={1}
      borderColor="$borderColor"
      borderRadius="$6"
      elevation="$2"
      width="100%"
      maxWidth={400}
      alignSelf="center"
    >
      <YStack padding="$6" alignItems="center" gap="$2">
        <Text fontSize="$6" fontWeight="bold" color="$color" textAlign="center">
          {t('signup.title')}
        </Text>
        <Text fontSize="$3" color="$colorFocus" textAlign="center">
          {t('signup.description')}
        </Text>
      </YStack>

      <YStack padding="$6" paddingTop="$0" gap="$6">
        {/* Social Signup */}
        {onSocialSignup && (
          <YStack gap="$3">
            <Button
              size="$4"
              backgroundColor="$backgroundHover"
              color="$color"
              borderWidth={1}
              borderColor="$borderColor"
              borderRadius="$4"
              onPress={() => onSocialSignup('google')}
              disabled={isLoading}
            >
              <XStack gap="$2" alignItems="center">
                <XStack width="$1" height="$1">
                  <svg viewBox="0 0 24 24" width="100%" height="100%">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                  </svg>
                </XStack>
                <Text fontSize="$3">
                  {t('signup.social.google')}
                </Text>
              </XStack>
            </Button>

            <Button
              size="$4"
              backgroundColor="$backgroundHover"
              color="$color"
              borderWidth={1}
              borderColor="$borderColor"
              borderRadius="$4"
              onPress={() => onSocialSignup('github')}
              disabled={isLoading}
            >
              <XStack gap="$2" alignItems="center">
                <XStack width="$1" height="$1">
                  <svg fill="currentColor" viewBox="0 0 24 24" width="100%" height="100%">
                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                  </svg>
                </XStack>
                <Text fontSize="$3">
                  {t('signup.social.github')}
                </Text>
              </XStack>
            </Button>

            <XStack alignItems="center" gap="$2">
              <Separator flex={1} borderColor="$borderColor" />
              <Text fontSize="$2" color="$colorFocus">
                {t('signup.social.or')}
              </Text>
              <Separator flex={1} borderColor="$borderColor" />
            </XStack>
          </YStack>
        )}

        {/* Error/Success Messages */}
        {error && (
          <XStack
            backgroundColor="$red2"
            borderWidth={1}
            borderColor="$red6"
            borderRadius="$4"
            padding="$4"
            gap="$3"
            alignItems="center"
          >
            <AlertCircle size="$1" color="$red10" />
            <Text fontSize="$3" color="$red10">
              {error}
            </Text>
          </XStack>
        )}

        {success && (
          <XStack
            backgroundColor="$green2"
            borderWidth={1}
            borderColor="$green6"
            borderRadius="$4"
            padding="$4"
            gap="$3"
            alignItems="center"
          >
            <CheckCircle size="$1" color="$green10" />
            <Text fontSize="$3" color="$green10">
              {success}
            </Text>
          </XStack>
        )}

        {/* Signup Form */}
        <YStack asChild gap="$4">
          <form onSubmit={handleSubmit(handleFormSubmit)}>
            {/* Name Fields */}
            <XStack gap="$4">
              {/* First Name */}
              <YStack flex={1} gap="$2">
                <Label htmlFor="firstName" fontSize="$4" color="$color">
                  {t('signup.form.firstName')}
                </Label>
                <XStack position="relative">
                  <User 
                    size="$1" 
                    color="$colorFocus" 
                    position="absolute" 
                    left="$3" 
                    top="50%" 
                    transform="translateY(-50%)" 
                  />
                  <Controller
                    control={control}
                    name="firstName"
                    render={({ field }) => (
                      <Input
                        id="firstName"
                        value={field.value || ''}
                        onChangeText={field.onChange}
                        placeholder={t('signup.form.firstNamePlaceholder')}
                        backgroundColor="$background"
                        color="$color"
                        borderWidth={1}
                        borderColor={errors.firstName ? '$red10' : '$borderColor'}
                        borderRadius="$4"
                        padding="$3"
                        paddingLeft="$8"
                        disabled={isLoading}
                        flex={1}
                      />
                    )}
                  />
                </XStack>
                {errors.firstName && (
                  <Text fontSize="$2" color="$red10">
                    {errors.firstName.message}
                  </Text>
                )}
              </YStack>

              {/* Last Name */}
              <YStack flex={1} gap="$2">
                <Label htmlFor="lastName" fontSize="$4" color="$color">
                  {t('signup.form.lastName')}
                </Label>
                <XStack position="relative">
                  <User 
                    size="$1" 
                    color="$colorFocus" 
                    position="absolute" 
                    left="$3" 
                    top="50%" 
                    transform="translateY(-50%)" 
                  />
                  <Controller
                    control={control}
                    name="lastName"
                    render={({ field }) => (
                      <Input
                        id="lastName"
                        value={field.value || ''}
                        onChangeText={field.onChange}
                        placeholder={t('signup.form.lastNamePlaceholder')}
                        backgroundColor="$background"
                        color="$color"
                        borderWidth={1}
                        borderColor={errors.lastName ? '$red10' : '$borderColor'}
                        borderRadius="$4"
                        padding="$3"
                        paddingLeft="$8"
                        disabled={isLoading}
                        flex={1}
                      />
                    )}
                  />
                </XStack>
                {errors.lastName && (
                  <Text fontSize="$2" color="$red10">
                    {errors.lastName.message}
                  </Text>
                )}
              </YStack>
            </XStack>

            {/* Email */}
            <YStack gap="$2">
              <Label htmlFor="email" fontSize="$4" color="$color">
                {t('signup.form.email')}
              </Label>
              <XStack position="relative">
                <Mail 
                  size="$1" 
                  color="$colorFocus" 
                  position="absolute" 
                  left="$3" 
                  top="50%" 
                  transform="translateY(-50%)" 
                />
                <Controller
                  control={control}
                  name="email"
                  render={({ field }) => (
                    <Input
                      id="email"
                      value={field.value || ''}
                      onChangeText={field.onChange}
                      placeholder={t('signup.form.emailPlaceholder')}
                      backgroundColor="$background"
                      color="$color"
                      borderWidth={1}
                      borderColor={errors.email ? '$red10' : '$borderColor'}
                      borderRadius="$4"
                      padding="$3"
                      paddingLeft="$8"
                      disabled={isLoading}
                      flex={1}
                    />
                  )}
                />
              </XStack>
              {errors.email && (
                <Text fontSize="$2" color="$red10">
                  {errors.email.message}
                </Text>
              )}
            </YStack>

            {/* Password */}
            <YStack gap="$2">
              <Label htmlFor="password" fontSize="$4" color="$color">
                {t('signup.form.password')}
              </Label>
              <XStack position="relative">
                <Lock 
                  size="$1" 
                  color="$colorFocus" 
                  position="absolute" 
                  left="$3" 
                  top="50%" 
                  transform="translateY(-50%)" 
                />
                <Controller
                  control={control}
                  name="password"
                  render={({ field }) => (
                    <Input
                      id="password"
                      value={field.value || ''}
                      onChangeText={field.onChange}
                      placeholder={t('signup.form.passwordPlaceholder')}
                      backgroundColor="$background"
                      color="$color"
                      borderWidth={1}
                      borderColor={errors.password ? '$red10' : '$borderColor'}
                      borderRadius="$4"
                      padding="$3"
                      paddingLeft="$8"
                      paddingRight="$8"
                      secureTextEntry={!showPassword}
                      disabled={isLoading}
                      flex={1}
                    />
                  )}
                />
                <Button
                  position="absolute"
                  right="$3"
                  top="50%"
                  transform="translateY(-50%)"
                  size="$2"
                  backgroundColor="transparent"
                  padding="$0"
                  onPress={() => setShowPassword(!showPassword)}
                  disabled={isLoading}
                >
                  {showPassword ? (
                    <EyeOff size="$1" color="$colorFocus" />
                  ) : (
                    <Eye size="$1" color="$colorFocus" />
                  )}
                </Button>
              </XStack>
              {errors.password && (
                <Text fontSize="$2" color="$red10">
                  {errors.password.message}
                </Text>
              )}
              
              {/* Password Strength Indicator */}
              {password && (
                <YStack gap="$1" marginTop="$2">
                  <XStack gap="$2" alignItems="center">
                    <YStack flex={1}>
                      <Progress value={(passwordStrength.score / 5) * 100}>
                        <Progress.Indicator backgroundColor={passwordStrength.color} />
                      </Progress>
                    </YStack>
                    <Text fontSize="$2" color="$colorFocus">
                      {passwordStrength.label}
                    </Text>
                  </XStack>
                </YStack>
              )}
            </YStack>

            {/* Confirm Password */}
            <YStack gap="$2">
              <Label htmlFor="confirmPassword" fontSize="$4" color="$color">
                {t('signup.form.confirmPassword')}
              </Label>
              <XStack position="relative">
                <Lock 
                  size="$1" 
                  color="$colorFocus" 
                  position="absolute" 
                  left="$3" 
                  top="50%" 
                  transform="translateY(-50%)" 
                />
                <Controller
                  control={control}
                  name="confirmPassword"
                  render={({ field }) => (
                    <Input
                      id="confirmPassword"
                      value={field.value || ''}
                      onChangeText={field.onChange}
                      placeholder={t('signup.form.confirmPasswordPlaceholder')}
                      backgroundColor="$background"
                      color="$color"
                      borderWidth={1}
                      borderColor={errors.confirmPassword ? '$red10' : '$borderColor'}
                      borderRadius="$4"
                      padding="$3"
                      paddingLeft="$8"
                      paddingRight="$8"
                      secureTextEntry={!showConfirmPassword}
                      disabled={isLoading}
                      flex={1}
                    />
                  )}
                />
                <Button
                  position="absolute"
                  right="$3"
                  top="50%"
                  transform="translateY(-50%)"
                  size="$2"
                  backgroundColor="transparent"
                  padding="$0"
                  onPress={() => setShowConfirmPassword(!showConfirmPassword)}
                  disabled={isLoading}
                >
                  {showConfirmPassword ? (
                    <EyeOff size="$1" color="$colorFocus" />
                  ) : (
                    <Eye size="$1" color="$colorFocus" />
                  )}
                </Button>
              </XStack>
              {errors.confirmPassword && (
                <Text fontSize="$2" color="$red10">
                  {errors.confirmPassword.message}
                </Text>
              )}
            </YStack>

            {/* Terms and Marketing */}
            <YStack gap="$3">
              <XStack gap="$2" alignItems="flex-start">
                <Controller
                  control={control}
                  name="acceptTerms"
                  render={({ field }) => (
                    <Checkbox
                      id="acceptTerms"
                      checked={field.value}
                      onCheckedChange={field.onChange}
                      disabled={isLoading}
                      size="$3"
                      backgroundColor={field.value ? "$blue10" : "transparent"}
                      borderWidth={1}
                      borderColor={errors.acceptTerms ? "$red10" : field.value ? "$blue10" : "$borderColor"}
                      marginTop="$1"
                    >
                      <Checkbox.Indicator>
                        <CheckCircle size="$1" color="white" />
                      </Checkbox.Indicator>
                    </Checkbox>
                  )}
                />
                <YStack>
                  <Text fontSize="$3" color="$color">
                    {t('signup.form.termsPrefix')}{' '}
                    <Text
                      fontSize="$3"
                      color="$blue10"
                      textDecorationLine="underline"
                      onPress={() => window.location.href = '/terms'}
                    >
                      {t('signup.form.termsLink')}
                    </Text>{' '}
                    {t('signup.form.termsMiddle')}{' '}
                    <Text
                      fontSize="$3"
                      color="$blue10"
                      textDecorationLine="underline"
                      onPress={() => window.location.href = '/privacy'}
                    >
                      {t('signup.form.privacyLink')}
                    </Text>
                  </Text>
                  {errors.acceptTerms && (
                    <Text fontSize="$2" color="$red10" marginTop="$1">
                      {errors.acceptTerms.message}
                    </Text>
                  )}
                </YStack>
              </XStack>

              <XStack gap="$2" alignItems="flex-start">
                <Controller
                  control={control}
                  name="acceptMarketing"
                  render={({ field }) => (
                    <Checkbox
                      id="acceptMarketing"
                      checked={field.value}
                      onCheckedChange={field.onChange}
                      disabled={isLoading}
                      size="$3"
                      backgroundColor={field.value ? "$blue10" : "transparent"}
                      borderWidth={1}
                      borderColor={field.value ? "$blue10" : "$borderColor"}
                      marginTop="$1"
                    >
                      <Checkbox.Indicator>
                        <CheckCircle size="$1" color="white" />
                      </Checkbox.Indicator>
                    </Checkbox>
                  )}
                />
                <Text fontSize="$3" color="$colorFocus">
                  {t('signup.form.marketing')}
                </Text>
              </XStack>
            </YStack>

            {/* Submit Button */}
            <Button
              theme="accent"
              size="$4"
              backgroundColor={isLoading || !isValid ? "$backgroundHover" : "$blue10"}
              color="white"
              borderRadius="$4"
              onPress={handleSubmit(handleFormSubmit)}
              disabled={isLoading || !isValid}
            >
              <XStack gap="$2" alignItems="center">
                {isLoading && <Spinner size="small" color="white" />}
                <Text fontSize="$4" fontWeight="bold" color="white">
                  {isLoading ? t('signup.form.creating') : t('signup.form.create')}
                </Text>
              </XStack>
            </Button>
          </form>
        </YStack>

        {/* Sign In Link */}
        <YStack alignItems="center">
          <XStack gap="$1">
            <Text fontSize="$3" color="$colorFocus">
              {t('signup.login.question')}
            </Text>
            <Link href="/login" passHref>
              <Text fontSize="$3" color="$blue10" fontWeight="bold">
                {t('signup.login.action')}
              </Text>
            </Link>
          </XStack>
        </YStack>
      </YStack>
    </Card>
  );
}

export default SignupForm;

