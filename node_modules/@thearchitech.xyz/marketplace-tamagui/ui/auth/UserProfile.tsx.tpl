/**
 * User Profile Component (Tamagui)
 * 
 * User profile management with i18n support
 */

import React, { useState } from 'react';
import { YStack, XStack, Card, Text, Button, Input, Label, Avatar, Spinner } from 'tamagui';
import { useForm, Controller } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { useAuth, useUpdateUser } from '@/lib/hooks/use-auth';
import { useTranslation } from '@/lib/i18n';

const profileSchema = z.object({
  name: z.string().min(2, 'Name must be at least 2 characters'),
  email: z.string().email('Please enter a valid email address'),
  avatar: z.string().url('Please enter a valid URL').optional(),
});

type ProfileFormData = z.infer<typeof profileSchema>;

export function UserProfile() {
  const { t } = useTranslation();
  const [isLoading, setIsLoading] = useState(false);
  const { data: user, isLoading: userLoading } = useAuth();
  const updateUserMutation = useUpdateUser();
  
  const form = useForm<ProfileFormData>({
    resolver: zodResolver(profileSchema),
    defaultValues: {
      name: user?.name || '',
      email: user?.email || '',
      avatar: user?.avatar || '',
    },
  });

  const onSubmit = async (data: ProfileFormData) => {
    if (!user) return;
    
    setIsLoading(true);
    try {
      await updateUserMutation.mutateAsync({
        id: user.id,
        data,
      });
    } catch (error) {
      console.error('Failed to update profile:', error);
    } finally {
      setIsLoading(false);
    }
  };

  if (userLoading) {
    return (
      <XStack padding="$4" justifyContent="center" alignItems="center">
        <Text fontSize="$4" color="$colorFocus">
          {t('profile.loading')}
        </Text>
      </XStack>
    );
  }

  if (!user) {
    return (
      <XStack padding="$4" justifyContent="center" alignItems="center">
        <Text fontSize="$4" color="$colorFocus">
          {t('profile.signInRequired')}
        </Text>
      </XStack>
    );
  }

  return (
    <Card
      theme="base"
      size="$4"
      padding="$0"
      backgroundColor="$background"
      borderWidth={1}
      borderColor="$borderColor"
      borderRadius="$6"
      elevation="$2"
      width="100%"
      maxWidth={640}
      alignSelf="center"
    >
      {/* Header */}
      <YStack padding="$6" paddingBottom="$4">
        <Text fontSize="$6" fontWeight="bold" color="$color">
          {t('profile.title')}
        </Text>
        <Text fontSize="$3" color="$colorFocus">
          {t('profile.description')}
        </Text>
      </YStack>

      {/* Content */}
      <YStack padding="$6" paddingTop="$0" gap="$6">
        {/* User Avatar and Info */}
        <XStack gap="$4" alignItems="center">
          <Avatar circular size="$8" backgroundColor="$blue10">
            <Avatar.Image src={user.avatar} />
            <Avatar.Fallback backgroundColor="$blue10" delayMs={600}>
              <Text color="white" fontSize="$6" fontWeight="bold">
                {user.name?.charAt(0).toUpperCase() || 'U'}
              </Text>
            </Avatar.Fallback>
          </Avatar>
          <YStack>
            <Text fontSize="$5" fontWeight="bold" color="$color">
              {user.name}
            </Text>
            <Text fontSize="$3" color="$colorFocus">
              {user.email}
            </Text>
          </YStack>
        </XStack>
        
        {/* Profile Form */}
        <YStack asChild gap="$4">
          <form onSubmit={form.handleSubmit(onSubmit)}>
            {/* Name Field */}
            <YStack gap="$2">
              <Label htmlFor="name" fontSize="$4" color="$color">
                {t('profile.form.name')}
              </Label>
              <Controller
                control={form.control}
                name="name"
                render={({ field }) => (
                  <Input
                    id="name"
                    value={field.value}
                    onChangeText={field.onChange}
                    placeholder={t('profile.form.namePlaceholder')}
                    backgroundColor="$background"
                    color="$color"
                    borderWidth={1}
                    borderColor={form.formState.errors.name ? '$red10' : '$borderColor'}
                    borderRadius="$4"
                    padding="$3"
                    disabled={isLoading}
                  />
                )}
              />
              {form.formState.errors.name && (
                <Text fontSize="$2" color="$red10">
                  {form.formState.errors.name.message}
                </Text>
              )}
            </YStack>
            
            {/* Email Field */}
            <YStack gap="$2">
              <Label htmlFor="email" fontSize="$4" color="$color">
                {t('profile.form.email')}
              </Label>
              <Controller
                control={form.control}
                name="email"
                render={({ field }) => (
                  <Input
                    id="email"
                    value={field.value}
                    onChangeText={field.onChange}
                    placeholder={t('profile.form.emailPlaceholder')}
                    backgroundColor="$background"
                    color="$color"
                    borderWidth={1}
                    borderColor={form.formState.errors.email ? '$red10' : '$borderColor'}
                    borderRadius="$4"
                    padding="$3"
                    disabled={isLoading}
                  />
                )}
              />
              {form.formState.errors.email && (
                <Text fontSize="$2" color="$red10">
                  {form.formState.errors.email.message}
                </Text>
              )}
            </YStack>
            
            {/* Avatar URL Field */}
            <YStack gap="$2">
              <Label htmlFor="avatar" fontSize="$4" color="$color">
                {t('profile.form.avatar')}
              </Label>
              <Controller
                control={form.control}
                name="avatar"
                render={({ field }) => (
                  <Input
                    id="avatar"
                    value={field.value || ''}
                    onChangeText={field.onChange}
                    placeholder={t('profile.form.avatarPlaceholder')}
                    backgroundColor="$background"
                    color="$color"
                    borderWidth={1}
                    borderColor={form.formState.errors.avatar ? '$red10' : '$borderColor'}
                    borderRadius="$4"
                    padding="$3"
                    disabled={isLoading}
                  />
                )}
              />
              {form.formState.errors.avatar && (
                <Text fontSize="$2" color="$red10">
                  {form.formState.errors.avatar.message}
                </Text>
              )}
            </YStack>
            
            {/* Submit Button */}
            <Button
              theme="accent"
              size="$4"
              backgroundColor={isLoading ? "$backgroundHover" : "$blue10"}
              color="white"
              onPress={form.handleSubmit(onSubmit)}
              disabled={isLoading}
              borderRadius="$4"
              marginTop="$2"
            >
              <XStack gap="$2" alignItems="center">
                {isLoading && <Spinner size="small" color="white" />}
                <Text fontSize="$4" fontWeight="bold">
                  {isLoading ? t('profile.form.updating') : t('profile.form.update')}
                </Text>
              </XStack>
            </Button>
          </form>
        </YStack>
      </YStack>
    </Card>
  );
}

export default UserProfile;

