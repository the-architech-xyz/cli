'use client';

import React, { useState } from 'react';
import { format } from 'date-fns';
import { useTranslation } from '@/lib/i18n';
import { useTeamsList } from '@/lib/teams-management';
import { 
  YStack, 
  XStack, 
  Button, 
  Input, 
  Badge,
  Card, 
  CardContent, 
  CardDescription, 
  CardHeader, 
  CardTitle,
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
  Alert, 
  AlertDescription,
  Spinner,
  Text,
  Theme,
  Square
} from 'tamagui';
import { 
  Users, 
  Search, 
  Plus, 
  Settings, 
  Eye, 
  Calendar,
  AlertCircle,
  Loader2,
  RefreshCw,
  MoreHorizontal,
  Trash2
} from 'lucide-react-native';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger
} from '@tamagui/dropdown-menu';
import type { Team } from '@/lib/teams-management';

interface TeamsListProps {
  className?: string;
  onCreateTeam?: () => void;
  onViewTeam?: (team: Team) => void;
  onEditTeam?: (team: Team) => void;
  onDeleteTeam?: (team: Team) => void;
}

export function TeamsList({ 
  className, 
  onCreateTeam, 
  onViewTeam, 
  onEditTeam, 
  onDeleteTeam 
}: TeamsListProps) {
  const { t } = useTranslation();
  const [searchTerm, setSearchTerm] = useState('');
  const { data: teams = [], isLoading, error, refetch, hasMore, loadMore } = useTeamsList({
    search: searchTerm || undefined
  });

  const handleSearch = (value: string) => {
    setSearchTerm(value);
  };

  if (error) {
    return (
      <Card elevate>
        <CardContent padding="$6">
          <Alert backgroundColor="$red2" borderColor="$red6">
            <XStack alignItems="center" space="$2">
              <AlertCircle size={16} color="$red10" />
              <AlertDescription>
                <Text color="$red10">{t('teams.errors.failedToLoad')}</Text>
              </AlertDescription>
            </XStack>
          </Alert>
          <Button 
            onPress={() => refetch()} 
            marginTop="$4"
            theme="accent"
          >
            <XStack space="$2" alignItems="center">
              <RefreshCw size={16} />
              <Text>{t('common.retry')}</Text>
            </XStack>
          </Button>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card elevate>
      <CardHeader>
        <XStack justifyContent="space-between" alignItems="center">
          <YStack>
            <XStack alignItems="center" space="$2">
              <Users size={20} />
              <CardTitle>{t('teams.list.title')}</CardTitle>
            </XStack>
            <CardDescription>
              {t('teams.list.description')}
            </CardDescription>
          </YStack>
          <XStack alignItems="center" space="$2">
            <Button 
              onPress={() => refetch()} 
              variant="outlined" 
              size="$3"
            >
              <XStack space="$2" alignItems="center">
                <RefreshCw size={16} />
                <Text>{t('common.refresh')}</Text>
              </XStack>
            </Button>
            {onCreateTeam && (
              <Button 
                onPress={onCreateTeam}
                theme="accent"
              >
                <XStack space="$2" alignItems="center">
                  <Plus size={16} />
                  <Text>{t('teams.actions.createTeam')}</Text>
                </XStack>
              </Button>
            )}
          </XStack>
        </XStack>
      </CardHeader>

      <CardContent space="$6">
        {/* Search */}
        <XStack position="relative">
          <XStack 
            position="absolute" 
            left="$3" 
            top="50%" 
            transform="translateY(-50%)" 
            zIndex={1}
          >
            <Search size={16} color="$gray10" />
          </XStack>
          <Input
            placeholder={t('teams.list.searchPlaceholder')}
            value={searchTerm}
            onChange={(e) => handleSearch(e.target.value)}
            paddingLeft="$10"
            width="100%"
          />
        </XStack>

        {/* Teams Table */}
        <YStack borderRadius="$4" borderWidth="$0.5" borderColor="$gray6" overflow="hidden">
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>{t('teams.list.columns.team')}</TableHead>
                <TableHead>{t('teams.list.columns.members')}</TableHead>
                <TableHead>{t('teams.list.columns.role')}</TableHead>
                <TableHead>{t('teams.list.columns.created')}</TableHead>
                <TableHead>{t('teams.list.columns.status')}</TableHead>
                <TableHead width={50}></TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {isLoading ? (
                Array.from({ length: 5 }).map((_, i) => (
                  <TableRow key={i}>
                    <TableCell>
                      <XStack alignItems="center" space="$3">
                        <Square size="$10" backgroundColor="$gray5" borderRadius="$full" />
                        <YStack space="$1">
                          <Square height="$4" width="$10" backgroundColor="$gray5" borderRadius="$2" />
                          <Square height="$3" width="$8" backgroundColor="$gray5" borderRadius="$2" />
                        </YStack>
                      </XStack>
                    </TableCell>
                    <TableCell><Square height="$4" width="$5" backgroundColor="$gray5" borderRadius="$2" /></TableCell>
                    <TableCell><Square height="$6" width="$6" backgroundColor="$gray5" borderRadius="$2" /></TableCell>
                    <TableCell><Square height="$4" width="$8" backgroundColor="$gray5" borderRadius="$2" /></TableCell>
                    <TableCell><Square height="$6" width="$5" backgroundColor="$gray5" borderRadius="$2" /></TableCell>
                    <TableCell><Square height="$8" width="$8" backgroundColor="$gray5" borderRadius="$2" /></TableCell>
                  </TableRow>
                ))
              ) : teams.length === 0 ? (
                <TableRow>
                  <TableCell colSpan={6} textAlign="center" paddingVertical="$8">
                    <Text color="$gray10">
                      {searchTerm ? t('teams.list.noTeamsFound') : t('teams.list.noTeamsYet')}
                    </Text>
                  </TableCell>
                </TableRow>
              ) : (
                teams.map((team) => (
                  <TableRow key={team.id} hoverStyle={{ backgroundColor: '$gray3' }}>
                    <TableCell>
                      <XStack alignItems="center" space="$3">
                        <XStack 
                          width="$10" 
                          height="$10" 
                          borderRadius="$full" 
                          backgroundColor="$blue9" 
                          alignItems="center" 
                          justifyContent="center"
                        >
                          <Text color="white" fontWeight="bold">
                            {team.name.charAt(0).toUpperCase()}
                          </Text>
                        </XStack>
                        <YStack>
                          <Text fontWeight="500">{team.name}</Text>
                          {team.description && (
                            <Text 
                              fontSize="$2" 
                              color="$gray10" 
                              numberOfLines={1} 
                              maxWidth={200}
                            >
                              {team.description}
                            </Text>
                          )}
                        </YStack>
                      </XStack>
                    </TableCell>
                    <TableCell>
                      <XStack alignItems="center" space="$1">
                        <Users size={16} color="$gray10" />
                        <Text fontWeight="500">{team.memberCount}</Text>
                      </XStack>
                    </TableCell>
                    <TableCell>
                      <Badge 
                        backgroundColor="$blue2" 
                        borderColor="$blue6"
                      >
                        <Text color="$blue11">{t('teams.roles.owner')}</Text>
                      </Badge>
                    </TableCell>
                    <TableCell>
                      <XStack alignItems="center" space="$1">
                        <Calendar size={12} color="$gray10" />
                        <Text fontSize="$2" color="$gray10">
                          {format(new Date(team.createdAt), 'MMM d, yyyy')}
                        </Text>
                      </XStack>
                    </TableCell>
                    <TableCell>
                      <Badge 
                        backgroundColor={team.isActive ? '$green2' : '$gray2'} 
                        borderColor={team.isActive ? '$green6' : '$gray6'}
                      >
                        <Text color={team.isActive ? '$green11' : '$gray11'}>
                          {team.isActive ? t('teams.status.active') : t('teams.status.inactive')}
                        </Text>
                      </Badge>
                    </TableCell>
                    <TableCell>
                      <DropdownMenu>
                        <DropdownMenuTrigger asChild>
                          <Button variant="ghost" size="$2" padding="$2">
                            <MoreHorizontal size={16} />
                          </Button>
                        </DropdownMenuTrigger>
                        <DropdownMenuContent align="end">
                          {onViewTeam && (
                            <DropdownMenuItem onSelect={() => onViewTeam(team)}>
                              <XStack space="$2" alignItems="center">
                                <Eye size={16} />
                                <Text>{t('teams.actions.viewTeam')}</Text>
                              </XStack>
                            </DropdownMenuItem>
                          )}
                          {onEditTeam && (
                            <DropdownMenuItem onSelect={() => onEditTeam(team)}>
                              <XStack space="$2" alignItems="center">
                                <Settings size={16} />
                                <Text>{t('teams.actions.editTeam')}</Text>
                              </XStack>
                            </DropdownMenuItem>
                          )}
                          {onDeleteTeam && (
                            <>
                              <DropdownMenuSeparator />
                              <DropdownMenuItem 
                                onSelect={() => onDeleteTeam(team)}
                                color="$red10"
                              >
                                <XStack space="$2" alignItems="center">
                                  <Trash2 size={16} color="$red10" />
                                  <Text color="$red10">{t('teams.actions.deleteTeam')}</Text>
                                </XStack>
                              </DropdownMenuItem>
                            </>
                          )}
                        </DropdownMenuContent>
                      </DropdownMenu>
                    </TableCell>
                  </TableRow>
                ))
              )}
            </TableBody>
          </Table>
        </YStack>

        {/* Load More */}
        {hasMore && (
          <XStack justifyContent="center">
            <Button 
              onPress={loadMore} 
              variant="outlined"
            >
              {t('teams.actions.loadMore')}
            </Button>
          </XStack>
        )}

        {/* Empty State */}
        {!isLoading && teams.length === 0 && !searchTerm && (
          <YStack alignItems="center" paddingVertical="$12">
            <Users size={48} color="$gray10" marginBottom="$4" />
            <Text fontSize="$5" fontWeight="500" marginBottom="$2">
              {t('teams.list.emptyState.title')}
            </Text>
            <Text color="$gray10" marginBottom="$4" textAlign="center">
              {t('teams.list.emptyState.description')}
            </Text>
            {onCreateTeam && (
              <Button 
                onPress={onCreateTeam}
                theme="accent"
              >
                <XStack space="$2" alignItems="center">
                  <Plus size={16} />
                  <Text>{t('teams.actions.createFirstTeam')}</Text>
                </XStack>
              </Button>
            )}
          </YStack>
        )}
      </CardContent>
    </Card>
  );
}
