'use client';

import React, { useState } from 'react';
import { useTranslation } from '@/lib/i18n';
import { useForm, Controller } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { useTeamsCreate } from '@/lib/teams-management';
import { 
  YStack, 
  XStack, 
  Button, 
  Input, 
  Label, 
  TextArea,
  Card, 
  CardContent, 
  CardDescription, 
  CardHeader, 
  CardTitle,
  Switch,
  Alert, 
  AlertDescription,
  Text,
  Theme,
  Square
} from 'tamagui';
import { 
  Loader2, 
  Plus, 
  Users, 
  Settings,
  AlertCircle
} from 'lucide-react-native';
import type { CreateTeamFormData } from '@/lib/teams-management';

interface CreateTeamFormProps {
  onSuccess?: (team: any) => void;
  onCancel?: () => void;
  className?: string;
}

export function CreateTeamForm({ onSuccess, onCancel, className }: CreateTeamFormProps) {
  const { t } = useTranslation();
  const [isSubmitting, setIsSubmitting] = useState(false);
  const createTeam = useTeamsCreate();

  const createTeamSchema = z.object({
    name: z.string().min(1, t('teams.form.validation.nameRequired')),
    description: z.string().optional(),
    slug: z.string().min(1, t('teams.form.validation.slugRequired')),
    allowMemberInvites: z.boolean().default(true),
    requireApprovalForJoins: z.boolean().default(false),
    allowPublicVisibility: z.boolean().default(false),
    maxMembers: z.number().positive().optional(),
  });

  type CreateTeamFormValues = z.infer<typeof createTeamSchema>;

  const {
    register,
    handleSubmit,
    formState: { errors },
    watch,
    setValue,
    control,
  } = useForm<CreateTeamFormValues>({
    resolver: zodResolver(createTeamSchema),
    defaultValues: {
      allowMemberInvites: true,
      requireApprovalForJoins: false,
      allowPublicVisibility: false,
    },
  });

  const watchedName = watch('name');

  // Auto-generate slug from name
  const generateSlug = (name: string) => {
    return name
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/(^-|-$)/g, '');
  };

  const handleNameChange = (value: string) => {
    setValue('name', value);
    setValue('slug', generateSlug(value));
  };

  const onSubmit = async (data: CreateTeamFormValues) => {
    setIsSubmitting(true);
    try {
      const team = await createTeam.mutateAsync(data);
      onSuccess?.(team);
    } catch (error) {
      console.error('Failed to create team:', error);
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <Card elevate>
      <CardHeader>
        <XStack alignItems="center" space="$2">
          <Plus size={20} />
          <CardTitle>{t('teams.form.createTitle')}</CardTitle>
        </XStack>
        <CardDescription>
          {t('teams.form.createDescription')}
        </CardDescription>
      </CardHeader>

      <CardContent>
        <YStack tag="form" onSubmit={handleSubmit(onSubmit)} space="$6">
          {createTeam.error && (
            <Alert backgroundColor="$red2" borderColor="$red6">
              <XStack alignItems="center" space="$2">
                <AlertCircle size={16} color="$red10" />
                <AlertDescription>
                  <Text color="$red10">
                    {createTeam.error.message || t('teams.form.errors.createFailed')}
                  </Text>
                </AlertDescription>
              </XStack>
            </Alert>
          )}

          {/* Basic Information */}
          <YStack space="$4">
            <XStack alignItems="center" space="$2">
              <Users size={16} />
              <Text fontSize="$5" fontWeight="500">
                {t('teams.form.sections.basicInfo')}
              </Text>
            </XStack>
            
            <YStack space="$2">
              <Label htmlFor="name">{t('teams.form.fields.name')}</Label>
              <Controller
                name="name"
                control={control}
                render={({ field }) => (
                  <Input
                    id="name"
                    placeholder={t('teams.form.placeholders.name')}
                    value={field.value}
                    onChange={(e) => {
                      field.onChange(e);
                      handleNameChange(e.nativeEvent.text);
                    }}
                    borderColor={errors.name ? '$red10' : undefined}
                  />
                )}
              />
              {errors.name && (
                <Text fontSize="$2" color="$red10">{errors.name.message}</Text>
              )}
            </YStack>

            <YStack space="$2">
              <Label htmlFor="description">{t('teams.form.fields.description')}</Label>
              <Controller
                name="description"
                control={control}
                render={({ field }) => (
                  <TextArea
                    id="description"
                    placeholder={t('teams.form.placeholders.description')}
                    numberOfLines={3}
                    value={field.value}
                    onChange={(e) => field.onChange(e.nativeEvent.text)}
                  />
                )}
              />
            </YStack>

            <YStack space="$2">
              <Label htmlFor="slug">{t('teams.form.fields.slug')}</Label>
              <XStack alignItems="center" space="$2">
                <Text fontSize="$2" color="$gray10">yourdomain.com/teams/</Text>
                <Controller
                  name="slug"
                  control={control}
                  render={({ field }) => (
                    <Input
                      id="slug"
                      placeholder={t('teams.form.placeholders.slug')}
                      value={field.value}
                      onChange={(e) => field.onChange(e.nativeEvent.text)}
                      borderColor={errors.slug ? '$red10' : undefined}
                      flex={1}
                    />
                  )}
                />
              </XStack>
              {errors.slug && (
                <Text fontSize="$2" color="$red10">{errors.slug.message}</Text>
              )}
              <Text fontSize="$1" color="$gray10">
                {t('teams.form.slugHelp')}
              </Text>
            </YStack>
          </YStack>

          {/* Team Settings */}
          <YStack space="$4">
            <XStack alignItems="center" space="$2">
              <Settings size={16} />
              <Text fontSize="$5" fontWeight="500">
                {t('teams.form.sections.settings')}
              </Text>
            </XStack>

            <YStack space="$4">
              <XStack justifyContent="space-between" alignItems="center">
                <YStack space="$0.5" flex={1} marginRight="$4">
                  <Label htmlFor="allowMemberInvites">
                    {t('teams.form.fields.allowMemberInvites')}
                  </Label>
                  <Text fontSize="$2" color="$gray10">
                    {t('teams.form.descriptions.allowMemberInvites')}
                  </Text>
                </YStack>
                <Controller
                  name="allowMemberInvites"
                  control={control}
                  render={({ field }) => (
                    <Switch
                      id="allowMemberInvites"
                      checked={field.value}
                      onCheckedChange={field.onChange}
                      size="$4"
                    />
                  )}
                />
              </XStack>

              <XStack justifyContent="space-between" alignItems="center">
                <YStack space="$0.5" flex={1} marginRight="$4">
                  <Label htmlFor="requireApprovalForJoins">
                    {t('teams.form.fields.requireApproval')}
                  </Label>
                  <Text fontSize="$2" color="$gray10">
                    {t('teams.form.descriptions.requireApproval')}
                  </Text>
                </YStack>
                <Controller
                  name="requireApprovalForJoins"
                  control={control}
                  render={({ field }) => (
                    <Switch
                      id="requireApprovalForJoins"
                      checked={field.value}
                      onCheckedChange={field.onChange}
                      size="$4"
                    />
                  )}
                />
              </XStack>

              <XStack justifyContent="space-between" alignItems="center">
                <YStack space="$0.5" flex={1} marginRight="$4">
                  <Label htmlFor="allowPublicVisibility">
                    {t('teams.form.fields.publicVisibility')}
                  </Label>
                  <Text fontSize="$2" color="$gray10">
                    {t('teams.form.descriptions.publicVisibility')}
                  </Text>
                </YStack>
                <Controller
                  name="allowPublicVisibility"
                  control={control}
                  render={({ field }) => (
                    <Switch
                      id="allowPublicVisibility"
                      checked={field.value}
                      onCheckedChange={field.onChange}
                      size="$4"
                    />
                  )}
                />
              </XStack>

              <YStack space="$2">
                <Label htmlFor="maxMembers">{t('teams.form.fields.maxMembers')}</Label>
                <Controller
                  name="maxMembers"
                  control={control}
                  render={({ field }) => (
                    <Input
                      id="maxMembers"
                      type="number"
                      placeholder="50"
                      value={field.value?.toString() || ''}
                      onChange={(e) => {
                        const value = e.nativeEvent.text;
                        field.onChange(value ? parseInt(value, 10) : undefined);
                      }}
                    />
                  )}
                />
                <Text fontSize="$1" color="$gray10">
                  {t('teams.form.maxMembersHelp')}
                </Text>
              </YStack>
            </YStack>
          </YStack>

          {/* Actions */}
          <XStack justifyContent="flex-end" space="$2" paddingTop="$4">
            {onCancel && (
              <Button 
                variant="outlined" 
                onPress={onCancel}
              >
                {t('common.cancel')}
              </Button>
            )}
            <Button 
              theme="accent"
              type="submit" 
              disabled={isSubmitting}
            >
              <XStack space="$2" alignItems="center">
                {isSubmitting && <Loader2 size={16} className="animate-spin" />}
                <Text>{t('teams.form.createButton')}</Text>
              </XStack>
            </Button>
          </XStack>
        </YStack>
      </CardContent>
    </Card>
  );
}
