'use client';

import { useTeamsList, useTeamAnalytics } from '@/lib/teams-management';
import { 
  YStack, 
  XStack, 
  Text,
  Card,
  CardHeader,
  CardContent,
  Alert,
  Theme,
  Square,
  Spinner
} from 'tamagui';
import { 
  Users, 
  TrendingUp, 
  Calendar, 
  Activity,
  AlertCircle,
  BarChart3
} from 'lucide-react-native';
import { useTranslation } from '@/lib/i18n';

interface TeamsDashboardProps {
  className?: string;
}

export function TeamsDashboard({ className }: TeamsDashboardProps) {
  const { t } = useTranslation();
  const { data: teams, isLoading: teamsLoading, error: teamsError } = useTeamsList();
  const { data: analytics, isLoading: analyticsLoading, error: analyticsError } = useTeamAnalytics('current-team-id');

  if (teamsError) {
    return (
      <Card elevate {...(className ? { className } : {})}>
        <CardContent padding="$6">
          <Alert theme="red">
            <XStack alignItems="center" gap="$2">
              <AlertCircle size={16} color="$red10" />
              <Text color="$red10">
                {t('teams.dashboard.errors.loadFailed')}
              </Text>
            </XStack>
          </Alert>
        </CardContent>
      </Card>
    );
  }

  return (
    <YStack space="$6" {...(className ? { className } : {})}>
      {/* Overview Cards */}
      <XStack flexWrap="wrap" gap="$4">
        <Card elevate flex={1} minWidth={200}>
          <CardHeader paddingHorizontal="$4" paddingTop="$4" paddingBottom="$2">
            <XStack alignItems="center" justifyContent="space-between">
              <Text fontSize="$2" fontWeight="$5">
                {t('teams.dashboard.stats.totalTeams')}
              </Text>
              <Users size={16} color="$gray10" />
            </XStack>
          </CardHeader>
          <CardContent paddingHorizontal="$4" paddingBottom="$4">
            {teamsLoading ? (
              <Square backgroundColor="$gray5" height="$4" width="$8" borderRadius="$2" animation="quick" opacity={0.7} />
            ) : (
              <Text fontSize="$6" fontWeight="$8">
                {teams.length}
              </Text>
            )}
            <Text fontSize="$1" color="$gray10">
              {t('teams.dashboard.stats.teamsYourePartOf')}
            </Text>
          </CardContent>
        </Card>

        <Card elevate flex={1} minWidth={200}>
          <CardHeader paddingHorizontal="$4" paddingTop="$4" paddingBottom="$2">
            <XStack alignItems="center" justifyContent="space-between">
              <Text fontSize="$2" fontWeight="$5">
                {t('teams.dashboard.stats.totalMembers')}
              </Text>
              <Users size={16} color="$gray10" />
            </XStack>
          </CardHeader>
          <CardContent paddingHorizontal="$4" paddingBottom="$4">
            {teamsLoading ? (
              <Square backgroundColor="$gray5" height="$4" width="$8" borderRadius="$2" animation="quick" opacity={0.7} />
            ) : (
              <Text fontSize="$6" fontWeight="$8">
                {teams.reduce((sum, team) => sum + team.memberCount, 0)}
              </Text>
            )}
            <Text fontSize="$1" color="$gray10">
              {t('teams.dashboard.stats.acrossAllTeams')}
            </Text>
          </CardContent>
        </Card>

        <Card elevate flex={1} minWidth={200}>
          <CardHeader paddingHorizontal="$4" paddingTop="$4" paddingBottom="$2">
            <XStack alignItems="center" justifyContent="space-between">
              <Text fontSize="$2" fontWeight="$5">
                {t('teams.dashboard.stats.activeTeams')}
              </Text>
              <Activity size={16} color="$gray10" />
            </XStack>
          </CardHeader>
          <CardContent paddingHorizontal="$4" paddingBottom="$4">
            {teamsLoading ? (
              <Square backgroundColor="$gray5" height="$4" width="$8" borderRadius="$2" animation="quick" opacity={0.7} />
            ) : (
              <Text fontSize="$6" fontWeight="$8">
                {teams.filter(team => team.isActive).length}
              </Text>
            )}
            <Text fontSize="$1" color="$gray10">
              {t('teams.dashboard.stats.currentlyActive')}
            </Text>
          </CardContent>
        </Card>

        <Card elevate flex={1} minWidth={200}>
          <CardHeader paddingHorizontal="$4" paddingTop="$4" paddingBottom="$2">
            <XStack alignItems="center" justifyContent="space-between">
              <Text fontSize="$2" fontWeight="$5">
                {t('teams.dashboard.stats.thisMonth')}
              </Text>
              <Calendar size={16} color="$gray10" />
            </XStack>
          </CardHeader>
          <CardContent paddingHorizontal="$4" paddingBottom="$4">
            {teamsLoading ? (
              <Square backgroundColor="$gray5" height="$4" width="$8" borderRadius="$2" animation="quick" opacity={0.7} />
            ) : (
              <Text fontSize="$6" fontWeight="$8">
                {teams.filter(team => {
                  const monthAgo = new Date();
                  monthAgo.setMonth(monthAgo.getMonth() - 1);
                  return new Date(team.createdAt) > monthAgo;
                }).length}
              </Text>
            )}
            <Text fontSize="$1" color="$gray10">
              {t('teams.dashboard.stats.newTeamsCreated')}
            </Text>
          </CardContent>
        </Card>
      </XStack>

      {/* Recent Teams */}
      <Card elevate>
        <CardHeader>
          <XStack alignItems="center" gap="$2">
            <BarChart3 size={20} />
            <Text fontSize="$5" fontWeight="$6">
              {t('teams.dashboard.recentTeams.title')}
            </Text>
          </XStack>
          <Text fontSize="$2" color="$gray11">
            {t('teams.dashboard.recentTeams.description')}
          </Text>
        </CardHeader>
        <CardContent>
          {teamsLoading ? (
            <YStack space="$3">
              {Array.from({ length: 3 }).map((_, i) => (
                <XStack key={i} alignItems="center" gap="$4">
                  <Square size="$4" borderRadius="$round" backgroundColor="$gray5" animation="quick" opacity={0.7} />
                  <YStack space="$2" flex={1}>
                    <Square height="$1" width={200} backgroundColor="$gray5" animation="quick" opacity={0.7} borderRadius="$1" />
                    <Square height={12} width={100} backgroundColor="$gray5" animation="quick" opacity={0.7} borderRadius="$1" />
                  </YStack>
                </XStack>
              ))}
            </YStack>
          ) : teams.length === 0 ? (
            <YStack height={200} alignItems="center" justifyContent="center">
              <Text color="$gray10" textAlign="center">
                {t('teams.dashboard.recentTeams.noTeams')}
              </Text>
            </YStack>
          ) : (
            <YStack space="$4">
              {teams.slice(0, 5).map((team) => (
                <XStack key={team.id} alignItems="center" gap="$4">
                  <Square
                    size="$4"
                    borderRadius="$round"
                    backgroundColor="$blue10"
                    alignItems="center"
                    justifyContent="center"
                  >
                    <Text color="white" fontWeight="$6">
                      {team.name.charAt(0).toUpperCase()}
                    </Text>
                  </Square>
                  <YStack flex={1} minWidth={0}>
                    <Text fontWeight="$5" numberOfLines={1} ellipsizeMode="tail">
                      {team.name}
                    </Text>
                    <Text fontSize="$2" color="$gray10">
                      {t('teams.dashboard.recentTeams.memberCount', { count: team.memberCount })} â€¢ 
                      {t('teams.dashboard.recentTeams.updated', { date: new Date(team.updatedAt).toLocaleDateString() })}
                    </Text>
                  </YStack>
                  <Text fontSize="$2" color="$gray10">
                    {team.isActive ? t('teams.dashboard.status.active') : t('teams.dashboard.status.inactive')}
                  </Text>
                </XStack>
              ))}
            </YStack>
          )}
        </CardContent>
      </Card>

      {/* Team Analytics (if available) */}
      {analytics && (
        <Card elevate>
          <CardHeader>
            <XStack alignItems="center" gap="$2">
              <TrendingUp size={20} />
              <Text fontSize="$5" fontWeight="$6">
                {t('teams.dashboard.analytics.title')}
              </Text>
            </XStack>
            <Text fontSize="$2" color="$gray11">
              {t('teams.dashboard.analytics.description')}
            </Text>
          </CardHeader>
          <CardContent>
            {analyticsLoading ? (
              <YStack space="$4">
                <Square height="$1" width="100%" backgroundColor="$gray5" animation="quick" opacity={0.7} borderRadius="$1" />
                <Square height="$1" width="75%" backgroundColor="$gray5" animation="quick" opacity={0.7} borderRadius="$1" />
                <Square height="$1" width="50%" backgroundColor="$gray5" animation="quick" opacity={0.7} borderRadius="$1" />
              </YStack>
            ) : (
              <XStack flexWrap="wrap" gap="$4">
                <YStack flex={1} minWidth={150} alignItems="center">
                  <Text fontSize="$6" fontWeight="$7">
                    {analytics.memberCount}
                  </Text>
                  <Text fontSize="$2" color="$gray10">
                    {t('teams.dashboard.analytics.totalMembers')}
                  </Text>
                </YStack>
                <YStack flex={1} minWidth={150} alignItems="center">
                  <Text fontSize="$6" fontWeight="$7">
                    {analytics.activeMembers}
                  </Text>
                  <Text fontSize="$2" color="$gray10">
                    {t('teams.dashboard.analytics.activeMembers')}
                  </Text>
                </YStack>
                <YStack flex={1} minWidth={150} alignItems="center">
                  <Text fontSize="$6" fontWeight="$7">
                    {analytics.newMembers}
                  </Text>
                  <Text fontSize="$2" color="$gray10">
                    {t('teams.dashboard.analytics.newThisMonth')}
                  </Text>
                </YStack>
                <YStack flex={1} minWidth={150} alignItems="center">
                  <Text fontSize="$6" fontWeight="$7">
                    {analytics.activityScore}%
                  </Text>
                  <Text fontSize="$2" color="$gray10">
                    {t('teams.dashboard.analytics.activityScore')}
                  </Text>
                </YStack>
              </XStack>
            )}
          </CardContent>
        </Card>
      )}
    </YStack>
  );
}

