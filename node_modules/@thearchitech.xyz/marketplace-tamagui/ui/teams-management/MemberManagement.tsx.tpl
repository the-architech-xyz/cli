/**
 * Member Management Component (Tamagui)
 * 
 * Team member management with i18n support
 */

import React, { useState } from 'react';
import { YStack, XStack, Card, Text, Button, Input, Label, TextArea, Separator, Badge, Spinner } from 'tamagui';
import { useForm, Controller } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { useTeamMembersList, useTeamInvitationsInvite, useTeamMembersUpdate, useTeamMembersRemove } from '@/lib/teams-management';
import { useTranslation } from '@/lib/i18n';
import { format } from 'date-fns';
import { 
  Users, 
  UserPlus,
  UserMinus,
  Shield,
  Calendar,
  AlertCircle,
  Check,
  Eye,
  User
} from '@tamagui/lucide-icons';
import { Dialog, Sheet, Adapt } from 'tamagui';
import { Select } from 'tamagui';
import type { Team, TeamMember, TeamRole } from '@/lib/teams-management';

// Role configuration with icons and styling
const ROLE_CONFIG = {
  admin: {
    icon: <Shield size="$1" />,
    color: '$blue10',
    textColor: 'white',
    label: 'Admin'
  },
  member: {
    icon: <User size="$1" />,
    color: '$green10',
    textColor: 'white',
    label: 'Member'
  },
  viewer: {
    icon: <Eye size="$1" />,
    color: '$purple10',
    textColor: 'white',
    label: 'Viewer'
  },
  guest: {
    icon: <User size="$1" />,
    color: '$gray10',
    textColor: 'white',
    label: 'Guest'
  }
};

const inviteMemberSchema = z.object({
  email: z.string().email('Please enter a valid email address'),
  role: z.enum(['admin', 'member', 'viewer', 'guest']),
  message: z.string().optional(),
});

type InviteMemberFormValues = z.infer<typeof inviteMemberSchema>;

interface MemberManagementProps {
  team: Team;
}

export function MemberManagement({ team }: MemberManagementProps) {
  const { t, formatDate } = useTranslation();
  const [isInviteDialogOpen, setIsInviteDialogOpen] = useState(false);
  const [selectedMember, setSelectedMember] = useState<TeamMember | null>(null);

  const { data: members = [], isLoading, error, refetch } = useTeamMembersList(team.id);
  const inviteMember = useTeamInvitationsInvite();
  const updateMemberRole = useTeamMembersUpdate();
  const removeMember = useTeamMembersRemove();

  const {
    control,
    register,
    handleSubmit,
    formState: { errors },
    reset,
  } = useForm<InviteMemberFormValues>({
    resolver: zodResolver(inviteMemberSchema),
    defaultValues: {
      role: 'member',
      message: '',
    },
  });

  const handleInviteMember = async (data: InviteMemberFormValues) => {
    try {
      await inviteMember.mutateAsync({
        teamId: team.id,
        email: data.email,
        role: data.role,
        message: data.message,
      });
      setIsInviteDialogOpen(false);
      reset();
    } catch (error) {
      console.error('Failed to invite member:', error);
    }
  };

  const handleUpdateRole = async (member: TeamMember, newRole: TeamRole) => {
    try {
      await updateMemberRole.mutateAsync({
        teamId: team.id,
        userId: member.userId,
        role: newRole,
      });
    } catch (error) {
      console.error('Failed to update member role:', error);
    }
  };

  const handleRemoveMember = async (member: TeamMember) => {
    if (confirm(t('teams.members.confirmRemove', { name: member.user.name }))) {
      try {
        await removeMember.mutateAsync({
          teamId: team.id,
          userId: member.userId,
        });
      } catch (error) {
        console.error('Failed to remove member:', error);
      }
    }
  };

  if (error) {
    return (
      <Card
        theme="base"
        size="$4"
        padding="$6"
        backgroundColor="$background"
        borderWidth={1}
        borderColor="$borderColor"
        borderRadius="$6"
        elevation="$2"
      >
        <XStack
          backgroundColor="$red2"
          borderWidth={1}
          borderColor="$red6"
          borderRadius="$4"
          padding="$4"
          gap="$3"
          alignItems="center"
        >
          <AlertCircle size="$1" color="$red10" />
          <Text fontSize="$3" color="$red10">
            {t('teams.members.loadError')}
          </Text>
        </XStack>
        <Button
          theme="accent"
          size="$3"
          marginTop="$4"
          onPress={() => refetch()}
        >
          {t('common.retry')}
        </Button>
      </Card>
    );
  }

  return (
    <Card
      theme="base"
      size="$4"
      padding="$0"
      backgroundColor="$background"
      borderWidth={1}
      borderColor="$borderColor"
      borderRadius="$6"
      elevation="$2"
      width="100%"
    >
      {/* Header */}
      <YStack padding="$6" paddingBottom="$4">
        <XStack justifyContent="space-between" alignItems="center">
          <YStack gap="$1">
            <XStack gap="$2" alignItems="center">
              <Users size="$1" color="$color" />
              <Text fontSize="$6" fontWeight="bold" color="$color">
                {t('teams.members.title')}
              </Text>
            </XStack>
            <Text fontSize="$3" color="$colorFocus">
              {t('teams.members.description')}
            </Text>
          </YStack>

          <Dialog modal open={isInviteDialogOpen} onOpenChange={setIsInviteDialogOpen}>
            <Dialog.Trigger asChild>
              <Button
                theme="accent"
                size="$3"
                backgroundColor="$blue10"
                color="white"
                borderRadius="$4"
              >
                <XStack gap="$1" alignItems="center">
                  <UserPlus size="$1" />
                  <Text fontSize="$3" fontWeight="bold">
                    {t('teams.members.inviteButton')}
                  </Text>
                </XStack>
              </Button>
            </Dialog.Trigger>

            <Adapt when="sm" platform="touch">
              <Sheet
                zIndex={200000}
                modal
                dismissOnSnapToBottom
                snapPointsMode="fit"
              >
                <Sheet.Frame padding="$4">
                  <Sheet.ScrollView>
                    <Adapt.Contents />
                  </Sheet.ScrollView>
                </Sheet.Frame>
                <Sheet.Overlay />
              </Sheet>
            </Adapt>

            <Dialog.Portal>
              <Dialog.Overlay
                key="overlay"
                animation="quick"
                opacity={0.5}
                enterStyle={{ opacity: 0 }}
                exitStyle={{ opacity: 0 }}
              />
              <Dialog.Content
                bordered
                elevate
                key="content"
                animation={[
                  'quick',
                  {
                    opacity: {
                      overshootClamping: true,
                    },
                  },
                ]}
                enterStyle={{ x: 0, y: -20, opacity: 0, scale: 0.9 }}
                exitStyle={{ x: 0, y: 10, opacity: 0, scale: 0.95 }}
                gap="$4"
                width={400}
                padding="$6"
              >
                <Dialog.Title>
                  <Text fontSize="$6" fontWeight="bold" color="$color">
                    {t('teams.members.inviteDialog.title')}
                  </Text>
                </Dialog.Title>
                <Dialog.Description>
                  <Text fontSize="$3" color="$colorFocus">
                    {t('teams.members.inviteDialog.description')}
                  </Text>
                </Dialog.Description>

                <YStack asChild gap="$4">
                  <form onSubmit={handleSubmit(handleInviteMember)}>
                    <YStack gap="$2">
                      <Label htmlFor="email" fontSize="$4" color="$color">
                        {t('teams.members.inviteDialog.emailLabel')}
                      </Label>
                      <Input
                        id="email"
                        placeholder={t('teams.members.inviteDialog.emailPlaceholder')}
                        {...register('email')}
                        backgroundColor="$background"
                        color="$color"
                        borderWidth={1}
                        borderColor={errors.email ? '$red10' : '$borderColor'}
                        borderRadius="$4"
                        padding="$3"
                      />
                      {errors.email && (
                        <Text fontSize="$2" color="$red10">
                          {errors.email.message}
                        </Text>
                      )}
                    </YStack>

                    <YStack gap="$2">
                      <Label htmlFor="role" fontSize="$4" color="$color">
                        {t('teams.members.inviteDialog.roleLabel')}
                      </Label>
                      <Controller
                        control={control}
                        name="role"
                        render={({ field }) => (
                          <Select
                            id="role"
                            value={field.value}
                            onValueChange={field.onChange}
                          >
                            <Select.Trigger
                              backgroundColor="$background"
                              borderColor="$borderColor"
                              borderRadius="$4"
                            >
                              <Select.Value placeholder={t('teams.members.inviteDialog.rolePlaceholder')} />
                            </Select.Trigger>

                            <Select.Content zIndex={200000}>
                              <Select.ScrollUpButton />
                              <Select.Viewport minHeight={100}>
                                <Select.Group>
                                  <Select.Label>{t('teams.members.inviteDialog.roleOptions')}</Select.Label>
                                  <Select.Item index={0} value="admin">
                                    <Select.ItemText>Admin</Select.ItemText>
                                  </Select.Item>
                                  <Select.Item index={1} value="member">
                                    <Select.ItemText>Member</Select.ItemText>
                                  </Select.Item>
                                  <Select.Item index={2} value="viewer">
                                    <Select.ItemText>Viewer</Select.ItemText>
                                  </Select.Item>
                                  <Select.Item index={3} value="guest">
                                    <Select.ItemText>Guest</Select.ItemText>
                                  </Select.Item>
                                </Select.Group>
                              </Select.Viewport>
                              <Select.ScrollDownButton />
                            </Select.Content>
                          </Select>
                        )}
                      />
                      {errors.role && (
                        <Text fontSize="$2" color="$red10">
                          {errors.role.message}
                        </Text>
                      )}
                    </YStack>

                    <YStack gap="$2">
                      <Label htmlFor="message" fontSize="$4" color="$color">
                        {t('teams.members.inviteDialog.messageLabel')}
                      </Label>
                      <TextArea
                        id="message"
                        placeholder={t('teams.members.inviteDialog.messagePlaceholder')}
                        {...register('message')}
                        backgroundColor="$background"
                        color="$color"
                        borderWidth={1}
                        borderColor="$borderColor"
                        borderRadius="$4"
                        padding="$3"
                        numberOfLines={3}
                      />
                    </YStack>

                    <XStack justifyContent="flex-end" gap="$2" marginTop="$4">
                      <Button
                        type="button"
                        size="$3"
                        backgroundColor="$backgroundHover"
                        color="$color"
                        borderWidth={1}
                        borderColor="$borderColor"
                        borderRadius="$4"
                        onPress={() => setIsInviteDialogOpen(false)}
                      >
                        {t('common.cancel')}
                      </Button>
                      <Button
                        type="submit"
                        theme="accent"
                        size="$3"
                        backgroundColor="$blue10"
                        color="white"
                        borderRadius="$4"
                        disabled={inviteMember.isPending}
                      >
                        <XStack gap="$1" alignItems="center">
                          {inviteMember.isPending && <Spinner size="small" color="white" />}
                          <Text fontSize="$3" fontWeight="bold">
                            {t('teams.members.inviteDialog.sendButton')}
                          </Text>
                        </XStack>
                      </Button>
                    </XStack>
                  </form>
                </YStack>
              </Dialog.Content>
            </Dialog.Portal>
          </Dialog>
        </XStack>
      </YStack>

      {/* Content */}
      <YStack padding="$6" paddingTop="$0">
        {/* Members Table */}
        <YStack
          borderWidth={1}
          borderColor="$borderColor"
          borderRadius="$4"
          overflow="hidden"
        >
          {/* Table Header */}
          <XStack
            backgroundColor="$backgroundHover"
            padding="$3"
            borderBottomWidth={1}
            borderBottomColor="$borderColor"
          >
            <Text flex={3} fontWeight="bold" color="$color">
              {t('teams.members.table.member')}
            </Text>
            <Text flex={1} fontWeight="bold" color="$color">
              {t('teams.members.table.role')}
            </Text>
            <Text flex={1} fontWeight="bold" color="$color">
              {t('teams.members.table.joined')}
            </Text>
            <Text flex={1} fontWeight="bold" color="$color">
              {t('teams.members.table.status')}
            </Text>
            <Text width={120} fontWeight="bold" color="$color">
              {t('teams.members.table.actions')}
            </Text>
          </XStack>

          {/* Table Body */}
          {isLoading ? (
            // Loading skeletons
            <>
              {[1, 2, 3].map((i) => (
                <XStack key={i} padding="$3" borderBottomWidth={1} borderBottomColor="$borderColor">
                  <XStack flex={3} gap="$3" alignItems="center">
                    <YStack width="$3" height="$3" borderRadius="$full" backgroundColor="$gray5" />
                    <YStack gap="$1">
                      <YStack width={100} height="$2" borderRadius="$2" backgroundColor="$gray5" />
                      <YStack width={80} height="$1" borderRadius="$2" backgroundColor="$gray5" />
                    </YStack>
                  </XStack>
                  <XStack flex={1} alignItems="center">
                    <YStack width={60} height="$2" borderRadius="$2" backgroundColor="$gray5" />
                  </XStack>
                  <XStack flex={1} alignItems="center">
                    <YStack width={80} height="$2" borderRadius="$2" backgroundColor="$gray5" />
                  </XStack>
                  <XStack flex={1} alignItems="center">
                    <YStack width={60} height="$2" borderRadius="$2" backgroundColor="$gray5" />
                  </XStack>
                  <XStack width={120} alignItems="center">
                    <YStack width={80} height="$2" borderRadius="$2" backgroundColor="$gray5" />
                  </XStack>
                </XStack>
              ))}
            </>
          ) : members.length === 0 ? (
            // Empty state
            <XStack padding="$8" justifyContent="center">
              <Text color="$colorFocus">
                {t('teams.members.emptyState')}
              </Text>
            </XStack>
          ) : (
            // Member rows
            <>
              {members.map((member) => {
                const roleConfig = ROLE_CONFIG[member.role];

                return (
                  <XStack 
                    key={member.id} 
                    padding="$3" 
                    borderBottomWidth={1} 
                    borderBottomColor="$borderColor"
                    hoverStyle={{ backgroundColor: '$backgroundHover' }}
                  >
                    {/* Member info */}
                    <XStack flex={3} gap="$3" alignItems="center">
                      <XStack
                        width="$3"
                        height="$3"
                        borderRadius="$full"
                        backgroundColor="$blue10"
                        alignItems="center"
                        justifyContent="center"
                      >
                        <Text color="white" fontWeight="bold">
                          {member.user.name.charAt(0).toUpperCase()}
                        </Text>
                      </XStack>
                      <YStack>
                        <Text fontWeight="medium" color="$color">
                          {member.user.name}
                        </Text>
                        <Text fontSize="$2" color="$colorFocus">
                          {member.user.email}
                        </Text>
                      </YStack>
                    </XStack>

                    {/* Role */}
                    <XStack flex={1} alignItems="center">
                      <Badge
                        backgroundColor={roleConfig.color}
                        color={roleConfig.textColor}
                        borderRadius="$4"
                        size="$2"
                      >
                        <XStack gap="$1" alignItems="center">
                          {roleConfig.icon}
                          <Text fontSize="$2" fontWeight="bold">
                            {roleConfig.label}
                          </Text>
                        </XStack>
                      </Badge>
                    </XStack>

                    {/* Joined date */}
                    <XStack flex={1} alignItems="center">
                      <XStack gap="$1" alignItems="center">
                        <Calendar size="$1" color="$colorFocus" />
                        <Text fontSize="$2" color="$colorFocus">
                          {formatDate(member.joinedAt)}
                        </Text>
                      </XStack>
                    </XStack>

                    {/* Status */}
                    <XStack flex={1} alignItems="center">
                      <Badge
                        backgroundColor={member.isActive ? '$green10' : '$gray5'}
                        color={member.isActive ? 'white' : '$color'}
                        borderRadius="$4"
                        size="$2"
                      >
                        <Text fontSize="$2" fontWeight="bold">
                          {member.isActive ? t('teams.members.status.active') : t('teams.members.status.inactive')}
                        </Text>
                      </Badge>
                    </XStack>

                    {/* Actions */}
                    <XStack width={120} alignItems="center">
                      <Controller
                        control={control}
                        name="role"
                        defaultValue={member.role}
                        render={({ field }) => (
                          <Select
                            id={`role-${member.id}`}
                            value={member.role}
                            onValueChange={(value) => handleUpdateRole(member, value as TeamRole)}
                          >
                            <Select.Trigger
                              backgroundColor="$background"
                              borderColor="$borderColor"
                              borderRadius="$4"
                              width={120}
                            >
                              <Select.Value placeholder={t('teams.members.selectRole')} />
                            </Select.Trigger>

                            <Select.Content zIndex={200000}>
                              <Select.ScrollUpButton />
                              <Select.Viewport minHeight={100}>
                                <Select.Group>
                                  <Select.Label>{t('teams.members.roles')}</Select.Label>
                                  <Select.Item index={0} value="admin">
                                    <Select.ItemText>Admin</Select.ItemText>
                                  </Select.Item>
                                  <Select.Item index={1} value="member">
                                    <Select.ItemText>Member</Select.ItemText>
                                  </Select.Item>
                                  <Select.Item index={2} value="viewer">
                                    <Select.ItemText>Viewer</Select.ItemText>
                                  </Select.Item>
                                  <Select.Item index={3} value="guest">
                                    <Select.ItemText>Guest</Select.ItemText>
                                  </Select.Item>
                                </Select.Group>
                              </Select.Viewport>
                              <Select.ScrollDownButton />
                            </Select.Content>
                          </Select>
                        )}
                      />
                    </XStack>
                  </XStack>
                );
              })}
            </>
          )}
        </YStack>

        {/* Member Count */}
        <Text fontSize="$3" color="$colorFocus" marginTop="$4">
          {t('teams.members.count', { count: members.length })}
        </Text>
      </YStack>
    </Card>
  );
}

export default MemberManagement;

