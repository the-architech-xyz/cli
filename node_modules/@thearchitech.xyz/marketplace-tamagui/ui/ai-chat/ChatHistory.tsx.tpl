'use client';

import React, { useState, useEffect } from 'react';
import { useTranslation } from '@/lib/i18n';
import {
  YStack,
  XStack,
  Button,
  Text,
  Card,
  CardContent,
  CardHeader,
  CardTitle,
  CardDescription,
  Badge,
  Spinner,
  Input,
  Select,
  SelectTrigger,
  SelectContent,
  SelectItem,
  SelectValue,
  Theme,
  Square,
  Separator
} from 'tamagui';
import {
  MessageSquare,
  Calendar,
  Clock,
  User,
  Bot,
  Search,
  Filter,
  ChevronDown,
  ChevronUp,
  Star,
  Archive,
  Trash2,
  MoreHorizontal,
  CheckCircle,
  AlertCircle,
  RefreshCw,
  Info
} from 'lucide-react-native';
import { useAIChat } from '@/lib/ai-chat/hooks';

export interface ChatHistoryProps {
  onSelectConversation?: (conversationId: string) => void;
  onCreateConversation?: () => void;
  onDeleteConversation?: (conversationId: string) => void;
  onArchiveConversation?: (conversationId: string) => void;
  onFavoriteConversation?: (conversationId: string, isFavorite: boolean) => void;
  onRefresh?: () => void;
  isLoading?: boolean;
  error?: string;
  conversations?: any[];
}

export function ChatHistory({
  onSelectConversation,
  onCreateConversation,
  onDeleteConversation,
  onArchiveConversation,
  onFavoriteConversation,
  onRefresh,
  isLoading = false,
  error = '',
  conversations = []
}: ChatHistoryProps) {
  const { t } = useTranslation();
  const [searchQuery, setSearchQuery] = useState('');
  const [sortBy, setSortBy] = useState<'recent' | 'oldest' | 'alphabetical'>('recent');
  const [filterBy, setFilterBy] = useState<'all' | 'favorites' | 'archived'>('all');
  const [filteredConversations, setFilteredConversations] = useState<any[]>(conversations);
  
  // Apply filters and sorting
  useEffect(() => {
    let filtered = [...conversations];
    
    // Apply search filter
    if (searchQuery) {
      const query = searchQuery.toLowerCase();
      filtered = filtered.filter(
        conv => conv.title.toLowerCase().includes(query)
      );
    }
    
    // Apply type filter
    if (filterBy === 'favorites') {
      filtered = filtered.filter(conv => conv.isFavorite);
    } else if (filterBy === 'archived') {
      filtered = filtered.filter(conv => conv.isArchived);
    } else if (filterBy === 'all') {
      filtered = filtered.filter(conv => !conv.isArchived);
    }
    
    // Apply sorting
    if (sortBy === 'recent') {
      filtered.sort((a, b) => new Date(b.updatedAt).getTime() - new Date(a.updatedAt).getTime());
    } else if (sortBy === 'oldest') {
      filtered.sort((a, b) => new Date(a.updatedAt).getTime() - new Date(b.updatedAt).getTime());
    } else if (sortBy === 'alphabetical') {
      filtered.sort((a, b) => a.title.localeCompare(b.title));
    }
    
    setFilteredConversations(filtered);
  }, [conversations, searchQuery, sortBy, filterBy]);
  
  const formatDate = (dateString: string) => {
    const date = new Date(dateString);
    const now = new Date();
    
    // If today, show time
    if (date.toDateString() === now.toDateString()) {
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
    
    // If this year, show month and day
    if (date.getFullYear() === now.getFullYear()) {
      return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
    }
    
    // Otherwise show full date
    return date.toLocaleDateString([], { year: 'numeric', month: 'short', day: 'numeric' });
  };
  
  const renderConversationItem = (conversation: any) => (
    <Card
      key={conversation.id}
      elevate
      bordered
      pressStyle={{ scale: 0.98 }}
      animation="bouncy"
      onPress={() => onSelectConversation?.(conversation.id)}
    >
      <CardContent padding="$3">
        <XStack alignItems="flex-start" justifyContent="space-between">
          <XStack alignItems="flex-start" gap="$3" flex={1}>
            <Theme name={conversation.isFavorite ? "yellow" : "gray"}>
              <Square
                backgroundColor={conversation.isFavorite ? "$yellow4" : "$gray4"}
                padding="$2"
                borderRadius="$4"
              >
                <MessageSquare size={16} color={conversation.isFavorite ? "$yellow10" : "$gray10"} />
              </Square>
            </Theme>
            
            <YStack flex={1} minWidth={0}>
              <XStack alignItems="center" gap="$2">
                <Text fontWeight="$6" fontSize="$3" numberOfLines={1} ellipsizeMode="tail" flex={1}>
                  {conversation.title}
                </Text>
                {conversation.isFavorite && (
                  <Star size={14} color="$yellow10" fill="$yellow10" />
                )}
                {conversation.isArchived && (
                  <Archive size={14} color="$gray10" />
                )}
              </XStack>
              
              <XStack alignItems="center" gap="$2" marginTop="$1">
                <XStack alignItems="center" gap="$1">
                  <Clock size={12} color="$gray10" />
                  <Text fontSize="$1" color="$gray11">
                    {formatDate(conversation.updatedAt)}
                  </Text>
                </XStack>
                <XStack alignItems="center" gap="$1">
                  <MessageSquare size={12} color="$gray10" />
                  <Text fontSize="$1" color="$gray11">
                    {conversation.messageCount}
                  </Text>
                </XStack>
              </XStack>
              
              {conversation.summary && (
                <Text fontSize="$2" color="$gray11" numberOfLines={1} ellipsizeMode="tail" marginTop="$1">
                  {conversation.summary}
                </Text>
              )}
            </YStack>
          </XStack>
          
          <YStack alignItems="flex-end">
            <XStack gap="$1">
              <Button
                size="$2"
                circular
                chromeless
                onPress={(e) => {
                  e.stopPropagation();
                  onFavoriteConversation?.(conversation.id, !conversation.isFavorite);
                }}
                theme={conversation.isFavorite ? "yellow" : undefined}
              >
                <Star size={14} fill={conversation.isFavorite ? "currentColor" : "none"} />
              </Button>
              
              <Button
                size="$2"
                circular
                chromeless
                onPress={(e) => {
                  e.stopPropagation();
                  onArchiveConversation?.(conversation.id);
                }}
              >
                <Archive size={14} />
              </Button>
              
              <Button
                size="$2"
                circular
                chromeless
                theme="red"
                onPress={(e) => {
                  e.stopPropagation();
                  onDeleteConversation?.(conversation.id);
                }}
              >
                <Trash2 size={14} />
              </Button>
            </XStack>
          </YStack>
        </XStack>
      </CardContent>
    </Card>
  );
  
  return (
    <YStack flex={1} backgroundColor="$background">
      {/* Search and Filters */}
      <YStack padding="$3" space="$3" borderBottomWidth={1} borderBottomColor="$borderColor">
        <Input
          placeholder={t('Search conversations...')}
          value={searchQuery}
          onChangeText={setSearchQuery}
          leftElement={<Search size={16} color="$gray10" />}
          clearButtonMode="while-editing"
        />
        
        <XStack alignItems="center" justifyContent="space-between">
          <Select value={filterBy} onValueChange={(value) => setFilterBy(value as any)}>
            <SelectTrigger width="45%" borderRadius="$4">
              <XStack alignItems="center" justifyContent="space-between" flex={1}>
                <XStack alignItems="center" gap="$2">
                  <Filter size={14} />
                  <SelectValue placeholder={t('Filter')} />
                </XStack>
                <ChevronDown size={14} />
              </XStack>
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all" text={t('All')} />
              <SelectItem value="favorites" text={t('Favorites')} />
              <SelectItem value="archived" text={t('Archived')} />
            </SelectContent>
          </Select>
          
          <Select value={sortBy} onValueChange={(value) => setSortBy(value as any)}>
            <SelectTrigger width="45%" borderRadius="$4">
              <XStack alignItems="center" justifyContent="space-between" flex={1}>
                <XStack alignItems="center" gap="$2">
                  {sortBy === 'recent' ? (
                    <ChevronUp size={14} />
                  ) : sortBy === 'oldest' ? (
                    <ChevronDown size={14} />
                  ) : (
                    <Text fontSize="$1">A-Z</Text>
                  )}
                  <SelectValue placeholder={t('Sort')} />
                </XStack>
                <ChevronDown size={14} />
              </XStack>
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="recent" text={t('Most Recent')} />
              <SelectItem value="oldest" text={t('Oldest First')} />
              <SelectItem value="alphabetical" text={t('Alphabetical')} />
            </SelectContent>
          </Select>
        </XStack>
      </YStack>
      
      {/* Conversation List */}
      <YStack flex={1} padding="$3" space="$3" overflow="auto">
        {isLoading ? (
          <YStack flex={1} alignItems="center" justifyContent="center" padding="$8">
            <Spinner size="large" />
            <Text marginTop="$4">{t('Loading conversations...')}</Text>
          </YStack>
        ) : error ? (
          <YStack flex={1} alignItems="center" justifyContent="center" padding="$8">
            <Theme name="red">
              <AlertCircle size={32} />
            </Theme>
            <Text marginTop="$4" fontWeight="$6">{t('Error loading conversations')}</Text>
            <Text marginTop="$2" textAlign="center" color="$gray11">{error}</Text>
            <Button 
              marginTop="$4" 
              icon={<RefreshCw size={16} />}
              onPress={onRefresh}
            >
              {t('Try Again')}
            </Button>
          </YStack>
        ) : filteredConversations.length === 0 ? (
          <YStack flex={1} alignItems="center" justifyContent="center" padding="$8">
            <Theme name="gray">
              <Info size={32} />
            </Theme>
            <Text marginTop="$4" fontWeight="$6">
              {searchQuery 
                ? t('No conversations found') 
                : filterBy === 'favorites' 
                  ? t('No favorite conversations') 
                  : filterBy === 'archived' 
                    ? t('No archived conversations')
                    : t('No conversations yet')
              }
            </Text>
            <Text marginTop="$2" textAlign="center" color="$gray11">
              {searchQuery 
                ? t('Try a different search term') 
                : filterBy !== 'all' 
                  ? t('Try a different filter')
                  : t('Start a new conversation')
              }
            </Text>
            {!searchQuery && filterBy === 'all' && (
              <Button 
                marginTop="$4" 
                icon={<MessageSquare size={16} />}
                onPress={onCreateConversation}
              >
                {t('New Conversation')}
              </Button>
            )}
          </YStack>
        ) : (
          <>
            {filteredConversations.map(renderConversationItem)}
            
            {filteredConversations.length > 0 && (
              <Text fontSize="$1" color="$gray11" textAlign="center" paddingVertical="$2">
                {filteredConversations.length} {filteredConversations.length === 1 
                  ? t('conversation found') 
                  : t('conversations found')
                }
              </Text>
            )}
          </>
        )}
      </YStack>
      
      {/* New Conversation Button */}
      <YStack padding="$3" borderTopWidth={1} borderTopColor="$borderColor">
        <Button 
          icon={<MessageSquare size={16} />}
          onPress={onCreateConversation}
          width="100%"
        >
          {t('New Conversation')}
        </Button>
      </YStack>
    </YStack>
  );
}

export default ChatHistory;
