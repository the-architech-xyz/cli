/**
 * Chat Interface Component (Tamagui)
 * 
 * AI chat interface with i18n support
 */

import React, { useState, useRef, useEffect } from 'react';
import { YStack, XStack, Card, Text, Button, TextArea, Avatar, Badge, ScrollView } from 'tamagui';
import { useTranslation } from '@/lib/i18n';
import { 
  Send, 
  Mic, 
  MicOff, 
  Paperclip, 
  X, 
  Bot, 
  User, 
  MoreVertical 
} from '@tamagui/lucide-icons';
import { Spinner } from 'tamagui';
import { toast } from 'sonner';
import { Sheet, Adapt } from 'tamagui';

export interface Message {
  id: string;
  content: string;
  role: 'user' | 'assistant';
  timestamp: Date;
  isStreaming?: boolean;
  attachments?: Attachment[];
  metadata?: Record<string, any>;
}

export interface Attachment {
  id: string;
  name: string;
  type: 'image' | 'document' | 'audio' | 'video';
  url: string;
  size: number;
}

export interface ChatInterfaceProps {
  messages: Message[];
  onSendMessage: (content: string, attachments?: File[]) => Promise<void>;
  onVoiceInput?: () => Promise<void>;
  onFileUpload?: (files: File[]) => Promise<void>;
  isLoading?: boolean;
  isVoiceRecording?: boolean;
  placeholder?: string;
  maxLength?: number;
  disabled?: boolean;
  showTypingIndicator?: boolean;
  typingUser?: string;
  onClearChat?: () => void;
  onExportChat?: () => void;
  onDeleteMessage?: (messageId: string) => void;
}

export function ChatInterface({
  messages,
  onSendMessage,
  onVoiceInput,
  onFileUpload,
  isLoading = false,
  isVoiceRecording = false,
  placeholder = "Type your message...",
  maxLength = 2000,
  disabled = false,
  showTypingIndicator = false,
  typingUser,
  onClearChat,
  onExportChat,
  onDeleteMessage,
}: ChatInterfaceProps) {
  const { t, formatDate } = useTranslation();
  const [input, setInput] = useState('');
  const [attachments, setAttachments] = useState<File[]>([]);
  const [isComposing, setIsComposing] = useState(false);
  const [menuOpen, setMenuOpen] = useState(false);
  const textareaRef = useRef<HTMLTextAreaElement>(null);
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const scrollViewRef = useRef<React.ElementRef<typeof ScrollView>>(null);

  // Auto-scroll to bottom when new messages arrive
  useEffect(() => {
    if (scrollViewRef.current) {
      setTimeout(() => {
        scrollViewRef.current?.scrollToEnd({ animated: true });
      }, 100);
    }
  }, [messages]);

  // Auto-resize textarea
  useEffect(() => {
    if (textareaRef.current) {
      textareaRef.current.style.height = 'auto';
      textareaRef.current.style.height = `${textareaRef.current.scrollHeight}px`;
    }
  }, [input]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!input.trim() || isLoading || disabled) return;

    const messageContent = input.trim();
    setInput('');
    setAttachments([]);
    
    try {
      await onSendMessage(messageContent, attachments);
    } catch (error) {
      console.error('Failed to send message:', error);
      toast(t('chat.error.sendFailed'));
    }
  };

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSubmit(e);
    }
  };

  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = Array.from(e.target.files || []);
    if (files.length === 0) return;

    // Validate file types and sizes
    const validFiles = files.filter(file => {
      const maxSize = 10 * 1024 * 1024; // 10MB
      if (file.size > maxSize) {
        toast(t('chat.error.fileTooBig', { name: file.name }));
        return false;
      }
      return true;
    });

    if (validFiles.length > 0) {
      setAttachments(prev => [...prev, ...validFiles]);
      onFileUpload?.(validFiles);
    }

    // Reset file input
    if (fileInputRef.current) {
      fileInputRef.current.value = '';
    }
  };

  const removeAttachment = (index: number) => {
    setAttachments(prev => prev.filter((_, i) => i !== index));
  };

  const formatFileSize = (bytes: number): string => {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  };

  const formatTimestamp = (timestamp: Date): string => {
    return new Intl.DateTimeFormat('en-US', {
      hour: '2-digit',
      minute: '2-digit',
      hour12: true,
    }).format(timestamp);
  };

  return (
    <YStack flex={1} backgroundColor="$background">
      {/* Header */}
      <XStack 
        padding="$4" 
        borderBottomWidth={1} 
        borderBottomColor="$borderColor" 
        justifyContent="space-between"
        alignItems="center"
      >
        <XStack gap="$3" alignItems="center">
          <Avatar circular size="$3" backgroundColor="$blue10">
            <Avatar.Fallback>
              <Bot size="$1" color="white" />
            </Avatar.Fallback>
          </Avatar>
          <YStack>
            <Text fontSize="$4" fontWeight="bold" color="$color">
              {t('chat.header.title')}
            </Text>
            <Text fontSize="$2" color="$colorFocus">
              {isLoading ? t('chat.header.thinking') : t('chat.header.online')}
            </Text>
          </YStack>
        </XStack>
        
        <Button
          size="$3"
          backgroundColor="transparent"
          onPress={() => setMenuOpen(true)}
        >
          <MoreVertical size="$1" color="$color" />
        </Button>
        
        <Sheet
          modal
          open={menuOpen}
          onOpenChange={setMenuOpen}
          snapPoints={[25]}
          position={0}
          dismissOnSnapToBottom
        >
          <Sheet.Overlay />
          <Sheet.Frame padding="$4">
            <YStack gap="$4">
              <Text fontSize="$5" fontWeight="bold" color="$color">
                {t('chat.menu.title')}
              </Text>
              
              {onClearChat && (
                <Button
                  size="$4"
                  backgroundColor="$backgroundHover"
                  color="$color"
                  borderWidth={1}
                  borderColor="$borderColor"
                  borderRadius="$4"
                  onPress={() => {
                    onClearChat();
                    setMenuOpen(false);
                  }}
                >
                  <Text fontSize="$4">
                    {t('chat.menu.clearChat')}
                  </Text>
                </Button>
              )}
              
              {onExportChat && (
                <Button
                  size="$4"
                  backgroundColor="$backgroundHover"
                  color="$color"
                  borderWidth={1}
                  borderColor="$borderColor"
                  borderRadius="$4"
                  onPress={() => {
                    onExportChat();
                    setMenuOpen(false);
                  }}
                >
                  <Text fontSize="$4">
                    {t('chat.menu.exportChat')}
                  </Text>
                </Button>
              )}
              
              <Button
                size="$4"
                backgroundColor="$backgroundHover"
                color="$color"
                borderWidth={1}
                borderColor="$borderColor"
                borderRadius="$4"
                onPress={() => setMenuOpen(false)}
              >
                <Text fontSize="$4">
                  {t('common.cancel')}
                </Text>
              </Button>
            </YStack>
          </Sheet.Frame>
        </Sheet>
      </XStack>

      {/* Messages */}
      <ScrollView
        ref={scrollViewRef}
        flex={1}
        padding="$4"
        contentContainerStyle={{ gap: 16 }}
      >
        {messages.length === 0 ? (
          <YStack height={256} alignItems="center" justifyContent="center" gap="$4">
            <Bot size="$6" color="$colorFocus" />
            <Text fontSize="$5" fontWeight="bold" color="$color">
              {t('chat.empty.title')}
            </Text>
            <Text fontSize="$3" color="$colorFocus" textAlign="center">
              {t('chat.empty.description')}
            </Text>
          </YStack>
        ) : (
          <>
            {messages.map((message) => (
              <XStack
                key={message.id}
                gap="$3"
                justifyContent={message.role === 'user' ? 'flex-end' : 'flex-start'}
              >
                {message.role === 'assistant' && (
                  <Avatar circular size="$3" backgroundColor="$blue10">
                    <Avatar.Fallback>
                      <Bot size="$1" color="white" />
                    </Avatar.Fallback>
                  </Avatar>
                )}
                
                <YStack
                  maxWidth="80%"
                  gap="$2"
                  order={message.role === 'user' ? 1 : 2}
                >
                  <Card
                    backgroundColor={message.role === 'user' ? '$blue10' : '$gray2'}
                    padding="$3"
                    borderRadius="$4"
                  >
                    <Text 
                      color={message.role === 'user' ? 'white' : '$color'}
                      whiteSpace="pre-wrap"
                    >
                      {message.content}
                      {message.isStreaming && (
                        <Text 
                          color={message.role === 'user' ? 'white' : '$color'}
                          opacity={0.7}
                          animation="pulse"
                        >
                          â–‹
                        </Text>
                      )}
                    </Text>
                    
                    {message.attachments && message.attachments.length > 0 && (
                      <YStack marginTop="$2" gap="$1">
                        {message.attachments.map((attachment) => (
                          <XStack
                            key={attachment.id}
                            gap="$2"
                            padding="$2"
                            backgroundColor={message.role === 'user' ? '$blue9' : '$gray3'}
                            borderRadius="$2"
                            alignItems="center"
                          >
                            <Paperclip size="$1" color={message.role === 'user' ? 'white' : '$color'} />
                            <Text 
                              fontSize="$2" 
                              color={message.role === 'user' ? 'white' : '$color'}
                              numberOfLines={1}
                              ellipsizeMode="tail"
                              flex={1}
                            >
                              {attachment.name}
                            </Text>
                            <Badge
                              backgroundColor={message.role === 'user' ? '$blue8' : '$gray4'}
                              borderRadius="$2"
                              size="$1"
                            >
                              <Text fontSize="$1" color={message.role === 'user' ? 'white' : '$color'}>
                                {attachment.type}
                              </Text>
                            </Badge>
                          </XStack>
                        ))}
                      </YStack>
                    )}
                  </Card>
                  
                  <XStack gap="$2" alignItems="center">
                    <Text fontSize="$2" color="$colorFocus">
                      {formatTimestamp(message.timestamp)}
                    </Text>
                    {message.role === 'user' && onDeleteMessage && (
                      <Button
                        size="$1"
                        backgroundColor="transparent"
                        padding="$0"
                        onPress={() => onDeleteMessage(message.id)}
                      >
                        <X size="$1" color="$colorFocus" />
                      </Button>
                    )}
                  </XStack>
                </YStack>
                
                {message.role === 'user' && (
                  <Avatar circular size="$3" backgroundColor="$purple10">
                    <Avatar.Fallback>
                      <User size="$1" color="white" />
                    </Avatar.Fallback>
                  </Avatar>
                )}
              </XStack>
            ))}
            
            {showTypingIndicator && typingUser && (
              <XStack gap="$3">
                <Avatar circular size="$3" backgroundColor="$blue10">
                  <Avatar.Fallback>
                    <Bot size="$1" color="white" />
                  </Avatar.Fallback>
                </Avatar>
                <Card
                  backgroundColor="$gray2"
                  padding="$3"
                  borderRadius="$4"
                >
                  <XStack gap="$2" alignItems="center">
                    <Spinner size="small" color="$colorFocus" />
                    <Text fontSize="$3" color="$colorFocus">
                      {t('chat.typing', { user: typingUser })}
                    </Text>
                  </XStack>
                </Card>
              </XStack>
            )}
            
            <YStack ref={messagesEndRef} />
          </>
        )}
      </ScrollView>

      {/* Attachments */}
      {attachments.length > 0 && (
        <XStack
          padding="$4"
          borderTopWidth={1}
          borderTopColor="$borderColor"
          flexWrap="wrap"
          gap="$2"
        >
          {attachments.map((file, index) => (
            <XStack
              key={index}
              gap="$2"
              padding="$2"
              paddingHorizontal="$3"
              backgroundColor="$gray2"
              borderRadius="$full"
              alignItems="center"
            >
              <Paperclip size="$1" color="$color" />
              <Text 
                fontSize="$2" 
                color="$color"
                numberOfLines={1}
                ellipsizeMode="tail"
                maxWidth={128}
              >
                {file.name}
              </Text>
              <Text fontSize="$2" color="$colorFocus">
                {formatFileSize(file.size)}
              </Text>
              <Button
                size="$1"
                backgroundColor="transparent"
                padding="$0"
                onPress={() => removeAttachment(index)}
              >
                <X size="$1" color="$color" />
              </Button>
            </XStack>
          ))}
        </XStack>
      )}

      {/* Input */}
      <YStack 
        padding="$4" 
        borderTopWidth={1} 
        borderTopColor="$borderColor"
        gap="$2"
      >
        <XStack asChild gap="$2">
          <form onSubmit={handleSubmit}>
            <XStack flex={1} position="relative">
              <TextArea
                ref={textareaRef}
                value={input}
                onChangeText={setInput}
                placeholder={placeholder}
                maxLength={maxLength}
                disabled={disabled || isLoading}
                backgroundColor="$background"
                color="$color"
                borderWidth={1}
                borderColor="$borderColor"
                borderRadius="$4"
                padding="$3"
                paddingRight="$10"
                minHeight="$4"
                maxHeight={128}
                flex={1}
                onKeyPress={(e) => {
                  if (e.nativeEvent.key === 'Enter' && !e.nativeEvent.shiftKey) {
                    e.preventDefault();
                    handleSubmit(e as any);
                  }
                }}
                onCompositionStart={() => setIsComposing(true)}
                onCompositionEnd={() => setIsComposing(false)}
              />
              
              <XStack position="absolute" right="$2" top="50%" transform="translateY(-50%)">
                <input
                  ref={fileInputRef}
                  type="file"
                  multiple
                  onChange={handleFileSelect}
                  style={{ display: 'none' }}
                  accept="image/*,application/pdf,.doc,.docx,.txt"
                />
                <Button
                  size="$2"
                  backgroundColor="transparent"
                  padding="$0"
                  onPress={() => fileInputRef.current?.click()}
                  disabled={disabled || isLoading}
                >
                  <Paperclip size="$1" color="$color" />
                </Button>
              </XStack>
            </XStack>
            
            <XStack gap="$1">
              {onVoiceInput && (
                <Button
                  size="$3"
                  backgroundColor={isVoiceRecording ? '$red10' : '$backgroundHover'}
                  color={isVoiceRecording ? 'white' : '$color'}
                  borderWidth={1}
                  borderColor={isVoiceRecording ? '$red10' : '$borderColor'}
                  borderRadius="$4"
                  onPress={onVoiceInput}
                  disabled={disabled || isLoading}
                >
                  {isVoiceRecording ? (
                    <MicOff size="$1" color="white" />
                  ) : (
                    <Mic size="$1" color="$color" />
                  )}
                </Button>
              )}
              
              <Button
                theme="accent"
                size="$3"
                backgroundColor="$blue10"
                color="white"
                borderRadius="$4"
                disabled={!input.trim() || isLoading || disabled || isComposing}
                onPress={handleSubmit}
              >
                {isLoading ? (
                  <Spinner size="small" color="white" />
                ) : (
                  <Send size="$1" color="white" />
                )}
              </Button>
            </XStack>
          </form>
        </XStack>
        
        <XStack justifyContent="space-between" alignItems="center">
          <Text fontSize="$2" color="$colorFocus">
            {t('chat.input.characters', { current: input.length, max: maxLength })}
          </Text>
          <Text fontSize="$2" color="$colorFocus">
            {t('chat.input.hint')}
          </Text>
        </XStack>
      </YStack>
    </YStack>
  );
}

export default ChatInterface;

