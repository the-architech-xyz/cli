'use client';

import React, { useState, useCallback, useMemo } from 'react';
import { useTranslation } from '@/lib/i18n';
import {
  YStack,
  XStack,
  Button,
  Text,
  Card,
  CardContent,
  Badge,
  ScrollView,
  Theme,
  Square
} from 'tamagui';
import {
  Download,
  Trash2,
  Eye,
  EyeOff,
  ZoomIn,
  ZoomOut,
  RotateCw,
  FileText,
  Image,
  Video,
  Music,
  Archive,
  File,
  X,
  ChevronLeft,
  ChevronRight,
  Maximize2,
  Minimize2
} from 'lucide-react-native';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '@tamagui/dialog';
import { MessageAttachment } from '@/types/ai-chat';

export interface MediaPreviewProps {
  attachments: MessageAttachment[];
  className?: string;
  onRemove?: (attachmentId: string) => void;
  onDownload?: (attachmentId: string) => void;
  onView?: (attachmentId: string) => void;
  maxHeight?: string;
  showThumbnails?: boolean;
  allowFullscreen?: boolean;
  allowDownload?: boolean;
  allowRemove?: boolean;
}

export function MediaPreview({
  attachments,
  className,
  onRemove,
  onDownload,
  onView,
  maxHeight = '300px',
  showThumbnails = true,
  allowFullscreen = true,
  allowDownload = true,
  allowRemove = true,
}: MediaPreviewProps) {
  const { t } = useTranslation();
  const [selectedIndex, setSelectedIndex] = useState<number | null>(null);
  const [isFullscreen, setIsFullscreen] = useState(false);
  const [zoom, setZoom] = useState(1);
  const [rotation, setRotation] = useState(0);

  // Group attachments by type
  const groupedAttachments = useMemo(() => {
    const groups = {
      images: [] as MessageAttachment[],
      videos: [] as MessageAttachment[],
      audio: [] as MessageAttachment[],
      documents: [] as MessageAttachment[],
      other: [] as MessageAttachment[],
    };

    attachments.forEach(attachment => {
      switch (attachment.type) {
        case 'image':
          groups.images.push(attachment);
          break;
        case 'video':
          groups.videos.push(attachment);
          break;
        case 'audio':
          groups.audio.push(attachment);
          break;
        case 'document':
          groups.documents.push(attachment);
          break;
        default:
          groups.other.push(attachment);
      }
    });

    return groups;
  }, [attachments]);

  const handleRemove = useCallback((attachmentId: string) => {
    onRemove?.(attachmentId);
  }, [onRemove]);

  const handleDownload = useCallback((attachmentId: string) => {
    onDownload?.(attachmentId);
  }, [onDownload]);

  const handleView = useCallback((attachmentId: string) => {
    onView?.(attachmentId);
    const index = attachments.findIndex(att => att.id === attachmentId);
    if (index !== -1) {
      setSelectedIndex(index);
    }
  }, [onView, attachments]);

  const handleNext = useCallback(() => {
    if (selectedIndex !== null && selectedIndex < attachments.length - 1) {
      setSelectedIndex(selectedIndex + 1);
    }
  }, [selectedIndex, attachments.length]);

  const handlePrevious = useCallback(() => {
    if (selectedIndex !== null && selectedIndex > 0) {
      setSelectedIndex(selectedIndex - 1);
    }
  }, [selectedIndex]);

  const handleZoomIn = useCallback(() => {
    setZoom(prev => Math.min(prev + 0.25, 3));
  }, []);

  const handleZoomOut = useCallback(() => {
    setZoom(prev => Math.max(prev - 0.25, 0.25));
  }, []);

  const handleRotate = useCallback(() => {
    setRotation(prev => (prev + 90) % 360);
  }, []);

  const handleReset = useCallback(() => {
    setZoom(1);
    setRotation(0);
  }, []);

  const formatFileSize = (bytes: number): string => {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  };

  const getFileIcon = (type: string) => {
    switch (type) {
      case 'image':
        return <Image size={16} />;
      case 'video':
        return <Video size={16} />;
      case 'audio':
        return <Music size={16} />;
      case 'document':
        return <FileText size={16} />;
      case 'archive':
        return <Archive size={16} />;
      default:
        return <File size={16} />;
    }
  };

  const getFileColor = (type: string) => {
    switch (type) {
      case 'image':
        return { color: '$green10', bg: '$green3' };
      case 'video':
        return { color: '$purple10', bg: '$purple3' };
      case 'audio':
        return { color: '$blue10', bg: '$blue3' };
      case 'document':
        return { color: '$orange10', bg: '$orange3' };
      case 'archive':
        return { color: '$gray10', bg: '$gray3' };
      default:
        return { color: '$gray10', bg: '$gray3' };
    }
  };

  const AttachmentThumbnail = ({ attachment, index }: { attachment: MessageAttachment; index: number }) => (
    <Card elevate bordered>
      <CardContent padding="$3">
        <XStack alignItems="flex-start" gap="$3">
          <Square padding="$2" borderRadius="$4" backgroundColor={getFileColor(attachment.type).bg}>
            <Theme name="accent">
              <XStack color={getFileColor(attachment.type).color}>
                {getFileIcon(attachment.type)}
              </XStack>
            </Theme>
          </Square>
          
          <YStack flex={1} minWidth={0}>
            <Text fontWeight="$6" fontSize="$3" numberOfLines={1} ellipsizeMode="tail">
              {attachment.name}
            </Text>
            <XStack alignItems="center" gap="$2" marginTop="$1">
              <Badge size="$1" backgroundColor="$gray3">
                <Text fontSize="$1" color="$gray11">{attachment.type}</Text>
              </Badge>
              {attachment.size && (
                <Text fontSize="$1" color="$gray11">{formatFileSize(attachment.size)}</Text>
              )}
            </XStack>
          </YStack>
          
          <XStack alignItems="center" gap="$1" opacity={0} hoverStyle={{ opacity: 1 }}>
            {allowDownload && (
              <Button
                chromeless
                size="$2"
                circular
                onPress={() => handleDownload(attachment.id)}
              >
                <Download size={12} />
              </Button>
            )}
            
            {allowFullscreen && (attachment.type === 'image' || attachment.type === 'video') && (
              <Button
                chromeless
                size="$2"
                circular
                onPress={() => handleView(attachment.id)}
              >
                <Eye size={12} />
              </Button>
            )}
            
            {allowRemove && (
              <Button
                chromeless
                size="$2"
                circular
                onPress={() => handleRemove(attachment.id)}
                theme="red"
              >
                <Trash2 size={12} />
              </Button>
            )}
          </XStack>
        </XStack>
      </CardContent>
    </Card>
  );

  const ImagePreview = ({ attachment }: { attachment: MessageAttachment }) => (
    <YStack position="relative" width="100%" height="100%" alignItems="center" justifyContent="center" backgroundColor="$background">
      <YStack
        as="img"
        src={attachment.url}
        alt={attachment.name}
        maxWidth="100%"
        maxHeight="100%"
        style={{
          objectFit: 'contain',
          transform: `scale(${zoom}) rotate(${rotation}deg)`,
          transition: 'transform 0.2s ease-in-out',
        }}
      />
      
      {/* Zoom and rotation controls */}
      <XStack position="absolute" top="$4" right="$4" gap="$2">
        <Button
          size="$2"
          theme="gray"
          onPress={handleZoomOut}
          disabled={zoom <= 0.25}
        >
          <ZoomOut size={16} />
        </Button>
        <Button
          size="$2"
          theme="gray"
          onPress={handleZoomIn}
          disabled={zoom >= 3}
        >
          <ZoomIn size={16} />
        </Button>
        <Button
          size="$2"
          theme="gray"
          onPress={handleRotate}
        >
          <RotateCw size={16} />
        </Button>
        <Button
          size="$2"
          theme="gray"
          onPress={handleReset}
        >
          <Text fontSize="$2">{t('Reset')}</Text>
        </Button>
      </XStack>
    </YStack>
  );

  const VideoPreview = ({ attachment }: { attachment: MessageAttachment }) => (
    <YStack position="relative" width="100%" height="100%" alignItems="center" justifyContent="center" backgroundColor="$background">
      <YStack
        as="video"
        src={attachment.url}
        controls
        maxWidth="100%"
        maxHeight="100%"
        style={{
          transform: `scale(${zoom})`,
          transition: 'transform 0.2s ease-in-out',
        }}
      />
      
      {/* Zoom controls */}
      <XStack position="absolute" top="$4" right="$4" gap="$2">
        <Button
          size="$2"
          theme="gray"
          onPress={handleZoomOut}
          disabled={zoom <= 0.25}
        >
          <ZoomOut size={16} />
        </Button>
        <Button
          size="$2"
          theme="gray"
          onPress={handleZoomIn}
          disabled={zoom >= 3}
        >
          <ZoomIn size={16} />
        </Button>
        <Button
          size="$2"
          theme="gray"
          onPress={handleReset}
        >
          <Text fontSize="$2">{t('Reset')}</Text>
        </Button>
      </XStack>
    </YStack>
  );

  const AudioPreview = ({ attachment }: { attachment: MessageAttachment }) => (
    <YStack width="100%" height="100%" alignItems="center" justifyContent="center" backgroundColor="$gray3">
      <YStack alignItems="center" gap="$4">
        <Square padding="$4" borderRadius="$full" backgroundColor={getFileColor(attachment.type).bg} alignSelf="center">
          <Theme name="accent">
            <XStack color={getFileColor(attachment.type).color}>
              {getFileIcon(attachment.type)}
            </XStack>
          </Theme>
        </Square>
        <Text fontWeight="$6">{attachment.name}</Text>
        <YStack as="audio" src={attachment.url} controls width="100%" maxWidth={400} />
      </YStack>
    </YStack>
  );

  const DocumentPreview = ({ attachment }: { attachment: MessageAttachment }) => (
    <YStack width="100%" height="100%" alignItems="center" justifyContent="center" backgroundColor="$gray3">
      <YStack alignItems="center" gap="$4">
        <Square padding="$4" borderRadius="$full" backgroundColor={getFileColor(attachment.type).bg} alignSelf="center">
          <Theme name="accent">
            <XStack color={getFileColor(attachment.type).color}>
              {getFileIcon(attachment.type)}
            </XStack>
          </Theme>
        </Square>
        <Text fontWeight="$6">{attachment.name}</Text>
        <Text fontSize="$2" color="$gray11">
          {attachment.size && formatFileSize(attachment.size)}
        </Text>
        <Button onPress={() => handleDownload(attachment.id)} icon={<Download size={16} />}>
          {t('Download')}
        </Button>
      </YStack>
    </YStack>
  );

  const FullscreenPreview = () => {
    if (selectedIndex === null) return null;
    
    const attachment = attachments[selectedIndex];
    
    return (
      <Dialog open={isFullscreen} onOpenChange={setIsFullscreen}>
        <DialogContent maxWidth={800} width="100%" height="90vh" padding={0}>
          <DialogHeader padding="$4" borderBottomWidth={1} borderBottomColor="$borderColor">
            <DialogTitle>
              <XStack justifyContent="space-between" alignItems="center" width="100%">
                <Text>{attachment.name}</Text>
                <XStack alignItems="center" gap="$2">
                  <Button
                    chromeless
                    size="$2"
                    onPress={handlePrevious}
                    disabled={selectedIndex === 0}
                  >
                    <ChevronLeft size={16} />
                  </Button>
                  <Text fontSize="$2" color="$gray11">
                    {selectedIndex + 1} {t('of')} {attachments.length}
                  </Text>
                  <Button
                    chromeless
                    size="$2"
                    onPress={handleNext}
                    disabled={selectedIndex === attachments.length - 1}
                  >
                    <ChevronRight size={16} />
                  </Button>
                  <Button
                    chromeless
                    size="$2"
                    onPress={() => setIsFullscreen(false)}
                  >
                    <X size={16} />
                  </Button>
                </XStack>
              </XStack>
            </DialogTitle>
          </DialogHeader>
          
          <YStack flex={1} overflow="hidden">
            {attachment.type === 'image' && <ImagePreview attachment={attachment} />}
            {attachment.type === 'video' && <VideoPreview attachment={attachment} />}
            {attachment.type === 'audio' && <AudioPreview attachment={attachment} />}
            {attachment.type === 'document' && <DocumentPreview attachment={attachment} />}
          </YStack>
        </DialogContent>
      </Dialog>
    );
  };

  if (attachments.length === 0) {
    return null;
  }

  return (
    <YStack space="$4">
      {/* Thumbnails */}
      {showThumbnails && (
        <ScrollView maxHeight={maxHeight}>
          <YStack space="$4">
            {/* Images */}
            {groupedAttachments.images.length > 0 && (
              <YStack space="$2">
                <Text fontSize="$2" fontWeight="$5" color="$gray11">{t('Images')}</Text>
                <YStack space="$3">
                  {groupedAttachments.images.map((attachment, index) => (
                    <AttachmentThumbnail
                      key={attachment.id}
                      attachment={attachment}
                      index={index}
                    />
                  ))}
                </YStack>
              </YStack>
            )}

            {/* Videos */}
            {groupedAttachments.videos.length > 0 && (
              <YStack space="$2">
                <Text fontSize="$2" fontWeight="$5" color="$gray11">{t('Videos')}</Text>
                <YStack space="$3">
                  {groupedAttachments.videos.map((attachment, index) => (
                    <AttachmentThumbnail
                      key={attachment.id}
                      attachment={attachment}
                      index={index}
                    />
                  ))}
                </YStack>
              </YStack>
            )}

            {/* Audio */}
            {groupedAttachments.audio.length > 0 && (
              <YStack space="$2">
                <Text fontSize="$2" fontWeight="$5" color="$gray11">{t('Audio')}</Text>
                <YStack space="$3">
                  {groupedAttachments.audio.map((attachment, index) => (
                    <AttachmentThumbnail
                      key={attachment.id}
                      attachment={attachment}
                      index={index}
                    />
                  ))}
                </YStack>
              </YStack>
            )}

            {/* Documents */}
            {groupedAttachments.documents.length > 0 && (
              <YStack space="$2">
                <Text fontSize="$2" fontWeight="$5" color="$gray11">{t('Documents')}</Text>
                <YStack space="$3">
                  {groupedAttachments.documents.map((attachment, index) => (
                    <AttachmentThumbnail
                      key={attachment.id}
                      attachment={attachment}
                      index={index}
                    />
                  ))}
                </YStack>
              </YStack>
            )}

            {/* Other files */}
            {groupedAttachments.other.length > 0 && (
              <YStack space="$2">
                <Text fontSize="$2" fontWeight="$5" color="$gray11">{t('Other Files')}</Text>
                <YStack space="$3">
                  {groupedAttachments.other.map((attachment, index) => (
                    <AttachmentThumbnail
                      key={attachment.id}
                      attachment={attachment}
                      index={index}
                    />
                  ))}
                </YStack>
              </YStack>
            )}
          </YStack>
        </ScrollView>
      )}

      {/* Fullscreen Preview */}
      <FullscreenPreview />
    </YStack>
  );
}

export default MediaPreview;
