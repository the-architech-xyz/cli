'use client';

import React, { useState, useRef } from 'react';
import { Send, Mic, MicOff, Paperclip, X } from 'lucide-react-native';
import { useTranslation } from '@/lib/i18n';

import {
  YStack,
  XStack,
  Button,
  TextArea,
  Text,
  Theme,
  Square,
  Spinner
} from 'tamagui';

interface MessageInputProps {
  onSendMessage: (message: string, attachments?: File[]) => void;
  isLoading?: boolean;
  placeholder?: string;
  disabled?: boolean;
  voiceEnabled?: boolean;
  attachmentsEnabled?: boolean;
  maxAttachments?: number;
}

export function MessageInput({
  onSendMessage,
  isLoading = false,
  placeholder,
  disabled = false,
  voiceEnabled = true,
  attachmentsEnabled = true,
  maxAttachments = 5
}: MessageInputProps) {
  const { t } = useTranslation();
  const [message, setMessage] = useState('');
  const [attachments, setAttachments] = useState<File[]>([]);
  const [isRecording, setIsRecording] = useState(false);
  const fileInputRef = useRef<HTMLInputElement>(null);

  const handleSendMessage = () => {
    if (message.trim() || attachments.length > 0) {
      onSendMessage(message, attachments);
      setMessage('');
      setAttachments([]);
    }
  };

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSendMessage();
    }
  };

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (files) {
      const newFiles = Array.from(files);
      if (attachments.length + newFiles.length <= maxAttachments) {
        setAttachments(prev => [...prev, ...newFiles]);
      } else {
        // Show error or toast about max attachments
      }
    }
  };

  const removeAttachment = (index: number) => {
    setAttachments(prev => prev.filter((_, i) => i !== index));
  };

  const toggleVoiceRecording = () => {
    setIsRecording(!isRecording);
    // Implement voice recording logic
  };

  return (
    <Theme name="base">
      <YStack width="100%" padding="$2" space="$2">
        {/* Attachments Preview */}
        {attachments.length > 0 && (
          <XStack flexWrap="wrap" gap="$2">
            {attachments.map((file, index) => (
              <XStack
                key={index}
                backgroundColor="$backgroundHover"
                borderRadius="$2"
                padding="$1"
                paddingLeft="$2"
                alignItems="center"
                gap="$1"
              >
                <Text fontSize="$2" numberOfLines={1} maxWidth={100}>
                  {file.name}
                </Text>
                <Button
                  size="$1"
                  circular
                  chromeless
                  onPress={() => removeAttachment(index)}
                >
                  <X size={12} />
                </Button>
              </XStack>
            ))}
          </XStack>
        )}
        
        {/* Input Area */}
        <XStack alignItems="flex-end" gap="$2">
          <TextArea
            flex={1}
            placeholder={placeholder || t('chat.typeMessage')}
            value={message}
            onChangeText={setMessage}
            onKeyDown={handleKeyDown}
            minHeight={40}
            maxHeight={200}
            autoGrow
            borderWidth={1}
            borderColor="$borderColor"
            borderRadius="$4"
            padding="$2"
            disabled={disabled || isLoading}
          />
          
          {/* Attachment Button */}
          {attachmentsEnabled && (
            <>
              <input
                type="file"
                ref={fileInputRef}
                style={{ display: 'none' }}
                onChange={handleFileChange}
                multiple
                disabled={disabled || isLoading || attachments.length >= maxAttachments}
              />
              <Button
                size="$3"
                circular
                onPress={() => fileInputRef.current?.click()}
                disabled={disabled || isLoading || attachments.length >= maxAttachments}
                backgroundColor="$backgroundHover"
                hoverStyle={{ backgroundColor: "$background" }}
              >
                <Paperclip size={18} />
              </Button>
            </>
          )}
          
          {/* Voice Button */}
          {voiceEnabled && (
            <Button
              size="$3"
              circular
              onPress={toggleVoiceRecording}
              disabled={disabled || isLoading}
              backgroundColor={isRecording ? "$red10" : "$backgroundHover"}
              hoverStyle={{ backgroundColor: isRecording ? "$red9" : "$background" }}
            >
              {isRecording ? (
                <MicOff size={18} color="white" />
              ) : (
                <Mic size={18} />
              )}
            </Button>
          )}
          
          {/* Send Button */}
          <Button
            size="$3"
            circular
            onPress={handleSendMessage}
            disabled={disabled || isLoading || (!message.trim() && attachments.length === 0)}
            backgroundColor="$blue10"
            hoverStyle={{ backgroundColor: "$blue9" }}
          >
            {isLoading ? (
              <Spinner size="small" color="white" />
            ) : (
              <Send size={18} color="white" />
            )}
          </Button>
        </XStack>
      </YStack>
    </Theme>
  );
}
