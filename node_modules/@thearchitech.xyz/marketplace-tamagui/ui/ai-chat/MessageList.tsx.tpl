'use client';

import React, { useRef, useEffect } from 'react';
import { useTranslation } from '@/lib/i18n';

import {
  YStack,
  ScrollView,
  Text,
  Spinner,
  Theme
} from 'tamagui';

import { MessageBubble, type MessageBubbleProps } from './MessageBubble';

interface Message extends Omit<MessageBubbleProps, 'onCopy' | 'onLike' | 'onDislike' | 'onDelete' | 'onRegenerate'> {
  id: string;
}

interface MessageListProps {
  messages: Message[];
  isLoading?: boolean;
  emptyStateMessage?: string;
  onCopyMessage?: (content: string) => void;
  onLikeMessage?: (messageId: string) => void;
  onDislikeMessage?: (messageId: string) => void;
  onDeleteMessage?: (messageId: string) => void;
  onRegenerateMessage?: (messageId: string) => void;
  likedMessages?: string[];
  dislikedMessages?: string[];
}

export function MessageList({
  messages,
  isLoading = false,
  emptyStateMessage,
  onCopyMessage,
  onLikeMessage,
  onDislikeMessage,
  onDeleteMessage,
  onRegenerateMessage,
  likedMessages = [],
  dislikedMessages = []
}: MessageListProps) {
  const { t } = useTranslation();
  const scrollRef = useRef<ScrollView>(null);
  
  // Auto-scroll to bottom when new messages arrive
  useEffect(() => {
    if (scrollRef.current && messages.length > 0) {
      setTimeout(() => {
        scrollRef.current?.scrollToEnd({ animated: true });
      }, 100);
    }
  }, [messages.length]);

  return (
    <Theme name="base">
      <YStack flex={1} width="100%">
        <ScrollView
          ref={scrollRef}
          flex={1}
          contentContainerStyle={{ padding: 16, gap: 16 }}
          showsVerticalScrollIndicator={true}
        >
          {messages.length === 0 && !isLoading ? (
            <YStack 
              flex={1} 
              justifyContent="center" 
              alignItems="center" 
              height={300}
            >
              <Text color="$colorFocus">
                {emptyStateMessage || t('chat.startConversation')}
              </Text>
            </YStack>
          ) : (
            <YStack space="$4">
              {messages.map((message) => (
                <MessageBubble
                  key={message.id}
                  {...message}
                  onCopy={onCopyMessage}
                  onLike={onLikeMessage}
                  onDislike={onDislikeMessage}
                  onDelete={onDeleteMessage}
                  onRegenerate={onRegenerateMessage}
                  isLiked={likedMessages.includes(message.id)}
                  isDisliked={dislikedMessages.includes(message.id)}
                />
              ))}
              
              {isLoading && (
                <YStack alignItems="center" paddingVertical="$4">
                  <Spinner size="large" />
                </YStack>
              )}
            </YStack>
          )}
        </ScrollView>
      </YStack>
    </Theme>
  );
}
