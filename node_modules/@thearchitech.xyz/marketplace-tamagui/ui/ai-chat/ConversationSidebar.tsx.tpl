'use client';

import React, { useState, useMemo } from 'react';
import { 
  YStack, 
  XStack, 
  Button, 
  Input, 
  Card, 
  CardHeader,
  CardFooter,
  CardContent,
  Badge, 
  Separator, 
  ScrollView,
  Text,
  Theme,
  Square
} from 'tamagui';
import { 
  Plus, 
  Search, 
  MoreVertical, 
  MessageSquare, 
  Archive, 
  Trash2, 
  Edit3,
  Pin,
  PinOff,
  Calendar,
  Clock,
  Bot,
  User
} from 'lucide-react-native';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { Conversation, CreateConversationData, UpdateConversationData } from '@/types/ai-chat';
import { useTranslation } from '@/lib/i18n';

export interface ConversationSidebarProps {
  conversations: Conversation[];
  activeConversationId?: string;
  onConversationSelect: (conversationId: string) => void;
  onConversationCreate: (data: CreateConversationData) => void;
  onConversationUpdate: (id: string, data: UpdateConversationData) => void;
  onConversationDelete: (id: string) => void;
  onConversationArchive: (id: string) => void;
  onConversationPin: (id: string) => void;
  onConversationUnpin: (id: string) => void;
  className?: string;
  showSearch?: boolean;
  showCreateButton?: boolean;
  maxHeight?: string;
  isLoading?: boolean;
  error?: string | null;
}

export interface ConversationFilters {
  search?: string;
  status?: 'active' | 'archived';
  pinned?: boolean;
  dateRange?: {
    start: Date;
    end: Date;
  };
}

export function ConversationSidebar({
  conversations,
  activeConversationId,
  onConversationSelect,
  onConversationCreate,
  onConversationUpdate,
  onConversationDelete,
  onConversationArchive,
  onConversationPin,
  onConversationUnpin,
  className,
  showSearch = true,
  showCreateButton = true,
  maxHeight = '600px',
  isLoading = false,
  error = null,
}: ConversationSidebarProps) {
  const { t } = useTranslation();
  const [searchQuery, setSearchQuery] = useState('');
  const [filters, setFilters] = useState<ConversationFilters>({});
  const [editingId, setEditingId] = useState<string | null>(null);
  const [editTitle, setEditTitle] = useState('');

  // Filter conversations based on search and filters
  const filteredConversations = useMemo(() => {
    let filtered = conversations;

    // Apply search filter
    if (searchQuery) {
      filtered = filtered.filter(conversation =>
        conversation.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
        conversation.description?.toLowerCase().includes(searchQuery.toLowerCase())
      );
    }

    // Apply status filter
    if (filters.status) {
      filtered = filtered.filter(conversation => conversation.status === filters.status);
    }

    // Apply pinned filter
    if (filters.pinned !== undefined) {
      filtered = filtered.filter(conversation => 
        filters.pinned ? conversation.pinned : !conversation.pinned
      );
    }

    // Apply date range filter
    if (filters.dateRange) {
      filtered = filtered.filter(conversation => {
        const conversationDate = new Date(conversation.updatedAt);
        return conversationDate >= filters.dateRange!.start && conversationDate <= filters.dateRange!.end;
      });
    }

    return filtered;
  }, [conversations, searchQuery, filters]);

  // Group conversations by status and pinned state
  const groupedConversations = useMemo(() => {
    const groups = {
      pinned: [] as Conversation[],
      active: [] as Conversation[],
      archived: [] as Conversation[],
    };

    filteredConversations.forEach(conversation => {
      if (conversation.pinned) {
        groups.pinned.push(conversation);
      } else if (conversation.status === 'active') {
        groups.active.push(conversation);
      } else if (conversation.status === 'archived') {
        groups.archived.push(conversation);
      }
    });

    // Sort each group by updatedAt (most recent first)
    Object.keys(groups).forEach(key => {
      groups[key as keyof typeof groups].sort((a, b) => 
        new Date(b.updatedAt).getTime() - new Date(a.updatedAt).getTime()
      );
    });

    return groups;
  }, [filteredConversations]);

  const handleCreateConversation = () => {
    const title = t('ai.chat.newConversation', { count: conversations.length + 1 });
    onConversationCreate({ title });
  };

  const handleEditStart = (conversation: Conversation) => {
    setEditingId(conversation.id);
    setEditTitle(conversation.title);
  };

  const handleEditSave = () => {
    if (editingId && editTitle.trim()) {
      onConversationUpdate(editingId, { title: editTitle.trim() });
      setEditingId(null);
      setEditTitle('');
    }
  };

  const handleEditCancel = () => {
    setEditingId(null);
    setEditTitle('');
  };

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter') {
      handleEditSave();
    } else if (e.key === 'Escape') {
      handleEditCancel();
    }
  };

  const formatDate = (date: string): string => {
    const messageDate = new Date(date);
    const now = new Date();
    const diffInHours = (now.getTime() - messageDate.getTime()) / (1000 * 60 * 60);

    if (diffInHours < 1) {
      return t('common.time.justNow');
    } else if (diffInHours < 24) {
      return t('common.time.hoursAgo', { hours: Math.floor(diffInHours) });
    } else if (diffInHours < 48) {
      return t('common.time.yesterday');
    } else {
      return messageDate.toLocaleDateString(undefined, {
        month: 'short',
        day: 'numeric',
      });
    }
  };

  const getConversationIcon = (conversation: Conversation) => {
    if (conversation.pinned) {
      return <Pin color="$yellow10" size={16} />;
    }
    return <MessageSquare size={16} />;
  };

  const ConversationItem = ({ conversation }: { conversation: Conversation }) => {
    const isActive = conversation.id === activeConversationId;
    const isEditing = editingId === conversation.id;

    return (
      <Card
        elevate
        bordered
        pressStyle={{ scale: 0.98 }}
        animation="bouncy"
        scale={0.95}
        hoverStyle={{ scale: 0.975 }}
        onPress={() => !isEditing && onConversationSelect(conversation.id)}
        theme={isActive ? "active" : undefined}
        borderColor={conversation.pinned ? "$yellow8" : undefined}
        backgroundColor={conversation.pinned ? "$yellow2" : undefined}
      >
        <CardContent padding="$3">
          <XStack alignItems="flex-start" gap="$3">
            <YStack marginTop="$0.5" flexShrink={0}>
              {getConversationIcon(conversation)}
            </YStack>
            
            <YStack flex={1} minWidth={0}>
              {isEditing ? (
                <Input
                  value={editTitle}
                  onChangeText={setEditTitle}
                  onKeyPress={(e) => {
                    if (e.nativeEvent.key === 'Enter') handleEditSave();
                    if (e.nativeEvent.key === 'Escape') handleEditCancel();
                  }}
                  onBlur={handleEditSave}
                  height="$2"
                  fontSize="$2"
                  autoFocus
                />
              ) : (
                <YStack space="$1">
                  <XStack alignItems="center" gap="$2">
                    <Text fontWeight="$6" fontSize="$2" numberOfLines={1} ellipsizeMode="tail">
                      {conversation.title}
                    </Text>
                    {conversation.pinned && (
                      <Pin color="$yellow10" size={12} />
                    )}
                  </XStack>
                  
                  {conversation.description && (
                    <Text fontSize="$1" color="$gray11" numberOfLines={1} ellipsizeMode="tail">
                      {conversation.description}
                    </Text>
                  )}
                  
                  <XStack alignItems="center" gap="$2" flexWrap="wrap">
                    <XStack alignItems="center" gap="$1">
                      <MessageSquare size={12} color="$gray10" />
                      <Text fontSize="$1" color="$gray10">
                        {conversation.messageCount}
                      </Text>
                    </XStack>
                    <XStack alignItems="center" gap="$1">
                      <Clock size={12} color="$gray10" />
                      <Text fontSize="$1" color="$gray10">
                        {formatDate(conversation.updatedAt)}
                      </Text>
                    </XStack>
                  </XStack>
                </YStack>
              )}
            </YStack>
            
            {!isEditing && (
              <DropdownMenu>
                <DropdownMenuTrigger asChild>
                  <Button 
                    chromeless
                    size="$2"
                    circular
                    onPress={(e) => e.stopPropagation()}
                    opacity={0}
                    hoverStyle={{ opacity: 1 }}
                  >
                    <MoreVertical size={12} />
                  </Button>
                </DropdownMenuTrigger>
                <DropdownMenuContent align="end">
                  <DropdownMenuItem onSelect={() => handleEditStart(conversation)}>
                    <XStack alignItems="center" gap="$2">
                      <Edit3 size={12} />
                      <Text>{t('ai.chat.rename')}</Text>
                    </XStack>
                  </DropdownMenuItem>
                  
                  <DropdownMenuItem
                    onSelect={() => 
                      conversation.pinned 
                        ? onConversationUnpin(conversation.id)
                        : onConversationPin(conversation.id)
                    }
                  >
                    <XStack alignItems="center" gap="$2">
                      {conversation.pinned ? (
                        <>
                          <PinOff size={12} />
                          <Text>{t('ai.chat.unpin')}</Text>
                        </>
                      ) : (
                        <>
                          <Pin size={12} />
                          <Text>{t('ai.chat.pin')}</Text>
                        </>
                      )}
                    </XStack>
                  </DropdownMenuItem>
                  
                  <Separator />
                  
                  <DropdownMenuItem
                    onSelect={() => onConversationArchive(conversation.id)}
                    disabled={conversation.status === 'archived'}
                  >
                    <XStack alignItems="center" gap="$2">
                      <Archive size={12} />
                      <Text>{t('ai.chat.archive')}</Text>
                    </XStack>
                  </DropdownMenuItem>
                  
                  <DropdownMenuItem
                    onSelect={() => onConversationDelete(conversation.id)}
                    color="$red10"
                  >
                    <XStack alignItems="center" gap="$2">
                      <Trash2 size={12} color="$red10" />
                      <Text>{t('common.actions.delete')}</Text>
                    </XStack>
                  </DropdownMenuItem>
                </DropdownMenuContent>
              </DropdownMenu>
            )}
          </XStack>
        </CardContent>
      </Card>
    );
  };

  if (error) {
    return (
      <YStack padding="$4" {...(className ? { className } : {})}>
        <Card width="100%">
          <CardContent padding="$6" alignItems="center">
            <Text color="$red10" marginBottom="$2">
              {t('ai.chat.errorLoadingConversations')}
            </Text>
            <Text fontSize="$2" color="$gray10">
              {error}
            </Text>
          </CardContent>
        </Card>
      </YStack>
    );
  }

  return (
    <YStack flex={1} backgroundColor="$background" {...(className ? { className } : {})}>
      {/* Header */}
      <YStack padding="$4" borderBottomWidth={1} borderBottomColor="$borderColor">
        <XStack alignItems="center" justifyContent="space-between" marginBottom="$4">
          <Text fontSize="$5" fontWeight="$6">
            {t('ai.chat.conversations')}
          </Text>
          {showCreateButton && (
            <Button size="$2" onPress={handleCreateConversation} theme="accent">
              <Plus size={16} />
              <Text marginLeft="$2">{t('ai.chat.newChat')}</Text>
            </Button>
          )}
        </XStack>
        
        {showSearch && (
          <YStack position="relative">
            <XStack position="absolute" left="$3" top="50%" transform={[{ translateY: -8 }]} zIndex={1}>
              <Search size={16} color="$gray10" />
            </XStack>
            <Input
              placeholder={t('ai.chat.searchConversations')}
              value={searchQuery}
              onChangeText={setSearchQuery}
              paddingLeft="$10"
            />
          </YStack>
        )}
      </YStack>

      {/* Conversations List */}
      <ScrollView flex={1} contentContainerStyle={{ padding: 16 }} style={{ maxHeight }}>
        <YStack space="$6">
          {isLoading ? (
            <YStack space="$3">
              {[...Array(5)].map((_, i) => (
                <Card key={i} opacity={0.7}>
                  <CardContent padding="$3">
                    <XStack alignItems="flex-start" gap="$3">
                      <Square size="$1" backgroundColor="$gray5" borderRadius="$1" />
                      <YStack flex={1} space="$2">
                        <Square height="$1" backgroundColor="$gray5" borderRadius="$1" width="75%" />
                        <Square height={12} backgroundColor="$gray5" borderRadius="$1" width="50%" />
                      </YStack>
                    </XStack>
                  </CardContent>
                </Card>
              ))}
            </YStack>
          ) : (
            <>
              {/* Pinned Conversations */}
              {groupedConversations.pinned.length > 0 && (
                <YStack space="$3">
                  <XStack alignItems="center" gap="$2">
                    <Pin size={16} color="$gray10" />
                    <Text fontSize="$2" fontWeight="$5" color="$gray10">
                      {t('ai.chat.pinned')}
                    </Text>
                  </XStack>
                  {groupedConversations.pinned.map((conversation) => (
                    <ConversationItem key={conversation.id} conversation={conversation} />
                  ))}
                </YStack>
              )}

              {/* Active Conversations */}
              {groupedConversations.active.length > 0 && (
                <YStack space="$3">
                  {groupedConversations.pinned.length > 0 && <Separator />}
                  <XStack alignItems="center" gap="$2">
                    <MessageSquare size={16} color="$gray10" />
                    <Text fontSize="$2" fontWeight="$5" color="$gray10">
                      {t('ai.chat.recent')}
                    </Text>
                  </XStack>
                  {groupedConversations.active.map((conversation) => (
                    <ConversationItem key={conversation.id} conversation={conversation} />
                  ))}
                </YStack>
              )}

              {/* Archived Conversations */}
              {groupedConversations.archived.length > 0 && (
                <YStack space="$3">
                  <Separator />
                  <XStack alignItems="center" gap="$2">
                    <Archive size={16} color="$gray10" />
                    <Text fontSize="$2" fontWeight="$5" color="$gray10">
                      {t('ai.chat.archived')}
                    </Text>
                  </XStack>
                  {groupedConversations.archived.map((conversation) => (
                    <ConversationItem key={conversation.id} conversation={conversation} />
                  ))}
                </YStack>
              )}

              {/* Empty State */}
              {filteredConversations.length === 0 && (
                <YStack alignItems="center" justifyContent="center" height={256} textAlign="center">
                  <MessageSquare size={48} color="$gray10" marginBottom="$4" />
                  <Text fontSize="$5" fontWeight="$6" marginBottom="$2">
                    {searchQuery ? t('ai.chat.noConversationsFound') : t('ai.chat.noConversationsYet')}
                  </Text>
                  <Text color="$gray10" marginBottom="$4">
                    {searchQuery 
                      ? t('ai.chat.adjustSearchTerms')
                      : t('ai.chat.startNewConversation')
                    }
                  </Text>
                  {!searchQuery && showCreateButton && (
                    <Button onPress={handleCreateConversation} theme="accent">
                      <Plus size={16} />
                      <Text marginLeft="$2">{t('ai.chat.createFirstConversation')}</Text>
                    </Button>
                  )}
                </YStack>
              )}
            </>
          )}
        </YStack>
      </ScrollView>
    </YStack>
  );
}

export default ConversationSidebar;

