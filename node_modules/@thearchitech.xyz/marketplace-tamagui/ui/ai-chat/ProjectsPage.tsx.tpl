// AI Projects Page Component

"use client";

import React, { useState } from 'react';
import { useTranslation } from '@/lib/i18n';
import { 
  Plus, 
  Search, 
  Filter, 
  MoreVertical, 
  Edit, 
  Trash2, 
  Copy,
  ExternalLink,
  Calendar,
  User,
  MessageSquare,
  Zap
} from 'lucide-react-native';

import {
  YStack,
  XStack,
  Button,
  Card,
  CardContent,
  CardHeader,
  CardTitle,
  CardDescription,
  Input,
  Badge,
  Text,
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
  Theme,
  Square
} from 'tamagui';

interface AIProject {
  id: string;
  name: string;
  description: string;
  type: 'chat' | 'completion' | 'embedding' | 'image' | 'custom';
  status: 'active' | 'archived' | 'draft';
  createdAt: Date;
  updatedAt: Date;
  messageCount: number;
  totalTokens: number;
  totalCost: number;
  lastActivity: Date;
  tags: string[];
  isPublic: boolean;
  collaborators: Array<{
    id: string;
    name: string;
    email: string;
    role: 'owner' | 'editor' | 'viewer';
  }>;
}

interface ProjectsPageProps {
  projects: AIProject[];
  onCreateProject: (project: Omit<AIProject, 'id' | 'createdAt' | 'updatedAt' | 'lastActivity'>) => void;
  onUpdateProject: (id: string, updates: Partial<AIProject>) => void;
  onDeleteProject: (id: string) => void;
  onDuplicateProject: (id: string) => void;
  onOpenProject: (id: string) => void;
  isLoading?: boolean;
}

export function ProjectsPage({
  projects,
  onCreateProject,
  onUpdateProject,
  onDeleteProject,
  onDuplicateProject,
  onOpenProject,
  isLoading = false,
}: ProjectsPageProps) {
  const { t } = useTranslation();
  const [searchQuery, setSearchQuery] = useState('');
  const [filterType, setFilterType] = useState<string>('all');
  const [filterStatus, setFilterStatus] = useState<string>('all');
  const [sortBy, setSortBy] = useState<'name' | 'createdAt' | 'updatedAt' | 'lastActivity'>('updatedAt');
  const [sortOrder, setSortOrder] = useState<'asc' | 'desc'>('desc');

  const filteredProjects = projects
    .filter(project => {
      const matchesSearch = project.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                           project.description.toLowerCase().includes(searchQuery.toLowerCase()) ||
                           project.tags.some(tag => tag.toLowerCase().includes(searchQuery.toLowerCase()));
      const matchesType = filterType === 'all' || project.type === filterType;
      const matchesStatus = filterStatus === 'all' || project.status === filterStatus;
      return matchesSearch && matchesType && matchesStatus;
    })
    .sort((a, b) => {
      const aValue = a[sortBy];
      const bValue = b[sortBy];
      const comparison = aValue < bValue ? -1 : aValue > bValue ? 1 : 0;
      return sortOrder === 'asc' ? comparison : -comparison;
    });

  const getTypeIcon = (type: string) => {
    switch (type) {
      case 'chat':
        return <MessageSquare size={16} />;
      case 'completion':
        return <Zap size={16} />;
      case 'embedding':
        return <Copy size={16} />;
      case 'image':
        return <ExternalLink size={16} />;
      default:
        return <Zap size={16} />;
    }
  };

  const getTypeTheme = (type: string): string => {
    switch (type) {
      case 'chat':
        return 'blue';
      case 'completion':
        return 'green';
      case 'embedding':
        return 'purple';
      case 'image':
        return 'orange';
      default:
        return 'gray';
    }
  };

  const getStatusTheme = (status: string): string => {
    switch (status) {
      case 'active':
        return 'green';
      case 'archived':
        return 'gray';
      case 'draft':
        return 'yellow';
      default:
        return 'gray';
    }
  };

  const formatDate = (date: Date) => {
    return new Date(date).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
    });
  };

  const formatCost = (cost: number) => {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
    }).format(cost);
  };

  const createEmptyProject = () => {
    onCreateProject({
      name: t('chat.newProject'),
      description: '',
      type: 'chat',
      status: 'draft',
      messageCount: 0,
      totalTokens: 0,
      totalCost: 0,
      tags: [],
      isPublic: false,
      collaborators: [],
    });
  };

  return (
    <YStack space="$6">
      {/* Header */}
      <XStack alignItems="center" justifyContent="space-between">
        <YStack>
          <Text fontSize="$7" fontWeight="$7">{t('chat.aiProjects')}</Text>
          <Text color="$colorFocus" fontSize="$3">
            {t('chat.manageAIProjects')}
          </Text>
        </YStack>
        <Button onPress={createEmptyProject}>
          <XStack alignItems="center" gap="$2">
            <Plus size={16} />
            <Text>{t('chat.newProject')}</Text>
          </XStack>
        </Button>
      </XStack>

      {/* Filters */}
      <XStack alignItems="center" gap="$4" flexWrap="wrap">
        <XStack position="relative" flex={1} maxWidth={400}>
          <XStack position="absolute" left="$3" top="50%" alignItems="center" transform={[{ translateY: -8 }]}>
            <Search size={16} color="$colorFocus" />
          </XStack>
          <Input
            placeholder={t('chat.searchProjects')}
            value={searchQuery}
            onChangeText={setSearchQuery}
            paddingLeft="$10"
            flex={1}
          />
        </XStack>
        
        <Select
          value={filterType}
          onValueChange={setFilterType}
        >
          <SelectTrigger>
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">
              <Text>{t('chat.allTypes')}</Text>
            </SelectItem>
            <SelectItem value="chat">
              <Text>{t('chat.chat')}</Text>
            </SelectItem>
            <SelectItem value="completion">
              <Text>{t('chat.completion')}</Text>
            </SelectItem>
            <SelectItem value="embedding">
              <Text>{t('chat.embedding')}</Text>
            </SelectItem>
            <SelectItem value="image">
              <Text>{t('chat.image')}</Text>
            </SelectItem>
            <SelectItem value="custom">
              <Text>{t('chat.custom')}</Text>
            </SelectItem>
          </SelectContent>
        </Select>

        <Select
          value={filterStatus}
          onValueChange={setFilterStatus}
        >
          <SelectTrigger>
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">
              <Text>{t('chat.allStatus')}</Text>
            </SelectItem>
            <SelectItem value="active">
              <Text>{t('chat.active')}</Text>
            </SelectItem>
            <SelectItem value="draft">
              <Text>{t('chat.draft')}</Text>
            </SelectItem>
            <SelectItem value="archived">
              <Text>{t('chat.archived')}</Text>
            </SelectItem>
          </SelectContent>
        </Select>

        <Select
          value={`${sortBy}-${sortOrder}`}
          onValueChange={(value) => {
            const [field, order] = value.split('-');
            setSortBy(field as any);
            setSortOrder(order as any);
          }}
        >
          <SelectTrigger>
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="updatedAt-desc">
              <Text>{t('chat.lastUpdated')}</Text>
            </SelectItem>
            <SelectItem value="createdAt-desc">
              <Text>{t('chat.newestFirst')}</Text>
            </SelectItem>
            <SelectItem value="createdAt-asc">
              <Text>{t('chat.oldestFirst')}</Text>
            </SelectItem>
            <SelectItem value="name-asc">
              <Text>{t('chat.nameAZ')}</Text>
            </SelectItem>
            <SelectItem value="name-desc">
              <Text>{t('chat.nameZA')}</Text>
            </SelectItem>
            <SelectItem value="lastActivity-desc">
              <Text>{t('chat.lastActivity')}</Text>
            </SelectItem>
          </SelectContent>
        </Select>
      </XStack>

      {/* Projects Grid */}
      {isLoading ? (
        <XStack flexWrap="wrap" gap="$6">
          {[...Array(6)].map((_, i) => (
            <Card key={i} bordered flex={1} minWidth={280} maxWidth="100%" opacity={0.5}>
              <CardHeader>
                <YStack space="$2">
                  <YStack height={16} width="75%" backgroundColor="$backgroundHover" borderRadius="$2" />
                  <YStack height={12} width="50%" backgroundColor="$backgroundHover" borderRadius="$2" />
                </YStack>
              </CardHeader>
              <CardContent>
                <YStack space="$2">
                  <YStack height={12} backgroundColor="$backgroundHover" borderRadius="$2" />
                  <YStack height={12} width="83%" backgroundColor="$backgroundHover" borderRadius="$2" />
                </YStack>
              </CardContent>
            </Card>
          ))}
        </XStack>
      ) : filteredProjects.length === 0 ? (
        <Card bordered>
          <CardContent padding="$12" alignItems="center">
            <YStack
              width={48}
              height={48}
              backgroundColor="$backgroundHover"
              borderRadius="$full"
              alignItems="center"
              justifyContent="center"
              marginBottom="$4"
            >
              <Zap size={24} color="$colorFocus" />
            </YStack>
            <Text fontSize="$5" fontWeight="$6" marginBottom="$2">
              {t('chat.noProjectsFound')}
            </Text>
            <Text color="$colorFocus" marginBottom="$4" textAlign="center">
              {searchQuery || filterType !== 'all' || filterStatus !== 'all'
                ? t('chat.adjustSearchOrFilters')
                : t('chat.getStartedByCreatingProject')
              }
            </Text>
            <Button onPress={createEmptyProject}>
              <XStack alignItems="center" gap="$2">
                <Plus size={16} />
                <Text>{t('chat.createProject')}</Text>
              </XStack>
            </Button>
          </CardContent>
        </Card>
      ) : (
        <XStack flexWrap="wrap" gap="$6">
          {filteredProjects.map((project) => (
            <Card 
              key={project.id} 
              bordered
              flex={1}
              minWidth={280}
              maxWidth="100%"
              elevate
              animation="bouncy"
              scale={1}
              hoverStyle={{ scale: 1.02 }}
              pressStyle={{ scale: 0.98 }}
            >
              <CardHeader paddingBottom="$3">
                <XStack alignItems="flex-start" justifyContent="space-between">
                  <XStack alignItems="center" gap="$2">
                    <Theme name={getTypeTheme(project.type)}>
                      <YStack 
                        padding="$2" 
                        borderRadius="$3" 
                        backgroundColor="$background"
                      >
                        {getTypeIcon(project.type)}
                      </YStack>
                    </Theme>
                    <YStack>
                      <CardTitle>{project.name}</CardTitle>
                      <XStack alignItems="center" gap="$2" marginTop="$1">
                        <Theme name={getTypeTheme(project.type)}>
                          <Badge size="$1">
                            <Text fontSize="$1">{project.type}</Text>
                          </Badge>
                        </Theme>
                        <Theme name={getStatusTheme(project.status)}>
                          <Badge size="$1">
                            <Text fontSize="$1">{project.status}</Text>
                          </Badge>
                        </Theme>
                      </XStack>
                    </YStack>
                  </XStack>
                  <DropdownMenu>
                    <DropdownMenuTrigger asChild>
                      <Button size="$2" chromeless>
                        <MoreVertical size={16} />
                      </Button>
                    </DropdownMenuTrigger>
                    <DropdownMenuContent align="end">
                      <DropdownMenuItem onPress={() => onOpenProject(project.id)}>
                        <XStack alignItems="center" gap="$2">
                          <ExternalLink size={16} />
                          <Text>{t('common.open')}</Text>
                        </XStack>
                      </DropdownMenuItem>
                      <DropdownMenuItem onPress={() => onUpdateProject(project.id, {})}>
                        <XStack alignItems="center" gap="$2">
                          <Edit size={16} />
                          <Text>{t('common.edit')}</Text>
                        </XStack>
                      </DropdownMenuItem>
                      <DropdownMenuItem onPress={() => onDuplicateProject(project.id)}>
                        <XStack alignItems="center" gap="$2">
                          <Copy size={16} />
                          <Text>{t('common.duplicate')}</Text>
                        </XStack>
                      </DropdownMenuItem>
                      <DropdownMenuItem onPress={() => onDeleteProject(project.id)}>
                        <XStack alignItems="center" gap="$2">
                          <Trash2 size={16} color="$red10" />
                          <Text color="$red10">{t('common.delete')}</Text>
                        </XStack>
                      </DropdownMenuItem>
                    </DropdownMenuContent>
                  </DropdownMenu>
                </XStack>
              </CardHeader>
              
              <CardContent space="$4">
                <CardDescription numberOfLines={2} ellipsizeMode="tail">
                  {project.description || t('chat.noDescriptionProvided')}
                </CardDescription>
                
                <YStack>
                  <XStack flexWrap="wrap" gap="$4">
                    <YStack flex={1} minWidth={100}>
                      <Text color="$colorFocus" fontSize="$2">{t('chat.messages')}</Text>
                      <Text fontWeight="$6">{project.messageCount.toLocaleString()}</Text>
                    </YStack>
                    <YStack flex={1} minWidth={100}>
                      <Text color="$colorFocus" fontSize="$2">{t('chat.tokens')}</Text>
                      <Text fontWeight="$6">{project.totalTokens.toLocaleString()}</Text>
                    </YStack>
                    <YStack flex={1} minWidth={100}>
                      <Text color="$colorFocus" fontSize="$2">{t('chat.cost')}</Text>
                      <Text fontWeight="$6">{formatCost(project.totalCost)}</Text>
                    </YStack>
                    <YStack flex={1} minWidth={100}>
                      <Text color="$colorFocus" fontSize="$2">{t('chat.lastActivity')}</Text>
                      <Text fontWeight="$6">{formatDate(project.lastActivity)}</Text>
                    </YStack>
                  </XStack>
                </YStack>
                
                {project.tags.length > 0 && (
                  <XStack flexWrap="wrap" gap="$1">
                    {project.tags.slice(0, 3).map((tag) => (
                      <Badge key={tag} variant="outline" size="$1">
                        <Text fontSize="$1">{tag}</Text>
                      </Badge>
                    ))}
                    {project.tags.length > 3 && (
                      <Badge variant="outline" size="$1">
                        <Text fontSize="$1">+{project.tags.length - 3}</Text>
                      </Badge>
                    )}
                  </XStack>
                )}
                
                <XStack alignItems="center" justifyContent="space-between" paddingTop="$2">
                  <XStack alignItems="center" gap="$1">
                    <Calendar size={12} color="$colorFocus" />
                    <Text fontSize="$1" color="$colorFocus">
                      {t('chat.created')} {formatDate(project.createdAt)}
                    </Text>
                  </XStack>
                  <Button 
                    size="$2" 
                    onPress={() => onOpenProject(project.id)}
                  >
                    {t('common.open')}
                  </Button>
                </XStack>
              </CardContent>
            </Card>
          ))}
        </XStack>
      )}
    </YStack>
  );
}
