'use client';

import React, { useState, useEffect } from 'react';
import { useTranslation } from '@/lib/i18n';
import {
  YStack,
  XStack,
  Button,
  Text,
  Card,
  CardContent,
  CardHeader,
  CardTitle,
  CardDescription,
  Badge,
  Spinner,
  Theme,
  Square
} from 'tamagui';
import {
  MessageSquare,
  Calendar,
  Clock,
  User,
  Bot,
  ArrowLeft,
  Share2,
  Download,
  Trash2,
  Star,
  Edit,
  Copy
} from 'lucide-react-native';
import { MessageBubble } from './MessageBubble';
import { MessageInput } from './MessageInput';
import { useAIChat } from '@/lib/ai-chat/hooks';

export interface ChatDetailPageProps {
  conversationId?: string;
  initialMessages?: any[];
  onBack?: () => void;
  onShare?: (conversationId: string) => void;
  onExport?: (conversationId: string) => void;
  onDelete?: (conversationId: string) => void;
  onFavorite?: (conversationId: string, isFavorite: boolean) => void;
  onRename?: (conversationId: string, newName: string) => void;
}

export function ChatDetailPage({
  conversationId,
  initialMessages = [],
  onBack,
  onShare,
  onExport,
  onDelete,
  onFavorite,
  onRename
}: ChatDetailPageProps) {
  const { t } = useTranslation();
  const [isLoading, setIsLoading] = useState(true);
  const [conversation, setConversation] = useState<any>(null);
  const [messages, setMessages] = useState<any[]>(initialMessages);
  const [isEditing, setIsEditing] = useState(false);
  const [newTitle, setNewTitle] = useState('');
  
  // In a real implementation, this would use the useAIChat hook
  // const { conversation, messages, isLoading, sendMessage } = useAIChat(conversationId);
  
  useEffect(() => {
    // Simulate loading conversation data
    const timer = setTimeout(() => {
      setConversation({
        id: conversationId || 'new-conversation',
        title: conversationId ? 'Sample Conversation' : 'New Conversation',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        messageCount: initialMessages.length,
        isFavorite: false
      });
      setIsLoading(false);
    }, 1000);
    
    return () => clearTimeout(timer);
  }, [conversationId, initialMessages.length]);
  
  useEffect(() => {
    if (conversation) {
      setNewTitle(conversation.title);
    }
  }, [conversation]);
  
  const handleSendMessage = (content: string) => {
    const userMessage = {
      id: `msg-${Date.now()}-user`,
      content,
      role: 'user',
      createdAt: new Date().toISOString()
    };
    
    setMessages(prev => [...prev, userMessage]);
    
    // Simulate AI response
    setTimeout(() => {
      const aiMessage = {
        id: `msg-${Date.now()}-assistant`,
        content: `This is a sample response to: "${content}"`,
        role: 'assistant',
        createdAt: new Date().toISOString()
      };
      
      setMessages(prev => [...prev, aiMessage]);
    }, 1500);
  };
  
  const handleRename = () => {
    if (newTitle && newTitle !== conversation.title) {
      setConversation(prev => ({ ...prev, title: newTitle }));
      onRename?.(conversation.id, newTitle);
    }
    setIsEditing(false);
  };
  
  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString();
  };
  
  const formatTime = (dateString: string) => {
    return new Date(dateString).toLocaleTimeString();
  };
  
  if (isLoading) {
    return (
      <YStack flex={1} alignItems="center" justifyContent="center" padding="$4">
        <Spinner size="large" />
        <Text marginTop="$4">{t('Loading conversation...')}</Text>
      </YStack>
    );
  }
  
  return (
    <YStack flex={1} backgroundColor="$background">
      {/* Header */}
      <Card elevate bordered marginBottom="$2">
        <CardHeader>
          <XStack alignItems="center" justifyContent="space-between" width="100%">
            <Button
              icon={<ArrowLeft size={16} />}
              chromeless
              onPress={onBack}
            />
            
            <YStack alignItems="center">
              {isEditing ? (
                <XStack alignItems="center" gap="$2">
                  <YStack
                    as="input"
                    value={newTitle}
                    onChange={(e: any) => setNewTitle(e.target.value)}
                    padding="$2"
                    borderWidth={1}
                    borderColor="$borderColor"
                    borderRadius="$2"
                    fontSize="$4"
                    fontWeight="$6"
                    backgroundColor="$background"
                    color="$color"
                    width={200}
                  />
                  <Button size="$2" onPress={handleRename}>
                    {t('Save')}
                  </Button>
                  <Button 
                    size="$2" 
                    theme="gray" 
                    onPress={() => {
                      setNewTitle(conversation.title);
                      setIsEditing(false);
                    }}
                  >
                    {t('Cancel')}
                  </Button>
                </XStack>
              ) : (
                <XStack alignItems="center" gap="$2">
                  <CardTitle>{conversation.title}</CardTitle>
                  <Button
                    icon={<Edit size={14} />}
                    size="$2"
                    chromeless
                    onPress={() => setIsEditing(true)}
                  />
                </XStack>
              )}
              <XStack alignItems="center" gap="$2" marginTop="$1">
                <XStack alignItems="center" gap="$1">
                  <Calendar size={12} />
                  <Text fontSize="$1" color="$gray11">
                    {formatDate(conversation.createdAt)}
                  </Text>
                </XStack>
                <XStack alignItems="center" gap="$1">
                  <Clock size={12} />
                  <Text fontSize="$1" color="$gray11">
                    {formatTime(conversation.updatedAt)}
                  </Text>
                </XStack>
                <XStack alignItems="center" gap="$1">
                  <MessageSquare size={12} />
                  <Text fontSize="$1" color="$gray11">
                    {conversation.messageCount} {t('messages')}
                  </Text>
                </XStack>
              </XStack>
            </YStack>
            
            <XStack alignItems="center" gap="$2">
              <Button
                icon={<Share2 size={16} />}
                size="$2"
                theme="gray"
                onPress={() => onShare?.(conversation.id)}
              />
              <Button
                icon={<Download size={16} />}
                size="$2"
                theme="gray"
                onPress={() => onExport?.(conversation.id)}
              />
              <Button
                icon={conversation.isFavorite ? <Star size={16} fill="currentColor" /> : <Star size={16} />}
                size="$2"
                theme={conversation.isFavorite ? "yellow" : "gray"}
                onPress={() => {
                  const newValue = !conversation.isFavorite;
                  setConversation(prev => ({ ...prev, isFavorite: newValue }));
                  onFavorite?.(conversation.id, newValue);
                }}
              />
              <Button
                icon={<Trash2 size={16} />}
                size="$2"
                theme="red"
                onPress={() => onDelete?.(conversation.id)}
              />
            </XStack>
          </XStack>
        </CardHeader>
      </Card>
      
      {/* Messages */}
      <YStack flex={1} padding="$4" space="$4" overflow="auto">
        {messages.length === 0 ? (
          <YStack flex={1} alignItems="center" justifyContent="center" opacity={0.7}>
            <Bot size={48} />
            <Text marginTop="$4" fontSize="$5" fontWeight="$6">
              {t('No messages yet')}
            </Text>
            <Text marginTop="$2" textAlign="center" color="$gray11">
              {t('Start a conversation by sending a message below')}
            </Text>
          </YStack>
        ) : (
          messages.map(message => (
            <MessageBubble
              key={message.id}
              message={{
                ...message,
                sender: message.role === 'user' ? 'user' : 'ai',
                timestamp: message.createdAt
              }}
              onCopy={() => {
                navigator.clipboard.writeText(message.content);
              }}
            />
          ))
        )}
      </YStack>
      
      {/* Input */}
      <YStack padding="$4" borderTopWidth={1} borderTopColor="$borderColor">
        <MessageInput onSend={handleSendMessage} />
      </YStack>
    </YStack>
  );
}

export default ChatDetailPage;
