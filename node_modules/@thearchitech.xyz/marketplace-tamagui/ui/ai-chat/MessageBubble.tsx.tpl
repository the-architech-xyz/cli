'use client';

import React, { useState, useRef } from 'react';
import { Copy, Check, ThumbsUp, ThumbsDown, MoreVertical, Bot, User, Loader2 } from 'lucide-react-native';
import { useTranslation } from '@/lib/i18n';
import { toast } from '@/hooks/use-toast';

import {
  YStack,
  XStack,
  Button,
  Card,
  CardContent,
  Avatar,
  AvatarFallback,
  AvatarImage,
  Badge,
  Separator,
  Text,
  Theme,
  Square,
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger
} from 'tamagui';

import { MarkdownRenderer } from '@/components/ai-chat/MarkdownRenderer';

export interface MessageBubbleProps {
  id: string;
  content: string;
  role: 'user' | 'assistant';
  timestamp: Date;
  isStreaming?: boolean;
  attachments?: Attachment[];
  metadata?: {
    model?: string;
    tokens?: number;
    processingTime?: number;
    sources?: Source[];
  };
  onCopy?: (content: string) => void;
  onLike?: (messageId: string) => void;
  onDislike?: (messageId: string) => void;
  onDelete?: (messageId: string) => void;
  onRegenerate?: (messageId: string) => void;
  className?: string;
  showAvatar?: boolean;
  showTimestamp?: boolean;
  showActions?: boolean;
  isLiked?: boolean;
  isDisliked?: boolean;
}

export interface Attachment {
  id: string;
  name: string;
  type: 'image' | 'document' | 'audio' | 'video';
  url: string;
  size: number;
  thumbnail?: string;
}

export interface Source {
  id: string;
  title: string;
  url: string;
  snippet: string;
  relevance: number;
}

export function MessageBubble({
  id,
  content,
  role,
  timestamp,
  isStreaming = false,
  attachments = [],
  metadata,
  onCopy,
  onLike,
  onDislike,
  onDelete,
  onRegenerate,
  showAvatar = true,
  showTimestamp = true,
  showActions = true,
  isLiked = false,
  isDisliked = false,
}: MessageBubbleProps) {
  const { t } = useTranslation();
  const [copied, setCopied] = useState(false);
  const [isImageLoading, setIsImageLoading] = useState(false);
  const [imageError, setImageError] = useState(false);
  const contentRef = useRef<HTMLDivElement>(null);

  const handleCopy = async () => {
    try {
      await navigator.clipboard.writeText(content);
      setCopied(true);
      onCopy?.(content);
      toast({
        title: t('common.copied'),
        description: t('chat.messageCopied'),
      });
      setTimeout(() => setCopied(false), 2000);
    } catch (error) {
      console.error('Failed to copy:', error);
      toast({
        title: t('common.error'),
        description: t('chat.copyFailed'),
        variant: 'destructive',
      });
    }
  };

  const handleLike = () => {
    onLike?.(id);
  };

  const handleDislike = () => {
    onDislike?.(id);
  };

  const handleDelete = () => {
    onDelete?.(id);
  };

  const handleRegenerate = () => {
    onRegenerate?.(id);
  };

  const formatTimestamp = (timestamp: Date): string => {
    return new Intl.DateTimeFormat('en-US', {
      hour: '2-digit',
      minute: '2-digit',
      hour12: true,
    }).format(timestamp);
  };

  const formatFileSize = (bytes: number): string => {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  };

  const getAttachmentIcon = (type: string) => {
    switch (type) {
      case 'image':
        return 'üñºÔ∏è';
      case 'document':
        return 'üìÑ';
      case 'audio':
        return 'üéµ';
      case 'video':
        return 'üé•';
      default:
        return 'üìé';
    }
  };

  const isUser = role === 'user';
  const isAssistant = role === 'assistant';

  return (
    <XStack 
      gap="$3" 
      justifyContent={isUser ? "flex-end" : "flex-start"}
      pressStyle={{ opacity: 1 }}
      hoverStyle={{ opacity: 1 }}
    >
      {/* Avatar */}
      {showAvatar && !isUser && (
        <Avatar size="$2" circular>
          <AvatarImage src="/ai-avatar.png" alt={t('chat.aiAssistant')} />
          <AvatarFallback>
            <Bot size={16} />
          </AvatarFallback>
        </Avatar>
      )}

      {/* Message Content */}
      <YStack 
        maxWidth="80%" 
        space="$2"
        order={isUser ? 1 : 2}
      >
        <Theme name={isUser ? "accent" : "base"}>
          <Card
            elevate
            bordered
            animation="bouncy"
            scale={1}
            hoverStyle={{ scale: 1.01 }}
            pressStyle={{ scale: 0.99 }}
            backgroundColor={isUser ? "$accentBackground" : "$background"}
          >
            <CardContent padding="$3">
              {/* Message Content */}
              <YStack ref={contentRef} space="$3">
                {isAssistant ? (
                  <MarkdownRenderer content={content} />
                ) : (
                  <Text whiteSpace="pre-wrap" wordWrap="break-word">
                    {content}
                  </Text>
                )}
                
                {/* Streaming Indicator */}
                {isStreaming && (
                  <XStack alignItems="center" gap="$1">
                    <Loader2 size={12} color="$color" />
                    <Text fontSize="$1" color="$color">
                      {t('chat.aiTyping')}
                    </Text>
                  </XStack>
                )}
              </YStack>

              {/* Attachments */}
              {attachments.length > 0 && (
                <YStack marginTop="$3" space="$2">
                  <Separator />
                  <YStack space="$2">
                    {attachments.map((attachment) => (
                      <XStack 
                        key={attachment.id}
                        alignItems="center" 
                        gap="$2" 
                        padding="$2" 
                        backgroundColor="$backgroundHover" 
                        borderRadius="$2"
                      >
                        <Text fontSize="$5">
                          {getAttachmentIcon(attachment.type)}
                        </Text>
                        <YStack flex={1} minWidth={0}>
                          <Text fontWeight="$6" numberOfLines={1} ellipsizeMode="tail">
                            {attachment.name}
                          </Text>
                          <Text fontSize="$1" color="$colorFocus">
                            {formatFileSize(attachment.size)}
                          </Text>
                        </YStack>
                        <Badge size="$1" variant="outline">
                          {attachment.type}
                        </Badge>
                      </XStack>
                    ))}
                  </YStack>
                </YStack>
              )}

              {/* Sources */}
              {metadata?.sources && metadata.sources.length > 0 && (
                <YStack marginTop="$3" space="$2">
                  <Separator />
                  <YStack space="$2">
                    <Text fontSize="$1" fontWeight="$6" color="$colorFocus">
                      {t('chat.sources')}:
                    </Text>
                    {metadata.sources.map((source) => (
                      <YStack
                        key={source.id}
                        padding="$2"
                        backgroundColor="$backgroundHover"
                        borderRadius="$2"
                      >
                        <Text 
                          color="$blue10" 
                          hoverStyle={{ textDecorationLine: "underline" }}
                          onPress={() => window.open(source.url, '_blank')}
                        >
                          {source.title}
                        </Text>
                        <Text fontSize="$1" color="$colorFocus" marginTop="$1">
                          {source.snippet}
                        </Text>
                        <XStack alignItems="center" gap="$2" marginTop="$1">
                          <Badge variant="outline" size="$1">
                            {Math.round(source.relevance * 100)}% {t('chat.relevant')}
                          </Badge>
                        </XStack>
                      </YStack>
                    ))}
                  </YStack>
                </YStack>
              )}

              {/* Metadata */}
              {metadata && (metadata.model || metadata.tokens || metadata.processingTime) && (
                <YStack marginTop="$3" paddingTop="$2" borderTopWidth={1} borderColor="$borderColor">
                  <XStack flexWrap="wrap" gap="$2">
                    {metadata.model && (
                      <Badge variant="outline" size="$1">
                        {metadata.model}
                      </Badge>
                    )}
                    {metadata.tokens && (
                      <Text fontSize="$1" color="$colorFocus">{metadata.tokens} {t('chat.tokens')}</Text>
                    )}
                    {metadata.processingTime && (
                      <Text fontSize="$1" color="$colorFocus">{metadata.processingTime}ms</Text>
                    )}
                  </XStack>
                </YStack>
              )}
            </CardContent>

            {/* Actions */}
            {showActions && (
              <XStack
                position="absolute"
                top={-10}
                right={-10}
                opacity={0}
                hoverStyle={{ opacity: 1 }}
                animation="quick"
              >
                <XStack 
                  alignItems="center" 
                  gap="$1" 
                  backgroundColor="$background" 
                  borderRadius="$10"
                  borderWidth={1}
                  borderColor="$borderColor"
                  padding="$1"
                  shadowColor="$shadowColor"
                  shadowOffset={{ width: 0, height: 2 }}
                  shadowOpacity={0.1}
                  shadowRadius={3}
                >
                  {/* Copy Button */}
                  <Button
                    size="$2"
                    circular
                    chromeless
                    onPress={handleCopy}
                    title={t('common.copy')}
                  >
                    <Square>
                      {copied ? (
                        <Check size={12} color="$green10" />
                      ) : (
                        <Copy size={12} />
                      )}
                    </Square>
                  </Button>

                  {/* Like/Dislike Buttons (for assistant messages) */}
                  {isAssistant && (
                    <>
                      <Button
                        size="$2"
                        circular
                        chromeless
                        onPress={handleLike}
                        title={t('chat.like')}
                      >
                        <Square>
                          <ThumbsUp size={12} color={isLiked ? "$green10" : "$color"} />
                        </Square>
                      </Button>
                      <Button
                        size="$2"
                        circular
                        chromeless
                        onPress={handleDislike}
                        title={t('chat.dislike')}
                      >
                        <Square>
                          <ThumbsDown size={12} color={isDisliked ? "$red10" : "$color"} />
                        </Square>
                      </Button>
                    </>
                  )}

                  {/* More Actions */}
                  <DropdownMenu>
                    <DropdownMenuTrigger asChild>
                      <Button
                        size="$2"
                        circular
                        chromeless
                        title={t('common.moreActions')}
                      >
                        <Square>
                          <MoreVertical size={12} />
                        </Square>
                      </Button>
                    </DropdownMenuTrigger>
                    <DropdownMenuContent align="end">
                      <DropdownMenuItem onPress={handleCopy}>
                        <XStack gap="$2" alignItems="center">
                          <Copy size={16} />
                          <Text>{t('common.copy')}</Text>
                        </XStack>
                      </DropdownMenuItem>
                      {isAssistant && onRegenerate && (
                        <DropdownMenuItem onPress={handleRegenerate}>
                          <XStack gap="$2" alignItems="center">
                            <Loader2 size={16} />
                            <Text>{t('chat.regenerate')}</Text>
                          </XStack>
                        </DropdownMenuItem>
                      )}
                      {onDelete && (
                        <DropdownMenuItem onPress={handleDelete}>
                          <XStack gap="$2" alignItems="center">
                            <ThumbsDown size={16} color="$red10" />
                            <Text color="$red10">{t('common.delete')}</Text>
                          </XStack>
                        </DropdownMenuItem>
                      )}
                    </DropdownMenuContent>
                  </DropdownMenu>
                </XStack>
              </XStack>
            )}
          </Card>
        </Theme>

        {/* Timestamp */}
        {showTimestamp && (
          <XStack alignItems="center" gap="$2">
            <Text fontSize="$1" color="$colorFocus">
              {formatTimestamp(timestamp)}
            </Text>
            {isAssistant && metadata?.model && (
              <>
                <Text fontSize="$1" color="$colorFocus">‚Ä¢</Text>
                <Text fontSize="$1" color="$colorFocus">
                  {metadata.model}
                </Text>
              </>
            )}
          </XStack>
        )}
      </YStack>

      {/* User Avatar */}
      {showAvatar && isUser && (
        <Avatar size="$2" circular>
          <AvatarImage src="/user-avatar.png" alt={t('chat.you')} />
          <AvatarFallback>
            <User size={16} />
          </AvatarFallback>
        </Avatar>
      )}
    </XStack>
  );
}
