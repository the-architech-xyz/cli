'use client';

import React, { useState, useEffect } from 'react';
import { useTranslation } from '@/lib/i18n';
import {
  YStack,
  XStack,
  Card,
  CardContent,
  Progress,
  Badge,
  Text,
  Theme,
  Square,
  Spinner
} from 'tamagui';
import { 
  Loader2, 
  Bot, 
  MessageSquare, 
  Zap, 
  Clock, 
  CheckCircle,
  AlertCircle,
  Info,
  Sparkles,
  Brain,
  Cpu,
  Database,
  Network,
  FileText,
  Image,
  Video,
  Music
} from 'lucide-react-native';

export interface LoadingIndicatorProps {
  className?: string;
  message?: string;
  showProgress?: boolean;
  progress?: number;
  type?: 'default' | 'message' | 'streaming' | 'upload' | 'processing' | 'thinking' | 'generating' | 'analyzing' | 'saving' | 'loading';
  size?: 'sm' | 'md' | 'lg';
  variant?: 'default' | 'minimal' | 'card' | 'inline';
  animated?: boolean;
  showIcon?: boolean;
  showDots?: boolean;
  showSpinner?: boolean;
  showPulse?: boolean;
  showWave?: boolean;
  showBounce?: boolean;
  showFade?: boolean;
  showSlide?: boolean;
  showScale?: boolean;
  showRotate?: boolean;
  showGlow?: boolean;
  showShimmer?: boolean;
  showGradient?: boolean;
  showPattern?: boolean;
  showText?: boolean;
  showPercentage?: boolean;
  showTime?: boolean;
  showSteps?: boolean;
  steps?: string[];
  currentStep?: number;
  estimatedTime?: number;
  startTime?: number;
  onComplete?: () => void;
  onCancel?: () => void;
  cancellable?: boolean;
  persistent?: boolean;
  overlay?: boolean;
  fullscreen?: boolean;
  position?: 'top' | 'center' | 'bottom' | 'left' | 'right';
  zIndex?: number;
}

export function LoadingIndicator({
  className,
  message = 'Loading...',
  showProgress = false,
  progress = 0,
  type = 'default',
  size = 'md',
  variant = 'default',
  animated = true,
  showIcon = true,
  showDots = true,
  showSpinner = true,
  showPulse = false,
  showWave = false,
  showBounce = false,
  showFade = false,
  showSlide = false,
  showScale = false,
  showRotate = false,
  showGlow = false,
  showShimmer = false,
  showGradient = false,
  showPattern = false,
  showText = true,
  showPercentage = false,
  showTime = false,
  showSteps = false,
  steps = [],
  currentStep = 0,
  estimatedTime = 0,
  startTime = Date.now(),
  onComplete,
  onCancel,
  cancellable = false,
  persistent = false,
  overlay = false,
  fullscreen = false,
  position = 'center',
  zIndex = 50,
}: LoadingIndicatorProps) {
  const { t } = useTranslation();
  const [currentProgress, setCurrentProgress] = useState(progress);
  const [elapsedTime, setElapsedTime] = useState(0);
  const [isVisible, setIsVisible] = useState(true);

  // Update progress
  useEffect(() => {
    if (showProgress && progress !== currentProgress) {
      setCurrentProgress(progress);
    }
  }, [progress, currentProgress, showProgress]);

  // Update elapsed time
  useEffect(() => {
    if (showTime && startTime) {
      const interval = setInterval(() => {
        setElapsedTime(Date.now() - startTime);
      }, 100);
      return () => clearInterval(interval);
    }
  }, [showTime, startTime]);

  // Handle completion
  useEffect(() => {
    if (showProgress && currentProgress >= 100 && onComplete) {
      const timer = setTimeout(() => {
        onComplete();
      }, 500);
      return () => clearTimeout(timer);
    }
  }, [currentProgress, onComplete, showProgress]);

  // Get icon based on type
  const getIcon = () => {
    switch (type) {
      case 'message':
        return <MessageSquare size={20} />;
      case 'streaming':
        return <Zap size={20} />;
      case 'upload':
        return <FileText size={20} />;
      case 'processing':
        return <Cpu size={20} />;
      case 'thinking':
        return <Brain size={20} />;
      case 'generating':
        return <Sparkles size={20} />;
      case 'analyzing':
        return <Database size={20} />;
      case 'saving':
        return <CheckCircle size={20} />;
      case 'loading':
        return <Loader2 size={20} />;
      default:
        return <Bot size={20} />;
    }
  };

  // Get size classes
  const getIconSize = () => {
    switch (size) {
      case 'sm':
        return 16;
      case 'lg':
        return 32;
      default:
        return 24;
    }
  };

  // Format time
  const formatTime = (ms: number): string => {
    const seconds = Math.floor(ms / 1000);
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
  };

  // Get estimated time remaining
  const getEstimatedTimeRemaining = (): string => {
    if (estimatedTime > 0 && currentProgress > 0) {
      const remaining = (estimatedTime * (100 - currentProgress)) / 100;
      return formatTime(remaining);
    }
    return '';
  };

  // Get progress color
  const getProgressColor = (): string => {
    if (currentProgress < 30) return '$red10';
    if (currentProgress < 70) return '$yellow10';
    return '$green10';
  };

  // Get type color
  const getTypeColor = (): string => {
    switch (type) {
      case 'message':
        return '$blue10';
      case 'streaming':
        return '$purple10';
      case 'upload':
        return '$orange10';
      case 'processing':
        return '$cyan10';
      case 'thinking':
        return '$pink10';
      case 'generating':
        return '$yellow10';
      case 'analyzing':
        return '$indigo10';
      case 'saving':
        return '$green10';
      case 'loading':
        return '$gray10';
      default:
        return '$blue10';
    }
  };

  // Get type badge theme
  const getTypeBadgeTheme = (): string => {
    switch (type) {
      case 'message':
        return 'blue';
      case 'streaming':
        return 'purple';
      case 'upload':
        return 'orange';
      case 'processing':
        return 'cyan';
      case 'thinking':
        return 'pink';
      case 'generating':
        return 'yellow';
      case 'analyzing':
        return 'indigo';
      case 'saving':
        return 'green';
      case 'loading':
        return 'gray';
      default:
        return 'blue';
    }
  };

  // Get type label
  const getTypeLabel = (): string => {
    switch (type) {
      case 'message':
        return t('Sending Message');
      case 'streaming':
        return t('Streaming Response');
      case 'upload':
        return t('Uploading File');
      case 'processing':
        return t('Processing');
      case 'thinking':
        return t('Thinking');
      case 'generating':
        return t('Generating');
      case 'analyzing':
        return t('Analyzing');
      case 'saving':
        return t('Saving');
      case 'loading':
        return t('Loading');
      default:
        return t('Working');
    }
  };

  // Render dots animation
  const renderDots = () => {
    if (!showDots) return null;
    
    return (
      <XStack alignItems="center" gap="$1">
        {[...Array(3)].map((_, i) => (
          <Square
            key={i}
            width={4}
            height={4}
            borderRadius="$full"
            backgroundColor="$color"
            animation={animated ? "bouncy" : undefined}
            {...(i === 1 && { delay: 150 })}
            {...(i === 2 && { delay: 300 })}
          />
        ))}
      </XStack>
    );
  };

  // Render wave animation
  const renderWave = () => {
    if (!showWave) return null;
    
    return (
      <XStack alignItems="center" gap="$1">
        {[...Array(5)].map((_, i) => (
          <Square
            key={i}
            width={4}
            backgroundColor="$color"
            borderRadius="$full"
            animation={animated ? "pulse" : undefined}
            {...(i > 0 && { delay: i * 100 })}
            height={i === 0 || i === 4 ? 8 : i === 1 || i === 3 ? 12 : 16}
          />
        ))}
      </XStack>
    );
  };

  // Render shimmer effect
  const renderShimmer = () => {
    if (!showShimmer) return null;
    
    return (
      <YStack 
        position="absolute" 
        top={0} 
        left={0} 
        right={0} 
        bottom={0} 
        opacity={0.2}
        animation="shimmer"
        backgroundColor="$background"
      />
    );
  };

  // Render gradient effect
  const renderGradient = () => {
    if (!showGradient) return null;
    
    return (
      <YStack 
        position="absolute" 
        top={0} 
        left={0} 
        right={0} 
        bottom={0} 
        opacity={0.2}
        animation="pulse"
        backgroundColor="$blue5"
      />
    );
  };

  // Render pattern effect
  const renderPattern = () => {
    if (!showPattern) return null;
    
    return (
      <YStack 
        position="absolute" 
        top={0} 
        left={0} 
        right={0} 
        bottom={0} 
        opacity={0.1}
      >
        <YStack 
          height="100%" 
          width="100%" 
          animation="pulse"
        />
      </YStack>
    );
  };

  // Render steps
  const renderSteps = () => {
    if (!showSteps || steps.length === 0) return null;
    
    return (
      <YStack space="$2">
        {steps.map((step, index) => (
          <XStack
            key={index}
            alignItems="center"
            gap="$2"
            opacity={index > currentStep ? 0.5 : 1}
          >
            {index < currentStep ? (
              <Theme name="green">
                <CheckCircle size={16} />
              </Theme>
            ) : index === currentStep ? (
              <Theme name="blue">
                <Spinner size="small" />
              </Theme>
            ) : (
              <Square 
                size={16} 
                borderRadius="$full" 
                borderWidth={2} 
                borderColor="$gray8" 
              />
            )}
            <Text 
              fontSize="$2"
              color={index < currentStep ? '$green10' : index === currentStep ? '$blue10' : '$gray11'}
              fontWeight={index === currentStep ? '$6' : '$4'}
            >
              {step}
            </Text>
          </XStack>
        ))}
      </YStack>
    );
  };

  // Render content
  const renderContent = () => {
    const content = (
      <XStack alignItems="center" gap="$3">
        {/* Icon */}
        {showIcon && (
          <Theme name={getTypeBadgeTheme() as any}>
            <XStack>
              {showSpinner ? 
                <Spinner size={getIconSize() === 16 ? 'small' : getIconSize() === 32 ? 'large' : 'medium'} /> : 
                getIcon()
              }
            </XStack>
          </Theme>
        )}

        {/* Text and Progress */}
        <YStack flex={1} minWidth={0}>
          {/* Message */}
          {showText && (
            <XStack alignItems="center" gap="$2">
              <Text fontSize="$3" fontWeight="$5">{message}</Text>
              {renderDots()}
              {renderWave()}
            </XStack>
          )}

          {/* Progress Bar */}
          {showProgress && (
            <YStack marginTop="$2" space="$1">
              <XStack alignItems="center" justifyContent="space-between">
                <Text fontSize="$1" color="$gray11">{getTypeLabel()}</Text>
                <XStack alignItems="center" gap="$2">
                  {showPercentage && (
                    <Text fontSize="$1" color="$gray11">{Math.round(currentProgress)}%</Text>
                  )}
                  {showTime && (
                    <Text fontSize="$1" color="$gray11">{formatTime(elapsedTime)}</Text>
                  )}
                  {getEstimatedTimeRemaining() && (
                    <Text fontSize="$1" color="$gray11">~{getEstimatedTimeRemaining()} {t('left')}</Text>
                  )}
                </XStack>
              </XStack>
              <Progress 
                value={currentProgress} 
                backgroundColor="$gray4"
              >
                <Progress.Indicator backgroundColor={getProgressColor()} />
              </Progress>
            </YStack>
          )}

          {/* Steps */}
          {renderSteps()}
        </YStack>

        {/* Type Badge */}
        <Theme name={getTypeBadgeTheme() as any}>
          <Badge size="$2">
            <Text>{getTypeLabel()}</Text>
          </Badge>
        </Theme>
      </XStack>
    );

    // Apply effects
    if (showShimmer || showGradient || showPattern) {
      return (
        <YStack position="relative" overflow="hidden" borderRadius="$4">
          {content}
          {renderShimmer()}
          {renderGradient()}
          {renderPattern()}
        </YStack>
      );
    }

    return content;
  };

  // Render based on variant
  if (variant === 'minimal') {
    return (
      <XStack alignItems="center" gap="$2">
        {showIcon && (
          <Theme name={getTypeBadgeTheme() as any}>
            <XStack>
              {showSpinner ? 
                <Spinner size="small" /> : 
                React.cloneElement(getIcon(), { size: getIconSize() })
              }
            </XStack>
          </Theme>
        )}
        {showText && <Text fontSize="$2">{message}</Text>}
        {renderDots()}
      </XStack>
    );
  }

  if (variant === 'inline') {
    return (
      <XStack alignItems="center" gap="$1" display="inline-flex">
        {showIcon && (
          <Theme name={getTypeBadgeTheme() as any}>
            <XStack>
              {showSpinner ? 
                <Spinner size="small" /> : 
                React.cloneElement(getIcon(), { size: 12 })
              }
            </XStack>
          </Theme>
        )}
        {showText && <Text fontSize="$1">{message}</Text>}
        {renderDots()}
      </XStack>
    );
  }

  if (variant === 'card') {
    return (
      <Card elevate bordered width="100%" maxWidth={400}>
        <CardContent padding="$4">
          {renderContent()}
        </CardContent>
      </Card>
    );
  }

  // Default variant
  const defaultContent = (
    <XStack alignItems="center" justifyContent="center" padding="$4">
      {renderContent()}
    </XStack>
  );

  if (overlay || fullscreen) {
    return (
      <YStack
        position="fixed"
        top={0}
        left={0}
        right={0}
        bottom={0}
        backgroundColor={fullscreen ? '$background' : 'rgba(0,0,0,0.5)'}
        backdropFilter="blur(4px)"
        alignItems={
          position === 'left' ? 'flex-start' : 
          position === 'right' ? 'flex-end' : 'center'
        }
        justifyContent={
          position === 'top' ? 'flex-start' : 
          position === 'bottom' ? 'flex-end' : 'center'
        }
        padding={
          position === 'top' ? '$10 0 0 0' : 
          position === 'bottom' ? '0 0 $10 0' : 
          position === 'left' ? '0 0 0 $10' : 
          position === 'right' ? '0 $10 0 0' : 0
        }
        zIndex={zIndex}
      >
        {defaultContent}
      </YStack>
    );
  }

  return defaultContent;
}

export default LoadingIndicator;
