'use client';

import React, { useState, useRef } from 'react';
import { useTranslation } from '@/lib/i18n';
import {
  YStack,
  XStack,
  Button,
  Text,
  Card,
  CardContent,
  CardHeader,
  CardTitle,
  CardDescription,
  CardFooter,
  Badge,
  Progress,
  Input,
  Label,
  Theme,
  Square,
  Spinner,
  Separator
} from 'tamagui';
import {
  Upload,
  FileJson,
  FileText,
  FilePdf,
  FileImage,
  AlertCircle,
  CheckCircle,
  Info,
  X,
  Clipboard,
  Link,
  Trash2
} from 'lucide-react-native';

export interface ChatImportProps {
  onImport?: (file: File | string, options: any) => Promise<void>;
  onCancel?: () => void;
  onPaste?: () => Promise<void>;
  isLoading?: boolean;
  error?: string;
  supportedFormats?: string[];
}

export function ChatImport({
  onImport,
  onCancel,
  onPaste,
  isLoading = false,
  error = '',
  supportedFormats = ['json', 'markdown', 'md', 'txt', 'html']
}: ChatImportProps) {
  const { t } = useTranslation();
  const fileInputRef = useRef<HTMLInputElement>(null);
  const [selectedFile, setSelectedFile] = useState<File | null>(null);
  const [importUrl, setImportUrl] = useState('');
  const [importProgress, setImportProgress] = useState(0);
  const [importStatus, setImportStatus] = useState<'idle' | 'importing' | 'success' | 'error'>('idle');
  const [options, setOptions] = useState({
    overwriteExisting: false,
    mergeWithCurrent: true,
    importAsNewConversation: true
  });
  
  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files.length > 0) {
      setSelectedFile(e.target.files[0]);
    }
  };
  
  const handleImport = async () => {
    if (!onImport) return;
    
    if (!selectedFile && !importUrl) {
      return;
    }
    
    setImportStatus('importing');
    setImportProgress(0);
    
    // Simulate progress
    const progressInterval = setInterval(() => {
      setImportProgress(prev => {
        if (prev >= 95) {
          clearInterval(progressInterval);
          return 95;
        }
        return prev + 5;
      });
    }, 100);
    
    try {
      await onImport(selectedFile || importUrl, options);
      setImportProgress(100);
      setImportStatus('success');
    } catch (err) {
      setImportStatus('error');
      setImportProgress(0);
    } finally {
      clearInterval(progressInterval);
    }
  };
  
  const handlePaste = async () => {
    if (!onPaste) return;
    
    setImportStatus('importing');
    setImportProgress(0);
    
    // Simulate progress
    const progressInterval = setInterval(() => {
      setImportProgress(prev => {
        if (prev >= 95) {
          clearInterval(progressInterval);
          return 95;
        }
        return prev + 10;
      });
    }, 50);
    
    try {
      await onPaste();
      setImportProgress(100);
      setImportStatus('success');
    } catch (err) {
      setImportStatus('error');
      setImportProgress(0);
    } finally {
      clearInterval(progressInterval);
    }
  };
  
  const getFileIcon = (fileName: string) => {
    const extension = fileName.split('.').pop()?.toLowerCase() || '';
    
    switch (extension) {
      case 'json':
        return <FileJson size={16} />;
      case 'md':
      case 'markdown':
      case 'txt':
        return <FileText size={16} />;
      case 'pdf':
        return <FilePdf size={16} />;
      case 'png':
      case 'jpg':
      case 'jpeg':
      case 'gif':
      case 'webp':
        return <FileImage size={16} />;
      default:
        return <FileText size={16} />;
    }
  };
  
  return (
    <Card elevate bordered width="100%" maxWidth={500}>
      <CardHeader>
        <XStack alignItems="center" justifyContent="space-between" width="100%">
          <CardTitle>{t('Import Conversation')}</CardTitle>
          <Button
            size="$2"
            circular
            chromeless
            onPress={onCancel}
          >
            <X size={16} />
          </Button>
        </XStack>
        <CardDescription>
          {t('Import from file or URL')}
        </CardDescription>
      </CardHeader>
      
      <CardContent padding="$4">
        <YStack space="$4">
          {/* File Upload */}
          <YStack 
            borderWidth={1} 
            borderColor="$borderColor" 
            borderRadius="$4"
            borderStyle="dashed"
            padding="$4"
            alignItems="center"
            justifyContent="center"
            backgroundColor="$background"
            hoverStyle={{ borderColor: '$blue8', backgroundColor: '$blue2' }}
            onPress={() => fileInputRef.current?.click()}
            cursor="pointer"
          >
            <input
              type="file"
              ref={fileInputRef}
              onChange={handleFileChange}
              accept={supportedFormats.map(format => `.${format}`).join(',')}
              style={{ display: 'none' }}
            />
            
            {selectedFile ? (
              <YStack alignItems="center" space="$2">
                <XStack alignItems="center" gap="$2">
                  {getFileIcon(selectedFile.name)}
                  <Text fontWeight="$6">{selectedFile.name}</Text>
                </XStack>
                <Text fontSize="$1" color="$gray11">
                  {(selectedFile.size / 1024).toFixed(1)} KB
                </Text>
                <Button
                  size="$2"
                  theme="gray"
                  icon={<Trash2 size={14} />}
                  onPress={() => setSelectedFile(null)}
                >
                  {t('Remove')}
                </Button>
              </YStack>
            ) : (
              <YStack alignItems="center" space="$2">
                <Theme name="blue">
                  <Upload size={32} />
                </Theme>
                <Text fontWeight="$6">{t('Drop file here or click to upload')}</Text>
                <Text fontSize="$2" color="$gray11">
                  {t('Supported formats')}: {supportedFormats.join(', ')}
                </Text>
              </YStack>
            )}
          </YStack>
          
          <Separator />
          
          {/* URL Import */}
          <YStack space="$2">
            <Label htmlFor="importUrl">{t('Import from URL')}</Label>
            <Input
              id="importUrl"
              placeholder="https://example.com/conversation.json"
              value={importUrl}
              onChangeText={setImportUrl}
              leftElement={<Link size={16} color="$gray10" />}
            />
          </YStack>
          
          <Separator />
          
          {/* Import Options */}
          <YStack space="$3">
            <Text fontWeight="$6">{t('Import Options')}</Text>
            
            <XStack alignItems="center" gap="$2">
              <YStack 
                as="input"
                type="radio"
                id="importAsNewConversation"
                name="importOption"
                checked={options.importAsNewConversation}
                onChange={() => setOptions({
                  overwriteExisting: false,
                  mergeWithCurrent: false,
                  importAsNewConversation: true
                })}
              />
              <Label htmlFor="importAsNewConversation">{t('Import as new conversation')}</Label>
            </XStack>
            
            <XStack alignItems="center" gap="$2">
              <YStack 
                as="input"
                type="radio"
                id="mergeWithCurrent"
                name="importOption"
                checked={options.mergeWithCurrent}
                onChange={() => setOptions({
                  overwriteExisting: false,
                  mergeWithCurrent: true,
                  importAsNewConversation: false
                })}
              />
              <Label htmlFor="mergeWithCurrent">{t('Merge with current conversation')}</Label>
            </XStack>
            
            <XStack alignItems="center" gap="$2">
              <YStack 
                as="input"
                type="radio"
                id="overwriteExisting"
                name="importOption"
                checked={options.overwriteExisting}
                onChange={() => setOptions({
                  overwriteExisting: true,
                  mergeWithCurrent: false,
                  importAsNewConversation: false
                })}
              />
              <Label htmlFor="overwriteExisting">{t('Overwrite existing conversation')}</Label>
            </XStack>
          </YStack>
          
          {/* Status and Progress */}
          {(importStatus !== 'idle' || error) && (
            <YStack space="$2" marginTop="$2">
              {error ? (
                <XStack alignItems="center" gap="$2">
                  <Theme name="red">
                    <AlertCircle size={16} />
                  </Theme>
                  <Text color="$red10">{error}</Text>
                </XStack>
              ) : importStatus === 'importing' ? (
                <YStack space="$2">
                  <XStack alignItems="center" justifyContent="space-between">
                    <XStack alignItems="center" gap="$2">
                      <Spinner size="small" />
                      <Text>{t('Importing...')}</Text>
                    </XStack>
                    <Text fontSize="$1" color="$gray11">{Math.round(importProgress)}%</Text>
                  </XStack>
                  <Progress value={importProgress}>
                    <Progress.Indicator backgroundColor="$blue10" />
                  </Progress>
                </YStack>
              ) : importStatus === 'success' ? (
                <XStack alignItems="center" gap="$2">
                  <Theme name="green">
                    <CheckCircle size={16} />
                  </Theme>
                  <Text color="$green10">{t('Import completed successfully!')}</Text>
                </XStack>
              ) : null}
            </YStack>
          )}
        </YStack>
      </CardContent>
      
      <CardFooter padding="$4" borderTopWidth={1} borderTopColor="$borderColor">
        <XStack alignItems="center" justifyContent="space-between" width="100%">
          <Button 
            theme="gray"
            onPress={onCancel}
          >
            {t('Cancel')}
          </Button>
          
          <XStack gap="$2">
            <Button
              theme="gray"
              icon={<Clipboard size={16} />}
              onPress={handlePaste}
              disabled={isLoading || importStatus === 'importing'}
            >
              {t('Paste from Clipboard')}
            </Button>
            
            <Button
              icon={<Upload size={16} />}
              onPress={handleImport}
              disabled={isLoading || importStatus === 'importing' || (!selectedFile && !importUrl)}
            >
              {t('Import')}
            </Button>
          </XStack>
        </XStack>
      </CardFooter>
    </Card>
  );
}

export default ChatImport;
