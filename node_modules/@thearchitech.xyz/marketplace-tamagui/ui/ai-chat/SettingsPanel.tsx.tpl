'use client';

import React, { useState, useCallback, useEffect } from 'react';
import { useTranslation } from '@/lib/i18n';
import { 
  Settings, 
  Save, 
  RotateCcw, 
  Eye, 
  EyeOff, 
  Palette, 
  Zap, 
  MessageSquare, 
  Volume2, 
  VolumeX,
  Monitor,
  Moon,
  Sun,
  Smartphone,
  Globe,
  Shield,
  Bell,
  Keyboard,
  Mouse,
  Download,
  Upload,
  Trash2,
  CheckCircle,
  AlertCircle,
  Info,
  X
} from 'lucide-react-native';

import {
  YStack,
  XStack,
  Button,
  Card,
  CardContent,
  CardHeader,
  CardTitle,
  Input,
  Label,
  TextArea,
  Switch,
  Slider,
  Badge,
  Separator,
  Text,
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
  Tabs,
  TabsContent,
  TabsList,
  TabsTrigger,
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
  Theme,
  Square
} from 'tamagui';

// Define types if not imported
interface ChatSettings {
  model: string;
  temperature: number;
  maxTokens: number;
  systemPrompt: string;
}

interface ChatUIConfig {
  theme: {
    name: string;
  };
  layout: {
    sidebarWidth: string;
  };
  features: {
    showTimestamps: boolean;
    showStatus: boolean;
    showTokenCount: boolean;
    showCost: boolean;
    enableAnimations: boolean;
    enableSounds: boolean;
    highContrast?: boolean;
    reducedMotion?: boolean;
  };
  limits: {
    maxMessageLength: number;
    maxAttachments: number;
    maxFileSize: number;
  };
}

interface ModelProvider {
  id: string;
  name: string;
}

export interface SettingsPanelProps {
  settings: ChatSettings;
  uiConfig: ChatUIConfig;
  onSettingsChange?: (settings: ChatSettings) => void;
  onUIConfigChange?: (config: ChatUIConfig) => void;
  onReset?: () => void;
  onExport?: () => void;
  onImport?: (file: File) => void;
  availableModels?: string[];
  availableProviders?: ModelProvider[];
}

export function SettingsPanel({
  settings,
  uiConfig,
  onSettingsChange,
  onUIConfigChange,
  onReset,
  onExport,
  onImport,
  availableModels = ['gpt-3.5-turbo', 'gpt-4', 'gpt-4-turbo', 'claude-3-sonnet', 'claude-3-opus'],
  availableProviders = ['openai', 'anthropic', 'google', 'azure'],
}: SettingsPanelProps) {
  const { t } = useTranslation();
  const [localSettings, setLocalSettings] = useState<ChatSettings>(settings);
  const [localUIConfig, setLocalUIConfig] = useState<ChatUIConfig>(uiConfig);
  const [hasChanges, setHasChanges] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const [showResetDialog, setShowResetDialog] = useState(false);
  const [showExportDialog, setShowExportDialog] = useState(false);
  const [showImportDialog, setShowImportDialog] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState<string | null>(null);
  const [activeTab, setActiveTab] = useState('chat');

  // Update local state when props change
  useEffect(() => {
    setLocalSettings(settings);
    setLocalUIConfig(uiConfig);
  }, [settings, uiConfig]);

  // Check for changes
  useEffect(() => {
    const settingsChanged = JSON.stringify(localSettings) !== JSON.stringify(settings);
    const uiConfigChanged = JSON.stringify(localUIConfig) !== JSON.stringify(uiConfig);
    setHasChanges(settingsChanged || uiConfigChanged);
  }, [localSettings, localUIConfig, settings, uiConfig]);

  // Handle settings changes
  const handleSettingsChange = useCallback((updates: Partial<ChatSettings>) => {
    setLocalSettings(prev => ({ ...prev, ...updates }));
    setError(null);
  }, []);

  const handleUIConfigChange = useCallback((updates: Partial<ChatUIConfig>) => {
    setLocalUIConfig(prev => ({ ...prev, ...updates }));
    setError(null);
  }, []);

  // Save changes
  const handleSave = useCallback(async () => {
    setIsSaving(true);
    setError(null);

    try {
      await onSettingsChange?.(localSettings);
      await onUIConfigChange?.(localUIConfig);
      setSuccess(t('chat.settingsSaved'));
      setHasChanges(false);
    } catch (err) {
      setError(err instanceof Error ? err.message : t('errors.saveSettingsFailed'));
    } finally {
      setIsSaving(false);
    }
  }, [localSettings, localUIConfig, onSettingsChange, onUIConfigChange, t]);

  // Reset to defaults
  const handleReset = useCallback(async () => {
    try {
      await onReset?.();
      setSuccess(t('chat.settingsReset'));
      setShowResetDialog(false);
    } catch (err) {
      setError(err instanceof Error ? err.message : t('errors.resetSettingsFailed'));
    }
  }, [onReset, t]);

  // Export settings
  const handleExport = useCallback(async () => {
    try {
      await onExport?.();
      setSuccess(t('chat.settingsExported'));
      setShowExportDialog(false);
    } catch (err) {
      setError(err instanceof Error ? err.message : t('errors.exportSettingsFailed'));
    }
  }, [onExport, t]);

  // Import settings
  const handleImport = useCallback(async (file: File) => {
    try {
      await onImport?.(file);
      setSuccess(t('chat.settingsImported'));
      setShowImportDialog(false);
    } catch (err) {
      setError(err instanceof Error ? err.message : t('errors.importSettingsFailed'));
    }
  }, [onImport, t]);

  // Clear messages
  const clearMessages = useCallback(() => {
    setError(null);
    setSuccess(null);
  }, []);

  return (
    <YStack space="$6">
      {/* Header */}
      <XStack alignItems="center" justifyContent="space-between">
        <XStack alignItems="center" gap="$2">
          <Settings size={20} />
          <Text fontSize="$5" fontWeight="$6">{t('chat.settings')}</Text>
        </XStack>
        <XStack alignItems="center" gap="$2">
          {hasChanges && (
            <Badge variant="outline" theme="orange">
              <Text fontSize="$1">{t('chat.unsavedChanges')}</Text>
            </Badge>
          )}
          <Button
            variant="outlined"
            size="$2"
            onPress={() => setShowResetDialog(true)}
          >
            <XStack alignItems="center" gap="$2">
              <RotateCcw size={16} />
              <Text>{t('common.reset')}</Text>
            </XStack>
          </Button>
          <Button
            onPress={handleSave}
            disabled={!hasChanges || isSaving}
          >
            <XStack alignItems="center" gap="$2">
              <Save size={16} />
              <Text>{isSaving ? t('common.saving') : t('common.save')}</Text>
            </XStack>
          </Button>
        </XStack>
      </XStack>

      {/* Status Messages */}
      {error && (
        <XStack 
          alignItems="center" 
          gap="$2" 
          padding="$3" 
          backgroundColor="$red2" 
          borderWidth={1} 
          borderColor="$red6" 
          borderRadius="$2"
        >
          <AlertCircle size={16} color="$red10" />
          <Text color="$red10" fontSize="$2">{error}</Text>
          <Button
            chromeless
            size="$1"
            circular
            marginLeft="auto"
            onPress={clearMessages}
          >
            <X size={12} />
          </Button>
        </XStack>
      )}

      {success && (
        <XStack 
          alignItems="center" 
          gap="$2" 
          padding="$3" 
          backgroundColor="$green2" 
          borderWidth={1} 
          borderColor="$green6" 
          borderRadius="$2"
        >
          <CheckCircle size={16} color="$green10" />
          <Text color="$green10" fontSize="$2">{success}</Text>
          <Button
            chromeless
            size="$1"
            circular
            marginLeft="auto"
            onPress={clearMessages}
          >
            <X size={12} />
          </Button>
        </XStack>
      )}

      {/* Settings Tabs */}
      <Tabs
        defaultValue="chat"
        value={activeTab}
        onValueChange={setActiveTab}
      >
        <TabsList>
          <TabsTrigger value="chat">
            <Text>{t('chat.chat')}</Text>
          </TabsTrigger>
          <TabsTrigger value="appearance">
            <Text>{t('chat.appearance')}</Text>
          </TabsTrigger>
          <TabsTrigger value="advanced">
            <Text>{t('chat.advanced')}</Text>
          </TabsTrigger>
          <TabsTrigger value="data">
            <Text>{t('chat.data')}</Text>
          </TabsTrigger>
        </TabsList>

        {/* Chat Settings */}
        <TabsContent value="chat">
          <YStack space="$4" marginTop="$4">
            <Card bordered>
              <CardHeader>
                <CardTitle>{t('chat.modelConfiguration')}</CardTitle>
              </CardHeader>
              <CardContent>
                <YStack space="$4">
                  <XStack flexDirection={{ sm: 'column', md: 'row' }} gap="$4">
                    <YStack flex={1} space="$2">
                      <Label htmlFor="model">{t('chat.model')}</Label>
                      <Select
                        id="model"
                        value={localSettings.model}
                        onValueChange={(value) => handleSettingsChange({ model: value })}
                      >
                        <SelectTrigger>
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          {availableModels.map(model => (
                            <SelectItem key={model} value={model}>
                              <Text>{model}</Text>
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                    </YStack>

                    <YStack flex={1} space="$2">
                      <Label htmlFor="temperature">
                        {t('chat.temperature')}: {localSettings.temperature}
                      </Label>
                      <Slider
                        value={[localSettings.temperature]}
                        onValueChange={([value]) => handleSettingsChange({ temperature: value })}
                        min={0}
                        max={2}
                        step={0.1}
                        marginTop="$2"
                      />
                      <XStack justifyContent="space-between">
                        <Text fontSize="$1" color="$colorFocus">{t('chat.focused')}</Text>
                        <Text fontSize="$1" color="$colorFocus">{t('chat.creative')}</Text>
                      </XStack>
                    </YStack>
                  </XStack>

                  <YStack space="$2">
                    <Label htmlFor="maxTokens">
                      {t('chat.maxTokens')}: {localSettings.maxTokens}
                    </Label>
                    <Slider
                      value={[localSettings.maxTokens]}
                      onValueChange={([value]) => handleSettingsChange({ maxTokens: value })}
                      min={100}
                      max={4000}
                      step={100}
                      marginTop="$2"
                    />
                    <XStack justifyContent="space-between">
                      <Text fontSize="$1" color="$colorFocus">{t('chat.short')}</Text>
                      <Text fontSize="$1" color="$colorFocus">{t('chat.long')}</Text>
                    </XStack>
                  </YStack>

                  <YStack space="$2">
                    <Label htmlFor="systemPrompt">{t('chat.systemPrompt')}</Label>
                    <TextArea
                      id="systemPrompt"
                      value={localSettings.systemPrompt}
                      onChangeText={(text) => handleSettingsChange({ systemPrompt: text })}
                      placeholder={t('chat.enterSystemPrompt')}
                      numberOfLines={4}
                      minHeight={100}
                    />
                  </YStack>
                </YStack>
              </CardContent>
            </Card>
          </YStack>
        </TabsContent>

        {/* Appearance Settings */}
        <TabsContent value="appearance">
          <YStack space="$4" marginTop="$4">
            <Card bordered>
              <CardHeader>
                <CardTitle>{t('chat.themeAndLayout')}</CardTitle>
              </CardHeader>
              <CardContent>
                <YStack space="$4">
                  <XStack flexDirection={{ sm: 'column', md: 'row' }} gap="$4">
                    <YStack flex={1} space="$2">
                      <Label>{t('chat.theme')}</Label>
                      <Select
                        value={localUIConfig.theme.name}
                        onValueChange={(value) => handleUIConfigChange({
                          theme: { ...localUIConfig.theme, name: value }
                        })}
                      >
                        <SelectTrigger>
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="default">
                            <XStack alignItems="center" gap="$2">
                              <Monitor size={16} />
                              <Text>{t('chat.default')}</Text>
                            </XStack>
                          </SelectItem>
                          <SelectItem value="dark">
                            <XStack alignItems="center" gap="$2">
                              <Moon size={16} />
                              <Text>{t('chat.dark')}</Text>
                            </XStack>
                          </SelectItem>
                          <SelectItem value="light">
                            <XStack alignItems="center" gap="$2">
                              <Sun size={16} />
                              <Text>{t('chat.light')}</Text>
                            </XStack>
                          </SelectItem>
                          <SelectItem value="minimal">
                            <XStack alignItems="center" gap="$2">
                              <Palette size={16} />
                              <Text>{t('chat.minimal')}</Text>
                            </XStack>
                          </SelectItem>
                        </SelectContent>
                      </Select>
                    </YStack>

                    <YStack flex={1} space="$2">
                      <Label>{t('chat.layout')}</Label>
                      <Select
                        value={localUIConfig.layout.sidebarWidth}
                        onValueChange={(value) => handleUIConfigChange({
                          layout: { ...localUIConfig.layout, sidebarWidth: value }
                        })}
                      >
                        <SelectTrigger>
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="240px">
                            <Text>{t('chat.compact')}</Text>
                          </SelectItem>
                          <SelectItem value="280px">
                            <Text>{t('chat.normal')}</Text>
                          </SelectItem>
                          <SelectItem value="320px">
                            <Text>{t('chat.wide')}</Text>
                          </SelectItem>
                        </SelectContent>
                      </Select>
                    </YStack>
                  </XStack>

                  <Separator />

                  <YStack space="$3">
                    <Text fontWeight="$6">{t('chat.displayOptions')}</Text>
                    <YStack space="$3">
                      <XStack alignItems="center" justifyContent="space-between">
                        <Label htmlFor="showTimestamps">{t('chat.showTimestamps')}</Label>
                        <Switch
                          id="showTimestamps"
                          checked={localUIConfig.features.showTimestamps}
                          onCheckedChange={(checked) => handleUIConfigChange({
                            features: { ...localUIConfig.features, showTimestamps: checked }
                          })}
                        />
                      </XStack>

                      <XStack alignItems="center" justifyContent="space-between">
                        <Label htmlFor="showStatus">{t('chat.showMessageStatus')}</Label>
                        <Switch
                          id="showStatus"
                          checked={localUIConfig.features.showStatus}
                          onCheckedChange={(checked) => handleUIConfigChange({
                            features: { ...localUIConfig.features, showStatus: checked }
                          })}
                        />
                      </XStack>

                      <XStack alignItems="center" justifyContent="space-between">
                        <Label htmlFor="showTokenCount">{t('chat.showTokenCount')}</Label>
                        <Switch
                          id="showTokenCount"
                          checked={localUIConfig.features.showTokenCount}
                          onCheckedChange={(checked) => handleUIConfigChange({
                            features: { ...localUIConfig.features, showTokenCount: checked }
                          })}
                        />
                      </XStack>

                      <XStack alignItems="center" justifyContent="space-between">
                        <Label htmlFor="showCost">{t('chat.showCost')}</Label>
                        <Switch
                          id="showCost"
                          checked={localUIConfig.features.showCost}
                          onCheckedChange={(checked) => handleUIConfigChange({
                            features: { ...localUIConfig.features, showCost: checked }
                          })}
                        />
                      </XStack>

                      <XStack alignItems="center" justifyContent="space-between">
                        <Label htmlFor="enableAnimations">{t('chat.enableAnimations')}</Label>
                        <Switch
                          id="enableAnimations"
                          checked={localUIConfig.features.enableAnimations}
                          onCheckedChange={(checked) => handleUIConfigChange({
                            features: { ...localUIConfig.features, enableAnimations: checked }
                          })}
                        />
                      </XStack>

                      <XStack alignItems="center" justifyContent="space-between">
                        <Label htmlFor="enableSounds">{t('chat.enableSounds')}</Label>
                        <Switch
                          id="enableSounds"
                          checked={localUIConfig.features.enableSounds}
                          onCheckedChange={(checked) => handleUIConfigChange({
                            features: { ...localUIConfig.features, enableSounds: checked }
                          })}
                        />
                      </XStack>
                    </YStack>
                  </YStack>
                </YStack>
              </CardContent>
            </Card>
          </YStack>
        </TabsContent>

        {/* Advanced Settings */}
        <TabsContent value="advanced">
          <YStack space="$4" marginTop="$4">
            <Card bordered>
              <CardHeader>
                <CardTitle>{t('chat.advancedConfiguration')}</CardTitle>
              </CardHeader>
              <CardContent>
                <YStack space="$4">
                  <YStack space="$3">
                    <Text fontWeight="$6">{t('chat.limits')}</Text>
                    <XStack flexDirection={{ sm: 'column', md: 'row' }} gap="$4">
                      <YStack flex={1} space="$2">
                        <Label htmlFor="maxMessageLength">
                          {t('chat.maxMessageLength')}: {localUIConfig.limits.maxMessageLength}
                        </Label>
                        <Slider
                          value={[localUIConfig.limits.maxMessageLength]}
                          onValueChange={([value]) => handleUIConfigChange({
                            limits: { ...localUIConfig.limits, maxMessageLength: value }
                          })}
                          min={100}
                          max={5000}
                          step={100}
                          marginTop="$2"
                        />
                      </YStack>

                      <YStack flex={1} space="$2">
                        <Label htmlFor="maxAttachments">
                          {t('chat.maxAttachments')}: {localUIConfig.limits.maxAttachments}
                        </Label>
                        <Slider
                          value={[localUIConfig.limits.maxAttachments]}
                          onValueChange={([value]) => handleUIConfigChange({
                            limits: { ...localUIConfig.limits, maxAttachments: value }
                          })}
                          min={1}
                          max={10}
                          step={1}
                          marginTop="$2"
                        />
                      </YStack>
                    </XStack>

                    <YStack space="$2">
                      <Label htmlFor="maxFileSize">
                        {t('chat.maxFileSize')}: {Math.round(localUIConfig.limits.maxFileSize / (1024 * 1024))}MB
                      </Label>
                      <Slider
                        value={[localUIConfig.limits.maxFileSize / (1024 * 1024)]}
                        onValueChange={([value]) => handleUIConfigChange({
                          limits: { ...localUIConfig.limits, maxFileSize: value * 1024 * 1024 }
                        })}
                        min={1}
                        max={100}
                        step={1}
                        marginTop="$2"
                      />
                    </YStack>
                  </YStack>

                  <Separator />

                  <YStack space="$3">
                    <Text fontWeight="$6">{t('chat.accessibility')}</Text>
                    <YStack space="$3">
                      <XStack alignItems="center" justifyContent="space-between">
                        <Label htmlFor="highContrast">{t('chat.highContrastMode')}</Label>
                        <Switch
                          id="highContrast"
                          checked={localUIConfig.features.highContrast || false}
                          onCheckedChange={(checked) => handleUIConfigChange({
                            features: { ...localUIConfig.features, highContrast: checked }
                          })}
                        />
                      </XStack>

                      <XStack alignItems="center" justifyContent="space-between">
                        <Label htmlFor="reducedMotion">{t('chat.reduceMotion')}</Label>
                        <Switch
                          id="reducedMotion"
                          checked={localUIConfig.features.reducedMotion || false}
                          onCheckedChange={(checked) => handleUIConfigChange({
                            features: { ...localUIConfig.features, reducedMotion: checked }
                          })}
                        />
                      </XStack>
                    </YStack>
                  </YStack>
                </YStack>
              </CardContent>
            </Card>
          </YStack>
        </TabsContent>

        {/* Data Settings */}
        <TabsContent value="data">
          <YStack space="$4" marginTop="$4">
            <Card bordered>
              <CardHeader>
                <CardTitle>{t('chat.dataManagement')}</CardTitle>
              </CardHeader>
              <CardContent>
                <YStack space="$4">
                  <YStack space="$3">
                    <Text fontWeight="$6">{t('chat.importExport')}</Text>
                    <XStack alignItems="center" gap="$2">
                      <Button
                        variant="outlined"
                        onPress={() => setShowExportDialog(true)}
                      >
                        <XStack alignItems="center" gap="$2">
                          <Download size={16} />
                          <Text>{t('chat.exportSettings')}</Text>
                        </XStack>
                      </Button>
                      <Button
                        variant="outlined"
                        onPress={() => setShowImportDialog(true)}
                      >
                        <XStack alignItems="center" gap="$2">
                          <Upload size={16} />
                          <Text>{t('chat.importSettings')}</Text>
                        </XStack>
                      </Button>
                    </XStack>
                  </YStack>

                  <Separator />

                  <YStack space="$3">
                    <Text fontWeight="$6">{t('chat.storage')}</Text>
                    <YStack>
                      <Text fontSize="$2" color="$colorFocus">
                        {t('chat.settingsStoredLocally')}
                      </Text>
                      <Text fontSize="$2" color="$colorFocus">
                        {t('chat.exportSettingsBackup')}
                      </Text>
                    </YStack>
                  </YStack>
                </YStack>
              </CardContent>
            </Card>
          </YStack>
        </TabsContent>
      </Tabs>

      {/* Reset Dialog */}
      <Dialog open={showResetDialog} onOpenChange={setShowResetDialog}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>{t('chat.resetSettings')}</DialogTitle>
          </DialogHeader>
          <YStack space="$4" paddingVertical="$4">
            <Text fontSize="$2" color="$colorFocus">
              {t('chat.resetSettingsConfirmation')}
            </Text>
          </YStack>
          <DialogFooter>
            <XStack gap="$3" justifyContent="flex-end">
              <Button
                variant="outlined"
                onPress={() => setShowResetDialog(false)}
              >
                {t('common.cancel')}
              </Button>
              <Button
                theme="red"
                onPress={handleReset}
              >
                {t('common.reset')}
              </Button>
            </XStack>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Export Dialog */}
      <Dialog open={showExportDialog} onOpenChange={setShowExportDialog}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>{t('chat.exportSettings')}</DialogTitle>
          </DialogHeader>
          <YStack space="$4" paddingVertical="$4">
            <Text fontSize="$2" color="$colorFocus">
              {t('chat.exportSettingsDescription')}
            </Text>
          </YStack>
          <DialogFooter>
            <XStack gap="$3" justifyContent="flex-end">
              <Button
                variant="outlined"
                onPress={() => setShowExportDialog(false)}
              >
                {t('common.cancel')}
              </Button>
              <Button onPress={handleExport}>
                {t('chat.export')}
              </Button>
            </XStack>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Import Dialog */}
      <Dialog open={showImportDialog} onOpenChange={setShowImportDialog}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>{t('chat.importSettings')}</DialogTitle>
          </DialogHeader>
          <YStack space="$4" paddingVertical="$4">
            <Text fontSize="$2" color="$colorFocus">
              {t('chat.importSettingsDescription')}
            </Text>
            <input
              type="file"
              accept=".json"
              onChange={(e) => {
                const file = e.target.files?.[0];
                if (file) {
                  handleImport(file);
                }
              }}
              style={{ width: '100%' }}
            />
          </YStack>
          <DialogFooter>
            <XStack gap="$3" justifyContent="flex-end">
              <Button
                variant="outlined"
                onPress={() => setShowImportDialog(false)}
              >
                {t('common.cancel')}
              </Button>
            </XStack>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </YStack>
  );
}
