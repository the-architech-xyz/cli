'use client';

import React, { useState } from 'react';
import { useTranslation } from '@/lib/i18n';
import {
  YStack,
  XStack,
  Button,
  Text,
  Card,
  CardContent,
  CardHeader,
  CardTitle,
  CardDescription,
  CardFooter,
  Badge,
  Progress,
  Checkbox,
  Label,
  Select,
  SelectTrigger,
  SelectContent,
  SelectItem,
  SelectValue,
  Theme,
  Square,
  Spinner,
  Separator
} from 'tamagui';
import {
  Download,
  FileJson,
  FileText,
  FilePdf,
  FileImage,
  Calendar,
  Clock,
  MessageSquare,
  Settings,
  CheckCircle,
  AlertCircle,
  Info,
  Share2,
  Copy,
  Save,
  Clipboard,
  X
} from 'lucide-react-native';

export interface ChatExportProps {
  conversationId?: string;
  conversationTitle?: string;
  messages?: any[];
  onExport?: (format: string, options: any) => Promise<void>;
  onCancel?: () => void;
  onCopy?: () => Promise<void>;
  isLoading?: boolean;
  error?: string;
  exportFormats?: { id: string; name: string; description?: string; icon?: React.ReactNode }[];
}

export function ChatExport({
  conversationId,
  conversationTitle = 'Conversation',
  messages = [],
  onExport,
  onCancel,
  onCopy,
  isLoading = false,
  error = '',
  exportFormats = [
    { id: 'json', name: 'JSON', description: 'Full data structure', icon: <FileJson size={16} /> },
    { id: 'markdown', name: 'Markdown', description: 'Readable text format', icon: <FileText size={16} /> },
    { id: 'pdf', name: 'PDF', description: 'Document format', icon: <FilePdf size={16} /> },
    { id: 'html', name: 'HTML', description: 'Web page format', icon: <FileText size={16} /> },
    { id: 'image', name: 'Image', description: 'PNG screenshot', icon: <FileImage size={16} /> },
    { id: 'txt', name: 'Text', description: 'Plain text format', icon: <FileText size={16} /> }
  ]
}: ChatExportProps) {
  const { t } = useTranslation();
  const [selectedFormat, setSelectedFormat] = useState('markdown');
  const [exportProgress, setExportProgress] = useState(0);
  const [exportStatus, setExportStatus] = useState<'idle' | 'exporting' | 'success' | 'error'>('idle');
  const [options, setOptions] = useState({
    includeMetadata: true,
    includeTimestamps: true,
    includeUserInfo: false,
    includeSummary: true,
    includeSystemMessages: false,
    prettify: true
  });
  
  const handleExport = async () => {
    if (!onExport) return;
    
    setExportStatus('exporting');
    setExportProgress(0);
    
    // Simulate progress
    const progressInterval = setInterval(() => {
      setExportProgress(prev => {
        if (prev >= 95) {
          clearInterval(progressInterval);
          return 95;
        }
        return prev + 5;
      });
    }, 100);
    
    try {
      await onExport(selectedFormat, options);
      setExportProgress(100);
      setExportStatus('success');
    } catch (err) {
      setExportStatus('error');
      setExportProgress(0);
    } finally {
      clearInterval(progressInterval);
    }
  };
  
  const handleCopy = async () => {
    if (!onCopy) return;
    
    setExportStatus('exporting');
    setExportProgress(0);
    
    // Simulate progress
    const progressInterval = setInterval(() => {
      setExportProgress(prev => {
        if (prev >= 95) {
          clearInterval(progressInterval);
          return 95;
        }
        return prev + 10;
      });
    }, 50);
    
    try {
      await onCopy();
      setExportProgress(100);
      setExportStatus('success');
    } catch (err) {
      setExportStatus('error');
      setExportProgress(0);
    } finally {
      clearInterval(progressInterval);
    }
  };
  
  const selectedFormatObj = exportFormats.find(f => f.id === selectedFormat) || exportFormats[0];
  
  return (
    <Card elevate bordered width="100%" maxWidth={500}>
      <CardHeader>
        <XStack alignItems="center" justifyContent="space-between" width="100%">
          <CardTitle>{t('Export Conversation')}</CardTitle>
          <Button
            size="$2"
            circular
            chromeless
            onPress={onCancel}
          >
            <X size={16} />
          </Button>
        </XStack>
        <CardDescription>
          {conversationTitle} â€¢ {messages.length} {t('messages')}
        </CardDescription>
      </CardHeader>
      
      <CardContent padding="$4">
        <YStack space="$4">
          {/* Format Selection */}
          <YStack space="$2">
            <Label htmlFor="format">{t('Export Format')}</Label>
            <Select id="format" value={selectedFormat} onValueChange={setSelectedFormat}>
              <SelectTrigger>
                <XStack alignItems="center" justifyContent="space-between" flex={1}>
                  <XStack alignItems="center" gap="$2">
                    {selectedFormatObj.icon}
                    <SelectValue placeholder={t('Select format')} />
                  </XStack>
                </XStack>
              </SelectTrigger>
              <SelectContent>
                {exportFormats.map((format) => (
                  <SelectItem key={format.id} value={format.id}>
                    <XStack alignItems="center" gap="$2">
                      {format.icon}
                      <Text>{format.name}</Text>
                      {format.description && (
                        <Text fontSize="$1" color="$gray11">- {format.description}</Text>
                      )}
                    </XStack>
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </YStack>
          
          <Separator />
          
          {/* Options */}
          <YStack space="$3">
            <Text fontWeight="$6">{t('Export Options')}</Text>
            
            <XStack alignItems="center" gap="$2">
              <Checkbox 
                id="includeMetadata"
                checked={options.includeMetadata}
                onCheckedChange={(checked) => 
                  setOptions(prev => ({ ...prev, includeMetadata: !!checked }))
                }
              >
                <Checkbox.Indicator>
                  <CheckCircle size={16} />
                </Checkbox.Indicator>
              </Checkbox>
              <Label htmlFor="includeMetadata">{t('Include Metadata')}</Label>
            </XStack>
            
            <XStack alignItems="center" gap="$2">
              <Checkbox 
                id="includeTimestamps"
                checked={options.includeTimestamps}
                onCheckedChange={(checked) => 
                  setOptions(prev => ({ ...prev, includeTimestamps: !!checked }))
                }
              >
                <Checkbox.Indicator>
                  <CheckCircle size={16} />
                </Checkbox.Indicator>
              </Checkbox>
              <Label htmlFor="includeTimestamps">{t('Include Timestamps')}</Label>
            </XStack>
            
            <XStack alignItems="center" gap="$2">
              <Checkbox 
                id="includeUserInfo"
                checked={options.includeUserInfo}
                onCheckedChange={(checked) => 
                  setOptions(prev => ({ ...prev, includeUserInfo: !!checked }))
                }
              >
                <Checkbox.Indicator>
                  <CheckCircle size={16} />
                </Checkbox.Indicator>
              </Checkbox>
              <Label htmlFor="includeUserInfo">{t('Include User Information')}</Label>
            </XStack>
            
            <XStack alignItems="center" gap="$2">
              <Checkbox 
                id="includeSummary"
                checked={options.includeSummary}
                onCheckedChange={(checked) => 
                  setOptions(prev => ({ ...prev, includeSummary: !!checked }))
                }
              >
                <Checkbox.Indicator>
                  <CheckCircle size={16} />
                </Checkbox.Indicator>
              </Checkbox>
              <Label htmlFor="includeSummary">{t('Include Summary')}</Label>
            </XStack>
            
            <XStack alignItems="center" gap="$2">
              <Checkbox 
                id="includeSystemMessages"
                checked={options.includeSystemMessages}
                onCheckedChange={(checked) => 
                  setOptions(prev => ({ ...prev, includeSystemMessages: !!checked }))
                }
              >
                <Checkbox.Indicator>
                  <CheckCircle size={16} />
                </Checkbox.Indicator>
              </Checkbox>
              <Label htmlFor="includeSystemMessages">{t('Include System Messages')}</Label>
            </XStack>
            
            <XStack alignItems="center" gap="$2">
              <Checkbox 
                id="prettify"
                checked={options.prettify}
                onCheckedChange={(checked) => 
                  setOptions(prev => ({ ...prev, prettify: !!checked }))
                }
              >
                <Checkbox.Indicator>
                  <CheckCircle size={16} />
                </Checkbox.Indicator>
              </Checkbox>
              <Label htmlFor="prettify">{t('Prettify Output')}</Label>
            </XStack>
          </YStack>
          
          {/* Status and Progress */}
          {(exportStatus !== 'idle' || error) && (
            <YStack space="$2" marginTop="$2">
              {error ? (
                <XStack alignItems="center" gap="$2">
                  <Theme name="red">
                    <AlertCircle size={16} />
                  </Theme>
                  <Text color="$red10">{error}</Text>
                </XStack>
              ) : exportStatus === 'exporting' ? (
                <YStack space="$2">
                  <XStack alignItems="center" justifyContent="space-between">
                    <XStack alignItems="center" gap="$2">
                      <Spinner size="small" />
                      <Text>{t('Exporting...')}</Text>
                    </XStack>
                    <Text fontSize="$1" color="$gray11">{Math.round(exportProgress)}%</Text>
                  </XStack>
                  <Progress value={exportProgress}>
                    <Progress.Indicator backgroundColor="$blue10" />
                  </Progress>
                </YStack>
              ) : exportStatus === 'success' ? (
                <XStack alignItems="center" gap="$2">
                  <Theme name="green">
                    <CheckCircle size={16} />
                  </Theme>
                  <Text color="$green10">{t('Export completed successfully!')}</Text>
                </XStack>
              ) : null}
            </YStack>
          )}
        </YStack>
      </CardContent>
      
      <CardFooter padding="$4" borderTopWidth={1} borderTopColor="$borderColor">
        <XStack alignItems="center" justifyContent="space-between" width="100%">
          <Button 
            theme="gray"
            onPress={onCancel}
          >
            {t('Cancel')}
          </Button>
          
          <XStack gap="$2">
            <Button
              theme="gray"
              icon={<Clipboard size={16} />}
              onPress={handleCopy}
              disabled={isLoading || exportStatus === 'exporting'}
            >
              {t('Copy to Clipboard')}
            </Button>
            
            <Button
              icon={<Download size={16} />}
              onPress={handleExport}
              disabled={isLoading || exportStatus === 'exporting'}
            >
              {t('Export')}
            </Button>
          </XStack>
        </XStack>
      </CardFooter>
    </Card>
  );
}

export default ChatExport;
