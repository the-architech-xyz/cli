'use client';

import React, { useState } from 'react';
import { 
  YStack, 
  XStack, 
  Button, 
  Text,
  Card,
  CardHeader,
  CardContent,
  CardDescription,
  Switch,
  Select,
  Label,
  Slider,
  Separator,
  Alert,
  Theme,
  Square
} from 'tamagui';
import { 
  Settings,
  Bot,
  MessageSquare,
  Save,
  Mic,
  Volume2,
  Zap,
  Clock,
  Shield,
  Lock,
  AlertTriangle,
  CheckCircle,
  Loader2
} from 'lucide-react-native';
import { useTranslation } from '@/lib/i18n';

interface ChatSettingsProps {
  onSave?: (settings: ChatSettingsData) => Promise<void>;
  initialSettings?: Partial<ChatSettingsData>;
  className?: string;
}

export interface ChatSettingsData {
  model: string;
  temperature: number;
  maxTokens: number;
  saveHistory: boolean;
  enableVoiceInput: boolean;
  enableVoiceOutput: boolean;
  autoSendAfterVoice: boolean;
  enableFileAttachments: boolean;
  enableCodeHighlighting: boolean;
  enableMarkdownFormatting: boolean;
  enableStreamingResponse: boolean;
  responseSpeed: 'fast' | 'balanced' | 'thorough';
  privacyLevel: 'standard' | 'enhanced' | 'maximum';
}

const defaultSettings: ChatSettingsData = {
  model: 'gpt-4',
  temperature: 0.7,
  maxTokens: 2000,
  saveHistory: true,
  enableVoiceInput: true,
  enableVoiceOutput: false,
  autoSendAfterVoice: true,
  enableFileAttachments: true,
  enableCodeHighlighting: true,
  enableMarkdownFormatting: true,
  enableStreamingResponse: true,
  responseSpeed: 'balanced',
  privacyLevel: 'standard',
};

export function ChatSettings({ 
  onSave, 
  initialSettings = {}, 
  className 
}: ChatSettingsProps) {
  const { t } = useTranslation();
  const [settings, setSettings] = useState<ChatSettingsData>({
    ...defaultSettings,
    ...initialSettings
  });
  const [isLoading, setIsLoading] = useState(false);
  const [success, setSuccess] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleSave = async () => {
    if (!onSave) return;
    
    setIsLoading(true);
    setError(null);
    setSuccess(false);
    
    try {
      await onSave(settings);
      setSuccess(true);
      setTimeout(() => setSuccess(false), 3000);
    } catch (err) {
      setError(err instanceof Error ? err.message : t('ai.chat.settings.errors.saveFailed'));
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <YStack space="$6" {...(className ? { className } : {})}>
      <XStack alignItems="center" gap="$2">
        <Settings size={24} />
        <Text fontSize="$6" fontWeight="$7">
          {t('ai.chat.settings.title')}
        </Text>
      </XStack>
      
      {error && (
        <Alert theme="red">
          <XStack alignItems="center" gap="$2">
            <AlertTriangle size={16} color="$red10" />
            <Text color="$red10">{error}</Text>
          </XStack>
        </Alert>
      )}
      
      {success && (
        <Alert theme="green">
          <XStack alignItems="center" gap="$2">
            <CheckCircle size={16} color="$green10" />
            <Text color="$green10">
              {t('ai.chat.settings.saveSuccess')}
            </Text>
          </XStack>
        </Alert>
      )}
      
      <Card elevate>
        <CardHeader>
          <XStack alignItems="center" gap="$2">
            <Bot size={20} />
            <Text fontSize="$5" fontWeight="$6">
              {t('ai.chat.settings.modelSettings')}
            </Text>
          </XStack>
          <Text fontSize="$2" color="$gray11">
            {t('ai.chat.settings.modelSettingsDescription')}
          </Text>
        </CardHeader>
        <CardContent space="$4">
          <YStack space="$2">
            <Label htmlFor="model">
              {t('ai.chat.settings.model')}
            </Label>
            <Select
              id="model"
              value={settings.model}
              onValueChange={(value) => setSettings(prev => ({ ...prev, model: value }))}
            >
              <Select.Trigger width="100%" id="model">
                <Select.Value placeholder={t('ai.chat.settings.selectModel')} />
              </Select.Trigger>
              <Select.Content>
                <Select.Item value="gpt-4">
                  <Select.ItemText>GPT-4</Select.ItemText>
                </Select.Item>
                <Select.Item value="gpt-4-turbo">
                  <Select.ItemText>GPT-4 Turbo</Select.ItemText>
                </Select.Item>
                <Select.Item value="gpt-3.5-turbo">
                  <Select.ItemText>GPT-3.5 Turbo</Select.ItemText>
                </Select.Item>
                <Select.Item value="claude-3">
                  <Select.ItemText>Claude 3</Select.ItemText>
                </Select.Item>
              </Select.Content>
            </Select>
          </YStack>
          
          <YStack space="$2">
            <Label htmlFor="temperature">
              {t('ai.chat.settings.temperature', { value: settings.temperature.toFixed(1) })}
            </Label>
            <Slider
              value={[settings.temperature]}
              onValueChange={([value]) => setSettings(prev => ({ ...prev, temperature: value }))}
              min={0}
              max={1}
              step={0.1}
              id="temperature"
            >
              <Slider.Track>
                <Slider.TrackActive />
              </Slider.Track>
              <Slider.Thumb circular index={0} />
            </Slider>
            <Text fontSize="$1" color="$gray10">
              {t('ai.chat.settings.temperatureDescription')}
            </Text>
          </YStack>
          
          <YStack space="$2">
            <Label htmlFor="maxTokens">
              {t('ai.chat.settings.maxTokens', { value: settings.maxTokens })}
            </Label>
            <Slider
              value={[settings.maxTokens]}
              onValueChange={([value]) => setSettings(prev => ({ ...prev, maxTokens: value }))}
              min={500}
              max={4000}
              step={100}
              id="maxTokens"
            >
              <Slider.Track>
                <Slider.TrackActive />
              </Slider.Track>
              <Slider.Thumb circular index={0} />
            </Slider>
            <Text fontSize="$1" color="$gray10">
              {t('ai.chat.settings.maxTokensDescription')}
            </Text>
          </YStack>
          
          <YStack space="$2">
            <Label htmlFor="responseSpeed">
              {t('ai.chat.settings.responseSpeed')}
            </Label>
            <Select
              id="responseSpeed"
              value={settings.responseSpeed}
              onValueChange={(value: any) => setSettings(prev => ({ ...prev, responseSpeed: value }))}
            >
              <Select.Trigger width="100%" id="responseSpeed">
                <Select.Value placeholder={t('ai.chat.settings.selectResponseSpeed')} />
              </Select.Trigger>
              <Select.Content>
                <Select.Item value="fast">
                  <Select.ItemText>{t('ai.chat.settings.fast')}</Select.ItemText>
                </Select.Item>
                <Select.Item value="balanced">
                  <Select.ItemText>{t('ai.chat.settings.balanced')}</Select.ItemText>
                </Select.Item>
                <Select.Item value="thorough">
                  <Select.ItemText>{t('ai.chat.settings.thorough')}</Select.ItemText>
                </Select.Item>
              </Select.Content>
            </Select>
          </YStack>
        </CardContent>
      </Card>
      
      <Card elevate>
        <CardHeader>
          <XStack alignItems="center" gap="$2">
            <MessageSquare size={20} />
            <Text fontSize="$5" fontWeight="$6">
              {t('ai.chat.settings.chatFeatures')}
            </Text>
          </XStack>
          <Text fontSize="$2" color="$gray11">
            {t('ai.chat.settings.chatFeaturesDescription')}
          </Text>
        </CardHeader>
        <CardContent space="$4">
          <XStack alignItems="center" justifyContent="space-between">
            <YStack>
              <Text fontWeight="$5">
                {t('ai.chat.settings.saveHistory')}
              </Text>
              <Text fontSize="$2" color="$gray10">
                {t('ai.chat.settings.saveHistoryDescription')}
              </Text>
            </YStack>
            <Switch
              checked={settings.saveHistory}
              onCheckedChange={(checked) => setSettings(prev => ({ ...prev, saveHistory: !!checked }))}
              size="$3"
            >
              <Switch.Thumb animation="quick" />
            </Switch>
          </XStack>
          
          <XStack alignItems="center" justifyContent="space-between">
            <YStack>
              <Text fontWeight="$5">
                {t('ai.chat.settings.enableVoiceInput')}
              </Text>
              <Text fontSize="$2" color="$gray10">
                {t('ai.chat.settings.enableVoiceInputDescription')}
              </Text>
            </YStack>
            <Switch
              checked={settings.enableVoiceInput}
              onCheckedChange={(checked) => setSettings(prev => ({ ...prev, enableVoiceInput: !!checked }))}
              size="$3"
            >
              <Switch.Thumb animation="quick" />
            </Switch>
          </XStack>
          
          <XStack alignItems="center" justifyContent="space-between">
            <YStack>
              <Text fontWeight="$5">
                {t('ai.chat.settings.enableVoiceOutput')}
              </Text>
              <Text fontSize="$2" color="$gray10">
                {t('ai.chat.settings.enableVoiceOutputDescription')}
              </Text>
            </YStack>
            <Switch
              checked={settings.enableVoiceOutput}
              onCheckedChange={(checked) => setSettings(prev => ({ ...prev, enableVoiceOutput: !!checked }))}
              size="$3"
            >
              <Switch.Thumb animation="quick" />
            </Switch>
          </XStack>
          
          <XStack alignItems="center" justifyContent="space-between">
            <YStack>
              <Text fontWeight="$5">
                {t('ai.chat.settings.enableFileAttachments')}
              </Text>
              <Text fontSize="$2" color="$gray10">
                {t('ai.chat.settings.enableFileAttachmentsDescription')}
              </Text>
            </YStack>
            <Switch
              checked={settings.enableFileAttachments}
              onCheckedChange={(checked) => setSettings(prev => ({ ...prev, enableFileAttachments: !!checked }))}
              size="$3"
            >
              <Switch.Thumb animation="quick" />
            </Switch>
          </XStack>
          
          <XStack alignItems="center" justifyContent="space-between">
            <YStack>
              <Text fontWeight="$5">
                {t('ai.chat.settings.enableCodeHighlighting')}
              </Text>
              <Text fontSize="$2" color="$gray10">
                {t('ai.chat.settings.enableCodeHighlightingDescription')}
              </Text>
            </YStack>
            <Switch
              checked={settings.enableCodeHighlighting}
              onCheckedChange={(checked) => setSettings(prev => ({ ...prev, enableCodeHighlighting: !!checked }))}
              size="$3"
            >
              <Switch.Thumb animation="quick" />
            </Switch>
          </XStack>
          
          <XStack alignItems="center" justifyContent="space-between">
            <YStack>
              <Text fontWeight="$5">
                {t('ai.chat.settings.enableMarkdownFormatting')}
              </Text>
              <Text fontSize="$2" color="$gray10">
                {t('ai.chat.settings.enableMarkdownFormattingDescription')}
              </Text>
            </YStack>
            <Switch
              checked={settings.enableMarkdownFormatting}
              onCheckedChange={(checked) => setSettings(prev => ({ ...prev, enableMarkdownFormatting: !!checked }))}
              size="$3"
            >
              <Switch.Thumb animation="quick" />
            </Switch>
          </XStack>
          
          <XStack alignItems="center" justifyContent="space-between">
            <YStack>
              <Text fontWeight="$5">
                {t('ai.chat.settings.enableStreamingResponse')}
              </Text>
              <Text fontSize="$2" color="$gray10">
                {t('ai.chat.settings.enableStreamingResponseDescription')}
              </Text>
            </YStack>
            <Switch
              checked={settings.enableStreamingResponse}
              onCheckedChange={(checked) => setSettings(prev => ({ ...prev, enableStreamingResponse: !!checked }))}
              size="$3"
            >
              <Switch.Thumb animation="quick" />
            </Switch>
          </XStack>
        </CardContent>
      </Card>
      
      <Card elevate>
        <CardHeader>
          <XStack alignItems="center" gap="$2">
            <Shield size={20} />
            <Text fontSize="$5" fontWeight="$6">
              {t('ai.chat.settings.privacy')}
            </Text>
          </XStack>
          <Text fontSize="$2" color="$gray11">
            {t('ai.chat.settings.privacyDescription')}
          </Text>
        </CardHeader>
        <CardContent space="$4">
          <YStack space="$2">
            <Label htmlFor="privacyLevel">
              {t('ai.chat.settings.privacyLevel')}
            </Label>
            <Select
              id="privacyLevel"
              value={settings.privacyLevel}
              onValueChange={(value: any) => setSettings(prev => ({ ...prev, privacyLevel: value }))}
            >
              <Select.Trigger width="100%" id="privacyLevel">
                <Select.Value placeholder={t('ai.chat.settings.selectPrivacyLevel')} />
              </Select.Trigger>
              <Select.Content>
                <Select.Item value="standard">
                  <Select.ItemText>{t('ai.chat.settings.standard')}</Select.ItemText>
                </Select.Item>
                <Select.Item value="enhanced">
                  <Select.ItemText>{t('ai.chat.settings.enhanced')}</Select.ItemText>
                </Select.Item>
                <Select.Item value="maximum">
                  <Select.ItemText>{t('ai.chat.settings.maximum')}</Select.ItemText>
                </Select.Item>
              </Select.Content>
            </Select>
            <Text fontSize="$1" color="$gray10">
              {t('ai.chat.settings.privacyLevelDescription')}
            </Text>
          </YStack>
        </CardContent>
      </Card>
      
      <XStack justifyContent="flex-end" gap="$2">
        <Button chromeless bordered>
          {t('common.actions.cancel')}
        </Button>
        <Button 
          theme="accent" 
          onPress={handleSave} 
          disabled={isLoading || !onSave}
          icon={isLoading ? 
            <Loader2 size={16} style={{ animation: 'spin 1s linear infinite' }} /> : 
            <Save size={16} />
          }
        >
          <Text marginLeft="$2">
            {isLoading ? 
              t('common.actions.saving') : 
              t('common.actions.saveChanges')
            }
          </Text>
        </Button>
      </XStack>
    </YStack>
  );
}

