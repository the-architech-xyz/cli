'use client';

import React, { useState, useRef } from 'react';
import { Copy, Check, Code } from 'lucide-react-native';
import { useTranslation } from '@/lib/i18n';
import { toast } from '@/hooks/use-toast';

import {
  YStack,
  XStack,
  Button,
  Card,
  CardContent,
  ScrollView,
  Text,
  Theme,
  Square
} from 'tamagui';

interface CodeBlockProps {
  language: string;
  code: string;
  showLineNumbers?: boolean;
  maxHeight?: number | string;
  allowCopy?: boolean;
}

export function CodeBlock({
  language,
  code,
  showLineNumbers = false,
  maxHeight = 384,
  allowCopy = true
}: CodeBlockProps) {
  const { t } = useTranslation();
  const [copied, setCopied] = useState(false);
  const codeRef = useRef<HTMLPreElement>(null);

  const handleCopy = async () => {
    try {
      await navigator.clipboard.writeText(code);
      setCopied(true);
      toast({
        title: t('common.copied'),
        description: t('chat.codeCopied'),
      });
      setTimeout(() => setCopied(false), 2000);
    } catch (error) {
      console.error('Failed to copy code:', error);
      toast({
        title: t('common.error'),
        description: t('chat.copyFailed'),
        variant: 'destructive',
      });
    }
  };

  // Split code into lines for line numbers
  const codeLines = code.split('\n');

  return (
    <Theme name="base">
      <Card
        overflow="hidden"
        elevate
        bordered
        marginVertical="$2"
      >
        <XStack 
          alignItems="center" 
          justifyContent="space-between" 
          paddingHorizontal="$4" 
          paddingVertical="$2"
          backgroundColor="$backgroundHover"
          borderBottomWidth={1}
          borderBottomColor="$borderColor"
        >
          <XStack alignItems="center" gap="$2">
            <Code size={16} />
            <Text fontWeight="$6" fontSize="$2">{language}</Text>
          </XStack>
          {allowCopy && (
            <Button
              size="$2"
              circular
              chromeless
              onPress={handleCopy}
              opacity={0}
              hoverStyle={{ opacity: 1 }}
              animation="quick"
            >
              <Square>
                {copied ? (
                  <Check size={12} color="$green10" />
                ) : (
                  <Copy size={12} />
                )}
              </Square>
            </Button>
          )}
        </XStack>
        <CardContent padding={0}>
          <ScrollView 
            horizontal 
            showsHorizontalScrollIndicator={true}
          >
            <ScrollView 
              showsVerticalScrollIndicator={true}
              maxHeight={maxHeight}
            >
              <XStack>
                {showLineNumbers && (
                  <YStack
                    padding="$4"
                    paddingRight="$2"
                    backgroundColor="$backgroundHover"
                    borderRightWidth={1}
                    borderRightColor="$borderColor"
                    alignItems="flex-end"
                  >
                    {codeLines.map((_, i) => (
                      <Text
                        key={`line-${i}`}
                        fontFamily="$mono"
                        fontSize="$2"
                        color="$colorFocus"
                        userSelect="none"
                      >
                        {i + 1}
                      </Text>
                    ))}
                  </YStack>
                )}
                <YStack
                  ref={codeRef}
                  padding="$4"
                  backgroundColor="$background"
                  flex={1}
                >
                  <Text 
                    fontFamily="$mono" 
                    fontSize="$2" 
                    whiteSpace="pre"
                    userSelect="text"
                  >
                    {code}
                  </Text>
                </YStack>
              </XStack>
            </ScrollView>
          </ScrollView>
        </CardContent>
      </Card>
    </Theme>
  );
}
