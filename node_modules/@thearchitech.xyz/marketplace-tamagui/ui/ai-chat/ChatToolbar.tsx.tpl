'use client';

import React, { useState } from 'react';
import { useTranslation } from '@/lib/i18n';
import {
  YStack,
  XStack,
  Button,
  Text,
  Badge,
  Select,
  SelectTrigger,
  SelectContent,
  SelectItem,
  SelectValue,
  Theme,
  Square,
  Popover,
  PopoverTrigger,
  PopoverContent,
  Separator
} from 'tamagui';
import {
  Bot,
  Settings,
  Sliders,
  Mic,
  Volume2,
  Upload,
  Download,
  Trash2,
  Share2,
  Copy,
  Save,
  RefreshCw,
  AlertCircle,
  CheckCircle,
  PlusCircle,
  ChevronDown,
  Sparkles,
  Brain,
  Cpu,
  Zap,
  MessageSquare,
  MoreHorizontal
} from 'lucide-react-native';

export interface ChatToolbarProps {
  onSettings?: () => void;
  onToggleMic?: () => void;
  onToggleVoice?: () => void;
  onUpload?: () => void;
  onDownload?: () => void;
  onClear?: () => void;
  onShare?: () => void;
  onCopy?: () => void;
  onSave?: () => void;
  onRefresh?: () => void;
  onNewChat?: () => void;
  onModelChange?: (modelId: string) => void;
  onTemperatureChange?: (temperature: number) => void;
  onMaxTokensChange?: (maxTokens: number) => void;
  micEnabled?: boolean;
  voiceEnabled?: boolean;
  selectedModel?: string;
  temperature?: number;
  maxTokens?: number;
  models?: { id: string; name: string; description?: string; maxTokens?: number }[];
  isResponding?: boolean;
  error?: string;
  showModels?: boolean;
  showAdvanced?: boolean;
  showMic?: boolean;
  showVoice?: boolean;
  compact?: boolean;
  vertical?: boolean;
}

export function ChatToolbar({
  onSettings,
  onToggleMic,
  onToggleVoice,
  onUpload,
  onDownload,
  onClear,
  onShare,
  onCopy,
  onSave,
  onRefresh,
  onNewChat,
  onModelChange,
  onTemperatureChange,
  onMaxTokensChange,
  micEnabled = false,
  voiceEnabled = false,
  selectedModel = 'gpt-4',
  temperature = 0.7,
  maxTokens = 2048,
  models = [
    { id: 'gpt-4', name: 'GPT-4', description: 'Most powerful model', maxTokens: 8192 },
    { id: 'gpt-3.5-turbo', name: 'GPT-3.5 Turbo', description: 'Fast and efficient', maxTokens: 4096 }
  ],
  isResponding = false,
  error = '',
  showModels = true,
  showAdvanced = true,
  showMic = true,
  showVoice = true,
  compact = false,
  vertical = false
}: ChatToolbarProps) {
  const { t } = useTranslation();
  const [showAdvancedSettings, setShowAdvancedSettings] = useState(false);
  
  const selectedModelObj = models.find(m => m.id === selectedModel) || models[0];
  
  const renderModelSelector = () => (
    <Select value={selectedModel} onValueChange={onModelChange}>
      <SelectTrigger width={compact ? 120 : 180} borderRadius="$4">
        <XStack alignItems="center" justifyContent="space-between" flex={1}>
          <XStack alignItems="center" gap="$2">
            <Bot size={14} />
            <SelectValue placeholder={t('Model')} />
          </XStack>
          <ChevronDown size={14} />
        </XStack>
      </SelectTrigger>
      <SelectContent>
        {models.map((model) => (
          <SelectItem key={model.id} value={model.id}>
            <XStack alignItems="center" justifyContent="space-between" width="100%">
              <Text>{model.name}</Text>
              {model.description && (
                <Text fontSize="$1" color="$gray11">{model.description}</Text>
              )}
            </XStack>
          </SelectItem>
        ))}
      </SelectContent>
    </Select>
  );
  
  const renderAdvancedSettings = () => (
    <Popover placement="bottom">
      <PopoverTrigger asChild>
        <Button
          size={compact ? "$2" : "$3"}
          theme="gray"
          icon={<Sliders size={compact ? 14 : 16} />}
        >
          {compact ? null : t('Advanced')}
        </Button>
      </PopoverTrigger>
      <PopoverContent padding="$4" width={300}>
        <YStack space="$4">
          <Text fontWeight="$6" fontSize="$4">{t('Model Settings')}</Text>
          
          <YStack space="$2">
            <Text fontWeight="$5">{t('Temperature')}: {temperature}</Text>
            <XStack alignItems="center" gap="$2">
              <Text fontSize="$1" color="$gray11">0</Text>
              <YStack
                as="input"
                type="range"
                min="0"
                max="1"
                step="0.1"
                value={temperature}
                onChange={(e: any) => onTemperatureChange?.(parseFloat(e.target.value))}
                flex={1}
                height={20}
              />
              <Text fontSize="$1" color="$gray11">1</Text>
            </XStack>
            <Text fontSize="$1" color="$gray11">
              {temperature < 0.3 
                ? t('More deterministic and focused') 
                : temperature > 0.7 
                  ? t('More creative and varied')
                  : t('Balanced responses')
              }
            </Text>
          </YStack>
          
          <YStack space="$2">
            <Text fontWeight="$5">{t('Max Tokens')}: {maxTokens}</Text>
            <XStack alignItems="center" gap="$2">
              <Text fontSize="$1" color="$gray11">1024</Text>
              <YStack
                as="input"
                type="range"
                min="1024"
                max={selectedModelObj.maxTokens || 8192}
                step="1024"
                value={maxTokens}
                onChange={(e: any) => onMaxTokensChange?.(parseInt(e.target.value))}
                flex={1}
                height={20}
              />
              <Text fontSize="$1" color="$gray11">{selectedModelObj.maxTokens || 8192}</Text>
            </XStack>
            <Text fontSize="$1" color="$gray11">
              {t('Maximum length of the generated response')}
            </Text>
          </YStack>
          
          <XStack alignItems="center" gap="$2">
            <Theme name="blue">
              <Badge size="$1">
                <Bot size={12} />
                <Text marginLeft="$1">{selectedModelObj.name}</Text>
              </Badge>
            </Theme>
            
            <Theme name={temperature < 0.3 ? "blue" : temperature > 0.7 ? "orange" : "green"}>
              <Badge size="$1">
                <Sparkles size={12} />
                <Text marginLeft="$1">
                  {temperature < 0.3 
                    ? t('Precise') 
                    : temperature > 0.7 
                      ? t('Creative')
                      : t('Balanced')
                  }
                </Text>
              </Badge>
            </Theme>
            
            <Theme name="purple">
              <Badge size="$1">
                <Zap size={12} />
                <Text marginLeft="$1">{maxTokens}</Text>
              </Badge>
            </Theme>
          </XStack>
        </YStack>
      </PopoverContent>
    </Popover>
  );
  
  const renderMainButtons = () => (
    <>
      {showMic && (
        <Button
          size={compact ? "$2" : "$3"}
          theme={micEnabled ? "blue" : "gray"}
          icon={<Mic size={compact ? 14 : 16} />}
          onPress={onToggleMic}
        >
          {compact ? null : t('Mic')}
        </Button>
      )}
      
      {showVoice && (
        <Button
          size={compact ? "$2" : "$3"}
          theme={voiceEnabled ? "blue" : "gray"}
          icon={<Volume2 size={compact ? 14 : 16} />}
          onPress={onToggleVoice}
        >
          {compact ? null : t('Voice')}
        </Button>
      )}
      
      <Button
        size={compact ? "$2" : "$3"}
        theme="gray"
        icon={<Upload size={compact ? 14 : 16} />}
        onPress={onUpload}
      >
        {compact ? null : t('Upload')}
      </Button>
      
      <Button
        size={compact ? "$2" : "$3"}
        theme="gray"
        icon={<Download size={compact ? 14 : 16} />}
        onPress={onDownload}
      >
        {compact ? null : t('Download')}
      </Button>
    </>
  );
  
  const renderMoreActions = () => (
    <Popover placement="bottom">
      <PopoverTrigger asChild>
        <Button
          size={compact ? "$2" : "$3"}
          theme="gray"
          icon={<MoreHorizontal size={compact ? 14 : 16} />}
        />
      </PopoverTrigger>
      <PopoverContent padding="$2" width={200}>
        <YStack>
          <Button
            size="$3"
            chromeless
            icon={<Trash2 size={16} />}
            onPress={onClear}
            justifyContent="flex-start"
          >
            {t('Clear Chat')}
          </Button>
          <Button
            size="$3"
            chromeless
            icon={<Share2 size={16} />}
            onPress={onShare}
            justifyContent="flex-start"
          >
            {t('Share')}
          </Button>
          <Button
            size="$3"
            chromeless
            icon={<Copy size={16} />}
            onPress={onCopy}
            justifyContent="flex-start"
          >
            {t('Copy All')}
          </Button>
          <Button
            size="$3"
            chromeless
            icon={<Save size={16} />}
            onPress={onSave}
            justifyContent="flex-start"
          >
            {t('Save Chat')}
          </Button>
          <Separator marginVertical="$2" />
          <Button
            size="$3"
            chromeless
            icon={<Settings size={16} />}
            onPress={onSettings}
            justifyContent="flex-start"
          >
            {t('Settings')}
          </Button>
        </YStack>
      </PopoverContent>
    </Popover>
  );
  
  // Status indicator
  const renderStatus = () => {
    if (error) {
      return (
        <XStack alignItems="center" gap="$1">
          <Theme name="red">
            <AlertCircle size={14} />
          </Theme>
          <Text fontSize="$2" color="$red10">{t('Error')}</Text>
        </XStack>
      );
    }
    
    if (isResponding) {
      return (
        <XStack alignItems="center" gap="$1">
          <Theme name="blue">
            <Square animation="pulse">
              <Bot size={14} />
            </Square>
          </Theme>
          <Text fontSize="$2" color="$blue10">{t('Responding...')}</Text>
        </XStack>
      );
    }
    
    return (
      <XStack alignItems="center" gap="$1">
        <Theme name="green">
          <CheckCircle size={14} />
        </Theme>
        <Text fontSize="$2" color="$green10">{t('Ready')}</Text>
      </XStack>
    );
  };
  
  // New chat button
  const renderNewChat = () => (
    <Button
      size={compact ? "$2" : "$3"}
      icon={<PlusCircle size={compact ? 14 : 16} />}
      onPress={onNewChat}
    >
      {compact ? null : t('New Chat')}
    </Button>
  );
  
  // Refresh button
  const renderRefresh = () => (
    <Button
      size={compact ? "$2" : "$3"}
      theme="gray"
      icon={<RefreshCw size={compact ? 14 : 16} />}
      onPress={onRefresh}
      disabled={isResponding}
    >
      {compact ? null : t('Refresh')}
    </Button>
  );
  
  if (vertical) {
    return (
      <YStack space="$2" padding="$2" borderRightWidth={1} borderRightColor="$borderColor">
        {renderNewChat()}
        <Separator />
        {showModels && renderModelSelector()}
        {showAdvanced && renderAdvancedSettings()}
        <Separator />
        {renderMainButtons()}
        {renderMoreActions()}
        <Separator />
        {renderRefresh()}
        <YStack flex={1} />
        {renderStatus()}
      </YStack>
    );
  }
  
  return (
    <XStack 
      alignItems="center" 
      justifyContent="space-between" 
      padding="$2"
      gap="$2"
      borderBottomWidth={1}
      borderBottomColor="$borderColor"
      flexWrap="wrap"
    >
      <XStack alignItems="center" gap="$2" flexWrap="wrap">
        {renderNewChat()}
        {showModels && renderModelSelector()}
        {showAdvanced && renderAdvancedSettings()}
      </XStack>
      
      <XStack alignItems="center" gap="$2" flexWrap="wrap">
        {renderMainButtons()}
        {renderMoreActions()}
        {renderRefresh()}
        {renderStatus()}
      </XStack>
    </XStack>
  );
}

export default ChatToolbar;
