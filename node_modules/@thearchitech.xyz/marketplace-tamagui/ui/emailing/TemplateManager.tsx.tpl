/**
 * Template Manager Component (Tamagui)
 * 
 * Email template management with i18n support
 */

import React, { useState } from 'react';
import { YStack, XStack, Card, Text, Button, Input, Label, TextArea, Badge, Separator, Tabs } from 'tamagui';
import { useForm, Controller } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { useTemplates, useCreateTemplate, useUpdateTemplate, useDeleteTemplate } from '@/lib/emailing';
import { useTranslation } from '@/lib/i18n';
import { Dialog, Adapt, Sheet } from 'tamagui';
import { 
  FileText, 
  Plus, 
  Edit, 
  Trash2, 
  Eye, 
  Copy, 
  Calendar,
  Tag,
  AlertCircle,
  CheckCircle,
  X
} from '@tamagui/lucide-icons';
import { format } from 'date-fns';
import { Spinner } from 'tamagui';
import type { EmailTemplate, TemplateFormData } from '@/lib/emailing';

const templateFormSchema = z.object({
  name: z.string().min(1, 'Template name is required'),
  subject: z.string().min(1, 'Subject is required'),
  content: z.string().min(1, 'Content is required'),
  htmlContent: z.string().optional(),
  variables: z.array(z.string()).default([]),
  category: z.string().optional(),
});

type TemplateFormValues = z.infer<typeof templateFormSchema>;

interface TemplateManagerProps {}

export function TemplateManager({}: TemplateManagerProps) {
  const { t, formatDate } = useTranslation();
  const [isDialogOpen, setIsDialogOpen] = useState(false);
  const [editingTemplate, setEditingTemplate] = useState<EmailTemplate | null>(null);
  const [selectedCategory, setSelectedCategory] = useState<string>('all');
  const [newVariable, setNewVariable] = useState('');

  const { templates = [], isLoading, error, refetch } = useTemplates({ 
    isActive: true,
    category: selectedCategory === 'all' ? undefined : selectedCategory
  });
  
  const createTemplate = useCreateTemplate();
  const updateTemplate = useUpdateTemplate();
  const deleteTemplate = useDeleteTemplate();

  const {
    control,
    handleSubmit,
    formState: { errors },
    reset,
    watch,
    setValue,
  } = useForm<TemplateFormValues>({
    resolver: zodResolver(templateFormSchema),
    defaultValues: {
      variables: [],
    },
  });

  const watchedVariables = watch('variables') || [];

  const categories = Array.from(new Set(templates.map(t => t.category).filter(Boolean)));

  const handleCreateTemplate = async (data: TemplateFormValues) => {
    try {
      await createTemplate.mutateAsync(data);
      setIsDialogOpen(false);
      reset();
    } catch (error) {
      console.error('Failed to create template:', error);
    }
  };

  const handleUpdateTemplate = async (data: TemplateFormValues) => {
    if (!editingTemplate) return;
    
    try {
      await updateTemplate.mutateAsync({
        id: editingTemplate.id,
        ...data,
      });
      setIsDialogOpen(false);
      setEditingTemplate(null);
      reset();
    } catch (error) {
      console.error('Failed to update template:', error);
    }
  };

  const handleEditTemplate = (template: EmailTemplate) => {
    setEditingTemplate(template);
    reset({
      name: template.name,
      subject: template.subject,
      content: template.content,
      htmlContent: template.htmlContent || '',
      variables: template.variables || [],
      category: template.category || '',
    });
    setIsDialogOpen(true);
  };

  const handleDeleteTemplate = async (template: EmailTemplate) => {
    if (confirm(t('template.delete.confirm', { name: template.name }))) {
      try {
        await deleteTemplate.mutateAsync(template.id);
      } catch (error) {
        console.error('Failed to delete template:', error);
      }
    }
  };

  const handleCloseDialog = () => {
    setIsDialogOpen(false);
    setEditingTemplate(null);
    reset();
  };

  const addVariable = () => {
    if (newVariable.trim() && !watchedVariables.includes(newVariable.trim())) {
      setValue('variables', [...watchedVariables, newVariable.trim()]);
      setNewVariable('');
    }
  };

  const removeVariable = (index: number) => {
    setValue('variables', watchedVariables.filter((_, i) => i !== index));
  };

  const copyTemplate = (template: EmailTemplate) => {
    navigator.clipboard.writeText(template.content);
  };

  if (error) {
    return (
      <Card
        theme="base"
        size="$4"
        padding="$6"
        backgroundColor="$background"
        borderWidth={1}
        borderColor="$borderColor"
        borderRadius="$6"
        elevation="$2"
      >
        <XStack
          backgroundColor="$red2"
          borderWidth={1}
          borderColor="$red6"
          borderRadius="$4"
          padding="$4"
          gap="$3"
          alignItems="center"
        >
          <AlertCircle size="$1" color="$red10" />
          <Text fontSize="$3" color="$red10">
            {t('template.error.load')}
          </Text>
        </XStack>
        <Button
          size="$4"
          backgroundColor="$backgroundHover"
          color="$color"
          borderWidth={1}
          borderColor="$borderColor"
          borderRadius="$4"
          onPress={() => refetch()}
          marginTop="$4"
        >
          <Text fontSize="$3">
            {t('common.retry')}
          </Text>
        </Button>
      </Card>
    );
  }

  return (
    <Card
      theme="base"
      size="$4"
      padding="$0"
      backgroundColor="$background"
      borderWidth={1}
      borderColor="$borderColor"
      borderRadius="$6"
      elevation="$2"
      width="100%"
    >
      <YStack padding="$6" paddingBottom="$2">
        <XStack justifyContent="space-between" alignItems="center">
          <YStack gap="$1">
            <XStack gap="$2" alignItems="center">
              <FileText size="$1" color="$color" />
              <Text fontSize="$5" fontWeight="bold" color="$color">
                {t('template.title')}
              </Text>
            </XStack>
            <Text fontSize="$3" color="$colorFocus">
              {t('template.description')}
            </Text>
          </YStack>
          
          <Button
            theme="accent"
            size="$3"
            backgroundColor="$blue10"
            color="white"
            borderRadius="$4"
            onPress={() => {
              handleCloseDialog();
              setIsDialogOpen(true);
            }}
          >
            <XStack gap="$2" alignItems="center">
              <Plus size="$1" color="white" />
              <Text fontSize="$3" fontWeight="bold" color="white">
                {t('template.new')}
              </Text>
            </XStack>
          </Button>
        </XStack>
      </YStack>

      <YStack padding="$6" paddingTop="$0" gap="$6">
        {/* Template Dialog */}
        <Dialog modal open={isDialogOpen} onOpenChange={setIsDialogOpen}>
          <Adapt when="sm" platform="touch">
            <Sheet
              modal
              dismissOnSnapToBottom
              snapPointsMode="fit"
            >
              <Sheet.Frame padding="$4">
                <Sheet.ScrollView>
                  <Adapt.Contents />
                </Sheet.ScrollView>
              </Sheet.Frame>
              <Sheet.Overlay />
            </Sheet>
          </Adapt>

          <Dialog.Portal>
            <Dialog.Overlay
              key="overlay"
              animation="quick"
              opacity={0.5}
              enterStyle={{ opacity: 0 }}
              exitStyle={{ opacity: 0 }}
            />
            <Dialog.Content
              bordered
              elevate
              key="content"
              animation={[
                'quick',
                {
                  opacity: {
                    overshootClamping: true,
                  },
                },
              ]}
              enterStyle={{ x: 0, y: -20, opacity: 0, scale: 0.9 }}
              exitStyle={{ x: 0, y: 10, opacity: 0, scale: 0.95 }}
              width="90%"
              maxWidth={800}
              padding="$5"
            >
              <YStack gap="$5">
                <YStack gap="$2">
                  <Dialog.Title>
                    <Text fontSize="$6" fontWeight="bold" color="$color">
                      {editingTemplate ? t('template.edit.title') : t('template.create.title')}
                    </Text>
                  </Dialog.Title>
                  <Dialog.Description>
                    <Text fontSize="$3" color="$colorFocus">
                      {editingTemplate ? t('template.edit.description') : t('template.create.description')}
                    </Text>
                  </Dialog.Description>
                </YStack>

                <YStack asChild gap="$4">
                  <form onSubmit={handleSubmit(editingTemplate ? handleUpdateTemplate : handleCreateTemplate)}>
                    <XStack flexWrap="wrap" gap="$4">
                      {/* Template Name */}
                      <YStack flex={1} minWidth={200} gap="$2">
                        <Label htmlFor="name" fontSize="$4" color="$color">
                          {t('template.form.name')}
                        </Label>
                        <Controller
                          control={control}
                          name="name"
                          render={({ field }) => (
                            <Input
                              id="name"
                              value={field.value || ''}
                              onChangeText={field.onChange}
                              placeholder={t('template.form.namePlaceholder')}
                              backgroundColor="$background"
                              color="$color"
                              borderWidth={1}
                              borderColor={errors.name ? '$red10' : '$borderColor'}
                              borderRadius="$4"
                              padding="$3"
                            />
                          )}
                        />
                        {errors.name && (
                          <Text fontSize="$2" color="$red10">
                            {errors.name.message}
                          </Text>
                        )}
                      </YStack>

                      {/* Category */}
                      <YStack flex={1} minWidth={200} gap="$2">
                        <Label htmlFor="category" fontSize="$4" color="$color">
                          {t('template.form.category')}
                        </Label>
                        <Controller
                          control={control}
                          name="category"
                          render={({ field }) => (
                            <Input
                              id="category"
                              value={field.value || ''}
                              onChangeText={field.onChange}
                              placeholder={t('template.form.categoryPlaceholder')}
                              backgroundColor="$background"
                              color="$color"
                              borderWidth={1}
                              borderColor="$borderColor"
                              borderRadius="$4"
                              padding="$3"
                            />
                          )}
                        />
                      </YStack>
                    </XStack>

                    {/* Subject */}
                    <YStack gap="$2">
                      <Label htmlFor="subject" fontSize="$4" color="$color">
                        {t('template.form.subject')}
                      </Label>
                      <Controller
                        control={control}
                        name="subject"
                        render={({ field }) => (
                          <Input
                            id="subject"
                            value={field.value || ''}
                            onChangeText={field.onChange}
                            placeholder={t('template.form.subjectPlaceholder')}
                            backgroundColor="$background"
                            color="$color"
                            borderWidth={1}
                            borderColor={errors.subject ? '$red10' : '$borderColor'}
                            borderRadius="$4"
                            padding="$3"
                          />
                        )}
                      />
                      {errors.subject && (
                        <Text fontSize="$2" color="$red10">
                          {errors.subject.message}
                        </Text>
                      )}
                    </YStack>

                    {/* Content */}
                    <YStack gap="$2">
                      <Label htmlFor="content" fontSize="$4" color="$color">
                        {t('template.form.content')}
                      </Label>
                      <Controller
                        control={control}
                        name="content"
                        render={({ field }) => (
                          <TextArea
                            id="content"
                            value={field.value || ''}
                            onChangeText={field.onChange}
                            placeholder={t('template.form.contentPlaceholder')}
                            backgroundColor="$background"
                            color="$color"
                            borderWidth={1}
                            borderColor={errors.content ? '$red10' : '$borderColor'}
                            borderRadius="$4"
                            padding="$3"
                            numberOfLines={6}
                          />
                        )}
                      />
                      {errors.content && (
                        <Text fontSize="$2" color="$red10">
                          {errors.content.message}
                        </Text>
                      )}
                    </YStack>

                    {/* HTML Content */}
                    <YStack gap="$2">
                      <Label htmlFor="htmlContent" fontSize="$4" color="$color">
                        {t('template.form.htmlContent')}
                      </Label>
                      <Controller
                        control={control}
                        name="htmlContent"
                        render={({ field }) => (
                          <TextArea
                            id="htmlContent"
                            value={field.value || ''}
                            onChangeText={field.onChange}
                            placeholder={t('template.form.htmlContentPlaceholder')}
                            backgroundColor="$background"
                            color="$color"
                            borderWidth={1}
                            borderColor="$borderColor"
                            borderRadius="$4"
                            padding="$3"
                            numberOfLines={4}
                          />
                        )}
                      />
                    </YStack>

                    {/* Variables */}
                    <YStack gap="$2">
                      <Label htmlFor="variables" fontSize="$4" color="$color">
                        {t('template.form.variables')}
                      </Label>
                      <XStack gap="$2">
                        <Input
                          id="variables"
                          value={newVariable}
                          onChangeText={setNewVariable}
                          placeholder={t('template.form.variablesPlaceholder')}
                          backgroundColor="$background"
                          color="$color"
                          borderWidth={1}
                          borderColor="$borderColor"
                          borderRadius="$4"
                          padding="$3"
                          flex={1}
                          onKeyPress={(e) => {
                            if (e.nativeEvent.key === 'Enter') {
                              e.preventDefault();
                              addVariable();
                            }
                          }}
                        />
                        <Button
                          size="$3"
                          backgroundColor="$backgroundHover"
                          color="$color"
                          borderWidth={1}
                          borderColor="$borderColor"
                          borderRadius="$4"
                          onPress={addVariable}
                        >
                          <Text fontSize="$3">
                            {t('template.form.addVariable')}
                          </Text>
                        </Button>
                      </XStack>
                      
                      {watchedVariables.length > 0 && (
                        <XStack flexWrap="wrap" gap="$2" marginTop="$2">
                          {watchedVariables.map((variable, index) => (
                            <Badge
                              key={index}
                              backgroundColor="$gray5"
                              borderRadius="$4"
                              size="$2"
                            >
                              <XStack gap="$1" alignItems="center">
                                <Text fontSize="$2" color="$color">
                                  {variable}
                                </Text>
                                <Button
                                  size="$1"
                                  backgroundColor="transparent"
                                  color="$red10"
                                  padding="$0"
                                  onPress={() => removeVariable(index)}
                                >
                                  <X size="$1" />
                                </Button>
                              </XStack>
                            </Badge>
                          ))}
                        </XStack>
                      )}
                    </YStack>

                    {/* Form Actions */}
                    <XStack justifyContent="flex-end" gap="$2" marginTop="$4">
                      <Button
                        size="$3"
                        backgroundColor="$backgroundHover"
                        color="$color"
                        borderWidth={1}
                        borderColor="$borderColor"
                        borderRadius="$4"
                        onPress={handleCloseDialog}
                      >
                        <Text fontSize="$3">
                          {t('common.cancel')}
                        </Text>
                      </Button>
                      <Button
                        theme="accent"
                        size="$3"
                        backgroundColor="$blue10"
                        color="white"
                        borderRadius="$4"
                        disabled={createTemplate.isPending || updateTemplate.isPending}
                        onPress={handleSubmit(editingTemplate ? handleUpdateTemplate : handleCreateTemplate)}
                      >
                        <XStack gap="$2" alignItems="center">
                          {(createTemplate.isPending || updateTemplate.isPending) && (
                            <Spinner size="small" color="white" />
                          )}
                          <Text fontSize="$3" fontWeight="bold" color="white">
                            {editingTemplate ? t('template.edit.submit') : t('template.create.submit')}
                          </Text>
                        </XStack>
                      </Button>
                    </XStack>
                  </form>
                </YStack>
              </YStack>

              <Dialog.Close asChild>
                <Button
                  position="absolute"
                  top="$3"
                  right="$3"
                  size="$2"
                  circular
                  backgroundColor="$backgroundHover"
                  onPress={handleCloseDialog}
                >
                  <X size="$1" />
                </Button>
              </Dialog.Close>
            </Dialog.Content>
          </Dialog.Portal>
        </Dialog>

        {/* Tabs and Template Table */}
        <YStack gap="$4">
          <Tabs
            value={selectedCategory}
            onValueChange={setSelectedCategory}
            orientation="horizontal"
            flexDirection="column"
            borderRadius="$4"
            borderWidth={0}
          >
            <Tabs.List
              backgroundColor="$backgroundHover"
              borderRadius="$4"
              padding="$1"
            >
              <Tabs.Tab
                value="all"
                backgroundColor={selectedCategory === 'all' ? '$background' : 'transparent'}
                borderRadius="$4"
                padding="$2"
              >
                <Text fontSize="$3" color="$color">
                  {t('template.tabs.all')}
                </Text>
              </Tabs.Tab>
              {categories.map((category) => (
                <Tabs.Tab
                  key={category}
                  value={category}
                  backgroundColor={selectedCategory === category ? '$background' : 'transparent'}
                  borderRadius="$4"
                  padding="$2"
                >
                  <Text fontSize="$3" color="$color">
                    {category}
                  </Text>
                </Tabs.Tab>
              ))}
            </Tabs.List>
          </Tabs>

          {/* Template Table */}
          <YStack
            borderWidth={1}
            borderColor="$borderColor"
            borderRadius="$4"
          >
            {/* Table Header */}
            <XStack
              backgroundColor="$gray2"
              padding="$3"
              borderBottomWidth={1}
              borderBottomColor="$borderColor"
            >
              <Text flex={2} fontWeight="bold" color="$color">
                {t('template.table.name')}
              </Text>
              <Text flex={3} fontWeight="bold" color="$color">
                {t('template.table.subject')}
              </Text>
              <Text flex={1} fontWeight="bold" color="$color">
                {t('template.table.category')}
              </Text>
              <Text flex={2} fontWeight="bold" color="$color">
                {t('template.table.variables')}
              </Text>
              <Text flex={1} fontWeight="bold" color="$color">
                {t('template.table.created')}
              </Text>
              <Text width={120} fontWeight="bold" color="$color">
                {t('template.table.actions')}
              </Text>
            </XStack>

            {/* Table Body */}
            {isLoading ? (
              // Loading skeletons
              <>
                {[1, 2, 3].map((i) => (
                  <XStack key={i} padding="$3" borderBottomWidth={1} borderBottomColor="$borderColor">
                    <XStack flex={2}>
                      <YStack width={120} height="$2" borderRadius="$2" backgroundColor="$gray5" />
                    </XStack>
                    <XStack flex={3}>
                      <YStack width={180} height="$2" borderRadius="$2" backgroundColor="$gray5" />
                    </XStack>
                    <XStack flex={1}>
                      <YStack width={60} height="$2" borderRadius="$2" backgroundColor="$gray5" />
                    </XStack>
                    <XStack flex={2}>
                      <YStack width={80} height="$2" borderRadius="$2" backgroundColor="$gray5" />
                    </XStack>
                    <XStack flex={1}>
                      <YStack width={80} height="$2" borderRadius="$2" backgroundColor="$gray5" />
                    </XStack>
                    <XStack width={120}>
                      <YStack width={80} height="$2" borderRadius="$2" backgroundColor="$gray5" />
                    </XStack>
                  </XStack>
                ))}
              </>
            ) : templates.length === 0 ? (
              // Empty state
              <XStack padding="$8" justifyContent="center">
                <Text color="$colorFocus">
                  {t('template.table.empty')}
                </Text>
              </XStack>
            ) : (
              // Template rows
              <>
                {templates.map((template) => (
                  <XStack 
                    key={template.id} 
                    padding="$3" 
                    borderBottomWidth={1} 
                    borderBottomColor="$borderColor"
                    hoverStyle={{ backgroundColor: '$backgroundHover' }}
                  >
                    <Text flex={2} color="$color" fontWeight="medium">
                      {template.name}
                    </Text>
                    <Text 
                      flex={3} 
                      color="$color" 
                      numberOfLines={1}
                      ellipsizeMode="tail"
                    >
                      {template.subject}
                    </Text>
                    <XStack flex={1} alignItems="center">
                      {template.category ? (
                        <Badge
                          backgroundColor="$gray5"
                          borderRadius="$4"
                          size="$2"
                        >
                          <Text fontSize="$2" color="$color">
                            {template.category}
                          </Text>
                        </Badge>
                      ) : (
                        <Text color="$colorFocus">-</Text>
                      )}
                    </XStack>
                    <XStack flex={2} alignItems="center">
                      {template.variables && template.variables.length > 0 ? (
                        <XStack flexWrap="wrap" gap="$1">
                          {template.variables.slice(0, 2).map((variable, index) => (
                            <Badge
                              key={index}
                              backgroundColor="$blue5"
                              borderRadius="$4"
                              size="$1"
                            >
                              <Text fontSize="$1" color="$blue10">
                                {variable}
                              </Text>
                            </Badge>
                          ))}
                          {template.variables.length > 2 && (
                            <Badge
                              backgroundColor="$gray5"
                              borderRadius="$4"
                              size="$1"
                            >
                              <Text fontSize="$1" color="$color">
                                +{template.variables.length - 2}
                              </Text>
                            </Badge>
                          )}
                        </XStack>
                      ) : (
                        <Text color="$colorFocus">-</Text>
                      )}
                    </XStack>
                    <Text flex={1} color="$colorFocus">
                      {format(new Date(template.createdAt), 'MMM d, yyyy')}
                    </Text>
                    <XStack width={120} gap="$1">
                      <Button
                        size="$2"
                        backgroundColor="transparent"
                        color="$color"
                        onPress={() => handleEditTemplate(template)}
                      >
                        <Edit size="$1" />
                      </Button>
                      <Button
                        size="$2"
                        backgroundColor="transparent"
                        color="$color"
                        onPress={() => copyTemplate(template)}
                      >
                        <Copy size="$1" />
                      </Button>
                      <Button
                        size="$2"
                        backgroundColor="transparent"
                        color="$red10"
                        onPress={() => handleDeleteTemplate(template)}
                      >
                        <Trash2 size="$1" />
                      </Button>
                    </XStack>
                  </XStack>
                ))}
              </>
            )}
          </YStack>
        </YStack>
      </YStack>
    </Card>
  );
}

export default TemplateManager;

