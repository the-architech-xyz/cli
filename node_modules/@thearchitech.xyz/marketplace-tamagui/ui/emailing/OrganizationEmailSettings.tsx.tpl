/**
 * Organization Email Settings Component (Tamagui)
 * 
 * Email settings management for organizations with i18n support
 */

import React, { useState } from 'react';
import { YStack, XStack, Card, Text, Button, Input, Label, Badge, Tabs, Checkbox } from 'tamagui';
import { useEmailContext } from '@/hooks/use-email-context';
import { useEmailAnalytics } from '@/hooks/emailing/hooks';
import { useTranslation } from '@/lib/i18n';
import { Select, Adapt, Sheet } from 'tamagui';
import { 
  Mail, 
  BarChart3, 
  Settings, 
  Users, 
  Shield, 
  AlertCircle,
  CheckCircle,
  Clock
} from '@tamagui/lucide-icons';
import { Spinner } from 'tamagui';

export function OrganizationEmailSettings() {
  const { t, formatDate } = useTranslation();
  const { 
    userContext, 
    isLoading: authLoading, 
    error: authError,
    canManageOrgSettings,
    canViewAnalytics,
    canManageTemplates,
    canManageCampaigns
  } = useEmailContext();
  
  const { analytics, isLoading: analyticsLoading } = useEmailAnalytics();
  const [isSaving, setIsSaving] = useState(false);
  const [activeTab, setActiveTab] = useState('overview');

  // For template rendering conditions
  const hasTemplates = true; // Replace with module.parameters.hasTemplates
  const hasBulkEmail = true; // Replace with module.parameters.hasBulkEmail
  const hasAnalytics = true; // Replace with module.parameters.hasAnalytics

  if (authLoading) {
    return (
      <YStack padding="$8" alignItems="center" justifyContent="center">
        <YStack alignItems="center" gap="$4">
          <Spinner size="large" color="$blue10" />
          <Text fontSize="$4" color="$colorFocus">
            {t('email.settings.loading')}
          </Text>
        </YStack>
      </YStack>
    );
  }

  if (authError) {
    return (
      <XStack
        backgroundColor="$red2"
        borderWidth={1}
        borderColor="$red6"
        borderRadius="$4"
        padding="$4"
        gap="$3"
        alignItems="center"
      >
        <AlertCircle size="$1" color="$red10" />
        <Text fontSize="$3" color="$red10">
          {t('email.settings.error', { message: authError.message })}
        </Text>
      </XStack>
    );
  }

  if (!userContext) {
    return (
      <XStack
        backgroundColor="$blue2"
        borderWidth={1}
        borderColor="$blue6"
        borderRadius="$4"
        padding="$4"
        gap="$3"
        alignItems="center"
      >
        <AlertCircle size="$1" color="$blue10" />
        <Text fontSize="$3" color="$blue10">
          {t('email.settings.signInRequired')}
        </Text>
      </XStack>
    );
  }

  if (!canManageOrgSettings) {
    return (
      <XStack
        backgroundColor="$yellow2"
        borderWidth={1}
        borderColor="$yellow6"
        borderRadius="$4"
        padding="$4"
        gap="$3"
        alignItems="center"
      >
        <Shield size="$1" color="$yellow10" />
        <Text fontSize="$3" color="$yellow10">
          {t('email.settings.permissionRequired')}
        </Text>
      </XStack>
    );
  }

  return (
    <YStack gap="$6">
      <XStack justifyContent="space-between" alignItems="center">
        <YStack>
          <Text fontSize="$7" fontWeight="bold" color="$color">
            {t('email.settings.title')}
          </Text>
          <Text fontSize="$4" color="$colorFocus">
            {t('email.settings.subtitle', { org: userContext.organizationId })}
          </Text>
        </YStack>
        <Badge
          backgroundColor="$gray5"
          borderRadius="$4"
          size="$3"
        >
          <XStack gap="$2" alignItems="center">
            <Users size="$1" color="$color" />
            <Text fontSize="$3" color="$color">
              {t('email.settings.orgOwner')}
            </Text>
          </XStack>
        </Badge>
      </XStack>

      <Tabs
        value={activeTab}
        onValueChange={setActiveTab}
        orientation="horizontal"
        flexDirection="column"
        borderRadius="$4"
        borderWidth={0}
      >
        <Tabs.List
          backgroundColor="$backgroundHover"
          borderRadius="$4"
          padding="$1"
        >
          <Tabs.Tab
            value="overview"
            backgroundColor={activeTab === 'overview' ? '$background' : 'transparent'}
            borderRadius="$4"
            padding="$2"
          >
            <Text fontSize="$3" color="$color">
              {t('email.settings.tabs.overview')}
            </Text>
          </Tabs.Tab>
          {hasTemplates && (
            <Tabs.Tab
              value="templates"
              backgroundColor={activeTab === 'templates' ? '$background' : 'transparent'}
              borderRadius="$4"
              padding="$2"
            >
              <Text fontSize="$3" color="$color">
                {t('email.settings.tabs.templates')}
              </Text>
            </Tabs.Tab>
          )}
          {hasBulkEmail && (
            <Tabs.Tab
              value="campaigns"
              backgroundColor={activeTab === 'campaigns' ? '$background' : 'transparent'}
              borderRadius="$4"
              padding="$2"
            >
              <Text fontSize="$3" color="$color">
                {t('email.settings.tabs.campaigns')}
              </Text>
            </Tabs.Tab>
          )}
          {hasAnalytics && (
            <Tabs.Tab
              value="analytics"
              backgroundColor={activeTab === 'analytics' ? '$background' : 'transparent'}
              borderRadius="$4"
              padding="$2"
            >
              <Text fontSize="$3" color="$color">
                {t('email.settings.tabs.analytics')}
              </Text>
            </Tabs.Tab>
          )}
          <Tabs.Tab
            value="settings"
            backgroundColor={activeTab === 'settings' ? '$background' : 'transparent'}
            borderRadius="$4"
            padding="$2"
          >
            <Text fontSize="$3" color="$color">
              {t('email.settings.tabs.settings')}
            </Text>
          </Tabs.Tab>
        </Tabs.List>

        {/* Overview Tab */}
        {activeTab === 'overview' && (
          <YStack gap="$6" marginTop="$6">
            <XStack flexWrap="wrap" gap="$4">
              {/* Emails Sent */}
              <Card
                theme="base"
                size="$4"
                padding="$0"
                backgroundColor="$background"
                borderWidth={1}
                borderColor="$borderColor"
                borderRadius="$6"
                elevation="$2"
                flex={1}
                minWidth={200}
              >
                <YStack padding="$4" paddingBottom="$2">
                  <XStack justifyContent="space-between" alignItems="center">
                    <Text fontSize="$3" fontWeight="medium" color="$color">
                      {t('email.settings.metrics.sent')}
                    </Text>
                    <Mail size="$1" color="$colorFocus" />
                  </XStack>
                </YStack>
                <YStack padding="$4" paddingTop="$0">
                  <Text fontSize="$6" fontWeight="bold" color="$color">
                    {analytics?.totalSent || 0}
                  </Text>
                  <Text fontSize="$2" color="$colorFocus">
                    {t('email.settings.metrics.thisMonth')}
                  </Text>
                </YStack>
              </Card>

              {/* Open Rate */}
              <Card
                theme="base"
                size="$4"
                padding="$0"
                backgroundColor="$background"
                borderWidth={1}
                borderColor="$borderColor"
                borderRadius="$6"
                elevation="$2"
                flex={1}
                minWidth={200}
              >
                <YStack padding="$4" paddingBottom="$2">
                  <XStack justifyContent="space-between" alignItems="center">
                    <Text fontSize="$3" fontWeight="medium" color="$color">
                      {t('email.settings.metrics.openRate')}
                    </Text>
                    <BarChart3 size="$1" color="$colorFocus" />
                  </XStack>
                </YStack>
                <YStack padding="$4" paddingTop="$0">
                  <Text fontSize="$6" fontWeight="bold" color="$color">
                    {analytics?.openRate ? `${(analytics.openRate * 100).toFixed(1)}%` : '0%'}
                  </Text>
                  <Text fontSize="$2" color="$colorFocus">
                    {t('email.settings.metrics.averageOpen')}
                  </Text>
                </YStack>
              </Card>

              {/* Click Rate */}
              <Card
                theme="base"
                size="$4"
                padding="$0"
                backgroundColor="$background"
                borderWidth={1}
                borderColor="$borderColor"
                borderRadius="$6"
                elevation="$2"
                flex={1}
                minWidth={200}
              >
                <YStack padding="$4" paddingBottom="$2">
                  <XStack justifyContent="space-between" alignItems="center">
                    <Text fontSize="$3" fontWeight="medium" color="$color">
                      {t('email.settings.metrics.clickRate')}
                    </Text>
                    <BarChart3 size="$1" color="$colorFocus" />
                  </XStack>
                </YStack>
                <YStack padding="$4" paddingTop="$0">
                  <Text fontSize="$6" fontWeight="bold" color="$color">
                    {analytics?.clickRate ? `${(analytics.clickRate * 100).toFixed(1)}%` : '0%'}
                  </Text>
                  <Text fontSize="$2" color="$colorFocus">
                    {t('email.settings.metrics.averageClick')}
                  </Text>
                </YStack>
              </Card>

              {/* Bounce Rate */}
              <Card
                theme="base"
                size="$4"
                padding="$0"
                backgroundColor="$background"
                borderWidth={1}
                borderColor="$borderColor"
                borderRadius="$6"
                elevation="$2"
                flex={1}
                minWidth={200}
              >
                <YStack padding="$4" paddingBottom="$2">
                  <XStack justifyContent="space-between" alignItems="center">
                    <Text fontSize="$3" fontWeight="medium" color="$color">
                      {t('email.settings.metrics.bounceRate')}
                    </Text>
                    <AlertCircle size="$1" color="$colorFocus" />
                  </XStack>
                </YStack>
                <YStack padding="$4" paddingTop="$0">
                  <Text fontSize="$6" fontWeight="bold" color="$color">
                    {analytics?.bounceRate ? `${(analytics.bounceRate * 100).toFixed(1)}%` : '0%'}
                  </Text>
                  <Text fontSize="$2" color="$colorFocus">
                    {t('email.settings.metrics.averageBounce')}
                  </Text>
                </YStack>
              </Card>
            </XStack>

            {/* Recent Activity */}
            <Card
              theme="base"
              size="$4"
              padding="$0"
              backgroundColor="$background"
              borderWidth={1}
              borderColor="$borderColor"
              borderRadius="$6"
              elevation="$2"
            >
              <YStack padding="$6" paddingBottom="$2">
                <Text fontSize="$5" fontWeight="bold" color="$color">
                  {t('email.settings.activity.title')}
                </Text>
                <Text fontSize="$3" color="$colorFocus">
                  {t('email.settings.activity.description')}
                </Text>
              </YStack>
              
              <YStack padding="$6" paddingTop="$0">
                {analytics?.recentActivity && analytics.recentActivity.length > 0 ? (
                  <YStack gap="$2">
                    {analytics.recentActivity.slice(0, 5).map((activity) => (
                      <XStack 
                        key={activity.id} 
                        justifyContent="space-between" 
                        alignItems="center"
                        padding="$3"
                        borderWidth={1}
                        borderColor="$borderColor"
                        borderRadius="$4"
                      >
                        <XStack gap="$3" alignItems="center">
                          <Mail size="$1" color="$colorFocus" />
                          <YStack>
                            <Text fontSize="$3" fontWeight="medium" color="$color">
                              {activity.subject}
                            </Text>
                            <Text fontSize="$2" color="$colorFocus">
                              {formatDate(activity.sentAt)}
                            </Text>
                          </YStack>
                        </XStack>
                        <Badge
                          backgroundColor={activity.status === 'sent' ? '$green10' : '$gray5'}
                          color={activity.status === 'sent' ? 'white' : '$color'}
                          borderRadius="$4"
                          size="$2"
                        >
                          <Text fontSize="$2" fontWeight="bold">
                            {activity.status}
                          </Text>
                        </Badge>
                      </XStack>
                    ))}
                  </YStack>
                ) : (
                  <YStack padding="$8" alignItems="center">
                    <Text color="$colorFocus">
                      {t('email.settings.activity.empty')}
                    </Text>
                  </YStack>
                )}
              </YStack>
            </Card>
          </YStack>
        )}

        {/* Templates Tab */}
        {activeTab === 'templates' && hasTemplates && (
          <YStack gap="$6" marginTop="$6">
            <Card
              theme="base"
              size="$4"
              padding="$0"
              backgroundColor="$background"
              borderWidth={1}
              borderColor="$borderColor"
              borderRadius="$6"
              elevation="$2"
            >
              <YStack padding="$6" paddingBottom="$2">
                <Text fontSize="$5" fontWeight="bold" color="$color">
                  {t('email.settings.templates.title')}
                </Text>
                <Text fontSize="$3" color="$colorFocus">
                  {t('email.settings.templates.description')}
                </Text>
              </YStack>
              
              <YStack padding="$6" paddingTop="$0">
                {canManageTemplates ? (
                  <YStack gap="$4">
                    <XStack justifyContent="space-between" alignItems="center">
                      <Text color="$color">
                        {t('email.settings.templates.managedBy')}
                      </Text>
                      <Button
                        theme="accent"
                        size="$3"
                        backgroundColor="$blue10"
                        color="white"
                        borderRadius="$4"
                      >
                        <Text fontSize="$3" fontWeight="bold" color="white">
                          {t('email.settings.templates.create')}
                        </Text>
                      </Button>
                    </XStack>
                    <Text fontSize="$3" color="$colorFocus">
                      {t('email.settings.templates.comingSoon')}
                    </Text>
                  </YStack>
                ) : (
                  <XStack
                    backgroundColor="$yellow2"
                    borderWidth={1}
                    borderColor="$yellow6"
                    borderRadius="$4"
                    padding="$4"
                    gap="$3"
                    alignItems="center"
                  >
                    <Shield size="$1" color="$yellow10" />
                    <Text fontSize="$3" color="$yellow10">
                      {t('email.settings.templates.noPermission')}
                    </Text>
                  </XStack>
                )}
              </YStack>
            </Card>
          </YStack>
        )}

        {/* Campaigns Tab */}
        {activeTab === 'campaigns' && hasBulkEmail && (
          <YStack gap="$6" marginTop="$6">
            <Card
              theme="base"
              size="$4"
              padding="$0"
              backgroundColor="$background"
              borderWidth={1}
              borderColor="$borderColor"
              borderRadius="$6"
              elevation="$2"
            >
              <YStack padding="$6" paddingBottom="$2">
                <Text fontSize="$5" fontWeight="bold" color="$color">
                  {t('email.settings.campaigns.title')}
                </Text>
                <Text fontSize="$3" color="$colorFocus">
                  {t('email.settings.campaigns.description')}
                </Text>
              </YStack>
              
              <YStack padding="$6" paddingTop="$0">
                {canManageCampaigns ? (
                  <YStack gap="$4">
                    <XStack justifyContent="space-between" alignItems="center">
                      <Text color="$color">
                        {t('email.settings.campaigns.managedBy')}
                      </Text>
                      <Button
                        theme="accent"
                        size="$3"
                        backgroundColor="$blue10"
                        color="white"
                        borderRadius="$4"
                      >
                        <Text fontSize="$3" fontWeight="bold" color="white">
                          {t('email.settings.campaigns.create')}
                        </Text>
                      </Button>
                    </XStack>
                    <Text fontSize="$3" color="$colorFocus">
                      {t('email.settings.campaigns.comingSoon')}
                    </Text>
                  </YStack>
                ) : (
                  <XStack
                    backgroundColor="$yellow2"
                    borderWidth={1}
                    borderColor="$yellow6"
                    borderRadius="$4"
                    padding="$4"
                    gap="$3"
                    alignItems="center"
                  >
                    <Shield size="$1" color="$yellow10" />
                    <Text fontSize="$3" color="$yellow10">
                      {t('email.settings.campaigns.noPermission')}
                    </Text>
                  </XStack>
                )}
              </YStack>
            </Card>
          </YStack>
        )}

        {/* Analytics Tab */}
        {activeTab === 'analytics' && hasAnalytics && (
          <YStack gap="$6" marginTop="$6">
            <Card
              theme="base"
              size="$4"
              padding="$0"
              backgroundColor="$background"
              borderWidth={1}
              borderColor="$borderColor"
              borderRadius="$6"
              elevation="$2"
            >
              <YStack padding="$6" paddingBottom="$2">
                <Text fontSize="$5" fontWeight="bold" color="$color">
                  {t('email.settings.analyticsTab.title')}
                </Text>
                <Text fontSize="$3" color="$colorFocus">
                  {t('email.settings.analyticsTab.description')}
                </Text>
              </YStack>
              
              <YStack padding="$6" paddingTop="$0">
                {canViewAnalytics ? (
                  <YStack gap="$4">
                    <Text color="$color">
                      {t('email.settings.analyticsTab.detailedInfo')}
                    </Text>
                    <Text fontSize="$3" color="$colorFocus">
                      {t('email.settings.analyticsTab.comingSoon')}
                    </Text>
                  </YStack>
                ) : (
                  <XStack
                    backgroundColor="$yellow2"
                    borderWidth={1}
                    borderColor="$yellow6"
                    borderRadius="$4"
                    padding="$4"
                    gap="$3"
                    alignItems="center"
                  >
                    <Shield size="$1" color="$yellow10" />
                    <Text fontSize="$3" color="$yellow10">
                      {t('email.settings.analyticsTab.noPermission')}
                    </Text>
                  </XStack>
                )}
              </YStack>
            </Card>
          </YStack>
        )}

        {/* Settings Tab */}
        {activeTab === 'settings' && (
          <YStack gap="$6" marginTop="$6">
            <Card
              theme="base"
              size="$4"
              padding="$0"
              backgroundColor="$background"
              borderWidth={1}
              borderColor="$borderColor"
              borderRadius="$6"
              elevation="$2"
            >
              <YStack padding="$6" paddingBottom="$2">
                <Text fontSize="$5" fontWeight="bold" color="$color">
                  {t('email.settings.config.title')}
                </Text>
                <Text fontSize="$3" color="$colorFocus">
                  {t('email.settings.config.description')}
                </Text>
              </YStack>
              
              <YStack padding="$6" paddingTop="$0" gap="$4">
                {/* From Email */}
                <YStack gap="$2">
                  <Label htmlFor="from-email" fontSize="$4" color="$color">
                    {t('email.settings.config.fromEmail')}
                  </Label>
                  <Input
                    id="from-email"
                    placeholder={t('email.settings.config.fromEmailPlaceholder')}
                    defaultValue="noreply@yourcompany.com"
                    backgroundColor="$background"
                    color="$color"
                    borderWidth={1}
                    borderColor="$borderColor"
                    borderRadius="$4"
                    padding="$3"
                  />
                </YStack>
                
                {/* Reply-To Email */}
                <YStack gap="$2">
                  <Label htmlFor="reply-to" fontSize="$4" color="$color">
                    {t('email.settings.config.replyTo')}
                  </Label>
                  <Input
                    id="reply-to"
                    placeholder={t('email.settings.config.replyToPlaceholder')}
                    defaultValue="support@yourcompany.com"
                    backgroundColor="$background"
                    color="$color"
                    borderWidth={1}
                    borderColor="$borderColor"
                    borderRadius="$4"
                    padding="$3"
                  />
                </YStack>

                {/* Daily Email Limit */}
                <YStack gap="$2">
                  <Label htmlFor="daily-limit" fontSize="$4" color="$color">
                    {t('email.settings.config.dailyLimit')}
                  </Label>
                  <Select defaultValue="1000">
                    <Select.Trigger
                      id="daily-limit"
                      backgroundColor="$background"
                      borderColor="$borderColor"
                      borderRadius="$4"
                    >
                      <Select.Value placeholder={t('email.settings.config.selectLimit')} />
                    </Select.Trigger>

                    <Adapt when="sm" platform="touch">
                      <Sheet
                        modal
                        dismissOnSnapToBottom
                        snapPointsMode="fit"
                      >
                        <Sheet.Frame>
                          <Sheet.ScrollView>
                            <Adapt.Contents />
                          </Sheet.ScrollView>
                        </Sheet.Frame>
                        <Sheet.Overlay />
                      </Sheet>
                    </Adapt>

                    <Select.Content zIndex={200000}>
                      <Select.ScrollUpButton />
                      <Select.Viewport minHeight={120}>
                        <Select.Group>
                          <Select.Item index={0} value="100">
                            <Select.ItemText>{t('email.settings.config.limit100')}</Select.ItemText>
                          </Select.Item>
                          <Select.Item index={1} value="500">
                            <Select.ItemText>{t('email.settings.config.limit500')}</Select.ItemText>
                          </Select.Item>
                          <Select.Item index={2} value="1000">
                            <Select.ItemText>{t('email.settings.config.limit1000')}</Select.ItemText>
                          </Select.Item>
                          <Select.Item index={3} value="5000">
                            <Select.ItemText>{t('email.settings.config.limit5000')}</Select.ItemText>
                          </Select.Item>
                          <Select.Item index={4} value="unlimited">
                            <Select.ItemText>{t('email.settings.config.limitUnlimited')}</Select.ItemText>
                          </Select.Item>
                        </Select.Group>
                      </Select.Viewport>
                      <Select.ScrollDownButton />
                    </Select.Content>
                  </Select>
                </YStack>

                {/* Tracking Options */}
                <XStack gap="$2" alignItems="center">
                  <Checkbox
                    id="track-opens"
                    size="$3"
                    defaultChecked={true}
                    backgroundColor="$blue10"
                    borderWidth={1}
                    borderColor="$blue10"
                  >
                    <Checkbox.Indicator>
                      <CheckCircle size="$1" color="white" />
                    </Checkbox.Indicator>
                  </Checkbox>
                  <Label htmlFor="track-opens" fontSize="$4" color="$color">
                    {t('email.settings.config.trackOpens')}
                  </Label>
                </XStack>

                <XStack gap="$2" alignItems="center">
                  <Checkbox
                    id="track-clicks"
                    size="$3"
                    defaultChecked={true}
                    backgroundColor="$blue10"
                    borderWidth={1}
                    borderColor="$blue10"
                  >
                    <Checkbox.Indicator>
                      <CheckCircle size="$1" color="white" />
                    </Checkbox.Indicator>
                  </Checkbox>
                  <Label htmlFor="track-clicks" fontSize="$4" color="$color">
                    {t('email.settings.config.trackClicks')}
                  </Label>
                </XStack>

                {/* Save Button */}
                <Button
                  theme="accent"
                  size="$4"
                  backgroundColor={isSaving ? "$backgroundHover" : "$blue10"}
                  color="white"
                  borderRadius="$4"
                  onPress={() => setIsSaving(true)}
                  disabled={isSaving}
                  marginTop="$2"
                >
                  <XStack gap="$2" alignItems="center">
                    {isSaving && <Spinner size="small" color="white" />}
                    <Text fontSize="$4" fontWeight="bold" color="white">
                      {isSaving ? t('email.settings.config.saving') : t('email.settings.config.save')}
                    </Text>
                  </XStack>
                </Button>
              </YStack>
            </Card>
          </YStack>
        )}
      </Tabs>
    </YStack>
  );
}

export default OrganizationEmailSettings;

