/**
 * Email List Component (Tamagui)
 * 
 * Email list management with i18n support
 */

import React, { useState } from 'react';
import { YStack, XStack, Card, Text, Button, Input, Badge, Separator } from 'tamagui';
import { format } from 'date-fns';
import { useEmails, useEmailAnalytics } from '@/lib/emailing';
import { useTranslation } from '@/lib/i18n';
import { Select, Adapt, Sheet } from 'tamagui';
import { 
  Mail, 
  Search, 
  Filter, 
  Calendar, 
  Eye, 
  MousePointer, 
  AlertCircle,
  CheckCircle,
  Clock,
  XCircle,
  Loader2,
  RefreshCw
} from '@tamagui/lucide-icons';
import type { EmailListFilters, EmailStatus } from '@/lib/emailing';

const statusConfig: Record<EmailStatus, { label: string; color: string; textColor: string }> = {
  draft: { label: 'Draft', color: '$gray5', textColor: '$color' },
  sending: { label: 'Sending', color: '$blue5', textColor: '$blue10' },
  sent: { label: 'Sent', color: '$green5', textColor: '$green10' },
  delivered: { label: 'Delivered', color: '$green10', textColor: 'white' },
  opened: { label: 'Opened', color: '$blue10', textColor: 'white' },
  clicked: { label: 'Clicked', color: '$purple10', textColor: 'white' },
  bounced: { label: 'Bounced', color: '$red10', textColor: 'white' },
  failed: { label: 'Failed', color: '$red10', textColor: 'white' },
  scheduled: { label: 'Scheduled', color: '$yellow5', textColor: '$yellow10' },
};

const statusIcons: Record<EmailStatus, React.ComponentType<{ size?: any; color?: any }>> = {
  draft: Clock,
  sending: Loader2,
  sent: CheckCircle,
  delivered: CheckCircle,
  opened: Eye,
  clicked: MousePointer,
  bounced: XCircle,
  failed: AlertCircle,
  scheduled: Clock,
};

interface EmailListProps {}

export function EmailList({}: EmailListProps) {
  const { t, formatDate } = useTranslation();
  const [filters, setFilters] = useState<EmailListFilters>({});
  const [searchTerm, setSearchTerm] = useState('');

  const { emails = [], isLoading, error, refetch, hasMore, loadMore } = useEmails(filters);
  const { analytics } = useEmailAnalytics();

  const handleStatusFilter = (status: string) => {
    setFilters(prev => ({
      ...prev,
      status: status === 'all' ? undefined : status as EmailStatus,
    }));
  };

  const handleSearch = (value: string) => {
    setSearchTerm(value);
    setFilters(prev => ({
      ...prev,
      search: value || undefined,
    }));
  };

  const handleDateFilter = (range: string) => {
    const now = new Date();
    let dateFrom: Date | undefined;
    let dateTo: Date | undefined;

    switch (range) {
      case 'today':
        dateFrom = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        dateTo = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
        break;
      case 'week':
        dateFrom = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        break;
      case 'month':
        dateFrom = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
        break;
      case 'all':
      default:
        dateFrom = undefined;
        dateTo = undefined;
        break;
    }

    setFilters(prev => ({
      ...prev,
      dateFrom,
      dateTo,
    }));
  };

  if (error) {
    return (
      <Card
        theme="base"
        size="$4"
        padding="$6"
        backgroundColor="$background"
        borderWidth={1}
        borderColor="$borderColor"
        borderRadius="$6"
        elevation="$2"
      >
        <XStack
          backgroundColor="$red2"
          borderWidth={1}
          borderColor="$red6"
          borderRadius="$4"
          padding="$4"
          gap="$3"
          alignItems="center"
        >
          <AlertCircle size="$1" color="$red10" />
          <Text fontSize="$3" color="$red10">
            {t('email.list.error')}
          </Text>
        </XStack>
        <Button
          size="$4"
          backgroundColor="$backgroundHover"
          color="$color"
          borderWidth={1}
          borderColor="$borderColor"
          borderRadius="$4"
          onPress={() => refetch()}
          marginTop="$4"
        >
          <XStack gap="$2" alignItems="center">
            <RefreshCw size="$1" color="$color" />
            <Text fontSize="$3">
              {t('common.retry')}
            </Text>
          </XStack>
        </Button>
      </Card>
    );
  }

  return (
    <Card
      theme="base"
      size="$4"
      padding="$0"
      backgroundColor="$background"
      borderWidth={1}
      borderColor="$borderColor"
      borderRadius="$6"
      elevation="$2"
      width="100%"
    >
      <YStack padding="$6" paddingBottom="$2">
        <XStack justifyContent="space-between" alignItems="center">
          <YStack gap="$1">
            <XStack gap="$2" alignItems="center">
              <Mail size="$1" color="$color" />
              <Text fontSize="$5" fontWeight="bold" color="$color">
                {t('email.list.title')}
              </Text>
            </XStack>
            <Text fontSize="$3" color="$colorFocus">
              {t('email.list.description')}
            </Text>
          </YStack>
          <Button
            size="$3"
            backgroundColor="$backgroundHover"
            color="$color"
            borderWidth={1}
            borderColor="$borderColor"
            borderRadius="$4"
            onPress={() => refetch()}
          >
            <XStack gap="$2" alignItems="center">
              <RefreshCw size="$1" color="$color" />
              <Text fontSize="$3">
                {t('email.list.refresh')}
              </Text>
            </XStack>
          </Button>
        </XStack>
      </YStack>

      <YStack padding="$6" paddingTop="$0" gap="$6">
        {/* Filters */}
        <XStack 
          flexDirection={{ base: 'column', sm: 'row' }} 
          gap="$4"
        >
          <XStack flex={1} position="relative">
            <Search 
              size="$1" 
              color="$colorFocus" 
              position="absolute" 
              left="$3" 
              top="50%" 
              transform="translateY(-50%)" 
            />
            <Input
              placeholder={t('email.list.searchPlaceholder')}
              value={searchTerm}
              onChangeText={handleSearch}
              backgroundColor="$background"
              color="$color"
              borderWidth={1}
              borderColor="$borderColor"
              borderRadius="$4"
              padding="$3"
              paddingLeft="$8"
              flex={1}
            />
          </XStack>
          
          <XStack gap="$2">
            <Select
              value={filters.status}
              onValueChange={handleStatusFilter}
            >
              <Select.Trigger
                backgroundColor="$background"
                borderColor="$borderColor"
                borderRadius="$4"
                width={140}
              >
                <Select.Value placeholder={t('email.list.statusFilter')} />
              </Select.Trigger>

              <Adapt when="sm" platform="touch">
                <Sheet
                  modal
                  dismissOnSnapToBottom
                  snapPointsMode="fit"
                >
                  <Sheet.Frame>
                    <Sheet.ScrollView>
                      <Adapt.Contents />
                    </Sheet.ScrollView>
                  </Sheet.Frame>
                  <Sheet.Overlay />
                </Sheet>
              </Adapt>

              <Select.Content zIndex={200000}>
                <Select.ScrollUpButton />
                <Select.Viewport minHeight={120}>
                  <Select.Group>
                    <Select.Label>{t('email.list.statusOptions')}</Select.Label>
                    <Select.Item index={0} value="all">
                      <Select.ItemText>{t('email.list.allStatus')}</Select.ItemText>
                    </Select.Item>
                    {Object.entries(statusConfig).map(([status, config], idx) => (
                      <Select.Item key={status} index={idx + 1} value={status}>
                        <Select.ItemText>{config.label}</Select.ItemText>
                      </Select.Item>
                    ))}
                  </Select.Group>
                </Select.Viewport>
                <Select.ScrollDownButton />
              </Select.Content>
            </Select>

            <Select
              value={filters.dateFrom ? 
                (filters.dateTo ? 'today' : 
                  filters.dateFrom.getTime() > new Date().getTime() - 8 * 24 * 60 * 60 * 1000 ? 'week' : 'month'
                ) : 'all'}
              onValueChange={handleDateFilter}
            >
              <Select.Trigger
                backgroundColor="$background"
                borderColor="$borderColor"
                borderRadius="$4"
                width={140}
              >
                <Select.Value placeholder={t('email.list.dateFilter')} />
              </Select.Trigger>

              <Adapt when="sm" platform="touch">
                <Sheet
                  modal
                  dismissOnSnapToBottom
                  snapPointsMode="fit"
                >
                  <Sheet.Frame>
                    <Sheet.ScrollView>
                      <Adapt.Contents />
                    </Sheet.ScrollView>
                  </Sheet.Frame>
                  <Sheet.Overlay />
                </Sheet>
              </Adapt>

              <Select.Content zIndex={200000}>
                <Select.ScrollUpButton />
                <Select.Viewport minHeight={120}>
                  <Select.Group>
                    <Select.Label>{t('email.list.dateOptions')}</Select.Label>
                    <Select.Item index={0} value="all">
                      <Select.ItemText>{t('email.list.allTime')}</Select.ItemText>
                    </Select.Item>
                    <Select.Item index={1} value="today">
                      <Select.ItemText>{t('email.list.today')}</Select.ItemText>
                    </Select.Item>
                    <Select.Item index={2} value="week">
                      <Select.ItemText>{t('email.list.lastWeek')}</Select.ItemText>
                    </Select.Item>
                    <Select.Item index={3} value="month">
                      <Select.ItemText>{t('email.list.lastMonth')}</Select.ItemText>
                    </Select.Item>
                  </Select.Group>
                </Select.Viewport>
                <Select.ScrollDownButton />
              </Select.Content>
            </Select>
          </XStack>
        </XStack>

        {/* Analytics Summary */}
        {analytics && (
          <XStack flexWrap="wrap" gap="$4">
            <YStack
              flex={1}
              minWidth={120}
              backgroundColor="$gray2"
              padding="$4"
              borderRadius="$4"
              alignItems="center"
            >
              <Text fontSize="$6" fontWeight="bold" color="$color">
                {analytics.totalSent}
              </Text>
              <Text fontSize="$3" color="$colorFocus">
                {t('email.analytics.totalSent')}
              </Text>
            </YStack>
            <YStack
              flex={1}
              minWidth={120}
              backgroundColor="$gray2"
              padding="$4"
              borderRadius="$4"
              alignItems="center"
            >
              <Text fontSize="$6" fontWeight="bold" color="$color">
                {analytics.openRate.toFixed(1)}%
              </Text>
              <Text fontSize="$3" color="$colorFocus">
                {t('email.analytics.openRate')}
              </Text>
            </YStack>
            <YStack
              flex={1}
              minWidth={120}
              backgroundColor="$gray2"
              padding="$4"
              borderRadius="$4"
              alignItems="center"
            >
              <Text fontSize="$6" fontWeight="bold" color="$color">
                {analytics.clickRate.toFixed(1)}%
              </Text>
              <Text fontSize="$3" color="$colorFocus">
                {t('email.analytics.clickRate')}
              </Text>
            </YStack>
            <YStack
              flex={1}
              minWidth={120}
              backgroundColor="$gray2"
              padding="$4"
              borderRadius="$4"
              alignItems="center"
            >
              <Text fontSize="$6" fontWeight="bold" color="$color">
                {analytics.bounceRate.toFixed(1)}%
              </Text>
              <Text fontSize="$3" color="$colorFocus">
                {t('email.analytics.bounceRate')}
              </Text>
            </YStack>
          </XStack>
        )}

        {/* Email Table */}
        <YStack
          borderWidth={1}
          borderColor="$borderColor"
          borderRadius="$4"
        >
          {/* Table Header */}
          <XStack
            backgroundColor="$gray2"
            padding="$3"
            borderBottomWidth={1}
            borderBottomColor="$borderColor"
          >
            <Text flex={2} fontWeight="bold" color="$color">
              {t('email.list.table.recipient')}
            </Text>
            <Text flex={3} fontWeight="bold" color="$color">
              {t('email.list.table.subject')}
            </Text>
            <Text flex={1} fontWeight="bold" color="$color">
              {t('email.list.table.status')}
            </Text>
            <Text flex={2} fontWeight="bold" color="$color">
              {t('email.list.table.sentAt')}
            </Text>
            <Text width={100} fontWeight="bold" color="$color">
              {t('email.list.table.actions')}
            </Text>
          </XStack>

          {/* Table Body */}
          {isLoading ? (
            // Loading skeletons
            <>
              {[1, 2, 3, 4, 5].map((i) => (
                <XStack key={i} padding="$3" borderBottomWidth={1} borderBottomColor="$borderColor">
                  <XStack flex={2}>
                    <YStack width={120} height="$2" borderRadius="$2" backgroundColor="$gray5" />
                  </XStack>
                  <XStack flex={3}>
                    <YStack width={180} height="$2" borderRadius="$2" backgroundColor="$gray5" />
                  </XStack>
                  <XStack flex={1}>
                    <YStack width={60} height="$2" borderRadius="$2" backgroundColor="$gray5" />
                  </XStack>
                  <XStack flex={2}>
                    <YStack width={100} height="$2" borderRadius="$2" backgroundColor="$gray5" />
                  </XStack>
                  <XStack width={100}>
                    <YStack width={60} height="$2" borderRadius="$2" backgroundColor="$gray5" />
                  </XStack>
                </XStack>
              ))}
            </>
          ) : emails.length === 0 ? (
            // Empty state
            <XStack padding="$8" justifyContent="center">
              <Text color="$colorFocus">
                {t('email.list.noEmails')}
              </Text>
            </XStack>
          ) : (
            // Email rows
            <>
              {emails.map((email) => {
                const StatusIcon = statusIcons[email.status];
                const status = statusConfig[email.status];

                return (
                  <XStack 
                    key={email.id} 
                    padding="$3" 
                    borderBottomWidth={1} 
                    borderBottomColor="$borderColor"
                    hoverStyle={{ backgroundColor: '$backgroundHover' }}
                  >
                    <Text flex={2} color="$color" fontWeight="medium">
                      {email.to}
                    </Text>
                    <Text 
                      flex={3} 
                      color="$color" 
                      numberOfLines={1}
                      ellipsizeMode="tail"
                    >
                      {email.subject}
                    </Text>
                    <XStack flex={1} alignItems="center">
                      <Badge
                        backgroundColor={status.color}
                        color={status.textColor}
                        borderRadius="$4"
                        size="$2"
                      >
                        <XStack gap="$1" alignItems="center">
                          <StatusIcon size="$1" />
                          <Text fontSize="$2" fontWeight="bold">
                            {status.label}
                          </Text>
                        </XStack>
                      </Badge>
                    </XStack>
                    <Text flex={2} color="$colorFocus">
                      {email.sentAt ? format(new Date(email.sentAt), 'MMM d, yyyy HH:mm') : '-'}
                    </Text>
                    <XStack width={100}>
                      <Button
                        size="$2"
                        backgroundColor="transparent"
                        color="$color"
                      >
                        <Text fontSize="$3">
                          {t('email.list.view')}
                        </Text>
                      </Button>
                    </XStack>
                  </XStack>
                );
              })}
            </>
          )}
        </YStack>

        {/* Load More */}
        {hasMore && (
          <XStack justifyContent="center" marginTop="$4">
            <Button
              size="$4"
              backgroundColor="$backgroundHover"
              color="$color"
              borderWidth={1}
              borderColor="$borderColor"
              borderRadius="$4"
              onPress={loadMore}
            >
              <Text fontSize="$3">
                {t('email.list.loadMore')}
              </Text>
            </Button>
          </XStack>
        )}
      </YStack>
    </Card>
  );
}

export default EmailList;

