/**
 * Email Composer Component (Tamagui)
 * 
 * Email composition interface with i18n support
 */

import React, { useState, useEffect } from 'react';
import { YStack, XStack, Card, Text, Button, Input, Label, TextArea, Spinner } from 'tamagui';
import { useForm, Controller } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { useSendEmail, useTemplates, useEmailContext } from '@/lib/emailing';
import { useTranslation } from '@/lib/i18n';
import { 
  Mail, 
  Send, 
  Loader2 
} from '@tamagui/lucide-icons';
import { Select, Adapt, Sheet } from 'tamagui';

const emailComposerSchema = z.object({
  to: z.string().email('Please enter a valid email address'),
  from: z.string().email('Please enter a valid sender email'),
  subject: z.string().min(1, 'Subject is required'),
  content: z.string().min(1, 'Content is required'),
  htmlContent: z.string().optional(),
  templateId: z.string().optional()
});

type EmailComposerFormData = z.infer<typeof emailComposerSchema>;

export function EmailComposer() {
  const { t } = useTranslation();
  const [isSubmitting, setIsSubmitting] = useState(false);
  const { userContext, canSendEmails, isAuthenticated } = useEmailContext();
  const sendEmail = useSendEmail();
  const { data: templates } = useTemplates({ isActive: true });

  const {
    control,
    register,
    handleSubmit,
    formState: { errors },
    watch,
    setValue
  } = useForm<EmailComposerFormData>({
    resolver: zodResolver(emailComposerSchema),
    defaultValues: {
      from: 'noreply@yourcompany.com'
    }
  });

  const selectedTemplateId = watch('templateId');

  // Load template content when template is selected
  useEffect(() => {
    if (selectedTemplateId && templates) {
      const template = templates.find(t => t.id === selectedTemplateId);
      if (template) {
        setValue('subject', template.subject || '');
        setValue('content', template.content || '');
        setValue('htmlContent', template.htmlContent || '');
      }
    }
  }, [selectedTemplateId, templates, setValue]);

  const onSubmit = async (data: EmailComposerFormData) => {
    if (!isAuthenticated) {
      alert(t('email.auth.signInRequired'));
      return;
    }

    if (!canSendEmails) {
      alert(t('email.auth.permissionRequired'));
      return;
    }

    setIsSubmitting(true);
    try {
      await sendEmail.mutateAsync({
        to: data.to,
        from: data.from,
        subject: data.subject,
        content: data.content,
        htmlContent: data.htmlContent,
        templateId: data.templateId
      });
      
      // Reset form on success
      setValue('to', '');
      setValue('subject', '');
      setValue('content', '');
      setValue('htmlContent', '');
      setValue('templateId', '');
    } catch (error) {
      console.error('Failed to send email:', error);
    } finally {
      setIsSubmitting(false);
    }
  };

  if (!isAuthenticated) {
    return (
      <Card
        theme="base"
        size="$4"
        padding="$0"
        backgroundColor="$background"
        borderWidth={1}
        borderColor="$borderColor"
        borderRadius="$6"
        elevation="$2"
        width="100%"
        maxWidth={800}
        alignSelf="center"
      >
        <YStack padding="$6" paddingBottom="$2">
          <Text fontSize="$6" fontWeight="bold" color="$color">
            {t('email.composer.title')}
          </Text>
          <Text fontSize="$3" color="$colorFocus">
            {t('email.auth.signInDescription')}
          </Text>
        </YStack>
        
        <YStack padding="$6" paddingTop="$0">
          <Text textAlign="center" color="$colorFocus" padding="$8">
            {t('email.auth.signInMessage')}
          </Text>
        </YStack>
      </Card>
    );
  }

  if (!canSendEmails) {
    return (
      <Card
        theme="base"
        size="$4"
        padding="$0"
        backgroundColor="$background"
        borderWidth={1}
        borderColor="$borderColor"
        borderRadius="$6"
        elevation="$2"
        width="100%"
        maxWidth={800}
        alignSelf="center"
      >
        <YStack padding="$6" paddingBottom="$2">
          <Text fontSize="$6" fontWeight="bold" color="$color">
            {t('email.composer.title')}
          </Text>
          <Text fontSize="$3" color="$colorFocus">
            {t('email.auth.noPermission')}
          </Text>
        </YStack>
        
        <YStack padding="$6" paddingTop="$0">
          <Text textAlign="center" color="$colorFocus" padding="$8">
            {t('email.auth.contactAdmin')}
          </Text>
        </YStack>
      </Card>
    );
  }

  return (
    <Card
      theme="base"
      size="$4"
      padding="$0"
      backgroundColor="$background"
      borderWidth={1}
      borderColor="$borderColor"
      borderRadius="$6"
      elevation="$2"
      width="100%"
      maxWidth={800}
      alignSelf="center"
    >
      <YStack padding="$6" paddingBottom="$2">
        <XStack gap="$2" alignItems="center">
          <Mail size="$1" color="$color" />
          <Text fontSize="$6" fontWeight="bold" color="$color">
            {t('email.composer.title')}
          </Text>
        </XStack>
        <Text fontSize="$3" color="$colorFocus">
          {t('email.composer.description')}
        </Text>
      </YStack>
      
      <YStack padding="$6" paddingTop="$0">
        <YStack asChild gap="$6">
          <form onSubmit={handleSubmit(onSubmit)}>
            {sendEmail.error && (
              <XStack
                backgroundColor="$red2"
                borderWidth={1}
                borderColor="$red6"
                borderRadius="$4"
                padding="$4"
                gap="$3"
                alignItems="center"
              >
                <Text fontSize="$3" color="$red10">
                  {sendEmail.error.message || t('email.error.sendFailed')}
                </Text>
              </XStack>
            )}

            <XStack flexWrap="wrap" gap="$4">
              {/* From Field */}
              <YStack flex={1} minWidth={200} gap="$2">
                <Label htmlFor="from" fontSize="$4" color="$color">
                  {t('email.composer.from')}
                </Label>
                <Controller
                  control={control}
                  name="from"
                  render={({ field }) => (
                    <Input
                      id="from"
                      value={field.value}
                      onChangeText={field.onChange}
                      placeholder={t('email.composer.fromPlaceholder')}
                      backgroundColor="$background"
                      color="$color"
                      borderWidth={1}
                      borderColor={errors.from ? '$red10' : '$borderColor'}
                      borderRadius="$4"
                      padding="$3"
                    />
                  )}
                />
                {errors.from && (
                  <Text fontSize="$2" color="$red10">
                    {errors.from.message}
                  </Text>
                )}
              </YStack>

              {/* To Field */}
              <YStack flex={1} minWidth={200} gap="$2">
                <Label htmlFor="to" fontSize="$4" color="$color">
                  {t('email.composer.to')}
                </Label>
                <Controller
                  control={control}
                  name="to"
                  render={({ field }) => (
                    <Input
                      id="to"
                      value={field.value}
                      onChangeText={field.onChange}
                      placeholder={t('email.composer.toPlaceholder')}
                      backgroundColor="$background"
                      color="$color"
                      borderWidth={1}
                      borderColor={errors.to ? '$red10' : '$borderColor'}
                      borderRadius="$4"
                      padding="$3"
                    />
                  )}
                />
                {errors.to && (
                  <Text fontSize="$2" color="$red10">
                    {errors.to.message}
                  </Text>
                )}
              </YStack>
            </XStack>

            {/* Template Selection */}
            <YStack gap="$2">
              <Label htmlFor="template" fontSize="$4" color="$color">
                {t('email.composer.template')}
              </Label>
              <Select
                id="template"
                value={selectedTemplateId || ''}
                onValueChange={(value) => setValue('templateId', value)}
              >
                <Select.Trigger
                  backgroundColor="$background"
                  borderColor="$borderColor"
                  borderRadius="$4"
                >
                  <Select.Value placeholder={t('email.composer.templatePlaceholder')} />
                </Select.Trigger>

                <Adapt when="sm" platform="touch">
                  <Sheet
                    modal
                    dismissOnSnapToBottom
                    snapPointsMode="fit"
                  >
                    <Sheet.Frame>
                      <Sheet.ScrollView>
                        <Adapt.Contents />
                      </Sheet.ScrollView>
                    </Sheet.Frame>
                    <Sheet.Overlay />
                  </Sheet>
                </Adapt>

                <Select.Content zIndex={200000}>
                  <Select.ScrollUpButton />
                  <Select.Viewport minHeight={120}>
                    <Select.Group>
                      <Select.Item index={0} value="">
                        <Select.ItemText>{t('email.composer.noTemplate')}</Select.ItemText>
                      </Select.Item>
                      {templates?.map((template, idx) => (
                        <Select.Item key={template.id} index={idx + 1} value={template.id}>
                          <Select.ItemText>{template.name}</Select.ItemText>
                        </Select.Item>
                      ))}
                    </Select.Group>
                  </Select.Viewport>
                  <Select.ScrollDownButton />
                </Select.Content>
              </Select>
            </YStack>

            {/* Subject Field */}
            <YStack gap="$2">
              <Label htmlFor="subject" fontSize="$4" color="$color">
                {t('email.composer.subject')}
              </Label>
              <Controller
                control={control}
                name="subject"
                render={({ field }) => (
                  <Input
                    id="subject"
                    value={field.value}
                    onChangeText={field.onChange}
                    placeholder={t('email.composer.subjectPlaceholder')}
                    backgroundColor="$background"
                    color="$color"
                    borderWidth={1}
                    borderColor={errors.subject ? '$red10' : '$borderColor'}
                    borderRadius="$4"
                    padding="$3"
                  />
                )}
              />
              {errors.subject && (
                <Text fontSize="$2" color="$red10">
                  {errors.subject.message}
                </Text>
              )}
            </YStack>

            {/* Content Field */}
            <YStack gap="$2">
              <Label htmlFor="content" fontSize="$4" color="$color">
                {t('email.composer.content')}
              </Label>
              <Controller
                control={control}
                name="content"
                render={({ field }) => (
                  <TextArea
                    id="content"
                    value={field.value}
                    onChangeText={field.onChange}
                    placeholder={t('email.composer.contentPlaceholder')}
                    backgroundColor="$background"
                    color="$color"
                    borderWidth={1}
                    borderColor={errors.content ? '$red10' : '$borderColor'}
                    borderRadius="$4"
                    padding="$3"
                    numberOfLines={8}
                  />
                )}
              />
              {errors.content && (
                <Text fontSize="$2" color="$red10">
                  {errors.content.message}
                </Text>
              )}
            </YStack>

            {/* Action Buttons */}
            <XStack justifyContent="flex-end" gap="$2">
              <Button
                size="$4"
                backgroundColor="$backgroundHover"
                color="$color"
                borderWidth={1}
                borderColor="$borderColor"
                borderRadius="$4"
                onPress={() => {
                  setValue('to', '');
                  setValue('subject', '');
                  setValue('content', '');
                  setValue('htmlContent', '');
                  setValue('templateId', '');
                }}
              >
                <Text fontSize="$4">
                  {t('email.composer.clear')}
                </Text>
              </Button>
              
              <Button
                theme="accent"
                size="$4"
                backgroundColor={isSubmitting ? "$backgroundHover" : "$blue10"}
                color="white"
                borderRadius="$4"
                onPress={handleSubmit(onSubmit)}
                disabled={isSubmitting}
              >
                <XStack gap="$2" alignItems="center">
                  {isSubmitting ? (
                    <Spinner size="small" color="white" />
                  ) : (
                    <Send size="$1" />
                  )}
                  <Text fontSize="$4" fontWeight="bold">
                    {t('email.composer.send')}
                  </Text>
                </XStack>
              </Button>
            </XStack>
          </form>
        </YStack>
      </YStack>
    </Card>
  );
}

export default EmailComposer;

