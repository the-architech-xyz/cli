import { BaseGenomeTransformer } from '../core/genome-transformer.js';
/**
 * LegacyModuleIdNormalizer
 *
 * Rewrites legacy module IDs to the current marketplace structure and removes duplicates.
 * Examples:
 *  - framework/nextjs -> adapters/framework/nextjs
 *  - ui/shadcn-ui -> adapters/ui/shadcn-ui
 */
export class LegacyModuleIdNormalizer extends BaseGenomeTransformer {
    name = 'Legacy Module ID Normalizer';
    priority = 0; // Run first
    description = 'Normalizes legacy module IDs to new adapter paths and de-duplicates.';
    canTransform(_genome) {
        return true;
    }
    async transform(genome, context) {
        this.logStep(context, 'Normalizing legacy module IDs', { modules: genome.modules.length });
        const normalized = [];
        const seen = new Set();
        // Patterns that need to be prefixed with 'adapters/'
        const adapterPatterns = [
            'framework/',
            'ui/',
            'monorepo/',
            'database/',
            'jobs/',
            'core/',
            'data-fetching/',
            'observability/',
            'deployment/',
            'email/',
            'ai/',
            'payment/',
            'analytics/',
            'content/',
            'blockchain/',
            'services/',
            'backend/'
        ];
        const normalizeId = (moduleId) => {
            let normalizedId = moduleId || '';
            for (const pattern of adapterPatterns) {
                if (normalizedId.startsWith(pattern) && !normalizedId.startsWith(`adapters/${pattern}`)) {
                    normalizedId = normalizedId.replace(new RegExp(`^${pattern.replace('/', '\\/')}`), `adapters/${pattern}`);
                    break;
                }
            }
            return normalizedId;
        };
        for (const mod of genome.modules) {
            const normalizedId = normalizeId(mod.id || '');
            const newMod = { ...mod, id: normalizedId };
            if (seen.has(newMod.id))
                continue;
            seen.add(newMod.id);
            normalized.push(newMod);
        }
        // Update module index metadata when available so subsequent transformers can resolve modules
        this.logSuccess(context, 'Legacy module IDs normalized', { modules: normalized.length });
        return { ...genome, modules: normalized };
    }
}
//# sourceMappingURL=legacy-module-id-normalizer.js.map